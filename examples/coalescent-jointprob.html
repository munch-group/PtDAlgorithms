<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Joint probability experiment – ptdalgorithms</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-d4d76bf8491c20bad77d141916dc28e1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-8647a4a42273f773479d27c00df3f9ed.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../api/_styles-quartodoc.css">
<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">ptdalgorithms</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../api/"> 
<span class="menu-text">Python API reference</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../r_api/"> 
<span class="menu-text">R API reference</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../c_api/"> 
<span class="menu-text">C API reference</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/munch-group/ptdalgorithms/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#make-discrete" id="toc-make-discrete" class="nav-link active" data-scroll-target="#make-discrete">Make discrete</a></li>
  <li><a href="#trash-state-approach" id="toc-trash-state-approach" class="nav-link" data-scroll-target="#trash-state-approach">Trash-state approach</a>
  <ul class="collapse">
  <li><a href="#coalescent" id="toc-coalescent" class="nav-link" data-scroll-target="#coalescent">Coalescent</a></li>
  <li><a href="#two-locus-arg" id="toc-two-locus-arg" class="nav-link" data-scroll-target="#two-locus-arg">Two-locus ARG</a></li>
  </ul></li>
  <li><a href="#base-n-approach" id="toc-base-n-approach" class="nav-link" data-scroll-target="#base-n-approach">Base-n approach</a>
  <ul class="collapse">
  <li><a href="#state-space-for-joint-proability-computation" id="toc-state-space-for-joint-proability-computation" class="nav-link" data-scroll-target="#state-space-for-joint-proability-computation">State space for joint proability computation</a></li>
  <li><a href="#reward-transform" id="toc-reward-transform" class="nav-link" data-scroll-target="#reward-transform">Reward transform</a></li>
  <li><a href="#figure-out-why-you-get-nas-in-multi_rewards-with-max_tons---1" id="toc-figure-out-why-you-get-nas-in-multi_rewards-with-max_tons---1" class="nav-link" data-scroll-target="#figure-out-why-you-get-nas-in-multi_rewards-with-max_tons---1">Figure out why you get NAs in multi_rewards with max_tons &lt;- 1</a></li>
  <li><a href="#compute-joint-prob" id="toc-compute-joint-prob" class="nav-link" data-scroll-target="#compute-joint-prob">Compute joint prob</a></li>
  <li><a href="#when-we-do-the-discrete-version-we-dont-need-to-go-through-the-cdf-to-get-the-pdf.-we-can-just-use-the-ddph-directly" id="toc-when-we-do-the-discrete-version-we-dont-need-to-go-through-the-cdf-to-get-the-pdf.-we-can-just-use-the-ddph-directly" class="nav-link" data-scroll-target="#when-we-do-the-discrete-version-we-dont-need-to-go-through-the-cdf-to-get-the-pdf.-we-can-just-use-the-ddph-directly">When we do the discrete version, we don’t need to go through the CDF to get the PDF. We can just use the <code>ddph</code> directly</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Joint probability experiment</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="405a9cbe-a26b-460b-8ed0-27bb88f943f2" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>config InlineBackend.figure_format <span class="op">=</span> <span class="st">'retina'</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.style.use('dark_background')</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># import matplotlib</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># matplotlib.rcParams['axes.facecolor'] = '#1F1F1F'</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># matplotlib.rcParams['figure.facecolor'] = '#1F1F1F'</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">#%matplotlib widget</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ptdalgorithms <span class="im">as</span> ptd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9bc0b14f-38fb-43e9-bf9b-29d96cfde495" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> coalescent(n):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> callback(state):</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        transitions <span class="op">=</span> []</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(nr_samples):</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i, nr_samples):            </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                same <span class="op">=</span> <span class="bu">int</span>(i <span class="op">==</span> j)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> same <span class="kw">and</span> state[i] <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> same <span class="kw">and</span> (state[i] <span class="op">&lt;</span> <span class="dv">1</span> <span class="kw">or</span> state[j] <span class="op">&lt;</span> <span class="dv">1</span>):</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span> </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                new <span class="op">=</span> state[:]</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                new[i] <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                new[j] <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                new[i<span class="op">+</span>j<span class="op">+</span><span class="dv">1</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                transitions.append((new, state[i]<span class="op">*</span>(state[j]<span class="op">-</span>same)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span>same)))</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> transitions</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">=</span> ptd.Graph(callback<span class="op">=</span>callback, initial<span class="op">=</span>[nr_samples]<span class="op">+</span>[<span class="dv">0</span>]<span class="op">*</span>nr_samples)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> graph</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>nr_samples <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>coalescent(nr_samples)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>graph.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-3-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="coalescent-jointprob_files/figure-html/cell-3-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<section id="make-discrete" class="level2">
<h2 class="anchored" data-anchor-id="make-discrete">Make discrete</h2>
<div id="58c9023d-7c17-43b2-86ca-4308b2acedca" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>np.zeros((<span class="dv">3</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>array([[0., 0., 0., 0., 0.],
       [0., 0., 0., 0., 0.],
       [0., 0., 0., 0., 0.]])</code></pre>
</div>
</div>
<div id="42fb2ba0-79df-4d0d-b49e-048d8883c80b" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_discrete(mutation_graph, mutation_rate):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Takes a graph for a continuous distribution and turns</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">    it into a descrete one (inplace). Returns a matrix of</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    rewards for computing marginal moments</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># current nr of states in graph</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    vlength <span class="op">=</span> mutation_graph.vertices_length()</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># number of fields in state vector (assumes all are the same length)</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    state_vector_length <span class="op">=</span> <span class="bu">len</span>(mutation_graph.vertex_at(<span class="dv">1</span>).state())</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># list state vector fields to reward at each auxiliary node</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rewarded_state_vector_indexes = [[] for _ in range(state_vector_length)]</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    rewarded_state_vector_indexes <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># loop all but starting node</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, vlength):</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        vertex <span class="op">=</span> mutation_graph.vertex_at(i)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> vertex.rate() <span class="op">&gt;</span> <span class="dv">0</span>: <span class="co"># not absorbing</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(state_vector_length):</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>                val <span class="op">=</span> vertex.state()[j]</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> val <span class="op">&gt;</span> <span class="dv">0</span>: <span class="co"># only ones we may reward</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># add auxilliary node</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>                    mutation_vertex <span class="op">=</span> mutation_graph.create_vertex(np.repeat(<span class="dv">0</span>, state_vector_length))</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>                    mutation_vertex.add_edge(vertex, <span class="dv">1</span>)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>                    mutation_vertex.add_edge(vertex, mutation_rate<span class="op">*</span>val)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(mutation_vertex.index(), rewarded_state_vector_indexes[j], j)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>                    rewarded_state_vector_indexes[mutation_vertex.index()] <span class="op">=</span> rewarded_state_vector_indexes[j] <span class="op">+</span> [j]</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(rewarded_state_vector_indexes)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># normalize graph</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    weights_were_multiplied_with <span class="op">=</span> mutation_graph.normalize()</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># build reward matrix</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    rewards <span class="op">=</span> np.zeros((mutation_graph.vertices_length(), state_vector_length))</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> state <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(rewarded_state_vector_indexes)):</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> rewarded_state_vector_indexes[state]:</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>            rewards[state, i] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    rewards <span class="op">=</span> np.transpose(rewards)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(rewards)</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> coalescent(<span class="dv">4</span>)</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a><span class="co"># self-transition rate:</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>mutation_rate <span class="op">=</span> <span class="fl">1e-8</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a><span class="co"># clone graph to get one to modify:</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>mutation_graph <span class="op">=</span> ptd.Graph(graph.clone())</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="co"># add auxilliary states, normalize and return reward matrix:</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>rewards <span class="op">=</span> make_discrete(mutation_graph, mutation_rate)</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a><span class="co">#print(mutation_graph.expectation())</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rewards)</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>mutation_graph.plot()</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a><span class="co"># # for plotting the new graph</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a><span class="co"># gam &lt;- graph_as_matrix(mutation_graph)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>6 [] 0
7 [] 0
8 [] 1
9 [] 1
10 [] 0
11 [] 2
defaultdict(&lt;class 'list'&gt;, {0: [], 6: [0], 7: [0], 1: [], 8: [1], 9: [1], 10: [0], 2: [], 11: [2]})
[[0. 0. 0. 0. 0. 0. 1. 1. 0. 0. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 1. 0. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="52">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-5-output-2.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="coalescent-jointprob_files/figure-html/cell-5-output-2.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="trash-state-approach" class="level1">
<h1>Trash-state approach</h1>
<div id="13817d7a-05a8-4ecc-b342-6eb80d21e4ab" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># discrete_joint_prob &lt;- function(graph, reward_limits, mutation_rate, reward_possible, tot_reward_limit=Inf, return_graph=FALSE) {</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (is.list(reward_limits)) {</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#         stopifnot(is.infinite(tot_reward_limit)) # don't use tot_reward_limit with list of all allowed rewards</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">#         reward_dims &lt;- length(reward_limits[[1]])</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">#         possible_rewards &lt;- reward_limits</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     } else {</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         reward_dims &lt;- length(reward_limits)</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">#         # get all possible reward combinations respecting the reward_limits</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">#         possible_rewards &lt;- unname(as.list(as.data.frame(t(</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">#             expand.grid(</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">#                 sapply(reward_limits, function(x) list(0:x))</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">#                        ) </span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co">#                     ))) </span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co">#                 )</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="co">#     ############</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="co">#     # remove reward combinations not respecting the tot_reward_limit                                </span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="co">#     possible_rewards &lt;- possible_rewards[sapply(possible_rewards, function(x) sum(x)&lt;=tot_reward_limit)]</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="co">#     ############</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     # print(possible_rewards)</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>                                                </span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="co">#     # m &lt;- matrix(0, nrow = reward_dims, ncol = reward_dims)</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="co">#     # diag(m) &lt;- 1                                                </span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="co">#     # # only use reward increments where we want tons at all (where reward limits are non-zero)                                            </span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="co">#     # # diag(m) &lt;- rowSums(as.data.frame(possible_rewards))</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="co">#     # reward_increments &lt;- as.list(as.data.frame(m))</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="co">#     # new graph</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="co">#     state_vector_length &lt;- length(vertex_at(graph, 1)$state) + reward_dims</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co">#     state_reward_indices &lt;- (state_vector_length-reward_dims+1):state_vector_length</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="co">#     new_graph &lt;- create_graph(state_vector_length)</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a><span class="co">#     # add vertices to new graph</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="co">#     t_vertex_indices &lt;- c()</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="co">#     for (vertex in vertices(graph)) {</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="co">#         for (p in possible_rewards) {</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a><span class="co">#           ############# # HOW DO I MAKE THIS WORK FOR OTHER THAN THE COALESCENCE STATE SPACE</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a><span class="co">#           # for all non-abs states, skip state/reward combinations with rewards that cannot be earned at state</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a><span class="co">#           if (length(edges(vertex)) &gt; 0 &amp;&amp; !reward_possible(vertex$state, p)) next            </span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a><span class="co">#           # if (length(edges(vertex)) &gt; 0 &amp;&amp; highest_nonzero_index(p) &gt; highest_nonzero_index(vertex$state)) next</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a><span class="co">#           #############</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a><span class="co">#           state &lt;- c(vertex$state, p)</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a><span class="co">#           new_vertex &lt;- find_or_create_vertex(new_graph, state) # if I use create_vertex here, I cannot find it again with find_vertex...</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a><span class="co">#           if (length(edges(vertex)) == 0) {</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a><span class="co">#             t_vertex_indices &lt;- c(t_vertex_indices, new_vertex$index) </span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a><span class="co">#           }</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a><span class="co">#     # trash states</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a><span class="co">#     trash_vertex &lt;- find_or_create_vertex(new_graph, rep(0, state_vector_length))</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a><span class="co">#     trash_loop_vertex &lt;- create_vertex(new_graph, rep(0, state_vector_length))</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a><span class="co">#     add_edge(trash_vertex, trash_loop_vertex, 1)</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a><span class="co">#     add_edge(trash_loop_vertex, trash_vertex, 1)</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a><span class="co">#     # add edges to new graph</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a><span class="co">#     for (vertex in vertices(graph)) {</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (vertex$index == 1)</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a><span class="co">#             next</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a><span class="co">#         state &lt;- vertex$state</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a><span class="co">#         for (p in possible_rewards) {</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a><span class="co">#             new_vertex &lt;- find_vertex(new_graph, c(state, p))</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a><span class="co">#             #############</span></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a><span class="co">#             if (is.null(new_vertex)) next</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a><span class="co">#             #############</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a><span class="co">#             # coalescence edges</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a><span class="co">#             for (edge in edges(vertex)) {            </span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a><span class="co">#                 child_state &lt;- edge$child$state</span></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a><span class="co">#                 new_child_vertex &lt;- find_vertex(new_graph, c(child_state, p))</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a><span class="co">#                 #############</span></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a><span class="co">#                 if (is.null(new_vertex) || is.null(new_child_vertex)) next</span></span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a><span class="co">#                 #############</span></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a><span class="co">#                 add_edge(new_vertex, </span></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a><span class="co">#                          new_child_vertex, </span></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a><span class="co">#                          edge$weight)</span></span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a><span class="co">#             # mutation edges</span></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a><span class="co">#             new_vertex_rewards &lt;- tail(new_vertex$state, reward_dims)</span></span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a><span class="co">#             trash_rate &lt;- 0</span></span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a><span class="co">#             for (i in 1:reward_dims) {</span></span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a><span class="co">#                 r &lt;- rep(0, reward_dims)</span></span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a><span class="co">#                 r[i] &lt;- 1</span></span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a><span class="co">#                 rate &lt;- state[i] * mutation_rate </span></span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a><span class="co">#                 new_child_vertex &lt;- find_vertex(new_graph, c(state, new_vertex_rewards + r))</span></span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a><span class="co">#                 # if ( all(sapply(reward_limits, function(x) all(new_vertex_rewards + r &lt;= x))) ) {</span></span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a><span class="co">#                 if ( all(new_vertex_rewards + r &lt;= reward_limits) &amp; sum(new_vertex_rewards + r) &lt;= tot_reward_limit) {</span></span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a><span class="co">#                     #############</span></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a><span class="co">#                     if (is.null(new_vertex) || is.null(new_child_vertex)) next</span></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a><span class="co">#                     #############</span></span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a><span class="co">#                     add_edge(new_vertex,</span></span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a><span class="co">#                              new_child_vertex, </span></span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a><span class="co">#                              rate)</span></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a><span class="co">#                 } else {</span></span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a><span class="co">#                     trash_rate &lt;- trash_rate + rate</span></span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a><span class="co">#                 }</span></span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a><span class="co">#             add_edge(new_vertex, trash_vertex, trash_rate) </span></span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a><span class="co">#     # add edges from t-states to new final absorbing</span></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a><span class="co">#     new_absorbing &lt;- create_vertex(new_graph, rep(0, state_vector_length))</span></span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a><span class="co">#     for (i in t_vertex_indices) {</span></span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a><span class="co">#         add_edge(vertex_at(new_graph, i), new_absorbing, 1)</span></span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a><span class="co">#     # add edges from starting vertex (IPV)</span></span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a><span class="co">#     starting_vertex &lt;- vertex_at(graph, 1)</span></span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a><span class="co">#     new_starting_vertex &lt;- vertex_at(new_graph, 1)</span></span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a><span class="co">#     for (edge in edges(starting_vertex)) {</span></span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a><span class="co">#         add_edge(new_starting_vertex, find_vertex(new_graph, c(edge$child$state, rep(0, reward_dims))), 1)</span></span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a><span class="co">#     # normalize graph                            </span></span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a><span class="co">#     weights_were_multiplied_with &lt;- normalize_graph(new_graph)</span></span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (return_graph)                           </span></span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a><span class="co">#         return(new_graph)                                             </span></span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a><span class="co">#     start &lt;- proc.time()[3]</span></span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a><span class="co">#     # time spent in each of the the t-states after some appropriately large time (these are the joint probs)</span></span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a><span class="co">#     # (maybe I can somehow figure out to stop at the 0.999 quantile)</span></span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a><span class="co">#     accum_time &lt;- accumulated_visiting_time(new_graph, 100)[t_vertex_indices]</span></span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a><span class="co">#     # I can test if the graph is acyclic and if so, use accumulated_residence_time instead?</span></span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>                                                </span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a><span class="co">#     proc.time()[3] - start</span></span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a><span class="co">#     # data frame with joint probs</span></span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a><span class="co">#     states &lt;- states(new_graph)</span></span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a><span class="co">#     state_reward_matrix &lt;- as.data.frame(states[t_vertex_indices, state_reward_indices])</span></span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a><span class="co">#     joint_probs &lt;- cbind(state_reward_matrix, accum_time)</span></span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(c(vertices_length(graph), vertices_length(new_graph), vertices_length(new_graph)/vertices_length(graph)))                                </span></span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a><span class="co">#     return(joint_probs)   </span></span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a><span class="co"># } </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="88c33bf3-95bc-41a8-8489-240f14290059" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sample_size &lt;- 4</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># graph &lt;- standard_coalescent(sample_size)</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># state_length &lt;- length(vertex_at(graph, 1)$state)</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # last state index is absorbing where no rewards can be earned</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># # reward_limits &lt;- c(rep(20, state_length-1), 0)</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># reward_limits &lt;- c(rep(1, state_length-1), 0)</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># tot_reward_limit &lt;- Inf</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># # mutation_rate &lt;- 20000 * 31 * 5e-10 # 0.00031</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># mutation_rate &lt;- 1</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co"># reward_possible &lt;- function(state, rewards) {</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     highest_nonzero_index &lt;- function(a) {</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">#        idx &lt;- a != 0</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">#        ifelse(any(idx), max(which(idx)), 0)</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co">#     return (highest_nonzero_index(rewards) &lt;= highest_nonzero_index(state))</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>                                   </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co"># start &lt;- proc.time()[3]</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co"># joint_probs &lt;- discrete_joint_prob(graph, reward_limits, mutation_rate, reward_possible, tot_reward_limit=tot_reward_limit)</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="co"># proc.time()[3] - start</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co"># new_graph &lt;- discrete_joint_prob(graph, reward_limits, mutation_rate, reward_possible, tot_reward_limit=tot_reward_limit, return_graph=TRUE)</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_graph(graph_as_matrix(new_graph), size=c(10, 10), align=TRUE, #rainbow=TRUE,</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="co">#                fontsize=16, ranksep=2, nodesep=0.5, rankdir="LR",</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co">#               subgraphs=TRUE, subgraphfun=function(state, index) paste(state[1:sample_size], collapse=""),</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="co">#            splines='line'</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="co">#           )  </span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>                                                </span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="co"># joint_probs                               </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7eee1cf6-8424-452f-ac2b-e894ecb6a581" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>discrete_joint_prob <span class="op">&lt;-</span> function(graph, reward_rates, precision<span class="op">=</span><span class="fl">1e-15</span>, return_graph<span class="op">=</span>FALSE) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    starting_vertex <span class="op">&lt;-</span> starting_vertex(graph)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    reward_dims <span class="op">&lt;-</span> length(reward_rates(starting_vertex$state, current_rewards<span class="op">=</span>NULL)) <span class="op">-</span> <span class="dv">1</span> <span class="co"># a bit of a hack. -1 to not count trash rate...</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    orig_state_vector_length <span class="op">&lt;-</span> length(vertex_at(graph, <span class="dv">1</span>)$state)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    state_vector_length <span class="op">&lt;-</span> orig_state_vector_length <span class="op">+</span> reward_dims</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    state_indices <span class="op">&lt;-</span> <span class="dv">1</span>:orig_state_vector_length</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    reward_indices <span class="op">&lt;-</span> (orig_state_vector_length<span class="op">+</span><span class="dv">1</span>):state_vector_length</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    new_graph <span class="op">&lt;-</span> create_graph(state_vector_length)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    new_starting_vertex <span class="op">&lt;-</span> vertex_at(new_graph, <span class="dv">1</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    null_rewards <span class="op">&lt;-</span> rep(<span class="dv">0</span>, reward_dims)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    index <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add edges from starting vertex (IPV)</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (edge <span class="kw">in</span> edges(starting_vertex)) {        </span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        add_edge(</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>          new_starting_vertex,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>          find_or_create_vertex(new_graph, c(edge$child$state, null_rewards)),</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>          <span class="dv">1</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    index <span class="op">&lt;-</span> index <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    trash_rates <span class="op">&lt;-</span> <span class="bu">list</span>()</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    t_vertex_indices <span class="op">&lt;-</span> c()</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (index <span class="op">&lt;=</span> vertices_length(new_graph)) {</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>        new_vertex <span class="op">&lt;-</span> vertex_at(new_graph, index)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>        new_state <span class="op">&lt;-</span> new_vertex$state</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>        state <span class="op">&lt;-</span> new_vertex$state[state_indices]</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>        vertex <span class="op">&lt;-</span> find_vertex(graph, state)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># non-mutation transitions (coalescence)</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (edge <span class="kw">in</span> edges(vertex)) {</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>            new_child_state <span class="op">&lt;-</span> c(edge$child$state, new_state[reward_indices])</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="bu">all</span>(new_state <span class="op">==</span> new_child_state)) <span class="bu">next</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>            new_child_vertex <span class="op">&lt;-</span> find_or_create_vertex(new_graph, new_child_state)</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>            <span class="co"># cat(new_child_vertex$state, "\n")</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>            add_edge(new_vertex,</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>                new_child_vertex, <span class="co"># if I use create_vertex here, I cannot find it again with find_vertex...</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>                edge$weight</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>            <span class="co"># if new child was absorbing, record at "t-states":</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (length(edges(find_vertex(graph, new_child_state[state_indices]))) <span class="op">==</span> <span class="dv">0</span>) {</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>                t_vertex_indices <span class="op">&lt;-</span> c(t_vertex_indices, new_child_vertex$index) </span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>            }            </span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># mutation transitions</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>        current_state <span class="op">&lt;-</span> new_state[state_indices]</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>        current_rewards <span class="op">&lt;-</span> new_state[reward_indices]</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        rates <span class="op">&lt;-</span> reward_rates(current_state, current_rewards) <span class="co"># list of all allowed mutation transition rates with trash rate appended</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>        trash_rates[[index]] <span class="op">&lt;-</span> rates[reward_dims<span class="op">+</span><span class="dv">1</span>]</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:reward_dims) {</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>            rate <span class="op">&lt;-</span> rates[i]</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (rate <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>                new_rewards <span class="op">&lt;-</span> current_rewards</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>                new_rewards[i] <span class="op">&lt;-</span> new_rewards[i] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>                new_child_vertex <span class="op">&lt;-</span> find_or_create_vertex(new_graph, c(current_state, new_rewards))</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>                <span class="co"># stopifnot(sum(new_child_vertex$state) &gt; 4)</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>                <span class="co"># cat(new_child_vertex$state, "\n")</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>                add_edge(</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>                    new_vertex,</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>                    new_child_vertex, <span class="co"># if I use create_vertex here, I cannot find it again with find_vertex...</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>                    rate</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>                <span class="co"># # if new child was absorbing, record at "t-states":                </span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>                <span class="co"># if (length(edges(find_vertex(graph, new_child_state[state_indices]))) == 0) {</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>                <span class="co">#     t_vertex_indices &lt;- c(t_vertex_indices, new_child_vertex$index) </span></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>                <span class="co"># }                 </span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>        index <span class="op">&lt;-</span> index <span class="op">+</span> <span class="dv">1</span> </span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (index <span class="op">%%</span> <span class="dv">1000</span> <span class="op">==</span> <span class="dv">0</span>) {</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>            cat(index, vertices_length(new_graph), <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>            flush.console()</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>        <span class="co"># stopifnot(index &lt; 100000)</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># trash states</span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>    trash_vertex <span class="op">&lt;-</span> find_or_create_vertex(new_graph, rep(<span class="dv">0</span>, state_vector_length))</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>    trash_loop_vertex <span class="op">&lt;-</span> create_vertex(new_graph, rep(<span class="dv">0</span>, state_vector_length))</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>    add_edge(trash_vertex, trash_loop_vertex, <span class="dv">1</span>)</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>    add_edge(trash_loop_vertex, trash_vertex, <span class="dv">1</span>)</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add trash edges</span></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:length(trash_rates)) {</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>        rate <span class="op">&lt;-</span> trash_rates[[i]]</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="op">!</span><span class="kw">is</span>.null(rate)) {</span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>            add_edge(vertex_at(new_graph, i), trash_vertex, rate) </span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add edges from t-states to new final absorbing</span></span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>    new_absorbing <span class="op">&lt;-</span> create_vertex(new_graph, rep(<span class="dv">0</span>, state_vector_length))</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>    t_vertex_indices <span class="op">&lt;-</span> unique(t_vertex_indices)</span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="kw">in</span> t_vertex_indices) {</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>        add_edge(vertex_at(new_graph, i), new_absorbing, <span class="dv">1</span>)</span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># normalize graph                            </span></span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>    weights_were_multiplied_with <span class="op">&lt;-</span> normalize_graph(new_graph)</span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (return_graph)                           </span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span>(new_graph)                                             </span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># time spent in each of the the t-states after some appropriately large time (these are the joint probs)</span></span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>    prev <span class="op">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (decade <span class="kw">in</span> <span class="dv">1</span>:<span class="dv">100</span>) {</span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>        <span class="co"># cat(decade, "\n")</span></span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>        <span class="co"># flush.console()</span></span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>        accum_time <span class="op">&lt;-</span> accumulated_visiting_time(new_graph, decade<span class="op">*</span><span class="dv">10</span>)[t_vertex_indices]</span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="bu">all</span>(<span class="bu">abs</span>(accum_time<span class="op">-</span>prev) <span class="op">&lt;</span> precision)) <span class="cf">break</span></span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>        prev <span class="op">&lt;-</span> accum_time</span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>    }    </span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>    stopifnot(decade <span class="op">&lt;</span> <span class="dv">100</span>)</span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I can test if the graph is acyclic and if so, use accumulated_residence_time instead?</span></span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>                                                    </span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># data frame with joint probs</span></span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>    states <span class="op">&lt;-</span> states(new_graph)</span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>    state_reward_matrix <span class="op">&lt;-</span> <span class="im">as</span>.data.frame(states[t_vertex_indices, reward_indices])</span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>    joint_probs <span class="op">&lt;-</span> cbind(state_reward_matrix, accum_time)</span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(c(vertices_length(graph), vertices_length(new_graph), vertices_length(new_graph)<span class="op">/</span>vertices_length(graph)))                                </span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(joint_probs)  </span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>partial <span class="op">&lt;-</span> function(f, ...) {</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>    l <span class="op">&lt;-</span> <span class="bu">list</span>(...)</span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>    function(...) {</span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>        do.call(f, c(l, <span class="bu">list</span>(...)))</span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a><span class="co"># sample_size &lt;- 2</span></span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a><span class="co"># graph &lt;- two_locus_arg(sample_size, 1, 1)</span></span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a><span class="co"># vertices_length(graph)</span></span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a><span class="co"># reward_rates &lt;- partial(arg_reward_rates, mutation_rate=1, reward_limit=1, locus_ton_reward_limit=1)</span></span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a><span class="co"># joint_probs &lt;- discrete_joint_prob(graph, reward_rates)</span></span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a><span class="co"># head(joint_probs)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="coalescent" class="level2">
<h2 class="anchored" data-anchor-id="coalescent">Coalescent</h2>
<div id="54ccda6d-799c-40b8-b391-cfe2ae8bd620" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>standard_coalescent <span class="op">&lt;-</span> function(n) {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># n &lt;- 4</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># state_vector_length &lt;- n + 1    ## + 1 needed to keep it from dumping ##################</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    state_vector_length <span class="op">&lt;-</span> n </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">&lt;-</span> create_graph(state_vector_length)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    starting_vertex <span class="op">&lt;-</span> vertex_at(graph, <span class="dv">1</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># initial_state &lt;- c(rep(0, n), 0)</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    initial_state <span class="op">&lt;-</span> rep(<span class="dv">0</span>, state_vector_length)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    initial_state[<span class="dv">1</span>] <span class="op">&lt;-</span> n</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    add_edge(</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>      starting_vertex,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>      find_or_create_vertex(graph, initial_state),</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    index <span class="op">&lt;-</span> <span class="dv">2</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (index <span class="op">&lt;=</span> vertices_length(graph)) {</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>      vertex <span class="op">&lt;-</span> vertex_at(graph, index)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>      <span class="co"># loop over all classes of lineages</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:n) {</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="kw">in</span> i:n) {</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>          state <span class="op">&lt;-</span> vertex$state</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>          <span class="co"># if same class, there need to be at least two to coalesce</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (i <span class="op">==</span> j) {</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (state[i] <span class="op">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>              <span class="bu">next</span><span class="op">;</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>            <span class="co"># coal rate</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>            rate <span class="op">&lt;-</span> state[i] <span class="op">*</span> (state[i] <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>            <span class="co"># else at least one in each class to coalesce</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (state[i] <span class="op">&lt;</span> <span class="dv">1</span> <span class="op">||</span> state[j] <span class="op">&lt;</span> <span class="dv">1</span>) {</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>              <span class="bu">next</span><span class="op">;</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>            <span class="co"># number of combinations</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>            rate <span class="op">&lt;-</span> state[i] <span class="op">*</span> state[j]</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>          <span class="co"># copy state</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>          child_state <span class="op">&lt;-</span> state</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>          <span class="co"># update child state</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>          child_state[i] <span class="op">&lt;-</span> child_state[i] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>          child_state[j] <span class="op">&lt;-</span> child_state[j] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>          child_state[i<span class="op">+</span>j] <span class="op">&lt;-</span> child_state[i<span class="op">+</span>j] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>          add_edge(</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>              vertex,</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>              find_or_create_vertex(graph, child_state),</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>              rate, c(rate)</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>      index <span class="op">&lt;-</span> index <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(graph)</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a><span class="co"># sample_size &lt;- 4</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a><span class="co"># graph &lt;- standard_coalescent(sample_size)</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a><span class="co"># for (i in 1:vertices_length(graph)) {</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a><span class="co">#     state &lt;- vertex_at(graph, i)$state</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(state)</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(find_vertex(graph, state))</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a><span class="co"># expectation(graph)</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a><span class="co"># states &lt;- t(sapply(1:vertices_length(graph), function(index) vertex_at(graph, index)$state ))</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a><span class="co"># ipv &lt;- graph_as_matrix(graph)$IPV</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a><span class="co"># sim &lt;- graph_as_matrix(graph)$SIM</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-cyan-fg">  Cell </span><span class="ansi-green-fg">In[8], line 6</span>
<span class="ansi-red-fg">    state_vector_length &lt;- n</span>
    ^
<span class="ansi-red-fg">SyntaxError</span><span class="ansi-red-fg">:</span> invalid syntax. Perhaps you forgot a comma?
</pre>
</div>
</div>
</div>
<div id="d5b68f6f-6a1a-4294-9b9f-95d1c0566ffc" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>sample_size <span class="op">&lt;-</span> <span class="dv">4</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>graph <span class="op">&lt;-</span> standard_coalescent(sample_size)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="88359730-211d-48b3-98c5-32e67b71a40a" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>gam <span class="op">&lt;-</span> graph_as_matrix(graph)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>gam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<dl>
    <dt>$states</dt>
        <dd>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A matrix: 4 × 4 of type dbl</caption>
<tbody>
<tr class="odd">
<td>4</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>0</td>
<td>2</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>

</dd>
    <dt>$SIM</dt>
        <dd>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A matrix: 4 × 4 of type dbl</caption>
<tbody>
<tr class="odd">
<td>-6</td>
<td>6</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>0</td>
<td>-3</td>
<td>1</td>
<td>2</td>
</tr>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>-1</td>
<td>0</td>
</tr>
<tr class="even">
<td>0</td>
<td>0</td>
<td>0</td>
<td>-1</td>
</tr>
</tbody>
</table>

</dd>
    <dt>$IPV</dt>
        <dd><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>1</li><li>0</li><li>0</li><li>0</li></ol>
</dd>
    <dt>$indices</dt>
        <dd><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>2</li><li>3</li><li>4</li><li>5</li></ol>
</dd>
</dl>
</div>
</div>
<div id="b1e04d89-41df-4b28-a35d-2b3b26885de0" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (vertices_length(graph) <span class="op">&lt;</span> <span class="dv">30</span>) {    </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    plot_graph(gam, size<span class="op">=</span>c(<span class="dv">10</span>, <span class="dv">10</span>), align<span class="op">=</span>TRUE, <span class="co">#rainbow=TRUE,</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>               fontsize<span class="op">=</span><span class="dv">16</span>, ranksep<span class="op">=</span><span class="dv">2</span>, nodesep<span class="op">=</span><span class="fl">0.5</span>, rankdir<span class="op">=</span><span class="st">"LR"</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>               subgraphs<span class="op">=</span>TRUE, subgraphfun<span class="op">=</span>function(state, index) paste(state[<span class="dv">1</span>:sample_size], collapse<span class="op">=</span><span class="st">""</span>),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>               splines<span class="op">=</span><span class="st">'line'</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-12-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="coalescent-jointprob_files/figure-html/cell-12-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="1fc2cdbc-354d-45f1-bc0c-8864b7c593e2" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>coalescent_reward_rates <span class="op">&lt;-</span> function(new_state, current_rewards, mutation_rate, reward_limit, tot_reward_limit)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>{    </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    reward_limits <span class="op">&lt;-</span> c(rep(reward_limit, length(new_state)<span class="op">-</span><span class="dv">1</span>), <span class="dv">0</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    reward_dims <span class="op">&lt;-</span> length(reward_limits)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">is</span>.null(current_rewards))</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        current_rewards <span class="op">&lt;-</span> rep(<span class="dv">0</span>, reward_dims)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    result <span class="op">&lt;-</span> rep(<span class="dv">0</span>, reward_dims)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    trash_rate <span class="op">&lt;-</span> <span class="dv">0</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:reward_dims) {</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        rate <span class="op">&lt;-</span> new_state[i] <span class="op">*</span> mutation_rate </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        r <span class="op">&lt;-</span> rep(<span class="dv">0</span>, reward_dims)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        r[i] <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ( <span class="bu">all</span>(current_rewards <span class="op">+</span> r <span class="op">&lt;=</span> reward_limits) <span class="op">&amp;&amp;</span> <span class="bu">sum</span>(current_rewards <span class="op">+</span> r) <span class="op">&lt;=</span> tot_reward_limit) {</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>            result[i] <span class="op">&lt;-</span> rate</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>            trash_rate <span class="op">&lt;-</span> trash_rate <span class="op">+</span> rate</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    }     </span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(c(result, trash_rate))</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>reward_rates <span class="op">&lt;-</span> partial(coalescent_reward_rates, mutation_rate<span class="op">=</span><span class="dv">1</span>, reward_limit<span class="op">=</span><span class="dv">1</span>, tot_reward_limit<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co"># reward_rates &lt;- partial(coalescent_reward_rates, mutation_rate=1, reward_limit=20, tot_reward_limit=Inf)</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>start <span class="op">&lt;-</span> proc.time()[<span class="dv">3</span>]</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>joint_probs <span class="op">&lt;-</span> discrete_joint_prob(graph, reward_rates)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>proc.time()[<span class="dv">3</span>] <span class="op">-</span> start</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>head(joint_probs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  6.000000 28.000000  4.666667</code></pre>
</div>
<div class="cell-output cell-output-display">
<strong>elapsed:</strong> 0.0370000000000346
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 5</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">V1</th>
<th data-quarto-table-cell-role="th" scope="col">V2</th>
<th data-quarto-table-cell-role="th" scope="col">V3</th>
<th data-quarto-table-cell-role="th" scope="col">V4</th>
<th data-quarto-table-cell-role="th" scope="col">accum_time</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.10000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">2</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0.03888889</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">3</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.09555556</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">4</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0.02222222</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">5</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0.03111111</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">6</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0.03777778</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="83a017cf-0ca8-4cfd-b5fb-25cec23cf972" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>with_deficit <span class="op">&lt;-</span> c(<span class="bu">sum</span>(joint_probs$V1 <span class="op">*</span> joint_probs$accum_time), </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">sum</span>(joint_probs$V2 <span class="op">*</span> joint_probs$accum_time), </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">sum</span>(joint_probs$V3 <span class="op">*</span> joint_probs$accum_time))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>with_deficit</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>(c(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>) <span class="op">-</span> with_deficit) <span class="op">/</span> c(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>0.164444444444434</li><li>0.0803703703703643</li><li>0.0570370370370341</li></ol>
</div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>0.917777777777783</li><li>0.919629629629636</li><li>0.914444444444449</li></ol>
</div>
</div>
<div id="dfa78f42-a109-470b-bdbe-ecf75d2b9cec" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>new_graph <span class="op">&lt;-</span> discrete_joint_prob(graph, reward_rates, return_graph<span class="op">=</span>TRUE)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>new_gam <span class="op">&lt;-</span> graph_as_matrix(new_graph)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (vertices_length(new_graph) <span class="op">&lt;</span> <span class="dv">30</span>) {    </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    plot_graph(new_gam, size<span class="op">=</span>c(<span class="dv">10</span>, <span class="dv">10</span>), align<span class="op">=</span>TRUE, <span class="co">#rainbow=TRUE,</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>               fontsize<span class="op">=</span><span class="dv">16</span>, ranksep<span class="op">=</span><span class="dv">2</span>, nodesep<span class="op">=</span><span class="fl">0.5</span>, rankdir<span class="op">=</span><span class="st">"LR"</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>               subgraphs<span class="op">=</span>TRUE, subgraphfun<span class="op">=</span>function(state, index) paste(state[<span class="dv">1</span>:sample_size], collapse<span class="op">=</span><span class="st">""</span>),</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>               splines<span class="op">=</span><span class="st">'line'</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-15-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="coalescent-jointprob_files/figure-html/cell-15-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="313312e9-ff43-4807-b12e-8a46f184e090" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># new_graph &lt;- discrete_joint_prob(graph, reward_rates, return_graph=TRUE)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># start &lt;- proc.time()[3]</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># prev &lt;- 0</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for (i in 1:10) {</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     accum_time &lt;- accumulated_visiting_time(new_graph, 10*i)</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (all(abs(accum_time-prev)[1:10] &lt; 10e-15))</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">#         break</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     prev &lt;- accum_time</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co"># proc.time()[3] - start</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="49be9860-add0-4ab4-bff4-03c4677f747b" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>joint_probs <span class="op">%&gt;%</span> <span class="bu">filter</span>(V1<span class="op">==</span><span class="dv">1</span>, V2<span class="op">==</span><span class="dv">0</span>, V3<span class="op">==</span><span class="dv">1</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A data.frame: 1 × 5</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">V1</th>
<th data-quarto-table-cell-role="th" scope="col">V2</th>
<th data-quarto-table-cell-role="th" scope="col">V3</th>
<th data-quarto-table-cell-role="th" scope="col">V4</th>
<th data-quarto-table-cell-role="th" scope="col">accum_time</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0.03111111</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>With <code>sample_size &lt;- 4</code>, <code>mutation_rate &lt;- 1</code>, <code>reward_limits &lt;- rep(20, sample_size-1)</code>, and <code>tot_reward_limit &lt;- Inf</code>, tothe marginal probabilities match the SFS:</p>
<pre><code>c(sum(joint_probs$V1 * joint_probs$accum_time), 
  sum(joint_probs$V2 * joint_probs$accum_time), 
  sum(joint_probs$V3 * joint_probs$accum_time))</code></pre>
<pre><code>1.99981743759578 0.998152771395828 0.666638375487117</code></pre>
<p>and the joint prob of a singleton and a trippleton is:</p>
<pre><code>1   0   1   0.03111111</code></pre>
<p>which is exactly what we also get with <code>reward_limits &lt;- rep(1, sample_size-1)</code>.</p>
<p>Setting <code>tot_reward_limit &lt;- 2</code> also produces <code>0.03111111</code>.</p>
<div id="7920bcae-7a9f-45da-82d4-4ade2c6fb72e" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>joint_probs <span class="op">%&gt;%</span> rename_with(gsub, pattern<span class="op">=</span><span class="st">"V"</span>, replacement<span class="op">=</span><span class="st">"ton"</span>) <span class="op">%&gt;%</span> group_by(ton1, ton2) <span class="op">%&gt;%</span> summarize(prob<span class="op">=</span><span class="bu">sum</span>(accum_time), .groups<span class="op">=</span><span class="st">"keep"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A grouped_df: 4 × 3</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">ton1</th>
<th data-quarto-table-cell-role="th" scope="col">ton2</th>
<th data-quarto-table-cell-role="th" scope="col">prob</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>0.12222222</td>
</tr>
<tr class="even">
<td>0</td>
<td>1</td>
<td>0.04259259</td>
</tr>
<tr class="odd">
<td>1</td>
<td>0</td>
<td>0.12666667</td>
</tr>
<tr class="even">
<td>1</td>
<td>1</td>
<td>0.03777778</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="f54088fd-f165-46b6-bf9d-dd93f40e1120" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>plot_df <span class="op">&lt;-</span> joint_probs <span class="op">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    rename_with(gsub, pattern<span class="op">=</span><span class="st">"V"</span>, replacement<span class="op">=</span><span class="st">"ton"</span>) <span class="op">%&gt;%</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    group_by(ton1, ton2) <span class="op">%&gt;%</span> </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    summarize(prob<span class="op">=</span><span class="bu">sum</span>(accum_time), .groups<span class="op">=</span><span class="st">"keep"</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (colname <span class="kw">in</span> colnames(plot_df)) {</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (startsWith(colname, <span class="st">'ton'</span>)) {</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>        plot_df[[colname]] <span class="op">&lt;-</span> <span class="im">as</span>.factor(plot_df[[colname]])</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>ggplot(plot_df, aes(x<span class="op">=</span>ton1, y<span class="op">=</span>ton2)) <span class="op">+</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    geom_tile(aes(fill <span class="op">=</span> prob)) <span class="op">+</span> </span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    geom_text(aes(label <span class="op">=</span> <span class="bu">round</span>(prob, <span class="dv">3</span>))) <span class="op">+</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    scale_fill_viridis() <span class="op">+</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># scale_fill_distiller(palette = 'PiYG',direction = 1,</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                 limit=max(abs(plot_df$prob)) * c(-1, 1)</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                 ) +</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>     theme(panel.grid.major <span class="op">=</span> element_blank(), </span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>            panel.grid.minor <span class="op">=</span> element_blank(), </span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>            text<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">17</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-19-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="coalescent-jointprob_files/figure-html/cell-19-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="49fbab45-6e6d-49cc-93b4-33ead5c1b2cd" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># map_state &lt;- function(state) {</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co">#         lumped_state &lt;- c(sum(state[1:sample_size]), head(state, sample_size) * (reward_limits - tail(state, sample_size)))</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">#         lumped_state &lt;- as.integer(lumped_state)</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">#         return(lumped_state)</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co"># label_fun &lt;- function(state, index) {</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     return(paste(map_state(state), collapse=""))</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># if (vertices_length(graph) &lt; 30) {    </span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     new_graph &lt;- discrete_joint_prob(graph, reward_rates, return_graph=TRUE)</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     plot_graph(graph_as_matrix(new_graph), size=c(10, 10), align=TRUE, #rainbow=TRUE,</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co">#                    fontsize=26, ranksep=4, nodesep=0.9, rankdir="LR",</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co">#               subgraphs=TRUE, subgraphfun=label_fun,</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co">#               # subgraphs=TRUE, subgraphfun=function(state, index) sum(head(state, sample_size)),</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="co">#             splines='line'</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co">#               )  </span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="co"># }           </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0451910e-9280-4b08-9d34-f070329e09bc" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>graph_vec <span class="op">&lt;-</span> c()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>new_graph_vec <span class="op">&lt;-</span> c()</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>sample_sizes <span class="op">&lt;-</span> <span class="dv">4</span>:<span class="dv">15</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (sample_size <span class="kw">in</span> sample_sizes) {</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">&lt;-</span> standard_coalescent(sample_size)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    graph_vec <span class="op">&lt;-</span> c(graph_vec, vertices_length(graph))</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    reward_limits <span class="op">&lt;-</span> c(rep(<span class="dv">1</span>, sample_size<span class="op">-</span><span class="dv">1</span>), <span class="dv">0</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    tot_reward_limit <span class="op">&lt;-</span> Inf</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    new_graph <span class="op">&lt;-</span> discrete_joint_prob(graph, reward_rates, return_graph<span class="op">=</span>TRUE)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># new_graph &lt;- discrete_joint_prob(graph, reward_limits, mutation_rate, reward_possible, tot_reward_limit=tot_reward_limit, return_graph=TRUE)</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    new_graph_vec <span class="op">&lt;-</span> c(new_graph_vec, vertices_length(new_graph))</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># new_graph_vec &lt;- c(new_graph_vec, length(unique(apply(apply(states(new_graph), 1, map_state), 2, paste, collapse=""))))</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1000 1311 
1000 1443 
2000 2178 
1000 1579 
2000 2687 
3000 3185 
1000 1656 
2000 2979 
3000 3930 
4000 4451 </code></pre>
</div>
</div>
<div id="1e1ac977-b555-4cb6-b7b7-b45a94632abd" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>theme_set(theme_bw() <span class="op">+</span> theme(axis.line <span class="op">=</span> element_line(colour <span class="op">=</span> <span class="st">"black"</span>),</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                 text<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">17</span>),</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>                 axis.text <span class="op">=</span> element_text(size<span class="op">=</span><span class="dv">15</span>),</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                 plot.margin <span class="op">=</span> unit(c(<span class="fl">0.3</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>), <span class="st">"inch"</span>)))</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>palette <span class="op">&lt;-</span> c(<span class="st">"#888888"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>, <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>opt <span class="op">&lt;-</span> options(<span class="bu">repr</span>.plot.width<span class="op">=</span><span class="dv">7</span>, <span class="bu">repr</span>.plot.height<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>               ggplot2.discrete.colour<span class="op">=</span>palette, ggplot2.discrete.fill<span class="op">=</span>palette) <span class="op">;</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>despine <span class="op">&lt;-</span>  theme(panel.border <span class="op">=</span> element_blank(), </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>                 panel.grid.major <span class="op">=</span> element_blank(),</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>                 panel.grid.minor <span class="op">=</span> element_blank())</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>library(gridExtra)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>df <span class="op">&lt;-</span> data.frame(</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  samples <span class="op">=</span> sample_sizes,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  graph_states <span class="op">=</span> graph_vec,</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  new_graph_states <span class="op">=</span>new_graph_vec</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>df_long <span class="op">&lt;-</span> pivot_longer(df, c(graph_states, new_graph_states))</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>p1 <span class="op">&lt;-</span> ggplot(df_long, aes(x<span class="op">=</span>samples, y<span class="op">=</span>value, color<span class="op">=</span>name)) <span class="op">+</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    geom_line(linewidth<span class="op">=</span><span class="dv">1</span>) <span class="op">+</span> geom_point(size<span class="op">=</span><span class="dv">3</span>) <span class="op">+</span> </span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    despine <span class="op">+</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    xlim(<span class="dv">0</span>, NA) <span class="op">+</span> ylim(<span class="dv">0</span>, NA) <span class="op">+</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">"Sample size"</span>, y<span class="op">=</span><span class="st">"Vertices"</span>, color<span class="op">=</span><span class="st">"Graph"</span>) <span class="op">+</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    scale_color_discrete(labels <span class="op">=</span> c(<span class="st">"Original"</span>, <span class="st">"Augmented"</span>))</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>p2 <span class="op">&lt;-</span> ggplot(df, aes(x<span class="op">=</span>samples, y<span class="op">=</span>new_graph_vec <span class="op">/</span> graph_vec)) <span class="op">+</span> </span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    geom_line(linewidth<span class="op">=</span><span class="dv">1</span>) <span class="op">+</span> geom_point(size<span class="op">=</span><span class="dv">3</span>) <span class="op">+</span> </span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    geom_abline(slope<span class="op">=</span><span class="dv">1</span>, intercept<span class="op">=</span><span class="dv">0</span>) <span class="op">+</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geom_abline(slope=0.25, intercept=1.5) +</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    despine <span class="op">+</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    xlim(<span class="dv">0</span>, NA) <span class="op">+</span> ylim(<span class="dv">0</span>, NA) <span class="op">+</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">"Sample size"</span>, y<span class="op">=</span><span class="st">"Augmented / original vertices"</span>, color<span class="op">=</span><span class="st">"Graph"</span>)</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>opt <span class="op">&lt;-</span> options(<span class="bu">repr</span>.plot.width<span class="op">=</span><span class="dv">12</span>, <span class="bu">repr</span>.plot.height<span class="op">=</span><span class="fl">5.5</span>)</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>grid.arrange(p1, p2, nrow <span class="op">=</span> <span class="dv">1</span>, widths <span class="op">=</span> <span class="dv">3</span>:<span class="dv">2</span>)</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>options(opt) <span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-22-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="coalescent-jointprob_files/figure-html/cell-22-output-1.png" width="720" height="330" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="e72d9b43-6d4e-405c-b820-212fbb9bdb40" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># nr_states_vec &lt;- c()</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># nr_lumped_states_vec &lt;- c()</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># sample_sizes &lt;- 4:10</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for (sample_size in sample_sizes) {</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     graph &lt;- standard_coalescent(sample_size)</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     state_length &lt;- length(vertex_at(graph, 1)$state)</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     # last state index is absorbing where no rewards can be earned</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     reward_limits &lt;- c(rep(1, state_length-1), 0)    </span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     new_graph &lt;- discrete_joint_prob(graph, reward_rates, return_graph=TRUE)</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     # new_graph &lt;- discrete_joint_prob(graph, reward_limits, mutation_rate, reward_possible, return_graph=TRUE)</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     nr_states_vec &lt;- c(nr_states_vec, vertices_length(new_graph))</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     nr_lumped_states_vec &lt;- c(nr_lumped_states_vec, length(unique(apply(apply(states(new_graph), 1, map_state), 2, paste, collapse=""))))</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co"># df &lt;- data.frame(</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   samples = sample_sizes,</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   nr_states = nr_states_vec,</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   nr_lumped_states =nr_lumped_states_vec</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co"># df_long &lt;- pivot_longer(df, c(nr_states, nr_lumped_states))</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(df_long, aes(x=samples, y=value, hue=name)) + geom_line() + geom_point()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="two-locus-arg" class="level2">
<h2 class="anchored" data-anchor-id="two-locus-arg">Two-locus ARG</h2>
<div id="40264356-a7d3-4cb8-8239-a2a2628fa771" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>Rcpp::sourceCpp(<span class="st">"./cpp/index_prop_mapping.cpp"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>two_locus_arg <span class="op">&lt;-</span> function(s, N, R) {</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># state vector length</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    n <span class="op">&lt;-</span> (s<span class="op">+</span><span class="dv">1</span>)<span class="op">**</span><span class="dv">2</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">&lt;-</span> create_graph(n)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    index <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># first_vertex &lt;- create_vertex(graph, c(rep(0, s+2), s, rep(0, n-s-3))) # assumes that p=2</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    state <span class="op">&lt;-</span> rep(<span class="dv">0</span>, n)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    state[props_to_index_two_locus(s, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)] <span class="op">&lt;-</span> s</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    first_vertex <span class="op">&lt;-</span> find_or_create_vertex(graph, state) <span class="co"># assumes that p=2</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    add_edge(starting_vertex(graph), first_vertex, <span class="dv">1</span>)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    index <span class="op">&lt;-</span> <span class="dv">2</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (index <span class="op">&lt;=</span> vertices_length(graph)) {</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>      vertex <span class="op">&lt;-</span> vertex_at(graph, index)</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>      state <span class="op">&lt;-</span> vertex$state</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>      count <span class="op">&lt;-</span> <span class="dv">0</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:n) {</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>          count <span class="op">&lt;-</span> count <span class="op">+</span> state[i]</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (count <span class="op">&lt;=</span> <span class="dv">1</span>) {</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Only one lineage, stop</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>          index <span class="op">&lt;-</span> index <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>          <span class="bu">next</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>      }    </span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:n) {</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (state[i] <span class="op">==</span> <span class="dv">0</span>) <span class="bu">next</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>        conf_i <span class="op">&lt;-</span> index_to_props_two_locus(s, i)</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># coalescence #########################</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="kw">in</span> i:n) {</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (state[j] <span class="op">==</span> <span class="dv">0</span>) <span class="bu">next</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>          conf_j <span class="op">&lt;-</span> index_to_props_two_locus(s, j)</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (i <span class="op">==</span> j) {</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (state[i] <span class="op">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>              <span class="bu">next</span><span class="op">;</span></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>            rate <span class="op">&lt;-</span> state[i] <span class="op">*</span> (state[i] <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> <span class="dv">2</span> <span class="op">/</span> N</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (state[i] <span class="op">&lt;</span> <span class="dv">1</span> <span class="op">||</span> state[j] <span class="op">&lt;</span> <span class="dv">1</span>) {</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>              <span class="bu">next</span><span class="op">;</span></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>            rate <span class="op">&lt;-</span> state[i] <span class="op">*</span> state[j] <span class="op">/</span> N</span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>          child_state <span class="op">&lt;-</span> state</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>          <span class="co"># lineages with index i and j coalesce:  </span></span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>          child_state[i] <span class="op">&lt;-</span> child_state[i] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>          child_state[j] <span class="op">&lt;-</span> child_state[j] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>          stopifnot(conf_i$descendants_l1<span class="op">+</span>conf_j$descendants_l1 <span class="op">&lt;=</span> s)</span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>          stopifnot(conf_i$descendants_l2<span class="op">+</span>conf_j$descendants_l2 <span class="op">&lt;=</span> s)</span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>          <span class="co"># coalescene into lineage with index k</span></span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>          k <span class="op">=</span> props_to_index_two_locus(s, conf_i$descendants_l1<span class="op">+</span>conf_j$descendants_l1, conf_i$descendants_l2<span class="op">+</span>conf_j$descendants_l2)</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>          child_state[k] <span class="op">&lt;-</span> child_state[k] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>          child_vertex <span class="op">&lt;-</span> find_or_create_vertex(graph, child_state)</span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>          add_edge(vertex, child_vertex, rate)</span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># recombination #######################</span></span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (state[i] <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> conf_i$descendants_l1 <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> conf_i$descendants_l2 <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>          <span class="co"># </span><span class="al">TODO</span><span class="co">: make sure this should not be R * state[i]</span></span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a>          rate <span class="op">&lt;-</span> R <span class="co">#* state[i] </span></span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>          child_state <span class="op">&lt;-</span> state</span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>          <span class="co"># a lineage with index i recombines to produce lineages with index k and l</span></span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>          k <span class="op">=</span> props_to_index_two_locus(s, conf_i$descendants_l1, <span class="dv">0</span>)</span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>          l <span class="op">=</span> props_to_index_two_locus(s, <span class="dv">0</span>, conf_i$descendants_l2)</span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>          child_state[i] <span class="op">&lt;-</span> child_state[i] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>          child_state[k] <span class="op">&lt;-</span> child_state[k] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>          child_state[l] <span class="op">&lt;-</span> child_state[l] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a>          child_vertex <span class="op">&lt;-</span> find_or_create_vertex(graph, child_state)</span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a>          add_edge(vertex, child_vertex, rate)</span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a>      index <span class="op">&lt;-</span> index <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if ((index %% 50) == 0) {</span></span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   cat(index, vertices_length(graph), "\n")</span></span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a>      <span class="co"># }</span></span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(graph)</span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="10102372-d9ce-41fb-a4a9-593cd0904309" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>arg_reward_rates <span class="op">&lt;-</span> function(new_state, current_rewards, mutation_rate, reward_limit, locus_ton_reward_limit)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>{    </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    reward_limits <span class="op">&lt;-</span> c(rep(reward_limit, length(new_state)<span class="op">-</span><span class="dv">1</span>), <span class="dv">0</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    reward_limits <span class="op">&lt;-</span> c(reward_limits, reward_limits) <span class="co"># duplicate to account for separate mutations at each locus</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    reward_dims <span class="op">&lt;-</span> length(reward_limits)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">is</span>.null(current_rewards))</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        current_rewards <span class="op">&lt;-</span> rep(<span class="dv">0</span>, reward_dims)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co"># allowed_l1 &lt;- sapply(1:(reward_dims %/% 2), function(i) index_to_props_two_locus(sample_size, i)$descendants_l1 &gt; 0)</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co"># allowed_l2 &lt;- sapply((reward_dims %/% 2 + 1):reward_dims, function(i) index_to_props_two_locus(sample_size, i)$descendants_l2 &gt; 0)                   </span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co"># allowed_mask &lt;- as.integer(c(allowed_l1, allowed_l2))</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    result <span class="op">&lt;-</span> rep(<span class="dv">0</span>, reward_dims)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    trash_rate <span class="op">&lt;-</span> <span class="dv">0</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:reward_dims) {</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        rate <span class="op">&lt;-</span> new_state[(i<span class="op">-</span><span class="dv">1</span>) <span class="op">%%</span> (reward_dims <span class="op">%/%</span> <span class="dv">2</span>) <span class="op">+</span> <span class="dv">1</span>] <span class="op">*</span> mutation_rate <span class="co"># fancy index to map state index to duplicted reward index</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        r <span class="op">&lt;-</span> rep(<span class="dv">0</span>, reward_dims)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        r[i] <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        proposed_rewards <span class="op">&lt;-</span> current_rewards <span class="op">+</span> r</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ( <span class="bu">all</span>(proposed_rewards <span class="op">&lt;=</span> reward_limits) <span class="op">&amp;&amp;</span> </span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>            <span class="bu">sum</span>(head(proposed_rewards, reward_dims <span class="op">%/%</span> <span class="dv">2</span>)) <span class="op">&lt;=</span> locus_ton_reward_limit <span class="op">&amp;&amp;</span> </span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">sum</span>(tail(proposed_rewards, reward_dims <span class="op">%/%</span> <span class="dv">2</span>)) <span class="op">&lt;=</span> locus_ton_reward_limit ) {</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>            result[i] <span class="op">&lt;-</span> rate</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>            trash_rate <span class="op">&lt;-</span> trash_rate <span class="op">+</span> rate</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    }     </span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(c(result, trash_rate))</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>sample_size <span class="op">&lt;-</span> <span class="dv">4</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>graph <span class="op">&lt;-</span> two_locus_arg(sample_size, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>vertices_length(graph)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
110
</div>
</div>
<div id="2beabc99-62a2-43bc-a02f-b1c2b8864de4" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>reward_rates <span class="op">&lt;-</span> partial(arg_reward_rates, mutation_rate<span class="op">=</span><span class="dv">1</span>, reward_limit<span class="op">=</span><span class="dv">1</span>, locus_ton_reward_limit<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>start <span class="op">&lt;-</span> proc.time()[<span class="dv">3</span>]</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>joint_probs <span class="op">&lt;-</span> discrete_joint_prob(graph, reward_rates)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>proc.time()[<span class="dv">3</span>] <span class="op">-</span> start</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>tail(joint_probs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1000 3020 
2000 4887 
3000 6721 
4000 8038 
5000 9302 
6000 10563 
7000 11123 
8000 11872 
9000 12493 
10000 13150 
11000 13551 
12000 13976 
13000 14322 
14000 14526 
[1]   110.0000 14593.0000   132.6636</code></pre>
</div>
<div class="cell-output cell-output-display">
<strong>elapsed:</strong> 32.5500000000001
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 51</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">V1</th>
<th data-quarto-table-cell-role="th" scope="col">V2</th>
<th data-quarto-table-cell-role="th" scope="col">V3</th>
<th data-quarto-table-cell-role="th" scope="col">V4</th>
<th data-quarto-table-cell-role="th" scope="col">V5</th>
<th data-quarto-table-cell-role="th" scope="col">V6</th>
<th data-quarto-table-cell-role="th" scope="col">V7</th>
<th data-quarto-table-cell-role="th" scope="col">V8</th>
<th data-quarto-table-cell-role="th" scope="col">V9</th>
<th data-quarto-table-cell-role="th" scope="col">V10</th>
<th data-quarto-table-cell-role="th" scope="col">⋯</th>
<th data-quarto-table-cell-role="th" scope="col">V42</th>
<th data-quarto-table-cell-role="th" scope="col">V43</th>
<th data-quarto-table-cell-role="th" scope="col">V44</th>
<th data-quarto-table-cell-role="th" scope="col">V45</th>
<th data-quarto-table-cell-role="th" scope="col">V46</th>
<th data-quarto-table-cell-role="th" scope="col">V47</th>
<th data-quarto-table-cell-role="th" scope="col">V48</th>
<th data-quarto-table-cell-role="th" scope="col">V49</th>
<th data-quarto-table-cell-role="th" scope="col">V50</th>
<th data-quarto-table-cell-role="th" scope="col">accum_time</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">⋯</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">539</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>5.350590e-08</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">540</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1.670565e-07</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">541</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>5.778167e-09</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">542</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>5.778167e-09</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">543</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>5.778167e-09</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">544</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>5.778167e-09</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="c65ff819-c145-4a3a-ad18-52dee15d22fd" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># sample_size &lt;- 3</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"># graph &lt;- two_locus_arg(sample_size, 1, 1)</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # plot_graph(graph_as_matrix(graph), size=c(10, 10), align=TRUE, rainbow=TRUE,</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co"># #                fontsize=16, ranksep=2, nodesep=0.5,</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co"># #           subgraphs=TRUE,         </span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co"># #            subgraphfun=function(state, index) paste(state[1:sample_size], collapse=""))  </span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="co"># state_length &lt;- length(vertex_at(graph, 1)$state)</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co"># reward_limits &lt;- list()</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="co"># for (i in 1:state_length) {</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     prop_i &lt;- index_to_props_two_locus(sample_size, i)</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (prop_i$descendants_l1 == sample_size &amp;&amp; prop_i$descendants_l2 == sample_size) {</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="co">#         # absorbing state has no reward</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="co">#         next</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (prop_i$descendants_l1 &gt; 0 &amp;&amp; prop_i$descendants_l2 &gt; 0) {</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="co">#         r &lt;- rep(0, state_length)</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="co">#         r[i] &lt;- 1</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="co">#         # cat(prop_i$descendants_l1, " ", prop_i$descendants_l2, " ", r, "\n")</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a><span class="co">#         reward_limits &lt;- c(reward_limits,  list(r))</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="co">#         next</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     for (j in i:state_length) {</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="co">#         prop_j &lt;- index_to_props_two_locus(sample_size, j)</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (prop_j$descendants_l1 &gt; 0 &amp;&amp; prop_j$descendants_l2 &gt; 0) {</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a><span class="co">#             next</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a><span class="co">#         }        </span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a><span class="co">#         r &lt;- rep(0, state_length)</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a><span class="co">#         if ((prop_i$descendants_l1 &gt; 0 &amp;&amp; prop_j$descendants_l2 &gt; 0) || (prop_j$descendants_l1 &gt; 0 &amp;&amp; prop_i$descendants_l2 &gt; 0)) {</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a><span class="co">#             r[i] &lt;- 1</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a><span class="co">#             r[j] &lt;- 1</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a><span class="co">#             reward_limits &lt;- c(reward_limits, list(r))</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a><span class="co">#             # cat(prop_i$descendants_l1, " ", prop_i$descendants_l2, " ", prop_j$descendants_l1, " ", prop_j$descendants_l2, " ", r, "\n")            </span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a><span class="co"># tot_reward_limit &lt;- Inf</span></span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a><span class="co"># mutation_rate &lt;- 1</span></span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a><span class="co"># reward_possible &lt;- function(state, rewards) {</span></span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a><span class="co">#     max_nrs_descendants &lt;- function(state) {</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a><span class="co">#        l1 &lt;- 0</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a><span class="co">#        l2 &lt;- 0</span></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a><span class="co">#        for (i in 1:length(state)) {</span></span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a><span class="co">#            if (state[i] &gt; 0) {</span></span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a><span class="co">#                props &lt;- index_to_props_two_locus(sample_size, i) # SAMPLE SIZE SHOULD NOT BE A GLOBAL HERE...</span></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a><span class="co">#                l1 &lt;- max(c(l1, props$descendants_l1))</span></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a><span class="co">#                l2 &lt;- max(c(l2, props$descendants_l2))</span></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a><span class="co">#            }</span></span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a><span class="co">#        return(c(l1, l2))</span></span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a><span class="co">#     return (all(max_nrs_descendants(rewards) &lt;= max_nrs_descendants(state)))</span></span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a><span class="co"># #reward_limits</span></span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a><span class="co"># #reward_limits &lt;- reward_limits[[1]]</span></span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a><span class="co"># state_length &lt;- length(vertex_at(graph, 1)$state)</span></span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a><span class="co"># # last state index is absorbing where no rewards can be earned</span></span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a><span class="co"># reward_limits &lt;- c(rep(1, state_length-1), 0)</span></span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a><span class="co"># start &lt;- proc.time()[3]</span></span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true" tabindex="-1"></a><span class="co"># joint_probs &lt;- discrete_joint_prob(graph, reward_limits, mutation_rate, reward_possible, tot_reward_limit=tot_reward_limit)</span></span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true" tabindex="-1"></a><span class="co"># proc.time()[3] - start</span></span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true" tabindex="-1"></a><span class="co"># tail(joint_probs)                                </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3d16edc5-3ce8-45a5-8109-9eef06bc7d13" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>state_length <span class="op">&lt;-</span> ncol(joint_probs) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>mat <span class="op">&lt;-</span> joint_probs <span class="op">%&gt;%</span> select(starts_with(<span class="st">'V'</span>)) <span class="op">%&gt;%</span> <span class="im">as</span>.matrix</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>fun <span class="op">&lt;-</span> function(x, marg_ton, sample_size) {</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>     <span class="bu">any</span>(sapply((<span class="dv">1</span>:state_length)[which(x<span class="op">==</span><span class="dv">1</span>)], function(i) index_to_props_two_locus(sample_size, i)$descendants_l1 <span class="op">==</span> marg_ton))</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (marg_ton <span class="kw">in</span> <span class="dv">1</span>:sample_size) {               </span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">&lt;-</span> <span class="bu">apply</span>(mat, <span class="dv">1</span>, fun, marg_ton<span class="op">=</span>marg_ton, sample_size<span class="op">=</span>sample_size)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>( <span class="bu">sum</span>(joint_probs$accum_time[mask]) )</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.04359551
[1] 0.018509
[1] 0.009337695
[1] 0.00101796</code></pre>
</div>
</div>
<div id="a4cd2852-56da-45ae-aab2-d14f593a5b19" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>fun <span class="op">&lt;-</span> function(name, sample_size) {</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>     f <span class="op">&lt;-</span> function(name, sample_size) {</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="op">!</span>startsWith(name, <span class="st">"V"</span>))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span>(name)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">&lt;-</span> <span class="im">as</span>.integer(gsub(<span class="st">'V'</span>, <span class="st">''</span>, name))</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>        props <span class="op">&lt;-</span> index_to_props_two_locus(sample_size, idx)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># new_name &lt;- paste(c("(", props$descendants_l1, ", ", props$descendants_l2, ")"), collapse="")</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>        new_name <span class="op">&lt;-</span> paste(c(<span class="st">"ton"</span>, props$descendants_l1, <span class="st">"x"</span>, props$descendants_l2, <span class="st">"_"</span>, props$population, props$population), collapse<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span>(new_name)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    sapply(name, f, sample_size<span class="op">=</span>sample_size)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>}    </span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>df <span class="op">&lt;-</span> joint_probs <span class="op">%&gt;%</span> </span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rename_with(gsub, pattern="V", replacement="ton") %&gt;% </span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    rename_with(fun, sample_size<span class="op">=</span>sample_size)</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>head(df)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>tonnames <span class="op">&lt;-</span> df <span class="op">%&gt;%</span> select(<span class="op">!</span>accum_time) <span class="op">%&gt;%</span> names() <span class="op">%&gt;%</span> str_extract(<span class="st">"^ton[:digit:]x[:digit:]"</span>) <span class="op">%&gt;%</span> unique()</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>l <span class="op">&lt;-</span> <span class="bu">map</span>(tonnames, function (n) rowSums(select(df, ends_with(n))))</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>plot_df <span class="op">&lt;-</span> <span class="im">as</span>.data.frame(do.call(cbind, l))</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>colnames(plot_df) <span class="op">&lt;-</span> tonnames</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>plot_df[<span class="st">'accum_time'</span>] <span class="op">&lt;-</span> df[<span class="st">'accum_time'</span>]</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>head(plot_df)         </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 51</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">ton0x0_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x0_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x0_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x0_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x0_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton0x1_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x1_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x1_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x1_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x1_11</th>
<th data-quarto-table-cell-role="th" scope="col">⋯</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x3_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x3_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x3_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x3_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton0x4_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x4_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x4_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x4_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x4_22</th>
<th data-quarto-table-cell-role="th" scope="col">accum_time</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">⋯</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.020014967</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.004216329</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.004216329</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">4</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.011198623</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.001859383</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">6</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.011198623</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 26</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">ton0x0</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x0</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x0</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x0</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x0</th>
<th data-quarto-table-cell-role="th" scope="col">ton0x1</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x1</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x1</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x1</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x1</th>
<th data-quarto-table-cell-role="th" scope="col">⋯</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x3</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x3</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x3</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x3</th>
<th data-quarto-table-cell-role="th" scope="col">ton0x4</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x4</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x4</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x4</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x4</th>
<th data-quarto-table-cell-role="th" scope="col">accum_time</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">⋯</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.020014967</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.004216329</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.004216329</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">4</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.011198623</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.001859383</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">6</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.011198623</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="8f2ee2f8-7caa-4654-97c5-6295571a62d9" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_df &lt;- joint_probs %&gt;% </span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     # rename_with(gsub, pattern="V", replacement="ton") %&gt;% </span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     rename_with(fun, sample_size=sample_size) %&gt;%</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     group_by(ton0x1, ton1x0) %&gt;% </span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     summarize(prob=sum(accum_time), .groups="keep")</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># for (colname in colnames(plot_df)) {</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     # if (startsWith(colname, 'ton')) {</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (colname != 'prob') {</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co">#         plot_df[[colname]] &lt;- as.factor(plot_df[[colname]])</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_df</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fe590e73-841c-405a-bec7-8cc66a1b1d42" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>ggplot(plot_df, aes(x<span class="op">=</span>ton0x1, y<span class="op">=</span>ton1x0)) <span class="op">+</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    geom_tile(aes(fill <span class="op">=</span> accum_time)) <span class="op">+</span> </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    geom_text(aes(label <span class="op">=</span> <span class="bu">round</span>(accum_time, <span class="dv">3</span>))) <span class="op">+</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    scale_fill_viridis() <span class="op">+</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># scale_fill_distiller(palette = 'PiYG',direction = 1,</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                 limit=max(abs(plot_df$prob)) * c(-1, 1)</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                 ) +</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>     theme(panel.grid.major <span class="op">=</span> element_blank(), </span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>            panel.grid.minor <span class="op">=</span> element_blank(), </span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>            text<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">17</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-33-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="coalescent-jointprob_files/figure-html/cell-33-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="085018aa-4437-44a2-918f-c56bcba1e7e6" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>get_exp_mat <span class="op">&lt;-</span> function(graph, rewards, s) </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    exp_mat <span class="op">&lt;-</span> matrix(nrow<span class="op">=</span>s<span class="op">+</span><span class="dv">1</span>,ncol<span class="op">=</span>s<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">0</span>:s) {</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="kw">in</span> <span class="dv">0</span>:s) {</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        exp_mat[i<span class="op">+</span><span class="dv">1</span>,j<span class="op">+</span><span class="dv">1</span>] <span class="op">&lt;-</span> expectation(graph, rewards[props_to_index_two_locus(s, i, j), ])</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(exp_mat)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>plot_exp_mat <span class="op">&lt;-</span> function(exp_mat, title<span class="op">=</span><span class="st">"Expectations"</span>) </span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>{  </span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    df <span class="op">&lt;-</span> <span class="im">as</span>.data.frame(exp_mat) <span class="co">#%&gt;% gather()</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    df <span class="op">&lt;-</span> df <span class="op">%&gt;%</span> rownames_to_column(<span class="st">'ton1'</span>) <span class="op">%&gt;%</span> gather(<span class="st">'ton2'</span>, <span class="st">'value'</span>, <span class="op">-</span>c(ton1))</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    limit <span class="op">&lt;-</span> <span class="bu">max</span>(<span class="bu">abs</span>(df$value)) <span class="op">*</span> c(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    ggplot(df, aes(ton1, ton2)) <span class="op">+</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>        geom_tile(aes(fill <span class="op">=</span> value)) <span class="op">+</span> </span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>        geom_text(aes(label <span class="op">=</span> <span class="bu">round</span>(value, <span class="dv">2</span>)), size<span class="op">=</span><span class="dv">5</span>) <span class="op">+</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>        ggtitle(title) <span class="op">+</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    scale_x_discrete(labels<span class="op">=</span> seq(<span class="dv">0</span>, nrow(exp_mat))) <span class="op">+</span> </span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    scale_y_discrete(labels<span class="op">=</span> seq(<span class="dv">0</span>, nrow(exp_mat))) <span class="op">+</span> </span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    scale_fill_distiller(palette <span class="op">=</span> <span class="st">'PiYG'</span>,direction <span class="op">=</span> <span class="dv">1</span>, limit<span class="op">=</span>limit) <span class="op">+</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>     theme(panel.grid.major <span class="op">=</span> element_blank(), </span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>            panel.grid.minor <span class="op">=</span> element_blank(), </span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>            text<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">17</span>))</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>exp_mat <span class="op">&lt;-</span> get_exp_mat(graph, reward_matrix, sample_size)</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>new_exp_mat <span class="op">&lt;-</span> get_exp_mat(new_graph, rbind(<span class="dv">0</span>, new_reward_matrix, <span class="dv">0</span>), sample_size)</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>options(<span class="bu">repr</span>.plot.width <span class="op">=</span> <span class="dv">20</span>, <span class="bu">repr</span>.plot.height <span class="op">=</span> <span class="dv">5</span>, <span class="bu">repr</span>.plot.res <span class="op">=</span> <span class="dv">100</span>)</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>p1 <span class="op">&lt;-</span> plot_exp_mat(exp_mat, <span class="st">"Original graph"</span>)    </span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>p2 <span class="op">&lt;-</span> plot_exp_mat(new_exp_mat, <span class="st">"Lumped graph"</span>)    </span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>p3 <span class="op">&lt;-</span> plot_exp_mat(exp_mat <span class="op">-</span> new_exp_mat, <span class="st">"Absolute difference"</span>)    </span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>rel_diff <span class="op">&lt;-</span> (exp_mat <span class="op">-</span> new_exp_mat)<span class="op">/</span>exp_mat</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>rel_diff[<span class="kw">is</span>.na(rel_diff)] <span class="op">&lt;-</span> <span class="dv">0</span></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>p4 <span class="op">&lt;-</span> plot_exp_mat(rel_diff, <span class="st">"Relative difference"</span>)    </span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>grid.arrange(p1, p2, p3, p4, nrow <span class="op">=</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>ERROR: Error in eval(expr, envir, enclos): objekt 'reward_matrix' blev ikke fundet

Error in eval(expr, envir, enclos): objekt 'reward_matrix' blev ikke fundet
Traceback:

1. get_exp_mat(graph, reward_matrix, sample_size)
2. expectation(graph, rewards[props_to_index_two_locus(s, i, j), 
 .     ])   # at line 6 of file &lt;text&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="base-n-approach" class="level1">
<h1>Base-n approach</h1>
<section id="state-space-for-joint-proability-computation" class="level2">
<h2 class="anchored" data-anchor-id="state-space-for-joint-proability-computation">State space for joint proability computation</h2>
<p>Generate coalescent state space like normal with the following modifications</p>
<ul>
<li>Change state space from (4, 0, 0, 0) to (4, 0, 0, 0, t1, t2, t3, t4). The last extra “ton” states keep track of the number accumulated mutations of each kind. We simply double the state vector so we keep track of the counts lineages with descendants, but also the counts of mutations happened on such lineages.</li>
<li>Each state can mutate to accumulate a “ton” in accordance with its state vector. E.g., a <code>(4, 0, 0, 0, 0, 0, 0, 0)</code> state can only make singletons, a <code>(2, 1, 0, 0, 0, 0, 0, 0)</code> state can only make singletons and doubletons.</li>
<li>A mutation event is a transition to a siter state E.g., <code>(4, 0, 0, 0, 0, 0, 0, 0) -&gt; (4, 0, 0, 0, 1, 0, 0, 0)</code></li>
<li>The ton counts have a maximum value (base-1). If this value is reached, the mutation transition instead leads to a trash state with an infinite self loop. The transitions to trash represents the part of the deficient PDF not covered because we only run up to a max nr of tons.</li>
</ul>
</section>
<section id="reward-transform" class="level2">
<h2 class="anchored" data-anchor-id="reward-transform">Reward transform</h2>
<ul>
<li>Convert the last half of each state (with ton counts) to numbers in some base.</li>
<li>Use these for reward transformation.</li>
<li>Compute PDF for t &lt;- 1:sample_size^(base-1)</li>
<li>Convert each time t back to the corresponding ton vector and associate it with the probability</li>
<li>group by two tons and sum probs in groups to get all pairwise combinations for a joint probability matrix.</li>
</ul>
</section>
<section id="figure-out-why-you-get-nas-in-multi_rewards-with-max_tons---1" class="level2">
<h2 class="anchored" data-anchor-id="figure-out-why-you-get-nas-in-multi_rewards-with-max_tons---1">Figure out why you get NAs in multi_rewards with max_tons &lt;- 1</h2>
<div id="57964fd0-735e-4a8c-9e3c-765483320541" class="cell" data-jupyter="{&quot;source_hidden&quot;:true}" data-execution_count="43">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># joint_prob_coalescent &lt;- function(n, mutation_rate, max_tons, total_tons=Inf) {</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     state_vector_length &lt;- n + n + 1</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     graph &lt;- create_graph(state_vector_length)</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     starting_vertex &lt;- vertex_at(graph, 1)</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     initial_state &lt;- c(rep(0, n), 0)</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     initial_state[1] &lt;- n</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     add_edge(</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="co">#       starting_vertex,</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="co">#       create_vertex(graph, initial_state),</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="co">#       1</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     index &lt;- 2</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     while (index &lt;= vertices_length(graph)) {</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="co">#       vertex &lt;- vertex_at(graph, index)</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a><span class="co">#       # skip if we only have one lineage left or if this is a trash state</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a><span class="co">#       if (sum(vertex$state[1:n]) &lt;= 1) {</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a><span class="co">#         index &lt;- index + 1</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a><span class="co">#         next</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="co">#       }</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a><span class="co">#       # mutations</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="co">#       trash_rate &lt;- 0 </span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a><span class="co">#       for (i in 1:n)  {</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a><span class="co">#         state &lt;- vertex$state          </span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a><span class="co">#         rate &lt;- vertex$state[i] * mutation_rate</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a><span class="co">#         nr_tons &lt;- state[n+i]</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (rate &gt; 0) {</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a><span class="co">#             if (nr_tons &lt; max_tons &amp;&amp; sum(vertex$state[(n+1):(2*n)]) &lt; total_tons) {</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a><span class="co">#               child_state &lt;- state</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a><span class="co">#               mutation_vertex &lt;- create_vertex(graph, rep(0, state_vector_length))</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a><span class="co">#               add_edge(vertex, mutation_vertex, rate)</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a><span class="co">#               child_state[n+i] &lt;- child_state[i+n] + 1</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a><span class="co">#               add_edge(mutation_vertex, find_or_create_vertex(graph, child_state), 1)</span></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a><span class="co">#               # child_state[n+i] &lt;- child_state[i+n] + 1</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a><span class="co">#               # add_edge(vertex, find_or_create_vertex(graph, child_state), rate)</span></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a><span class="co">#             } else {</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a><span class="co">#               trash_rate &lt;- trash_rate + rate</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a><span class="co">#         }          </span></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a><span class="co">#       }</span></span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a><span class="co">#       if (trash_rate &gt; 0) {</span></span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a><span class="co">#         add_edge(vertex, find_or_create_vertex(graph, rep(0, state_vector_length)), trash_rate)</span></span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a><span class="co">#       }</span></span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a><span class="co">#       # loop over all classes of lineages</span></span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a><span class="co">#       for (i in 1:n) {</span></span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a><span class="co">#         for (j in i:n) {</span></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a><span class="co">#           state &lt;- vertex$state</span></span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a><span class="co">#           # if same class, there need to be at least two to coalesce</span></span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a><span class="co">#           if (i == j) {</span></span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a><span class="co">#             if (state[i] &lt; 2) {</span></span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a><span class="co">#               next;</span></span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a><span class="co">#             # coal rate</span></span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a><span class="co">#             rate &lt;- state[i] * (state[i] - 1) / 2</span></span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a><span class="co">#           } else {</span></span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a><span class="co">#             # else at least one in each class to coalesce</span></span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a><span class="co">#             if (state[i] &lt; 1 || state[j] &lt; 1) {</span></span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a><span class="co">#               next;</span></span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a><span class="co">#             # number of combinations</span></span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a><span class="co">#             rate &lt;- state[i] * state[j]</span></span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a><span class="co">#           }</span></span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a><span class="co">#           # copy state</span></span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a><span class="co">#           child_state &lt;- state</span></span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a><span class="co">#           # update child state</span></span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a><span class="co">#           child_state[i] &lt;- child_state[i] - 1</span></span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a><span class="co">#           child_state[j] &lt;- child_state[j] - 1</span></span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a><span class="co">#           child_state[i+j] &lt;- child_state[i+j] + 1</span></span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-79"><a href="#cb42-79" aria-hidden="true" tabindex="-1"></a><span class="co">#           add_edge(</span></span>
<span id="cb42-80"><a href="#cb42-80" aria-hidden="true" tabindex="-1"></a><span class="co">#               vertex,</span></span>
<span id="cb42-81"><a href="#cb42-81" aria-hidden="true" tabindex="-1"></a><span class="co">#               find_or_create_vertex(graph, child_state),</span></span>
<span id="cb42-82"><a href="#cb42-82" aria-hidden="true" tabindex="-1"></a><span class="co">#               rate</span></span>
<span id="cb42-83"><a href="#cb42-83" aria-hidden="true" tabindex="-1"></a><span class="co">#             )</span></span>
<span id="cb42-84"><a href="#cb42-84" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb42-85"><a href="#cb42-85" aria-hidden="true" tabindex="-1"></a><span class="co">#       }</span></span>
<span id="cb42-86"><a href="#cb42-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-87"><a href="#cb42-87" aria-hidden="true" tabindex="-1"></a><span class="co">#       index &lt;- index + 1</span></span>
<span id="cb42-88"><a href="#cb42-88" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb42-89"><a href="#cb42-89" aria-hidden="true" tabindex="-1"></a><span class="co">#     trash_vertex &lt;- find_or_create_vertex(graph, rep(0, state_vector_length))</span></span>
<span id="cb42-90"><a href="#cb42-90" aria-hidden="true" tabindex="-1"></a><span class="co">#     trash_loop_vertex &lt;- create_vertex(graph, rep(0, state_vector_length))</span></span>
<span id="cb42-91"><a href="#cb42-91" aria-hidden="true" tabindex="-1"></a><span class="co">#     add_edge(trash_vertex, trash_loop_vertex, 1)</span></span>
<span id="cb42-92"><a href="#cb42-92" aria-hidden="true" tabindex="-1"></a><span class="co">#     add_edge(trash_loop_vertex, trash_vertex, 1)</span></span>
<span id="cb42-93"><a href="#cb42-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-94"><a href="#cb42-94" aria-hidden="true" tabindex="-1"></a><span class="co">#     return(graph)</span></span>
<span id="cb42-95"><a href="#cb42-95" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb42-96"><a href="#cb42-96" aria-hidden="true" tabindex="-1"></a><span class="co"># # states &lt;- t(sapply(1:vertices_length(graph), function(index) vertex_at(graph, index)$state ))</span></span>
<span id="cb42-97"><a href="#cb42-97" aria-hidden="true" tabindex="-1"></a><span class="co"># # ipv &lt;- graph_as_matrix(graph)$IPV</span></span>
<span id="cb42-98"><a href="#cb42-98" aria-hidden="true" tabindex="-1"></a><span class="co"># # sim &lt;- graph_as_matrix(graph)$SIM</span></span>
<span id="cb42-99"><a href="#cb42-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-100"><a href="#cb42-100" aria-hidden="true" tabindex="-1"></a><span class="co"># # sample_size &lt;- 4</span></span>
<span id="cb42-101"><a href="#cb42-101" aria-hidden="true" tabindex="-1"></a><span class="co"># # # mutation_rate &lt;- 20000 * 31 * 5e-10 # 0.00031</span></span>
<span id="cb42-102"><a href="#cb42-102" aria-hidden="true" tabindex="-1"></a><span class="co"># # mutation_rate &lt;- 1</span></span>
<span id="cb42-103"><a href="#cb42-103" aria-hidden="true" tabindex="-1"></a><span class="co"># # max_tons &lt;- 3</span></span>
<span id="cb42-104"><a href="#cb42-104" aria-hidden="true" tabindex="-1"></a><span class="co"># # base &lt;- max_tons + 1</span></span>
<span id="cb42-105"><a href="#cb42-105" aria-hidden="true" tabindex="-1"></a><span class="co"># # # graph &lt;- joint_prob_coalescent(sample_size, mutation_rate, max_tons)</span></span>
<span id="cb42-106"><a href="#cb42-106" aria-hidden="true" tabindex="-1"></a><span class="co"># # # gam &lt;- graph_as_matrix(graph)</span></span>
<span id="cb42-107"><a href="#cb42-107" aria-hidden="true" tabindex="-1"></a><span class="co"># # # #gam</span></span>
<span id="cb42-108"><a href="#cb42-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-109"><a href="#cb42-109" aria-hidden="true" tabindex="-1"></a><span class="co"># # graph &lt;- joint_prob_coalescent(sample_size, mutation_rate, max_tons, total_tons)</span></span>
<span id="cb42-110"><a href="#cb42-110" aria-hidden="true" tabindex="-1"></a><span class="co"># # gam &lt;- graph_as_matrix(graph)</span></span>
<span id="cb42-111"><a href="#cb42-111" aria-hidden="true" tabindex="-1"></a><span class="co"># # plot_graph(gam, #subgraphs=TRUE, </span></span>
<span id="cb42-112"><a href="#cb42-112" aria-hidden="true" tabindex="-1"></a><span class="co"># #            rainbow=TRUE,</span></span>
<span id="cb42-113"><a href="#cb42-113" aria-hidden="true" tabindex="-1"></a><span class="co"># #            size=c(10, 8), </span></span>
<span id="cb42-114"><a href="#cb42-114" aria-hidden="true" tabindex="-1"></a><span class="co"># #            align=TRUE,</span></span>
<span id="cb42-115"><a href="#cb42-115" aria-hidden="true" tabindex="-1"></a><span class="co"># #            fontsize=16, ranksep=1, nodesep=0.25,          </span></span>
<span id="cb42-116"><a href="#cb42-116" aria-hidden="true" tabindex="-1"></a><span class="co"># #            # subgraphfun=function(state) paste(state[-length(state)], collapse="")</span></span>
<span id="cb42-117"><a href="#cb42-117" aria-hidden="true" tabindex="-1"></a><span class="co"># #            )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4f0ef20f-3e4a-4df9-846d-084bc8925677" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>joint_prob_coalescent <span class="op">&lt;-</span> function(n, mutation_rate, max_tons, total_tons<span class="op">=</span>Inf) {</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    stopifnot(total_tons <span class="op">==</span> Inf)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    state_vector_length <span class="op">&lt;-</span> n <span class="op">+</span> n <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">&lt;-</span> create_graph(state_vector_length)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    starting_vertex <span class="op">&lt;-</span> vertex_at(graph, <span class="dv">1</span>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    initial_state <span class="op">&lt;-</span> c(rep(<span class="dv">0</span>, n), <span class="dv">0</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    initial_state[<span class="dv">1</span>] <span class="op">&lt;-</span> n</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    add_edge(</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>      starting_vertex,</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>      create_vertex(graph, initial_state),</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    index <span class="op">&lt;-</span> <span class="dv">2</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (index <span class="op">&lt;=</span> vertices_length(graph)) {</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>      vertex <span class="op">&lt;-</span> vertex_at(graph, index)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>      <span class="co"># skip if we only have one lineage left or if this is a trash state</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="bu">sum</span>(vertex$state[<span class="dv">1</span>:n]) <span class="op">&lt;=</span> <span class="dv">1</span>) {</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>        index <span class="op">&lt;-</span> index <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">next</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>      <span class="co"># loop over all classes of lineages</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:n) {</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="kw">in</span> i:n) {</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>          state <span class="op">&lt;-</span> vertex$state</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>          <span class="co"># if same class, there need to be at least two to coalesce</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (i <span class="op">==</span> j) {</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (state[i] <span class="op">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>              <span class="bu">next</span><span class="op">;</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>            <span class="co"># coal rate</span></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>            rate <span class="op">&lt;-</span> state[i] <span class="op">*</span> (state[i] <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>            <span class="co"># else at least one in each class to coalesce</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (state[i] <span class="op">&lt;</span> <span class="dv">1</span> <span class="op">||</span> state[j] <span class="op">&lt;</span> <span class="dv">1</span>) {</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>              <span class="bu">next</span><span class="op">;</span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>            <span class="co"># number of combinations</span></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>            rate <span class="op">&lt;-</span> state[i] <span class="op">*</span> state[j]</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>          <span class="co"># copy state</span></span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>          child_state <span class="op">&lt;-</span> state</span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>          <span class="co"># update child state</span></span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>          child_state[i] <span class="op">&lt;-</span> child_state[i] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>          child_state[j] <span class="op">&lt;-</span> child_state[j] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>          child_state[i<span class="op">+</span>j] <span class="op">&lt;-</span> child_state[i<span class="op">+</span>j] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>          add_edge(</span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>              vertex,</span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>              find_or_create_vertex(graph, child_state),</span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>              rate</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mutations</span></span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>      trash_rate <span class="op">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:n)  {</span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>        rate <span class="op">&lt;-</span> vertex$state[i] <span class="op">*</span> mutation_rate</span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>        nr_tons <span class="op">&lt;-</span> child_state[n<span class="op">+</span>i]</span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (rate <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (nr_tons <span class="op">&lt;</span> max_tons <span class="op">&amp;&amp;</span> <span class="bu">sum</span>(vertex$state[(n<span class="op">+</span><span class="dv">1</span>):(<span class="dv">2</span><span class="op">*</span>n)]) <span class="op">&lt;</span> total_tons) {</span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a>              child_state <span class="op">&lt;-</span> state</span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a>              child_state[n<span class="op">+</span>i] <span class="op">&lt;-</span> child_state[i<span class="op">+</span>n] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a>              add_edge(vertex, find_or_create_vertex(graph, child_state), rate)</span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> {</span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a>              trash_rate <span class="op">&lt;-</span> trash_rate <span class="op">+</span> rate</span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (trash_rate <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a>        add_edge(vertex, find_or_create_vertex(graph, rep(<span class="dv">0</span>, state_vector_length)), trash_rate)</span>
<span id="cb43-81"><a href="#cb43-81" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb43-82"><a href="#cb43-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-83"><a href="#cb43-83" aria-hidden="true" tabindex="-1"></a>      index <span class="op">&lt;-</span> index <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb43-84"><a href="#cb43-84" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb43-85"><a href="#cb43-85" aria-hidden="true" tabindex="-1"></a>    trash_vertex <span class="op">&lt;-</span> find_or_create_vertex(graph, rep(<span class="dv">0</span>, state_vector_length))</span>
<span id="cb43-86"><a href="#cb43-86" aria-hidden="true" tabindex="-1"></a>    trash_loop_vertex <span class="op">&lt;-</span> create_vertex(graph, rep(<span class="dv">0</span>, state_vector_length))</span>
<span id="cb43-87"><a href="#cb43-87" aria-hidden="true" tabindex="-1"></a>    add_edge(trash_vertex, trash_loop_vertex, <span class="dv">1</span>)</span>
<span id="cb43-88"><a href="#cb43-88" aria-hidden="true" tabindex="-1"></a>    add_edge(trash_loop_vertex, trash_vertex, <span class="dv">1</span>)</span>
<span id="cb43-89"><a href="#cb43-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-90"><a href="#cb43-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(graph)</span>
<span id="cb43-91"><a href="#cb43-91" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fc2ff96d-666d-4b53-8802-f86279938c25" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>ndigits <span class="op">&lt;-</span> function(x){</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  y <span class="op">&lt;-</span> floor(<span class="bu">abs</span>(x))</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(y <span class="op">!=</span> <span class="dv">0</span>){</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    floor(log10(y)) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>rev_number<span class="op">=</span>function(n){</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    m<span class="op">=</span><span class="im">as</span>.integer(rev(strsplit(<span class="im">as</span>.character(n),<span class="st">""</span>)))</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (m<span class="op">==</span>rev(m)) <span class="bu">print</span>(<span class="st">"reversed number"</span>)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>forth <span class="op">&lt;-</span> function(vec, base) {</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return( as.integer( c(vec %*%  (base ^ rev(seq_along(vec)) / base)) ) )</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return( as.integer( c(vec %*%  (base ^ (seq_along(vec)) / base)) ) )</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return( c(vec %*%  (base ^ (rev(seq_along(vec))) / base)) ) </span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>( c(vec <span class="op">%*%</span>  (base <span class="op">^</span> (seq_along(vec)) <span class="op">/</span> base)) ) </span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>back <span class="op">&lt;-</span> function(x, base, state_length) {</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x &lt;- as.integer(rev(paste(x, collapse='')))</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x &lt;- floor(as.numeric(rev(paste(x, collapse=''))))</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    vec <span class="op">&lt;-</span> c()</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:state_length) {</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if (x &gt; 0) {</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>            vec <span class="op">&lt;-</span> c(x <span class="op">%%</span> (base), vec)</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>            x <span class="op">&lt;-</span> x <span class="op">%/%</span> (base)</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># }</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># while (x &gt; 0) {</span></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     vec &lt;- c(x %% (base), vec)</span></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     x &lt;- x %/% (base)</span></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># }</span></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for (i in 1:ndigits(x)) {</span></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     if (x &gt; 0) {</span></span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         vec &lt;- c(x %% (base), vec)</span></span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         x &lt;- x %/% (base)</span></span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     }</span></span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># }</span></span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>    vec <span class="op">&lt;-</span> <span class="im">as</span>.integer(vec)</span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>( rev(c(rep(<span class="dv">0</span>, state_length<span class="op">-</span>length(vec)), vec) ))</span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return( c(rep(0, state_length-length(vec)), vec) )</span></span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a><span class="co"># vec &lt;- c(1, 2, 0)</span></span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a><span class="co"># base &lt;- max(vec)+1</span></span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a><span class="co"># state_length &lt;- length(vec)</span></span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a><span class="co"># print(vec)</span></span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a><span class="co"># f &lt;- forth(vec, base)</span></span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a><span class="co"># print(f)</span></span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a><span class="co"># b &lt;- back(f, base, state_length)</span></span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a><span class="co"># print(b)</span></span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a><span class="co"># b &lt;- c(rep(0, length(vec)-length(b)), b)</span></span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a><span class="co"># print(b)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1d2b1941-b5a7-417f-8a46-3146fcc59e76" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>graph <span class="op">&lt;-</span> standard_coalescent(sample_size)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>graph_as_matrix(graph)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<dl>
    <dt>$states</dt>
        <dd>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A matrix: 4 × 4 of type dbl</caption>
<tbody>
<tr class="odd">
<td>4</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>0</td>
<td>2</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>

</dd>
    <dt>$SIM</dt>
        <dd>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A matrix: 4 × 4 of type dbl</caption>
<tbody>
<tr class="odd">
<td>-6</td>
<td>6</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>0</td>
<td>-3</td>
<td>1</td>
<td>2</td>
</tr>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>-1</td>
<td>0</td>
</tr>
<tr class="even">
<td>0</td>
<td>0</td>
<td>0</td>
<td>-1</td>
</tr>
</tbody>
</table>

</dd>
    <dt>$IPV</dt>
        <dd><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>1</li><li>0</li><li>0</li><li>0</li></ol>
</dd>
    <dt>$indices</dt>
        <dd><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>2</li><li>3</li><li>4</li><li>5</li></ol>
</dd>
</dl>
</div>
</div>
<div id="6f49ff62-0311-4847-85c9-7f9dd27021b8" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>plot_graph(graph_as_matrix(graph), size<span class="op">=</span>c(<span class="dv">10</span>, <span class="dv">8</span>), align<span class="op">=</span>TRUE, <span class="co"># rainbow=TRUE,</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>               fontsize<span class="op">=</span><span class="dv">16</span>, ranksep<span class="op">=</span><span class="dv">1</span>, nodesep<span class="op">=</span><span class="fl">0.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-39-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="coalescent-jointprob_files/figure-html/cell-39-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="82416c05-7eb3-4520-94a9-522a24c6589d" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>expectation(graph)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
1.5
</div>
</div>
<div id="1dc37e54-99dd-4d0a-a8fb-b9fb10120f27" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>rewards <span class="op">&lt;-</span> make_discrete(graph, <span class="dv">1</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>graph_as_matrix(graph)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<dl>
    <dt>$states</dt>
        <dd>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A matrix: 10 × 4 of type dbl</caption>
<tbody>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>4</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>0</td>
<td>2</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>

</dd>
    <dt>$SIM</dt>
        <dd>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A matrix: 10 × 10 of type dbl</caption>
<tbody>
<tr class="odd">
<td>-1.0</td>
<td>1</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
</tr>
<tr class="even">
<td>0.4</td>
<td>-1</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.6</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
</tr>
<tr class="odd">
<td>0.0</td>
<td>0</td>
<td>-1.0000000</td>
<td>0.0000000</td>
<td>1.0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
</tr>
<tr class="even">
<td>0.0</td>
<td>0</td>
<td>0.0000000</td>
<td>-1.0000000</td>
<td>1.0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
</tr>
<tr class="odd">
<td>0.0</td>
<td>0</td>
<td>0.1666667</td>
<td>0.3333333</td>
<td>-1.0</td>
<td>0.0000000</td>
<td>0.1666667</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.3333333</td>
</tr>
<tr class="even">
<td>0.0</td>
<td>0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0</td>
<td>-1.0000000</td>
<td>1.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
</tr>
<tr class="odd">
<td>0.0</td>
<td>0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0</td>
<td>0.6666667</td>
<td>-1.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
</tr>
<tr class="even">
<td>0.0</td>
<td>0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>-1.0000000</td>
<td>0.0000000</td>
<td>1.0000000</td>
</tr>
<tr class="odd">
<td>0.0</td>
<td>0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>-1.0000000</td>
<td>1.0000000</td>
</tr>
<tr class="even">
<td>0.0</td>
<td>0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.3333333</td>
<td>0.3333333</td>
<td>-1.0000000</td>
</tr>
</tbody>
</table>

</dd>
    <dt>$IPV</dt>
        <dd><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>0</li><li>1</li><li>0</li><li>0</li><li>0</li><li>0</li><li>0</li><li>0</li><li>0</li><li>0</li></ol>
</dd>
    <dt>$indices</dt>
        <dd><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>7</li><li>2</li><li>9</li><li>8</li><li>3</li><li>10</li><li>4</li><li>12</li><li>11</li><li>5</li></ol>
</dd>
</dl>
</div>
</div>
<div id="46158f28-d1cc-427d-afd7-9f1bb128068d" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>plot_graph(graph_as_matrix(graph), <span class="co">#rainbow=TRUE, </span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>           size<span class="op">=</span>c(<span class="dv">10</span>, <span class="dv">8</span>), <span class="co">#align=TRUE,</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>               fontsize<span class="op">=</span><span class="dv">16</span>, ranksep<span class="op">=</span><span class="dv">1</span>, nodesep<span class="op">=</span><span class="fl">0.25</span>,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>             <span class="co"># subgraph=TRUE, subgraphfun=function(state, index) as.character((index+1) %/% 2)</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-42-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="coalescent-jointprob_files/figure-html/cell-42-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="d683f31f-d798-4920-929f-d4f6ad22e424" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="bu">apply</span>(rewards[<span class="dv">1</span>:<span class="dv">3</span>,], <span class="dv">1</span>, function(x) expectation(graph, x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>2</li><li>1</li><li>0.666666666666667</li></ol>
</div>
</div>
<div id="830882cd-1edd-4db5-9b0c-91387aa4cabd" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>rev_graph <span class="op">&lt;-</span> reward_transform(graph, rewards[<span class="dv">1</span>,])</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>plot_graph(graph_as_matrix(rev_graph), <span class="co">#rainbow=TRUE, </span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>           size<span class="op">=</span>c(<span class="dv">10</span>, <span class="dv">8</span>), <span class="co">#align=TRUE,</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>               fontsize<span class="op">=</span><span class="dv">16</span>, ranksep<span class="op">=</span><span class="dv">1</span>, nodesep<span class="op">=</span><span class="fl">0.25</span>,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>             <span class="co"># subgraph=TRUE, subgraphfun=function(state, index) as.character((index+1) %/% 2)</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-44-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="coalescent-jointprob_files/figure-html/cell-44-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="d27fa354-9ee0-4311-88c8-b90f4a40c0c6" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>pdph(<span class="dv">1</span>:<span class="dv">10</span>, rev_graph)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>0.492</li><li>0.6852</li><li>0.81444</li><li>0.89442</li><li>0.9414756</li><li>0.96819828</li><li>0.982985028</li><li>0.9910075476</li><li>0.9952940586</li><li>0.997556851764</li></ol>
</div>
</div>
</section>
<section id="compute-joint-prob" class="level2">
<h2 class="anchored" data-anchor-id="compute-joint-prob">Compute joint prob</h2>
<blockquote class="blockquote">
<p><strong>Constraining the total number of mutations does not work</strong></p>
<p>The deficit is computed correctly as long as all max rewards so that all r scalar values in the CDF represents a reward combination in the MDF</p>
<p>Just like we can limit the number of each king of tons in the state space contruction, we might also limit the total number of mutations so that we, for example, can have at most one instance of two different tons (<code>total_tons=2</code>). E.g., a singleton and a tripleton.</p>
<p>However, this gives a a deficit problem I am not sure I can solve with this approach. In principle, the deficit should be taken care of, and I should just discard all joint probs for total numbers of tons larger than <code>total_tons</code> - but that does not seem to be the case…</p>
</blockquote>
<p><strong>maybe I don’t need loops if they are not selff-loops anyway. If aux-&gt;C has rate 1 then A-&gt;aux-&gt;C is the same as A-&gt;C. Below I just changed two things</strong></p>
<ol type="1">
<li>normalize the graph</li>
<li>use pdph instead of pph</li>
</ol>
<p><strong>BUT</strong> if I normalize I need to represent the residual prob as reward, which means I need to reward transform, which I cannot if I want to do everying in one go with the scalar trick.</p>
<div id="ec06ea81-05b9-46c2-8f08-37cb37421dde" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>sample_size <span class="op">&lt;-</span> <span class="dv">4</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>graph <span class="op">&lt;-</span> standard_coalescent(sample_size)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>plot_graph(graph_as_matrix(graph), size<span class="op">=</span>c(<span class="dv">10</span>, <span class="dv">8</span>), align<span class="op">=</span>TRUE, rainbow<span class="op">=</span>TRUE,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>               fontsize<span class="op">=</span><span class="dv">16</span>, ranksep<span class="op">=</span><span class="dv">1</span>, nodesep<span class="op">=</span><span class="fl">0.25</span>,</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>            subgraphs<span class="op">=</span>TRUE,         </span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>           subgraphfun<span class="op">=</span>function(state, index) paste(state[<span class="dv">1</span>:sample_size], collapse<span class="op">=</span><span class="st">""</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-46-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="coalescent-jointprob_files/figure-html/cell-46-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="99f17d1d-68c1-4911-90bb-55fd01cef866" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mutation_rate &lt;- 20000 * 31 * 5e-10 # 0.00031</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>mutation_rate <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>max_tons <span class="op">&lt;-</span> <span class="dv">20</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>total_tons <span class="op">&lt;-</span> Inf</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>base <span class="op">&lt;-</span> max_tons <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>graph <span class="op">&lt;-</span> joint_prob_coalescent(sample_size, mutation_rate, max_tons, total_tons<span class="op">=</span>total_tons)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>weights_were_multiplied_with <span class="op">&lt;-</span> normalize_graph(graph)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co"># gam &lt;- graph_as_matrix(graph)</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="co">#gam</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="93aeb425-e499-4e97-b49e-3cab56d5b3aa" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (vertices_length(graph) <span class="op">&lt;</span> <span class="dv">50</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    plot_graph(graph_as_matrix(graph), size<span class="op">=</span>c(<span class="dv">10</span>, <span class="dv">8</span>), align<span class="op">=</span>TRUE, rainbow<span class="op">=</span>TRUE,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>               fontsize<span class="op">=</span><span class="dv">16</span>, ranksep<span class="op">=</span><span class="dv">2</span>, nodesep<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>             subgraphs<span class="op">=</span>TRUE,         </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>           subgraphfun<span class="op">=</span>function(state, index) paste(state[<span class="dv">1</span>:sample_size], collapse<span class="op">=</span><span class="st">""</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get last halves of states that server as mutation rewards:</p>
<div id="bb3f7312-8d03-49e3-9d65-5b8bda45f274" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>rewards <span class="op">&lt;-</span> states(graph)[, (sample_size<span class="op">+</span><span class="dv">1</span>):(<span class="dv">2</span><span class="op">*</span>sample_size)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Turn reward vectors into scalars (with the appropriate base):</p>
<div id="8c272e26-d72b-416d-8bfd-6bbd933f016b" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>multi_rewards <span class="op">&lt;-</span> <span class="bu">apply</span>(rewards, <span class="dv">1</span>, forth, base<span class="op">=</span>base)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>multi_rewards</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>0</li><li>0</li><li>0</li><li>1</li><li>0</li><li>0</li><li>1</li><li>21</li><li>2</li><li>0</li><li>21</li><li>1</li><li>441</li><li>1</li><li>2</li><li>22</li><li>21</li><li>42</li><li>3</li><li>21</li><li>42</li><li>1</li><li>2</li><li>442</li><li>441</li><li>882</li><li>22</li><li>2</li><li>3</li><li>23</li><li>22</li><li>43</li><li>462</li><li>42</li><li>63</li><li>4</li><li>42</li><li>63</li><li>2</li><li>3</li><li>443</li><li>442</li><li>883</li><li>882</li><li>1323</li><li>22</li><li>43</li><li>23</li><li>3</li><li>4</li><li>24</li><li>23</li><li>44</li><li>463</li><li>43</li><li>64</li><li>462</li><li>903</li><li>483</li><li>63</li><li>84</li><li>5</li><li>63</li><li>84</li><li>3</li><li>4</li><li>444</li><li>443</li><li>884</li><li>883</li><li>1324</li><li>1323</li><li>1764</li><li>43</li><li>64</li><li>23</li><li>44</li><li>24</li><li>4</li><li>5</li><li>25</li><li>24</li><li>45</li><li>464</li><li>44</li><li>65</li><li>463</li><li>904</li><li>484</li><li>64</li><li>85</li><li>903</li><li>1344</li><li>483</li><li>924</li><li>504</li><li>84</li><li>105</li><li>6</li><li>84</li><li>105</li><li>4</li><li>5</li><li>445</li><li>444</li><li>885</li><li>884</li><li>1325</li><li>1324</li><li>1765</li><li>1764</li><li>2205</li><li>64</li><li>85</li><li>44</li><li>65</li><li>24</li><li>45</li><li>25</li><li>5</li><li>6</li><li>26</li><li>25</li><li>46</li><li>465</li><li>45</li><li>66</li><li>464</li><li>905</li><li>485</li><li>65</li><li>86</li><li>904</li><li>1345</li><li>484</li><li>925</li><li>505</li><li>85</li><li>106</li><li>1344</li><li>1785</li><li>924</li><li>1365</li><li>504</li><li>945</li><li>525</li><li>105</li><li>126</li><li>7</li><li>105</li><li>126</li><li>5</li><li>6</li><li>446</li><li>445</li><li>886</li><li>885</li><li>1326</li><li>1325</li><li>1766</li><li>1765</li><li>2206</li><li>2205</li><li>2646</li><li>85</li><li>106</li><li>65</li><li>86</li><li>45</li><li>66</li><li>25</li><li>46</li><li>26</li><li>6</li><li>7</li><li>27</li><li>26</li><li>47</li><li>466</li><li>46</li><li>67</li><li>465</li><li>906</li><li>486</li><li>66</li><li>87</li><li>905</li><li>1346</li><li>485</li><li>926</li><li>506</li><li>86</li><li>107</li><li>1345</li><li>1786</li><li>925</li><li>1366</li><li>505</li><li>946</li><li>526</li><li>⋯</li><li>7853</li><li>8294</li><li>7433</li><li>7874</li><li>7013</li><li>7454</li><li>6593</li><li>7034</li><li>6173</li><li>6614</li><li>9133</li><li>8713</li><li>9154</li><li>8293</li><li>8734</li><li>7873</li><li>8314</li><li>7453</li><li>7894</li><li>7033</li><li>7474</li><li>6613</li><li>7054</li><li>9153</li><li>8733</li><li>9174</li><li>8313</li><li>8754</li><li>7893</li><li>8334</li><li>7473</li><li>7914</li><li>7053</li><li>7494</li><li>9173</li><li>8753</li><li>9194</li><li>8333</li><li>8774</li><li>7913</li><li>8354</li><li>7493</li><li>7934</li><li>9193</li><li>8773</li><li>9214</li><li>8353</li><li>8794</li><li>7933</li><li>8374</li><li>9213</li><li>8793</li><li>9234</li><li>8373</li><li>8814</li><li>9233</li><li>8813</li><li>9254</li><li>9253</li><li>9134</li><li>8714</li><li>9155</li><li>8294</li><li>8735</li><li>7874</li><li>8315</li><li>7454</li><li>7895</li><li>7034</li><li>7475</li><li>6614</li><li>7055</li><li>9154</li><li>8734</li><li>9175</li><li>8314</li><li>8755</li><li>7894</li><li>8335</li><li>7474</li><li>7915</li><li>7054</li><li>7495</li><li>9174</li><li>8754</li><li>9195</li><li>8334</li><li>8775</li><li>7914</li><li>8355</li><li>7494</li><li>7935</li><li>9194</li><li>8774</li><li>9215</li><li>8354</li><li>8795</li><li>7934</li><li>8375</li><li>9214</li><li>8794</li><li>9235</li><li>8374</li><li>8815</li><li>9234</li><li>8814</li><li>9255</li><li>9254</li><li>9155</li><li>8735</li><li>9176</li><li>8315</li><li>8756</li><li>7895</li><li>8336</li><li>7475</li><li>7916</li><li>7055</li><li>7496</li><li>9175</li><li>8755</li><li>9196</li><li>8335</li><li>8776</li><li>7915</li><li>8356</li><li>7495</li><li>7936</li><li>9195</li><li>8775</li><li>9216</li><li>8355</li><li>8796</li><li>7935</li><li>8376</li><li>9215</li><li>8795</li><li>9236</li><li>8375</li><li>8816</li><li>9235</li><li>8815</li><li>9256</li><li>9255</li><li>9176</li><li>8756</li><li>9197</li><li>8336</li><li>8777</li><li>7916</li><li>8357</li><li>7496</li><li>7937</li><li>9196</li><li>8776</li><li>9217</li><li>8356</li><li>8797</li><li>7936</li><li>8377</li><li>9216</li><li>8796</li><li>9237</li><li>8376</li><li>8817</li><li>9236</li><li>8816</li><li>9257</li><li>9256</li><li>9197</li><li>8777</li><li>9218</li><li>8357</li><li>8798</li><li>7937</li><li>8378</li><li>9217</li><li>8797</li><li>9238</li><li>8377</li><li>8818</li><li>9237</li><li>8817</li><li>9258</li><li>9257</li><li>9218</li><li>8798</li><li>9239</li><li>8378</li><li>8819</li><li>9238</li><li>8818</li><li>9259</li><li>9258</li><li>9239</li><li>8819</li><li>9260</li><li>9259</li><li>9260</li><li>0</li></ol>
</div>
</div>
<p>Loop over states except starting to find trash vertices and give them a reward so they won’t dissapear in the reward transformation. They will not contribute this reward because they are dead ends:</p>
<div id="801b1b24-d944-48ca-a947-6f54e377b71c" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>trash_states <span class="op">&lt;-</span> c()</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">2</span>:vertices_length(graph)) {</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  vertex <span class="op">&lt;-</span> vertex_at(graph, i)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="bu">sum</span>(vertex$state) <span class="op">==</span> <span class="dv">0</span>) {</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    multi_rewards[i] <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    trash_states <span class="op">&lt;-</span> c(trash_states, i)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>trash_states</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>3334</li><li>19428</li></ol>
</div>
</div>
<div id="e0cc56fb-78ed-4293-8ed7-41bed9b15530" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>multi_rewards</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>0</li><li>0</li><li>0</li><li>1</li><li>0</li><li>0</li><li>1</li><li>21</li><li>2</li><li>0</li><li>21</li><li>1</li><li>441</li><li>1</li><li>2</li><li>22</li><li>21</li><li>42</li><li>3</li><li>21</li><li>42</li><li>1</li><li>2</li><li>442</li><li>441</li><li>882</li><li>22</li><li>2</li><li>3</li><li>23</li><li>22</li><li>43</li><li>462</li><li>42</li><li>63</li><li>4</li><li>42</li><li>63</li><li>2</li><li>3</li><li>443</li><li>442</li><li>883</li><li>882</li><li>1323</li><li>22</li><li>43</li><li>23</li><li>3</li><li>4</li><li>24</li><li>23</li><li>44</li><li>463</li><li>43</li><li>64</li><li>462</li><li>903</li><li>483</li><li>63</li><li>84</li><li>5</li><li>63</li><li>84</li><li>3</li><li>4</li><li>444</li><li>443</li><li>884</li><li>883</li><li>1324</li><li>1323</li><li>1764</li><li>43</li><li>64</li><li>23</li><li>44</li><li>24</li><li>4</li><li>5</li><li>25</li><li>24</li><li>45</li><li>464</li><li>44</li><li>65</li><li>463</li><li>904</li><li>484</li><li>64</li><li>85</li><li>903</li><li>1344</li><li>483</li><li>924</li><li>504</li><li>84</li><li>105</li><li>6</li><li>84</li><li>105</li><li>4</li><li>5</li><li>445</li><li>444</li><li>885</li><li>884</li><li>1325</li><li>1324</li><li>1765</li><li>1764</li><li>2205</li><li>64</li><li>85</li><li>44</li><li>65</li><li>24</li><li>45</li><li>25</li><li>5</li><li>6</li><li>26</li><li>25</li><li>46</li><li>465</li><li>45</li><li>66</li><li>464</li><li>905</li><li>485</li><li>65</li><li>86</li><li>904</li><li>1345</li><li>484</li><li>925</li><li>505</li><li>85</li><li>106</li><li>1344</li><li>1785</li><li>924</li><li>1365</li><li>504</li><li>945</li><li>525</li><li>105</li><li>126</li><li>7</li><li>105</li><li>126</li><li>5</li><li>6</li><li>446</li><li>445</li><li>886</li><li>885</li><li>1326</li><li>1325</li><li>1766</li><li>1765</li><li>2206</li><li>2205</li><li>2646</li><li>85</li><li>106</li><li>65</li><li>86</li><li>45</li><li>66</li><li>25</li><li>46</li><li>26</li><li>6</li><li>7</li><li>27</li><li>26</li><li>47</li><li>466</li><li>46</li><li>67</li><li>465</li><li>906</li><li>486</li><li>66</li><li>87</li><li>905</li><li>1346</li><li>485</li><li>926</li><li>506</li><li>86</li><li>107</li><li>1345</li><li>1786</li><li>925</li><li>1366</li><li>505</li><li>946</li><li>526</li><li>⋯</li><li>7853</li><li>8294</li><li>7433</li><li>7874</li><li>7013</li><li>7454</li><li>6593</li><li>7034</li><li>6173</li><li>6614</li><li>9133</li><li>8713</li><li>9154</li><li>8293</li><li>8734</li><li>7873</li><li>8314</li><li>7453</li><li>7894</li><li>7033</li><li>7474</li><li>6613</li><li>7054</li><li>9153</li><li>8733</li><li>9174</li><li>8313</li><li>8754</li><li>7893</li><li>8334</li><li>7473</li><li>7914</li><li>7053</li><li>7494</li><li>9173</li><li>8753</li><li>9194</li><li>8333</li><li>8774</li><li>7913</li><li>8354</li><li>7493</li><li>7934</li><li>9193</li><li>8773</li><li>9214</li><li>8353</li><li>8794</li><li>7933</li><li>8374</li><li>9213</li><li>8793</li><li>9234</li><li>8373</li><li>8814</li><li>9233</li><li>8813</li><li>9254</li><li>9253</li><li>9134</li><li>8714</li><li>9155</li><li>8294</li><li>8735</li><li>7874</li><li>8315</li><li>7454</li><li>7895</li><li>7034</li><li>7475</li><li>6614</li><li>7055</li><li>9154</li><li>8734</li><li>9175</li><li>8314</li><li>8755</li><li>7894</li><li>8335</li><li>7474</li><li>7915</li><li>7054</li><li>7495</li><li>9174</li><li>8754</li><li>9195</li><li>8334</li><li>8775</li><li>7914</li><li>8355</li><li>7494</li><li>7935</li><li>9194</li><li>8774</li><li>9215</li><li>8354</li><li>8795</li><li>7934</li><li>8375</li><li>9214</li><li>8794</li><li>9235</li><li>8374</li><li>8815</li><li>9234</li><li>8814</li><li>9255</li><li>9254</li><li>9155</li><li>8735</li><li>9176</li><li>8315</li><li>8756</li><li>7895</li><li>8336</li><li>7475</li><li>7916</li><li>7055</li><li>7496</li><li>9175</li><li>8755</li><li>9196</li><li>8335</li><li>8776</li><li>7915</li><li>8356</li><li>7495</li><li>7936</li><li>9195</li><li>8775</li><li>9216</li><li>8355</li><li>8796</li><li>7935</li><li>8376</li><li>9215</li><li>8795</li><li>9236</li><li>8375</li><li>8816</li><li>9235</li><li>8815</li><li>9256</li><li>9255</li><li>9176</li><li>8756</li><li>9197</li><li>8336</li><li>8777</li><li>7916</li><li>8357</li><li>7496</li><li>7937</li><li>9196</li><li>8776</li><li>9217</li><li>8356</li><li>8797</li><li>7936</li><li>8377</li><li>9216</li><li>8796</li><li>9237</li><li>8376</li><li>8817</li><li>9236</li><li>8816</li><li>9257</li><li>9256</li><li>9197</li><li>8777</li><li>9218</li><li>8357</li><li>8798</li><li>7937</li><li>8378</li><li>9217</li><li>8797</li><li>9238</li><li>8377</li><li>8818</li><li>9237</li><li>8817</li><li>9258</li><li>9257</li><li>9218</li><li>8798</li><li>9239</li><li>8378</li><li>8819</li><li>9238</li><li>8818</li><li>9259</li><li>9258</li><li>9239</li><li>8819</li><li>9260</li><li>9259</li><li>9260</li><li>1</li></ol>
</div>
</div>
<p>Reward transform graph using scalar rewards:</p>
<div id="ac1e6694-be7c-40fd-a763-353ab911e4c0" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>rew_graph <span class="op">&lt;-</span> reward_transform(graph, multi_rewards)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a7b5cde1-fba9-465e-b690-8c2694f62712" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (vertices_length(graph) <span class="op">&lt;</span> <span class="dv">50</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    plot_graph(graph_as_matrix(rew_graph),</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>           rainbow<span class="op">=</span>TRUE,</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>           size<span class="op">=</span>c(<span class="dv">8</span>, <span class="dv">8</span>), </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>           align<span class="op">=</span>TRUE,</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>           fontsize<span class="op">=</span><span class="dv">14</span>, ranksep<span class="op">=</span><span class="dv">1</span>, nodesep<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>           <span class="co"># subgraphs=TRUE, subgraphfun=function(state, index) as.character((index+1) %/% 2)</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>           )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compute CDF assming no mutation count exceeds <code>max_tons</code>:</p>
<div id="999ec5ff-a494-4327-9f68-5bf34b74f404" class="cell" data-scrolled="true" data-execution_count="63">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>cdf_df <span class="op">&lt;-</span> data.frame(t<span class="op">=</span>seq(<span class="dv">0</span>, base<span class="op">^</span>(sample_size<span class="op">-</span><span class="dv">1</span>) <span class="op">-</span> <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>cdf_df[<span class="st">'cdf'</span>] <span class="op">&lt;-</span> sapply(cdf_df$t, function (t) pdph(t, rew_graph))</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># cdf_df['cdf'] &lt;- sapply(cdf_df$t, function (t) pph(t, rew_graph))</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>tail(cdf_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 2</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">t</th>
<th data-quarto-table-cell-role="th" scope="col">cdf</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">9256</td>
<td>9255</td>
<td>0.9796789</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">9257</td>
<td>9256</td>
<td>0.9796824</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">9258</td>
<td>9257</td>
<td>0.9796860</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">9259</td>
<td>9258</td>
<td>0.9796896</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">9260</td>
<td>9259</td>
<td>0.9796932</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">9261</td>
<td>9260</td>
<td>0.9796968</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Convert reward scalars back into state vectors representing ton counts:</p>
<div id="d9f818e0-e545-426a-a3fe-0f8961fd6035" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">&lt;-</span> lapply(cdf_df$t, back, base<span class="op">=</span>base, state_length<span class="op">=</span>sample_size)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">&lt;-</span> do.call(rbind, x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="caa3d9cd-7b88-48ec-99f1-f80f9732e045" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># is_additional_deficit &lt;- as.integer(rowSums(m) &gt; total_tons)</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="co"># p &lt;- df$cdf</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># pdf_from_cdf &lt;- c(p[1], p[2:length(p)] - p[-length(p)])</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co"># additional_deficit &lt;- cumsum(pdf_from_cdf * is_additional_deficit)</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co"># additional_deficit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9fec6e9d-49a6-4126-b5f4-6b82a87728d0" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">&lt;-</span> cbind(cdf_df, data.frame(m))</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>tail(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 6</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">t</th>
<th data-quarto-table-cell-role="th" scope="col">cdf</th>
<th data-quarto-table-cell-role="th" scope="col">X1</th>
<th data-quarto-table-cell-role="th" scope="col">X2</th>
<th data-quarto-table-cell-role="th" scope="col">X3</th>
<th data-quarto-table-cell-role="th" scope="col">X4</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">9256</td>
<td>9255</td>
<td>0.9796789</td>
<td>15</td>
<td>20</td>
<td>20</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">9257</td>
<td>9256</td>
<td>0.9796824</td>
<td>16</td>
<td>20</td>
<td>20</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">9258</td>
<td>9257</td>
<td>0.9796860</td>
<td>17</td>
<td>20</td>
<td>20</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">9259</td>
<td>9258</td>
<td>0.9796896</td>
<td>18</td>
<td>20</td>
<td>20</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">9260</td>
<td>9259</td>
<td>0.9796932</td>
<td>19</td>
<td>20</td>
<td>20</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">9261</td>
<td>9260</td>
<td>0.9796968</td>
<td>20</td>
<td>20</td>
<td>20</td>
<td>0</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The deficit is taken care of, so you should discard all joint probs for total numbers of tons larger than <code>total_tons</code>:</p>
<div id="7a2f46c6-1b58-4e62-b80c-1e0a3fac8350" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># df &lt;- df[!is_additional_deficit, ]</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="co"># df</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="dbf1c74a-c439-453c-a576-eba749223cd1" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">%&gt;%</span> ggplot(aes(x<span class="op">=</span>t, y<span class="op">=</span>cdf)) <span class="op">+</span> </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">'scaled time'</span>, y<span class="op">=</span><span class="st">'probability'</span>) <span class="op">+</span> </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    despine <span class="op">+</span> ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-60-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="coalescent-jointprob_files/figure-html/cell-60-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Compute probability of standing in on of the trash states for each time t in our CDF. These represent the deficit of the computed CDF:</p>
<blockquote class="blockquote">
<p>Make sure the stop_probability is the discrete version of that is what we are doing</p>
</blockquote>
<div id="0fa499b3-04fd-4c08-a028-c4b01d9487da" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>trash_prob <span class="op">&lt;-</span> c()</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="kw">in</span> df$t) {</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># s &lt;- stop_probability(graph, t)</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    s <span class="op">&lt;-</span> dph_stop_probability(graph, t)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    trash_prob <span class="op">&lt;-</span> c(trash_prob, <span class="bu">sum</span>(s[trash_states]))</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'cdf_deficit'</span>] <span class="op">&lt;-</span> trash_prob</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>head(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 7</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">t</th>
<th data-quarto-table-cell-role="th" scope="col">cdf</th>
<th data-quarto-table-cell-role="th" scope="col">X1</th>
<th data-quarto-table-cell-role="th" scope="col">X2</th>
<th data-quarto-table-cell-role="th" scope="col">X3</th>
<th data-quarto-table-cell-role="th" scope="col">X4</th>
<th data-quarto-table-cell-role="th" scope="col">cdf_deficit</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">1</td>
<td>0</td>
<td>0.1000000</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">2</td>
<td>1</td>
<td>0.1233308</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">3</td>
<td>2</td>
<td>0.1614973</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">4</td>
<td>3</td>
<td>0.2117425</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">5</td>
<td>4</td>
<td>0.2303889</td>
<td>4</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">6</td>
<td>5</td>
<td>0.2476603</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>CDF deficit:</p>
<div id="1471ec49-49c1-4772-805d-72e24bb6c8da" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">%&gt;%</span> ggplot(aes(x<span class="op">=</span>t, y<span class="op">=</span>cdf_deficit)) <span class="op">+</span> </span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">'scaled time'</span>, y<span class="op">=</span><span class="st">'probability'</span>) <span class="op">+</span> </span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    despine <span class="op">+</span> ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-62-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="coalescent-jointprob_files/figure-html/cell-62-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Sanity check: adding CDF and deficit should produce a CDF that goes to 1:</p>
<div id="76270025-fc59-49ab-a135-02b77151274c" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'cdf_incl_deficit'</span>] <span class="op">&lt;-</span> df$cdf <span class="op">+</span> df$cdf_deficit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a78bc3da-717f-477e-901f-3f2e1ef35c53" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">%&gt;%</span> ggplot(aes(x<span class="op">=</span>t, y<span class="op">=</span>cdf_incl_deficit)) <span class="op">+</span> </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">'scaled time'</span>, y<span class="op">=</span><span class="st">'probability'</span>) <span class="op">+</span> </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    despine <span class="op">+</span> </span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    ylim(<span class="dv">0</span>, <span class="dv">1</span>) <span class="op">+</span> </span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    geom_hline(yintercept<span class="op">=</span><span class="dv">1</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-64-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="coalescent-jointprob_files/figure-html/cell-64-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>I.e., and a PDF that sum to one:</p>
<div id="f4ee9fa0-7e6f-468f-9101-43c1efa029fd" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">&lt;-</span> df$cdf_incl_deficit</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'pdf_from_cdf_incl_deficit'</span>] <span class="op">&lt;-</span> c(p[<span class="dv">1</span>], p[<span class="dv">2</span>:length(p)] <span class="op">-</span> p[<span class="op">-</span>length(p)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="5c46909e-c74d-4e79-9394-ac6899092f30" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">%&gt;%</span> ggplot(aes(x<span class="op">=</span>t, y<span class="op">=</span>pdf_from_cdf_incl_deficit)) <span class="op">+</span> </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">'scaled time'</span>, y<span class="op">=</span><span class="st">'probability'</span>) <span class="op">+</span> </span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    despine</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-66-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="coalescent-jointprob_files/figure-html/cell-66-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="7d72c9ff-5ec9-4289-b5e7-a15a0ada4eba" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="bu">sum</span>(df$pdf_from_cdf_incl_deficit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
0.979780061019623
</div>
</div>
<p>It <strong>almost</strong> does… Maybe a numerical issue</p>
<p>Compute PDF from the CDF (<strong>this is the one we are after</strong>):</p>
<div id="a14baebd-3d2c-4ee3-b27a-58cacaab541b" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">&lt;-</span> df$cdf</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'pdf_from_cdf'</span>] <span class="op">&lt;-</span> c(p[<span class="dv">1</span>], p[<span class="dv">2</span>:length(p)] <span class="op">-</span> p[<span class="op">-</span>length(p)])</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'prob'</span>] <span class="op">=</span> df$pdf_from_cdf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3c326fb1-4c0c-4fae-90ba-9bd4455553b9" class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">%&gt;%</span> ggplot(aes(x<span class="op">=</span>t, y<span class="op">=</span>pdf_from_cdf)) <span class="op">+</span> </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">'scaled time'</span>, y<span class="op">=</span><span class="st">'probability'</span>) <span class="op">+</span> </span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    despine</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-69-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="coalescent-jointprob_files/figure-html/cell-69-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>The reason we need to go through the CDF to get the PDF is that the PDF function in PtD computes the distribution of times when the absorbing state is reached. It this cannot take the deficit in trash_states into account. The PDF commputed directly looks like this:</p>
<blockquote class="blockquote">
<p>Make sure I ues the discrete version here if I also use the dicscrete CDF above</p>
</blockquote>
<div id="283654b8-f944-4b9d-9306-e5de3bffe524" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># df['pdf'] &lt;- sapply(df$t, function (t) dph(t, rew_graph))</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'pdf'</span>] <span class="op">&lt;-</span> sapply(df$t, function (t) ddph(t, rew_graph))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4d720eae-e9bc-464c-a78a-18afe6a2afbd" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">%&gt;%</span> ggplot(aes(x<span class="op">=</span>t, y<span class="op">=</span>pdf)) <span class="op">+</span> </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">'scaled time'</span>, y<span class="op">=</span><span class="st">'probability'</span>) <span class="op">+</span> </span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    despine </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-71-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17"><img src="coalescent-jointprob_files/figure-html/cell-71-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="when-we-do-the-discrete-version-we-dont-need-to-go-through-the-cdf-to-get-the-pdf.-we-can-just-use-the-ddph-directly" class="level2">
<h2 class="anchored" data-anchor-id="when-we-do-the-discrete-version-we-dont-need-to-go-through-the-cdf-to-get-the-pdf.-we-can-just-use-the-ddph-directly">When we do the discrete version, we don’t need to go through the CDF to get the PDF. We can just use the <code>ddph</code> directly</h2>
<div id="0694dfdc-91fc-4a49-9f03-28756eb82fbf" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'diff'</span>] <span class="op">&lt;-</span> df[<span class="st">'pdf_from_cdf'</span>] <span class="op">-</span> df[<span class="st">'pdf'</span>]</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">%&gt;%</span> ggplot(aes(x<span class="op">=</span>t, y<span class="op">=</span>diff)) <span class="op">+</span> </span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">'scaled time'</span>, y<span class="op">=</span><span class="st">'probability'</span>) <span class="op">+</span> </span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    despine </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-72-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18"><img src="coalescent-jointprob_files/figure-html/cell-72-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>The marginal expectations does not match the SFS proportions, because paths that accumulate more than <code>max_tons</code> singletons will end in the trash state and not have the opportunity to also accumulate doubletons etc. That reflects that the the joint prob of a singleton <em>and</em> a doubleton is be a subset of the singleton probability. That way the total marginal singleton prob will be roughly sfs expectation, but the total marginal doubleton prob will be much too small:</p>
<div id="1bb84df6-565f-4e56-a866-35c8f568829f" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>sfs <span class="op">&lt;-</span> c(<span class="dv">1</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>sfs <span class="op">/</span> <span class="bu">sum</span>(sfs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>0.545454545454546</li><li>0.272727272727273</li><li>0.181818181818182</li></ol>
</div>
</div>
<div id="cfda6f75-20a4-4340-aa27-33ae20428d7e" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>df[df$X1<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span> df$X2<span class="op">==</span><span class="dv">0</span> <span class="op">&amp;</span> df$X3<span class="op">==</span><span class="dv">1</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A data.frame: 1 × 13</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">t</th>
<th data-quarto-table-cell-role="th" scope="col">cdf</th>
<th data-quarto-table-cell-role="th" scope="col">X1</th>
<th data-quarto-table-cell-role="th" scope="col">X2</th>
<th data-quarto-table-cell-role="th" scope="col">X3</th>
<th data-quarto-table-cell-role="th" scope="col">X4</th>
<th data-quarto-table-cell-role="th" scope="col">cdf_deficit</th>
<th data-quarto-table-cell-role="th" scope="col">cdf_incl_deficit</th>
<th data-quarto-table-cell-role="th" scope="col">pdf_from_cdf_incl_deficit</th>
<th data-quarto-table-cell-role="th" scope="col">pdf_from_cdf</th>
<th data-quarto-table-cell-role="th" scope="col">prob</th>
<th data-quarto-table-cell-role="th" scope="col">pdf</th>
<th data-quarto-table-cell-role="th" scope="col">diff</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">443</td>
<td>442</td>
<td>0.7136648</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.7137481</td>
<td>0.0002646858</td>
<td>0.0002646858</td>
<td>0.0002646858</td>
<td>0.0002646858</td>
<td>-2.238877e-17</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="4fe560a8-3a2b-4989-a113-54f5213cca5e" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A data.frame: 9261 × 13</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">t</th>
<th data-quarto-table-cell-role="th" scope="col">cdf</th>
<th data-quarto-table-cell-role="th" scope="col">X1</th>
<th data-quarto-table-cell-role="th" scope="col">X2</th>
<th data-quarto-table-cell-role="th" scope="col">X3</th>
<th data-quarto-table-cell-role="th" scope="col">X4</th>
<th data-quarto-table-cell-role="th" scope="col">cdf_deficit</th>
<th data-quarto-table-cell-role="th" scope="col">cdf_incl_deficit</th>
<th data-quarto-table-cell-role="th" scope="col">pdf_from_cdf_incl_deficit</th>
<th data-quarto-table-cell-role="th" scope="col">pdf_from_cdf</th>
<th data-quarto-table-cell-role="th" scope="col">prob</th>
<th data-quarto-table-cell-role="th" scope="col">pdf</th>
<th data-quarto-table-cell-role="th" scope="col">diff</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.1000000</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.1000000</td>
<td>0.100000000</td>
<td>0.100000000</td>
<td>0.100000000</td>
<td>0.100000000</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.1233308</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.1233308</td>
<td>0.023330814</td>
<td>0.023330814</td>
<td>0.023330814</td>
<td>0.023330814</td>
<td>-6.938894e-18</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.1614973</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.1614973</td>
<td>0.038166529</td>
<td>0.038166529</td>
<td>0.038166529</td>
<td>0.038166529</td>
<td>-6.938894e-18</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.2117425</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.2117425</td>
<td>0.050245196</td>
<td>0.050245196</td>
<td>0.050245196</td>
<td>0.050245196</td>
<td>6.938894e-18</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.2303889</td>
<td>4</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.2303889</td>
<td>0.018646386</td>
<td>0.018646386</td>
<td>0.018646386</td>
<td>0.018646386</td>
<td>-3.469447e-18</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.2476603</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.2476603</td>
<td>0.017271404</td>
<td>0.017271404</td>
<td>0.017271404</td>
<td>0.017271404</td>
<td>-1.387779e-17</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.2629493</td>
<td>6</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.2629493</td>
<td>0.015288932</td>
<td>0.015288932</td>
<td>0.015288932</td>
<td>0.015288932</td>
<td>2.428613e-17</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.2762541</td>
<td>7</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.2762541</td>
<td>0.013304841</td>
<td>0.013304841</td>
<td>0.013304841</td>
<td>0.013304841</td>
<td>5.204170e-18</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.2878150</td>
<td>8</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.2878150</td>
<td>0.011560939</td>
<td>0.011560939</td>
<td>0.011560939</td>
<td>0.011560939</td>
<td>-1.040834e-17</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.2979278</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.2979278</td>
<td>0.010112710</td>
<td>0.010112710</td>
<td>0.010112710</td>
<td>0.010112710</td>
<td>-2.255141e-17</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.3068648</td>
<td>10</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3068648</td>
<td>0.008937019</td>
<td>0.008937019</td>
<td>0.008937019</td>
<td>0.008937019</td>
<td>-2.081668e-17</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.3148516</td>
<td>11</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3148516</td>
<td>0.007986783</td>
<td>0.007986783</td>
<td>0.007986783</td>
<td>0.007986783</td>
<td>-1.734723e-17</td>
</tr>
<tr class="odd">
<td>12</td>
<td>0.3220662</td>
<td>12</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3220662</td>
<td>0.007214610</td>
<td>0.007214610</td>
<td>0.007214610</td>
<td>0.007214610</td>
<td>-1.127570e-17</td>
</tr>
<tr class="even">
<td>13</td>
<td>0.3286470</td>
<td>13</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3286470</td>
<td>0.006580816</td>
<td>0.006580816</td>
<td>0.006580816</td>
<td>0.006580816</td>
<td>8.673617e-19</td>
</tr>
<tr class="odd">
<td>14</td>
<td>0.3347016</td>
<td>14</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3347016</td>
<td>0.006054616</td>
<td>0.006054616</td>
<td>0.006054616</td>
<td>0.006054616</td>
<td>2.428613e-17</td>
</tr>
<tr class="even">
<td>15</td>
<td>0.3403145</td>
<td>15</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3403145</td>
<td>0.005612866</td>
<td>0.005612866</td>
<td>0.005612866</td>
<td>0.005612866</td>
<td>-1.301043e-17</td>
</tr>
<tr class="odd">
<td>16</td>
<td>0.3455527</td>
<td>16</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3455527</td>
<td>0.005238284</td>
<td>0.005238284</td>
<td>0.005238284</td>
<td>0.005238284</td>
<td>-6.938894e-18</td>
</tr>
<tr class="even">
<td>17</td>
<td>0.3504706</td>
<td>17</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3504706</td>
<td>0.004917865</td>
<td>0.004917865</td>
<td>0.004917865</td>
<td>0.004917865</td>
<td>1.734723e-18</td>
</tr>
<tr class="odd">
<td>18</td>
<td>0.3551123</td>
<td>18</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3551123</td>
<td>0.004641673</td>
<td>0.004641673</td>
<td>0.004641673</td>
<td>0.004641673</td>
<td>-2.168404e-17</td>
</tr>
<tr class="even">
<td>19</td>
<td>0.3595143</td>
<td>19</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3595143</td>
<td>0.004401981</td>
<td>0.004401981</td>
<td>0.004401981</td>
<td>0.004401981</td>
<td>-6.938894e-18</td>
</tr>
<tr class="odd">
<td>20</td>
<td>0.3637069</td>
<td>20</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3637069</td>
<td>0.004192673</td>
<td>0.004192673</td>
<td>0.004192673</td>
<td>0.004192673</td>
<td>2.602085e-18</td>
</tr>
<tr class="even">
<td>21</td>
<td>0.3677158</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>4.398047e-09</td>
<td>0.3677158</td>
<td>0.004008840</td>
<td>0.004008836</td>
<td>0.004008836</td>
<td>0.004008836</td>
<td>2.602085e-18</td>
</tr>
<tr class="odd">
<td>22</td>
<td>0.3715622</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1.730539e-08</td>
<td>0.3715623</td>
<td>0.003846485</td>
<td>0.003846472</td>
<td>0.003846472</td>
<td>0.003846472</td>
<td>-1.778092e-17</td>
</tr>
<tr class="even">
<td>23</td>
<td>0.3752645</td>
<td>2</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>2.678447e-05</td>
<td>0.3752913</td>
<td>0.003729069</td>
<td>0.003702302</td>
<td>0.003702302</td>
<td>0.003702302</td>
<td>-1.301043e-17</td>
</tr>
<tr class="odd">
<td>24</td>
<td>0.3788382</td>
<td>3</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>4.942828e-05</td>
<td>0.3788876</td>
<td>0.003596256</td>
<td>0.003573612</td>
<td>0.003573612</td>
<td>0.003573612</td>
<td>-1.301043e-17</td>
</tr>
<tr class="even">
<td>25</td>
<td>0.3822963</td>
<td>4</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>6.385415e-05</td>
<td>0.3823602</td>
<td>0.003472572</td>
<td>0.003458146</td>
<td>0.003458146</td>
<td>0.003458146</td>
<td>-1.387779e-17</td>
</tr>
<tr class="odd">
<td>26</td>
<td>0.3856503</td>
<td>5</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>7.209272e-05</td>
<td>0.3857224</td>
<td>0.003362254</td>
<td>0.003354016</td>
<td>0.003354016</td>
<td>0.003354016</td>
<td>6.071532e-18</td>
</tr>
<tr class="even">
<td>27</td>
<td>0.3889100</td>
<td>6</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>7.658223e-05</td>
<td>0.3889865</td>
<td>0.003264130</td>
<td>0.003259640</td>
<td>0.003259640</td>
<td>0.003259640</td>
<td>-5.204170e-18</td>
</tr>
<tr class="odd">
<td>28</td>
<td>0.3920836</td>
<td>7</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>7.901387e-05</td>
<td>0.3921627</td>
<td>0.003176117</td>
<td>0.003173686</td>
<td>0.003173686</td>
<td>0.003173686</td>
<td>-1.040834e-17</td>
</tr>
<tr class="even">
<td>29</td>
<td>0.3951787</td>
<td>8</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>8.037496e-05</td>
<td>0.3952590</td>
<td>0.003096387</td>
<td>0.003095026</td>
<td>0.003095026</td>
<td>0.003095026</td>
<td>-2.385245e-17</td>
</tr>
<tr class="odd">
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
</tr>
<tr class="even">
<td>9231</td>
<td>0.9795925</td>
<td>12</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9796758</td>
<td>3.607475e-06</td>
<td>3.607475e-06</td>
<td>3.607475e-06</td>
<td>3.607475e-06</td>
<td>1.581919e-17</td>
</tr>
<tr class="odd">
<td>9232</td>
<td>0.9795961</td>
<td>13</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9796794</td>
<td>3.606640e-06</td>
<td>3.606640e-06</td>
<td>3.606640e-06</td>
<td>3.606640e-06</td>
<td>3.827276e-17</td>
</tr>
<tr class="even">
<td>9233</td>
<td>0.9795997</td>
<td>14</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9796830</td>
<td>3.605805e-06</td>
<td>3.605805e-06</td>
<td>3.605805e-06</td>
<td>3.605805e-06</td>
<td>-8.857000e-18</td>
</tr>
<tr class="odd">
<td>9234</td>
<td>0.9796033</td>
<td>15</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9796866</td>
<td>3.604971e-06</td>
<td>3.604971e-06</td>
<td>3.604971e-06</td>
<td>3.604971e-06</td>
<td>-3.186792e-17</td>
</tr>
<tr class="even">
<td>9235</td>
<td>0.9796069</td>
<td>16</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9796902</td>
<td>3.604136e-06</td>
<td>3.604136e-06</td>
<td>3.604136e-06</td>
<td>3.604136e-06</td>
<td>-4.810512e-17</td>
</tr>
<tr class="odd">
<td>9236</td>
<td>0.9796106</td>
<td>17</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9796938</td>
<td>3.603302e-06</td>
<td>3.603302e-06</td>
<td>3.603302e-06</td>
<td>3.603302e-06</td>
<td>3.612087e-17</td>
</tr>
<tr class="even">
<td>9237</td>
<td>0.9796142</td>
<td>18</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9796974</td>
<td>3.602468e-06</td>
<td>3.602468e-06</td>
<td>3.602468e-06</td>
<td>3.602468e-06</td>
<td>-1.868893e-17</td>
</tr>
<tr class="odd">
<td>9238</td>
<td>0.9796178</td>
<td>19</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797010</td>
<td>3.601635e-06</td>
<td>3.601635e-06</td>
<td>3.601635e-06</td>
<td>3.601635e-06</td>
<td>-7.936699e-18</td>
</tr>
<tr class="even">
<td>9239</td>
<td>0.9796214</td>
<td>20</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797046</td>
<td>3.600801e-06</td>
<td>3.600801e-06</td>
<td>3.600801e-06</td>
<td>3.600801e-06</td>
<td>5.086136e-17</td>
</tr>
<tr class="odd">
<td>9240</td>
<td>0.9796250</td>
<td>0</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797082</td>
<td>3.599968e-06</td>
<td>3.599968e-06</td>
<td>3.599968e-06</td>
<td>3.599968e-06</td>
<td>2.912480e-17</td>
</tr>
<tr class="even">
<td>9241</td>
<td>0.9796286</td>
<td>1</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797118</td>
<td>3.599135e-06</td>
<td>3.599135e-06</td>
<td>3.599135e-06</td>
<td>3.599135e-06</td>
<td>2.031481e-17</td>
</tr>
<tr class="odd">
<td>9242</td>
<td>0.9796322</td>
<td>2</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797154</td>
<td>3.598303e-06</td>
<td>3.598303e-06</td>
<td>3.598303e-06</td>
<td>3.598303e-06</td>
<td>6.763982e-18</td>
</tr>
<tr class="even">
<td>9243</td>
<td>0.9796358</td>
<td>3</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797190</td>
<td>3.597470e-06</td>
<td>3.597470e-06</td>
<td>3.597470e-06</td>
<td>3.597470e-06</td>
<td>-2.921163e-17</td>
</tr>
<tr class="odd">
<td>9244</td>
<td>0.9796393</td>
<td>4</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797226</td>
<td>3.596638e-06</td>
<td>3.596638e-06</td>
<td>3.596638e-06</td>
<td>3.596638e-06</td>
<td>5.699685e-18</td>
</tr>
<tr class="even">
<td>9245</td>
<td>0.9796429</td>
<td>5</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797262</td>
<td>3.595806e-06</td>
<td>3.595806e-06</td>
<td>3.595806e-06</td>
<td>3.595806e-06</td>
<td>-1.727397e-17</td>
</tr>
<tr class="odd">
<td>9246</td>
<td>0.9796465</td>
<td>6</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797298</td>
<td>3.594975e-06</td>
<td>3.594975e-06</td>
<td>3.594975e-06</td>
<td>3.594975e-06</td>
<td>-4.977589e-18</td>
</tr>
<tr class="even">
<td>9247</td>
<td>0.9796501</td>
<td>7</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797334</td>
<td>3.594143e-06</td>
<td>3.594143e-06</td>
<td>3.594143e-06</td>
<td>3.594143e-06</td>
<td>2.477444e-17</td>
</tr>
<tr class="odd">
<td>9248</td>
<td>0.9796537</td>
<td>8</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797370</td>
<td>3.593312e-06</td>
<td>3.593312e-06</td>
<td>3.593312e-06</td>
<td>3.593312e-06</td>
<td>5.409449e-17</td>
</tr>
<tr class="even">
<td>9249</td>
<td>0.9796573</td>
<td>9</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797406</td>
<td>3.592481e-06</td>
<td>3.592481e-06</td>
<td>3.592481e-06</td>
<td>3.592481e-06</td>
<td>-4.600659e-17</td>
</tr>
<tr class="odd">
<td>9250</td>
<td>0.9796609</td>
<td>10</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797442</td>
<td>3.591651e-06</td>
<td>3.591651e-06</td>
<td>3.591651e-06</td>
<td>3.591651e-06</td>
<td>3.956999e-17</td>
</tr>
<tr class="even">
<td>9251</td>
<td>0.9796645</td>
<td>11</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797478</td>
<td>3.590820e-06</td>
<td>3.590820e-06</td>
<td>3.590820e-06</td>
<td>3.590820e-06</td>
<td>-4.026117e-17</td>
</tr>
<tr class="odd">
<td>9252</td>
<td>0.9796681</td>
<td>12</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797514</td>
<td>3.589990e-06</td>
<td>3.589990e-06</td>
<td>3.589990e-06</td>
<td>3.589990e-06</td>
<td>2.947717e-17</td>
</tr>
<tr class="even">
<td>9253</td>
<td>0.9796717</td>
<td>13</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797550</td>
<td>3.589160e-06</td>
<td>3.589160e-06</td>
<td>3.589160e-06</td>
<td>3.589160e-06</td>
<td>8.646512e-18</td>
</tr>
<tr class="odd">
<td>9254</td>
<td>0.9796753</td>
<td>14</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797585</td>
<td>3.588330e-06</td>
<td>3.588330e-06</td>
<td>3.588330e-06</td>
<td>3.588330e-06</td>
<td>-9.917909e-18</td>
</tr>
<tr class="even">
<td>9255</td>
<td>0.9796789</td>
<td>15</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797621</td>
<td>3.587501e-06</td>
<td>3.587501e-06</td>
<td>3.587501e-06</td>
<td>3.587501e-06</td>
<td>-4.435573e-17</td>
</tr>
<tr class="odd">
<td>9256</td>
<td>0.9796824</td>
<td>16</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797657</td>
<td>3.586672e-06</td>
<td>3.586672e-06</td>
<td>3.586672e-06</td>
<td>3.586672e-06</td>
<td>-1.940129e-18</td>
</tr>
<tr class="even">
<td>9257</td>
<td>0.9796860</td>
<td>17</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797693</td>
<td>3.585843e-06</td>
<td>3.585843e-06</td>
<td>3.585843e-06</td>
<td>3.585843e-06</td>
<td>-1.196561e-17</td>
</tr>
<tr class="odd">
<td>9258</td>
<td>0.9796896</td>
<td>18</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797729</td>
<td>3.585014e-06</td>
<td>3.585014e-06</td>
<td>3.585014e-06</td>
<td>3.585014e-06</td>
<td>1.828617e-17</td>
</tr>
<tr class="even">
<td>9259</td>
<td>0.9796932</td>
<td>19</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797765</td>
<td>3.584186e-06</td>
<td>3.584186e-06</td>
<td>3.584186e-06</td>
<td>3.584186e-06</td>
<td>-4.061396e-17</td>
</tr>
<tr class="odd">
<td>9260</td>
<td>0.9796968</td>
<td>20</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797801</td>
<td>3.583358e-06</td>
<td>3.583358e-06</td>
<td>3.583358e-06</td>
<td>3.583358e-06</td>
<td>1.500222e-17</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="d3c73019-41ba-42c0-846f-f3fb83e13b63" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>c(<span class="bu">sum</span>(joint_probs$V1 <span class="op">*</span> joint_probs$accum_time), </span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">sum</span>(joint_probs$V2 <span class="op">*</span> joint_probs$accum_time), </span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">sum</span>(joint_probs$V3 <span class="op">*</span> joint_probs$accum_time))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>0</li><li>0.000961598286934138</li><li>0.00057948368296313</li></ol>
</div>
</div>
<div id="3d176e56-84f1-4659-86f8-43a7fbc8c022" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>c(<span class="bu">sum</span>(df$X1 <span class="op">*</span> df$prob), <span class="bu">sum</span>(df$X2 <span class="op">*</span> df$prob), <span class="bu">sum</span>(df$X3 <span class="op">*</span> df$prob))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>7.73112709440204</li><li>4.69424968356727</li><li>1.19250319602024</li></ol>
</div>
</div>
<div id="42d2cdcb-38ed-48b5-a9f7-d2ab28ab1e6c" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>plot_df <span class="op">&lt;-</span> df <span class="op">%&gt;%</span> group_by(X2, X3) <span class="op">%&gt;%</span> summarise(prob <span class="op">=</span> <span class="bu">sum</span>(prob))</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>plot_df[,<span class="op">-</span>ncol(plot_df)] <span class="op">&lt;-</span> lapply(plot_df[,<span class="op">-</span>ncol(plot_df)], <span class="im">as</span>.factor)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>head(plot_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'X2'. You can override using the `.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A grouped_df: 6 × 3</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">X2</th>
<th data-quarto-table-cell-role="th" scope="col">X3</th>
<th data-quarto-table-cell-role="th" scope="col">prob</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;fct&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;fct&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>0.3637069369</td>
</tr>
<tr class="even">
<td>0</td>
<td>1</td>
<td>0.0054461936</td>
</tr>
<tr class="odd">
<td>0</td>
<td>2</td>
<td>0.0026874034</td>
</tr>
<tr class="even">
<td>0</td>
<td>3</td>
<td>0.0016935722</td>
</tr>
<tr class="odd">
<td>0</td>
<td>4</td>
<td>0.0011754205</td>
</tr>
<tr class="even">
<td>0</td>
<td>5</td>
<td>0.0008663035</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="b00fd888-4a56-4a58-bbfc-ef5826c96ba7" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>ggplot(plot_df, aes(x<span class="op">=</span>X2, y<span class="op">=</span>X3)) <span class="op">+</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>    geom_tile(aes(fill <span class="op">=</span> prob)) <span class="op">+</span> </span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    geom_text(aes(label <span class="op">=</span> <span class="bu">round</span>(prob, <span class="dv">3</span>))) <span class="op">+</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    scale_fill_distiller(palette <span class="op">=</span> <span class="st">'PiYG'</span>,direction <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>                    limit<span class="op">=</span><span class="bu">max</span>(<span class="bu">abs</span>(plot_df$prob)) <span class="op">*</span> c(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>                    ) <span class="op">+</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>     theme(panel.grid.major <span class="op">=</span> element_blank(), </span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>            panel.grid.minor <span class="op">=</span> element_blank(), </span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>            text<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">17</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-79-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-19"><img src="coalescent-jointprob_files/figure-html/cell-79-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="4654714c-5a1f-429c-8fab-52f254888578" class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>ggplot(plot_df, aes(x<span class="op">=</span>X2, y<span class="op">=</span>X3)) <span class="op">+</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>    geom_tile(aes(fill <span class="op">=</span> log10(prob))) <span class="op">+</span> </span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    geom_text(aes(label <span class="op">=</span> <span class="bu">round</span>(log10(prob), <span class="dv">2</span>))) <span class="op">+</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    scale_fill_distiller(palette <span class="op">=</span> <span class="st">'PiYG'</span>,direction <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>                    limit<span class="op">=</span><span class="bu">max</span>(<span class="bu">abs</span>(log10(plot_df$prob))) <span class="op">*</span> c(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>                    ) <span class="op">+</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>theme_minimal() <span class="op">+</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a> theme(panel.grid.major <span class="op">=</span> element_blank(), </span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>        panel.grid.minor <span class="op">=</span> element_blank(), </span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>        text<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">17</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-80-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-20"><img src="coalescent-jointprob_files/figure-html/cell-80-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="5aff04ee-d895-448a-9e69-c7383aa9e013" class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_graph &lt;- function(gam, constrained=TRUE, </span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="co">#                        subgraphs=FALSE, ranksep=2, nodesep=1,</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="co">#                        subgraphfun=function(state, index) paste(state[-length(state)], collapse=""), </span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="co">#                        size=c(6, 6), fontsize=10, rankdir="LR", align=FALSE, nodecolor='white', rainbow=FALSE, penwidth=1) {</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     format_rate &lt;- function(rate) {</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         # tol = .Machine$double.eps^0.5</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a><span class="co">#         # if (min(abs(c(rate%%1, rate%%1-1))) &lt; tol) {</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (rate == round(rate)) {</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a><span class="co">#             return(rate)</span></span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a><span class="co">#         } else {</span></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a><span class="co">#             return(formatC(rate, format = "e", digits = 2))</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     random_color &lt;- function() {</span></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (rainbow) {</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a><span class="co">#             return(paste("#", paste0(sample(c(0:9, LETTERS[1:6]), 6, T), collapse = ''), sep=''))</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a><span class="co">#         } else {</span></span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a><span class="co">#             return('#000000')</span></span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a><span class="co">#     sub_graphs = list()</span></span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a><span class="co">#     state_classes = list()</span></span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (constrained) {</span></span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a><span class="co">#         constrained &lt;- 'true'</span></span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a><span class="co">#     } else {</span></span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true" tabindex="-1"></a><span class="co">#         constrained &lt;- 'false'</span></span>
<span id="cb89-33"><a href="#cb89-33" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb89-34"><a href="#cb89-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-35"><a href="#cb89-35" aria-hidden="true" tabindex="-1"></a><span class="co">#     states &lt;- c()</span></span>
<span id="cb89-36"><a href="#cb89-36" aria-hidden="true" tabindex="-1"></a><span class="co">#     for (i in 1:(nrow(gam$states))) {</span></span>
<span id="cb89-37"><a href="#cb89-37" aria-hidden="true" tabindex="-1"></a><span class="co">#         states &lt;- c(states, paste0(i, ' [label="', paste(gam$states[i,], collapse = ","), '"];'))</span></span>
<span id="cb89-38"><a href="#cb89-38" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb89-39"><a href="#cb89-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-40"><a href="#cb89-40" aria-hidden="true" tabindex="-1"></a><span class="co">#     edge_templ &lt;- '"FROM" -&gt; "TO" [constraint=true, label="LABEL",labelfloat=false,color="COLOR",fontcolor="COLOR"];'</span></span>
<span id="cb89-41"><a href="#cb89-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-42"><a href="#cb89-42" aria-hidden="true" tabindex="-1"></a><span class="co">#     subgraph_template &lt;- '</span></span>
<span id="cb89-43"><a href="#cb89-43" aria-hidden="true" tabindex="-1"></a><span class="co">#     subgraph cluster_FREQBIN {</span></span>
<span id="cb89-44"><a href="#cb89-44" aria-hidden="true" tabindex="-1"></a><span class="co">#         rank=same;</span></span>
<span id="cb89-45"><a href="#cb89-45" aria-hidden="true" tabindex="-1"></a><span class="co">#         style=filled;</span></span>
<span id="cb89-46"><a href="#cb89-46" aria-hidden="true" tabindex="-1"></a><span class="co">#         color=whitesmoke;</span></span>
<span id="cb89-47"><a href="#cb89-47" aria-hidden="true" tabindex="-1"></a><span class="co">#         node [style=filled];</span></span>
<span id="cb89-48"><a href="#cb89-48" aria-hidden="true" tabindex="-1"></a><span class="co">#         NODES;</span></span>
<span id="cb89-49"><a href="#cb89-49" aria-hidden="true" tabindex="-1"></a><span class="co">#         label = "FREQBIN";</span></span>
<span id="cb89-50"><a href="#cb89-50" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb89-51"><a href="#cb89-51" aria-hidden="true" tabindex="-1"></a><span class="co">#     '</span></span>
<span id="cb89-52"><a href="#cb89-52" aria-hidden="true" tabindex="-1"></a><span class="co">#     start_name &lt;- 'IPV'</span></span>
<span id="cb89-53"><a href="#cb89-53" aria-hidden="true" tabindex="-1"></a><span class="co">#     absorbing_name &lt;- 'Absorb'</span></span>
<span id="cb89-54"><a href="#cb89-54" aria-hidden="true" tabindex="-1"></a><span class="co">#     edges &lt;- c()</span></span>
<span id="cb89-55"><a href="#cb89-55" aria-hidden="true" tabindex="-1"></a><span class="co">#     # IPV edges</span></span>
<span id="cb89-56"><a href="#cb89-56" aria-hidden="true" tabindex="-1"></a><span class="co">#     for (i in 1:length(gam$IPV)) {</span></span>
<span id="cb89-57"><a href="#cb89-57" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (gam$IPV[i] &gt; 0) {</span></span>
<span id="cb89-58"><a href="#cb89-58" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- edge_templ</span></span>
<span id="cb89-59"><a href="#cb89-59" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- sub('FROM', start_name, edge)</span></span>
<span id="cb89-60"><a href="#cb89-60" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- sub('TO', i, edge)</span></span>
<span id="cb89-61"><a href="#cb89-61" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- sub('LABEL', gam$IPV[i], edge)</span></span>
<span id="cb89-62"><a href="#cb89-62" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- gsub('COLOR', random_color(), edge)                        </span></span>
<span id="cb89-63"><a href="#cb89-63" aria-hidden="true" tabindex="-1"></a><span class="co">#             edges &lt;- c(edges, edge)</span></span>
<span id="cb89-64"><a href="#cb89-64" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb89-65"><a href="#cb89-65" aria-hidden="true" tabindex="-1"></a><span class="co">#     }    </span></span>
<span id="cb89-66"><a href="#cb89-66" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Matrix edges</span></span>
<span id="cb89-67"><a href="#cb89-67" aria-hidden="true" tabindex="-1"></a><span class="co">#     for (i in 1:(nrow(gam$states))) {</span></span>
<span id="cb89-68"><a href="#cb89-68" aria-hidden="true" tabindex="-1"></a><span class="co">#         for (j in 1:nrow(gam$states)) {</span></span>
<span id="cb89-69"><a href="#cb89-69" aria-hidden="true" tabindex="-1"></a><span class="co">#             if ((i != j) &amp;&amp; (gam$SIM[i, j] &gt; 0)) {</span></span>
<span id="cb89-70"><a href="#cb89-70" aria-hidden="true" tabindex="-1"></a><span class="co">#                 edge &lt;- edge_templ</span></span>
<span id="cb89-71"><a href="#cb89-71" aria-hidden="true" tabindex="-1"></a><span class="co">#                 edge &lt;- sub('FROM', i, edge)</span></span>
<span id="cb89-72"><a href="#cb89-72" aria-hidden="true" tabindex="-1"></a><span class="co">#                 edge &lt;- sub('TO', j, edge)</span></span>
<span id="cb89-73"><a href="#cb89-73" aria-hidden="true" tabindex="-1"></a><span class="co">#                 edge &lt;- sub('LABEL', format_rate(gam$SIM[i, j]), edge)</span></span>
<span id="cb89-74"><a href="#cb89-74" aria-hidden="true" tabindex="-1"></a><span class="co">#                 edge &lt;- gsub('COLOR', random_color(), edge)</span></span>
<span id="cb89-75"><a href="#cb89-75" aria-hidden="true" tabindex="-1"></a><span class="co">#                 edges &lt;- c(edges, edge)</span></span>
<span id="cb89-76"><a href="#cb89-76" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb89-77"><a href="#cb89-77" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb89-78"><a href="#cb89-78" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb89-79"><a href="#cb89-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-80"><a href="#cb89-80" aria-hidden="true" tabindex="-1"></a><span class="co">#     absorb_rates &lt;- -rowSums(gam$SIM)</span></span>
<span id="cb89-81"><a href="#cb89-81" aria-hidden="true" tabindex="-1"></a><span class="co">#     for (i in 1:nrow(gam$states)) {</span></span>
<span id="cb89-82"><a href="#cb89-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-83"><a href="#cb89-83" aria-hidden="true" tabindex="-1"></a><span class="co">#         # </span><span class="al">TODO</span><span class="co">: Avoid the hack below by changing the function to use the graph instead of the matrix</span></span>
<span id="cb89-84"><a href="#cb89-84" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (absorb_rates[i] &gt; abs(1e-14)) {</span></span>
<span id="cb89-85"><a href="#cb89-85" aria-hidden="true" tabindex="-1"></a><span class="co">#         # if (absorb_rates[i] &gt; 0) {</span></span>
<span id="cb89-86"><a href="#cb89-86" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- edge_templ</span></span>
<span id="cb89-87"><a href="#cb89-87" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- sub('FROM', i, edge)</span></span>
<span id="cb89-88"><a href="#cb89-88" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- sub('TO', absorbing_name, edge)</span></span>
<span id="cb89-89"><a href="#cb89-89" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- sub('LABEL', absorb_rates[i], edge)</span></span>
<span id="cb89-90"><a href="#cb89-90" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- gsub('COLOR', random_color(), edge)            </span></span>
<span id="cb89-91"><a href="#cb89-91" aria-hidden="true" tabindex="-1"></a><span class="co">#             edges &lt;- c(edges, edge)</span></span>
<span id="cb89-92"><a href="#cb89-92" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb89-93"><a href="#cb89-93" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb89-94"><a href="#cb89-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-95"><a href="#cb89-95" aria-hidden="true" tabindex="-1"></a><span class="co">#     graph_spec &lt;- paste(c(states, edges), collapse = '\n')</span></span>
<span id="cb89-96"><a href="#cb89-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-97"><a href="#cb89-97" aria-hidden="true" tabindex="-1"></a><span class="co">#     rank_same &lt;- ''</span></span>
<span id="cb89-98"><a href="#cb89-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-99"><a href="#cb89-99" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (subgraphs) {        </span></span>
<span id="cb89-100"><a href="#cb89-100" aria-hidden="true" tabindex="-1"></a><span class="co">#         for (i in 1:(nrow(gam$states))) {</span></span>
<span id="cb89-101"><a href="#cb89-101" aria-hidden="true" tabindex="-1"></a><span class="co">#             sg &lt;- subgraphfun(gam$states[i,], index=i)</span></span>
<span id="cb89-102"><a href="#cb89-102" aria-hidden="true" tabindex="-1"></a><span class="co">#             sub_graphs[[sg]] &lt;- c(sub_graphs[[sg]], i)</span></span>
<span id="cb89-103"><a href="#cb89-103" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb89-104"><a href="#cb89-104" aria-hidden="true" tabindex="-1"></a><span class="co">#         for (sg in labels(sub_graphs)) {</span></span>
<span id="cb89-105"><a href="#cb89-105" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb89-106"><a href="#cb89-106" aria-hidden="true" tabindex="-1"></a><span class="co">#             nodes &lt;- sub_graphs[[sg]]</span></span>
<span id="cb89-107"><a href="#cb89-107" aria-hidden="true" tabindex="-1"></a><span class="co">#             tmpl &lt;- subgraph_template</span></span>
<span id="cb89-108"><a href="#cb89-108" aria-hidden="true" tabindex="-1"></a><span class="co">#             node_str &lt;- ''</span></span>
<span id="cb89-109"><a href="#cb89-109" aria-hidden="true" tabindex="-1"></a><span class="co">#             for (i in 1:length(nodes)) {</span></span>
<span id="cb89-110"><a href="#cb89-110" aria-hidden="true" tabindex="-1"></a><span class="co">#                 node_str &lt;- paste(node_str, paste('"', nodes[i], '" ', sep=''), sep=' ')</span></span>
<span id="cb89-111"><a href="#cb89-111" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb89-112"><a href="#cb89-112" aria-hidden="true" tabindex="-1"></a><span class="co">#             tmpl &lt;- sub('NODES', node_str, tmpl)</span></span>
<span id="cb89-113"><a href="#cb89-113" aria-hidden="true" tabindex="-1"></a><span class="co">#             tmpl &lt;- sub('FREQBIN', sg, tmpl)            </span></span>
<span id="cb89-114"><a href="#cb89-114" aria-hidden="true" tabindex="-1"></a><span class="co">#             tmpl &lt;- sub('FREQBIN', sg, tmpl)            </span></span>
<span id="cb89-115"><a href="#cb89-115" aria-hidden="true" tabindex="-1"></a><span class="co">#             graph_spec &lt;- paste(graph_spec, tmpl)</span></span>
<span id="cb89-116"><a href="#cb89-116" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb89-117"><a href="#cb89-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-118"><a href="#cb89-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-119"><a href="#cb89-119" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (align) {</span></span>
<span id="cb89-120"><a href="#cb89-120" aria-hidden="true" tabindex="-1"></a><span class="co">#             for (i in 1:(nrow(gam$states))) {</span></span>
<span id="cb89-121"><a href="#cb89-121" aria-hidden="true" tabindex="-1"></a><span class="co">#                 sc &lt;- paste(head(gam$states[i,], -1), collapse = ",")</span></span>
<span id="cb89-122"><a href="#cb89-122" aria-hidden="true" tabindex="-1"></a><span class="co">#                 state_classes[[sc]] &lt;- c(state_classes[[sc]], i)</span></span>
<span id="cb89-123"><a href="#cb89-123" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb89-124"><a href="#cb89-124" aria-hidden="true" tabindex="-1"></a><span class="co">#             for (sc in labels(state_classes)) {</span></span>
<span id="cb89-125"><a href="#cb89-125" aria-hidden="true" tabindex="-1"></a><span class="co">#                 rank_same &lt;- paste(rank_same, '{rank=same; ', sep='')</span></span>
<span id="cb89-126"><a href="#cb89-126" aria-hidden="true" tabindex="-1"></a><span class="co">#                 nodes &lt;- state_classes[[sc]]</span></span>
<span id="cb89-127"><a href="#cb89-127" aria-hidden="true" tabindex="-1"></a><span class="co">#                 for (i in 1:length(nodes)) {</span></span>
<span id="cb89-128"><a href="#cb89-128" aria-hidden="true" tabindex="-1"></a><span class="co">#                     rank_same &lt;- paste(rank_same, paste('"', nodes[i], '" ', sep=''), sep=' ')</span></span>
<span id="cb89-129"><a href="#cb89-129" aria-hidden="true" tabindex="-1"></a><span class="co">#                 }            </span></span>
<span id="cb89-130"><a href="#cb89-130" aria-hidden="true" tabindex="-1"></a><span class="co">#                 rank_same &lt;- paste(rank_same, ' }', sep='\n')</span></span>
<span id="cb89-131"><a href="#cb89-131" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb89-132"><a href="#cb89-132" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb89-133"><a href="#cb89-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-134"><a href="#cb89-134" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb89-135"><a href="#cb89-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-136"><a href="#cb89-136" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- '</span></span>
<span id="cb89-137"><a href="#cb89-137" aria-hidden="true" tabindex="-1"></a><span class="co">#         graph [compound=true newrank=true pad="0.5", ranksep="RANKSEP", nodesep="NODESEP"] </span></span>
<span id="cb89-138"><a href="#cb89-138" aria-hidden="true" tabindex="-1"></a><span class="co">#         rankdir=RANKDIR;</span></span>
<span id="cb89-139"><a href="#cb89-139" aria-hidden="true" tabindex="-1"></a><span class="co">#         size="SIZEX,SIZEY";</span></span>
<span id="cb89-140"><a href="#cb89-140" aria-hidden="true" tabindex="-1"></a><span class="co">#         fontname="Helvetica,Arial,sans-serif"</span></span>
<span id="cb89-141"><a href="#cb89-141" aria-hidden="true" tabindex="-1"></a><span class="co">#       node [fontname="Helvetica,Arial,sans-serif", fontsize=FONTSIZE, style=filled, fillcolor="NODECOLOR"]</span></span>
<span id="cb89-142"><a href="#cb89-142" aria-hidden="true" tabindex="-1"></a><span class="co">#       edge [fontname="Helvetica,Arial,sans-serif", fontsize=FONTSIZE, penwidth=PENWIDTH]</span></span>
<span id="cb89-143"><a href="#cb89-143" aria-hidden="true" tabindex="-1"></a><span class="co">#         Absorb [style=filled,color="lightgrey"]</span></span>
<span id="cb89-144"><a href="#cb89-144" aria-hidden="true" tabindex="-1"></a><span class="co">#         IPV [style=filled,color="lightgrey"]</span></span>
<span id="cb89-145"><a href="#cb89-145" aria-hidden="true" tabindex="-1"></a><span class="co">#         RANKSAME</span></span>
<span id="cb89-146"><a href="#cb89-146" aria-hidden="true" tabindex="-1"></a><span class="co">#     '</span></span>
<span id="cb89-147"><a href="#cb89-147" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- sub('SIZEX', size[1], style_str)</span></span>
<span id="cb89-148"><a href="#cb89-148" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- sub('SIZEY', size[2], style_str)</span></span>
<span id="cb89-149"><a href="#cb89-149" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- gsub('FONTSIZE', fontsize, style_str)    </span></span>
<span id="cb89-150"><a href="#cb89-150" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- gsub('RANKDIR', rankdir, style_str)    </span></span>
<span id="cb89-151"><a href="#cb89-151" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- gsub('RANKSAME', rank_same, style_str)</span></span>
<span id="cb89-152"><a href="#cb89-152" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- gsub('RANKSEP', ranksep, style_str)</span></span>
<span id="cb89-153"><a href="#cb89-153" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- gsub('NODESEP', nodesep, style_str)</span></span>
<span id="cb89-154"><a href="#cb89-154" aria-hidden="true" tabindex="-1"></a><span class="co">#     graph_string &lt;- paste('digraph G {', style_str, graph_spec, '}', sep='\n')</span></span>
<span id="cb89-155"><a href="#cb89-155" aria-hidden="true" tabindex="-1"></a><span class="co">#     graph_string &lt;- gsub('NODECOLOR', nodecolor, graph_string)  </span></span>
<span id="cb89-156"><a href="#cb89-156" aria-hidden="true" tabindex="-1"></a><span class="co">#     graph_string &lt;- gsub('PENWIDTH', penwidth, graph_string)  </span></span>
<span id="cb89-157"><a href="#cb89-157" aria-hidden="true" tabindex="-1"></a><span class="co">#     system("dot -Tsvg -o tmp.svg", input=graph_string, intern=TRUE)</span></span>
<span id="cb89-158"><a href="#cb89-158" aria-hidden="true" tabindex="-1"></a><span class="co">#     return(display_svg(file="tmp.svg"))</span></span>
<span id="cb89-159"><a href="#cb89-159" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb89-160"><a href="#cb89-160" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb89-161"><a href="#cb89-161" aria-hidden="true" tabindex="-1"></a>sample_size <span class="op">&lt;-</span> <span class="dv">3</span></span>
<span id="cb89-162"><a href="#cb89-162" aria-hidden="true" tabindex="-1"></a>mutation_rate <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb89-163"><a href="#cb89-163" aria-hidden="true" tabindex="-1"></a>max_tons <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb89-164"><a href="#cb89-164" aria-hidden="true" tabindex="-1"></a>total_tons <span class="op">&lt;-</span> Inf</span>
<span id="cb89-165"><a href="#cb89-165" aria-hidden="true" tabindex="-1"></a>base <span class="op">&lt;-</span> max_tons <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb89-166"><a href="#cb89-166" aria-hidden="true" tabindex="-1"></a>graph <span class="op">&lt;-</span> joint_prob_coalescent(sample_size, mutation_rate, max_tons, total_tons<span class="op">=</span>total_tons)</span>
<span id="cb89-167"><a href="#cb89-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-168"><a href="#cb89-168" aria-hidden="true" tabindex="-1"></a>plot_graph(graph_as_matrix(graph), rainbow<span class="op">=</span>TRUE, size<span class="op">=</span>c(<span class="dv">10</span>, <span class="dv">8</span>), align<span class="op">=</span>TRUE,</span>
<span id="cb89-169"><a href="#cb89-169" aria-hidden="true" tabindex="-1"></a>           fontsize<span class="op">=</span><span class="dv">16</span>, ranksep<span class="op">=</span><span class="dv">1</span>, nodesep<span class="op">=</span><span class="fl">0.25</span>,</span>
<span id="cb89-170"><a href="#cb89-170" aria-hidden="true" tabindex="-1"></a>           subgraphs<span class="op">=</span>TRUE,</span>
<span id="cb89-171"><a href="#cb89-171" aria-hidden="true" tabindex="-1"></a>           <span class="co"># rankdir="TB",</span></span>
<span id="cb89-172"><a href="#cb89-172" aria-hidden="true" tabindex="-1"></a>           subgraphfun<span class="op">=</span>function(state, index) <span class="im">as</span>.character((index<span class="op">+</span><span class="dv">1</span>) <span class="op">%/%</span> <span class="dv">2</span>)</span>
<span id="cb89-173"><a href="#cb89-173" aria-hidden="true" tabindex="-1"></a>           <span class="co"># subgraphfun=function(state, index) paste(state[-length(state)], collapse="")</span></span>
<span id="cb89-174"><a href="#cb89-174" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob_files/figure-html/cell-81-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-21"><img src="coalescent-jointprob_files/figure-html/cell-81-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/munch-group\.github\.io\/PtDAlgorithms\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>