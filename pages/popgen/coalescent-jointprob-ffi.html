<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Joint probability and FMC embedding</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-8eb735be1893943fe49fb9ca03c59cb5.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../api/_styles-quartodoc.css">
<link rel="stylesheet" href="../../numpy.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../logo.png" alt="Phasic" class="navbar-logo light-content">
    <img src="../../logo.png" alt="Phasic" class="navbar-logo dark-content">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../pages/getting_started.html"> 
<span class="menu-text">Documentation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../api/"> 
<span class="menu-text">Python API reference</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../r_api/"> 
<span class="menu-text">R API reference</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../c_api/"> 
<span class="menu-text">C API reference</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/munch-group/ptdalgorithms/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#example-model-coalescent" id="toc-example-model-coalescent" class="nav-link active" data-scroll-target="#example-model-coalescent">Example model: Coalescent</a></li>
  <li><a href="#make-discrete" id="toc-make-discrete" class="nav-link" data-scroll-target="#make-discrete">Make discrete</a></li>
  <li><a href="#discrete-joint-prob" id="toc-discrete-joint-prob" class="nav-link" data-scroll-target="#discrete-joint-prob">Discrete joint prob</a></li>
  <li><a href="#finite-markov-chains-fmc" id="toc-finite-markov-chains-fmc" class="nav-link" data-scroll-target="#finite-markov-chains-fmc">Finite Markov Chains (FMC)</a>
  <ul class="collapse">
  <li><a href="#distribution-of-steps-spent-in-a-state" id="toc-distribution-of-steps-spent-in-a-state" class="nav-link" data-scroll-target="#distribution-of-steps-spent-in-a-state">Distribution of steps spent in a state</a></li>
  <li><a href="#nr-of-runs-of-a-particular-state" id="toc-nr-of-runs-of-a-particular-state" class="nav-link" data-scroll-target="#nr-of-runs-of-a-particular-state">Nr of runs of a particular state</a></li>
  <li><a href="#i-could-add-an-fmc-argument-that-adds-a-slot-to-initial-and-increments-that-for-all-states-returned-by-callback" id="toc-i-could-add-an-fmc-argument-that-adds-a-slot-to-initial-and-increments-that-for-all-states-returned-by-callback" class="nav-link" data-scroll-target="#i-could-add-an-fmc-argument-that-adds-a-slot-to-initial-and-increments-that-for-all-states-returned-by-callback">I could add an fmc argument that adds a slot to initial and increments that for all states returned by callback</a></li>
  <li><a href="#length-of-longest-run-of-a-state-in-an-fmc" id="toc-length-of-longest-run-of-a-state-in-an-fmc" class="nav-link" data-scroll-target="#length-of-longest-run-of-a-state-in-an-fmc">Length of longest run of a state in an FMC</a></li>
  </ul></li>
  <li><a href="#two-locus-arg" id="toc-two-locus-arg" class="nav-link" data-scroll-target="#two-locus-arg">Two-locus ARG</a></li>
  <li><a href="#base-n-approach" id="toc-base-n-approach" class="nav-link" data-scroll-target="#base-n-approach">Base-n approach</a>
  <ul class="collapse">
  <li><a href="#state-space-for-joint-proability-computation" id="toc-state-space-for-joint-proability-computation" class="nav-link" data-scroll-target="#state-space-for-joint-proability-computation">State space for joint proability computation</a></li>
  <li><a href="#reward-transform" id="toc-reward-transform" class="nav-link" data-scroll-target="#reward-transform">Reward transform</a></li>
  <li><a href="#figure-out-why-you-get-nas-in-multi_rewards-with-max_tons---1" id="toc-figure-out-why-you-get-nas-in-multi_rewards-with-max_tons---1" class="nav-link" data-scroll-target="#figure-out-why-you-get-nas-in-multi_rewards-with-max_tons---1">Figure out why you get NAs in multi_rewards with max_tons &lt;- 1</a></li>
  <li><a href="#compute-joint-prob" id="toc-compute-joint-prob" class="nav-link" data-scroll-target="#compute-joint-prob">Compute joint prob</a></li>
  <li><a href="#when-we-do-the-discrete-version-we-dont-need-to-go-through-the-cdf-to-get-the-pdf.-we-can-just-use-the-ddph-directly" id="toc-when-we-do-the-discrete-version-we-dont-need-to-go-through-the-cdf-to-get-the-pdf.-we-can-just-use-the-ddph-directly" class="nav-link" data-scroll-target="#when-we-do-the-discrete-version-we-dont-need-to-go-through-the-cdf-to-get-the-pdf.-we-can-just-use-the-ddph-directly">When we do the discrete version, we don’t need to go through the CDF to get the PDF. We can just use the <code>ddph</code> directly</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Joint probability and FMC embedding</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="405a9cbe-a26b-460b-8ed0-27bb88f943f2" class="cell" data-execution_count="40">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import sys</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># import pandas as pd</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># from collections import defaultdict</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># import numpy as np</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># np.random.seed(42)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># import matplotlib.pyplot as plt</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># import seaborn as sns</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># sns.set_context("paper")</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.style.use('dark_background')</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># import matplotlib as mpl</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># scale = 0.8</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># d = dict([(k, v*scale) for (k, v) in sns.plotting_context('paper').items()])</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># d['figure.figsize'] = [5.4, 3.5]</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># d['axes.facecolor'] = '#1F1F1F'</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># d['figure.facecolor'] = '#1F1F1F'</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># mpl.rcParams.update(d)</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># %config InlineBackend.figure_format = 'retina'</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># import ptdalgorithms as ptd</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ptd.plot.set_theme('dark')</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ptdalgorithms <span class="im">import</span> Graph, SVGD, analyze_svgd_profile, set_theme, clear_cache</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> jnp</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> colors</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>plt.set_loglevel(<span class="st">'warning'</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>set_theme(<span class="st">'dark'</span>)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co"># %config InlineBackend.figure_format='svg'</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>config InlineBackend.figure_format<span class="op">=</span><span class="st">'retina'</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="co"># "iridis" color map (viridis without the deep purple)</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> truncate_colormap(cmap, minval<span class="op">=</span><span class="fl">0.0</span>, maxval<span class="op">=</span><span class="fl">1.0</span>, n<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    new_cmap <span class="op">=</span> colors.LinearSegmentedColormap.from_list(</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">'trunc(</span><span class="sc">{n}</span><span class="st">,</span><span class="sc">{a:.2f}</span><span class="st">,</span><span class="sc">{b:.2f}</span><span class="st">)'</span>.<span class="bu">format</span>(n<span class="op">=</span>cmap.name, a<span class="op">=</span>minval, b<span class="op">=</span>maxval),</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>        cmap(np.linspace(minval, maxval, n)))</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> new_cmap</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>iridis <span class="op">=</span> truncate_colormap(plt.get_cmap(<span class="st">'viridis'</span>), <span class="fl">0.2</span>, <span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="example-model-coalescent" class="level2">
<h2 class="anchored" data-anchor-id="example-model-coalescent">Example model: Coalescent</h2>
<div id="900fde71" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> coalescent(state, nr_samples<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> state.size:</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        ipv <span class="op">=</span> [([nr_samples]<span class="op">+</span>[<span class="dv">0</span>]<span class="op">*</span>nr_samples, <span class="dv">1</span>)]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ipv</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        transitions <span class="op">=</span> []</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(nr_samples):</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i, nr_samples):            </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                same <span class="op">=</span> <span class="bu">int</span>(i <span class="op">==</span> j)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> same <span class="kw">and</span> state[i] <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> same <span class="kw">and</span> (state[i] <span class="op">&lt;</span> <span class="dv">1</span> <span class="kw">or</span> state[j] <span class="op">&lt;</span> <span class="dv">1</span>):</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span> </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                new <span class="op">=</span> state.copy()</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                new[i] <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                new[j] <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                new[i<span class="op">+</span>j<span class="op">+</span><span class="dv">1</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                transitions.append((new, state[i]<span class="op">*</span>(state[j]<span class="op">-</span>same)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span>same)))</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> transitions</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> Graph(callback<span class="op">=</span>coalescent, nr_samples<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>graph.plot()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-3-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="coalescent-jointprob-ffi_files/figure-html/cell-3-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="f8e57470" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>graph.expectation()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>1.5</code></pre>
</div>
</div>
<div id="8d5c59f6" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>rewards <span class="op">=</span> graph.states().T</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>rewards</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>array([[0, 4, 2, 0, 1, 0],
       [0, 0, 1, 2, 0, 0],
       [0, 0, 0, 0, 1, 0],
       [0, 0, 0, 0, 0, 1],
       [0, 0, 0, 0, 0, 0]], dtype=int32)</code></pre>
</div>
</div>
<div id="296993d8" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>sfs <span class="op">=</span> np.apply_along_axis(graph.expectation, <span class="dv">1</span>, rewards)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>sns.barplot(sfs) <span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-6-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="coalescent-jointprob-ffi_files/figure-html/cell-6-output-1.png" width="556" height="413" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="make-discrete" class="level2">
<h2 class="anchored" data-anchor-id="make-discrete">Make discrete</h2>
<p>Turn state space for a continuous PTD into one for a discrete.</p>
<div id="42fb2ba0-79df-4d0d-b49e-048d8883c80b" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_discrete(graph, mutation_rate, skip_states<span class="op">=</span>[], skip_slots<span class="op">=</span>[]):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Takes a graph for a continuous distribution and turns</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">    it into a descrete one (inplace). Returns a matrix of</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">    rewards for computing marginal moments</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    mutation_graph <span class="op">=</span> graph.copy()</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># save current nr of states in graph</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    vlength <span class="op">=</span> mutation_graph.vertices_length()</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># number of fields in state vector (assumes all are the same length)</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    state_vector_length <span class="op">=</span> <span class="bu">len</span>(mutation_graph.vertex_at(<span class="dv">1</span>).state())</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># list state vector fields to reward at each auxiliary node</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rewarded_state_vector_indexes = [[] for _ in range(state_vector_length)]</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    rewarded_state_vector_indexes <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># loop all but starting node</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, vlength):</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="kw">in</span> skip_states:</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        vertex <span class="op">=</span> mutation_graph.vertex_at(i)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> vertex.rate() <span class="op">&gt;</span> <span class="dv">0</span>: <span class="co"># not absorbing</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(state_vector_length):</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> j <span class="kw">in</span> skip_slots:</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>                val <span class="op">=</span> vertex.state()[j]</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> val <span class="op">&gt;</span> <span class="dv">0</span>: <span class="co"># only ones we may reward</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># add auxilliary node</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>                    mutation_vertex <span class="op">=</span> mutation_graph.create_vertex(np.repeat(<span class="dv">0</span>, state_vector_length))</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>                    mutation_vertex.add_edge(vertex, <span class="dv">1</span>)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>                    vertex.add_edge(mutation_vertex, mutation_rate<span class="op">*</span>val)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># print(mutation_vertex.index(), rewarded_state_vector_indexes[j], j)</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># rewarded_state_vector_indexes[mutation_vertex.index()] = rewarded_state_vector_indexes[j] + [j]</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>                    rewarded_state_vector_indexes[mutation_vertex.index()].append(j)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(rewarded_state_vector_indexes)</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># normalize graph</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    weights_were_multiplied_with <span class="op">=</span> mutation_graph.normalize()</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># build reward matrix</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>    rewards <span class="op">=</span> np.zeros((mutation_graph.vertices_length(), state_vector_length))</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> state <span class="kw">in</span> rewarded_state_vector_indexes:</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> rewarded_state_vector_indexes[state]:</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>            rewards[state, i] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    rewards <span class="op">=</span> np.transpose(rewards)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mutation_graph, rewards</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> Graph(callback<span class="op">=</span>coalescent, nr_samples<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a><span class="co"># self-transition rate:</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="co"># mutation_rate = 1e-8</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>mutation_rate <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a><span class="co"># # clone graph to get one to modify:</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a><span class="co"># mutation_graph = graph.copy()</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a><span class="co"># add auxilliary states, normalize and return reward matrix:</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>mutation_graph, rewards <span class="op">=</span> make_discrete(graph, mutation_rate)</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a><span class="co"># print(mutation_graph.expectation())</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a><span class="co"># print([mutation_graph.expectation(r) for r in rewards])</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a><span class="co"># print(rewards)</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>mutation_graph.plot()</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a><span class="co"># from functools import wraps</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a><span class="co"># def discrete(mutation_rate, skip_states=[], skip_slots=[]):</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a><span class="co">#     def decorator(graph_constructor):</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a><span class="co">#         @wraps(graph_constructor)</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a><span class="co">#         def wrapper(*args, **kwargs):</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a><span class="co">#             graph = graph_constructor(*args, **kwargs)</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a><span class="co">#             rewards = make_discrete(graph, mutation_rate)</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a><span class="co">#             return rewards</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a><span class="co">#         return wrapper</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a><span class="co">#     return decorator</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a><span class="co"># @discrete(mutation_rate=1)</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a><span class="co"># def foo():    </span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a><span class="co">#     return coalescent(4)</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a><span class="co"># rewards = foo()</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a><span class="co"># rewards</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-7-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="coalescent-jointprob-ffi_files/figure-html/cell-7-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="bf79ef0b" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>discrete_graph, discrete_rewards<span class="op">=</span> graph.discretize(reward_rate<span class="op">=</span><span class="fl">0.1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="5cae0455" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>mutation_graph.states()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>array([[0, 0, 0, 0],
       [3, 0, 0, 0],
       [1, 1, 0, 0],
       [0, 0, 1, 0],
       [0, 0, 0, 0],
       [0, 0, 0, 0],
       [0, 0, 0, 0]], dtype=int32)</code></pre>
</div>
</div>
<div id="46c60bc6" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>rewards</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>array([[0., 0., 0., 0., 1., 1., 0.],
       [0., 0., 0., 0., 0., 0., 1.],
       [0., 0., 0., 0., 0., 0., 0.],
       [0., 0., 0., 0., 0., 0., 0.]])</code></pre>
</div>
</div>
<div id="848c96f3" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>graph.expectation() <span class="op">*</span> <span class="fl">0.1</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>0.13333333333333333</code></pre>
</div>
</div>
<div id="b21bfdaf" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>graph.expectation(np.<span class="bu">sum</span>(mutation_graph.states(), axis<span class="op">=</span><span class="dv">0</span>) <span class="op">*</span> <span class="fl">0.1</span>), </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>(0.13333333333333333,)</code></pre>
</div>
</div>
<div id="87b263dc" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>sfs <span class="op">=</span> np.apply_along_axis(mutation_graph.expectation_discrete, <span class="dv">1</span>, rewards)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>sns.barplot(sfs) <span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-13-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="coalescent-jointprob-ffi_files/figure-html/cell-13-output-1.png" width="565" height="413" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="36211952" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>sns.barplot(mutation_graph.pdf(np.arange(<span class="dv">10</span>)))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>sns.despine()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-14-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="coalescent-jointprob-ffi_files/figure-html/cell-14-output-1.png" width="556" height="413" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="discrete-joint-prob" class="level2">
<h2 class="anchored" data-anchor-id="discrete-joint-prob">Discrete joint prob</h2>
<div id="7eee1cf6-8424-452f-ac2b-e894ecb6a581" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> discrete_joint_prob(graph, reward_rates, precision<span class="op">=</span><span class="fl">1e-15</span>, return_fun<span class="op">=</span><span class="va">False</span>, return_graph<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    starting_vertex <span class="op">=</span> graph.starting_vertex()</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    reward_dims <span class="op">=</span> <span class="bu">len</span>(reward_rates(starting_vertex.state())) <span class="op">-</span> <span class="dv">1</span> <span class="co"># a bit of a hack. -1 to not count trash rate...</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    orig_state_vector_length <span class="op">=</span> <span class="bu">len</span>(graph.vertex_at(<span class="dv">1</span>).state())</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    state_vector_length <span class="op">=</span> orig_state_vector_length <span class="op">+</span> reward_dims</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    state_indices <span class="op">=</span> np.arange(orig_state_vector_length)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    reward_indices <span class="op">=</span> np.arange(orig_state_vector_length, state_vector_length)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    new_graph <span class="op">=</span> Graph(state_vector_length)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># new_starting_vertex = new_graph.vertex_at(1)</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    new_starting_vertex <span class="op">=</span> new_graph.starting_vertex()</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    null_rewards <span class="op">=</span> np.zeros(reward_dims)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add edges from starting vertex (IPV)</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> edge <span class="kw">in</span> starting_vertex.edges():</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>        new_starting_vertex.add_edge(</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>          new_graph.find_or_create_vertex(np.append(edge.to().state(), null_rewards).astype(<span class="bu">int</span>)), <span class="dv">1</span>)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> index <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    trash_rates <span class="op">=</span> {}</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    t_vertex_indices <span class="op">=</span> np.array([], dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> index <span class="op">&lt;</span> new_graph.vertices_length():</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>        new_vertex <span class="op">=</span> new_graph.vertex_at(index)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>        new_state <span class="op">=</span> new_vertex.state()</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>        state <span class="op">=</span> new_vertex.state()[state_indices]</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>        vertex <span class="op">=</span> graph.find_vertex(state)</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># non-mutation transitions (coalescence)</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> edge <span class="kw">in</span> vertex.edges():</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>            new_child_state <span class="op">=</span> np.append(edge.to().state(), new_state[reward_indices])</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> np.<span class="bu">all</span>(new_state <span class="op">==</span> new_child_state):</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>            new_child_vertex <span class="op">=</span> new_graph.find_or_create_vertex(new_child_state)</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>            <span class="co"># cat(new_child_vertex$state, "\n")</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>            new_vertex.add_edge(new_child_vertex, <span class="co"># if I use create_vertex here, I cannot find it again with find_vertex...</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>                edge.weight()</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>            <span class="co"># if new child was absorbing, record at "t-states":</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> graph.find_vertex(new_child_state[state_indices]).edges():</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>                t_vertex_indices <span class="op">=</span> np.append(t_vertex_indices, new_child_vertex.index()) </span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># mutation transitions</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>        current_state <span class="op">=</span> new_state[state_indices]</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>        current_rewards <span class="op">=</span> new_state[reward_indices]</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>        rates <span class="op">=</span> reward_rates(current_state, current_rewards) <span class="co"># list of all allowed mutation transition rates with trash rate appended</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>        trash_rates[index] <span class="op">=</span> rates[reward_dims]</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(reward_dims):</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>            rate <span class="op">=</span> rates[i]</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> rate <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>                new_rewards <span class="op">=</span> current_rewards</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>                new_rewards[i] <span class="op">=</span> new_rewards[i] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>                new_child_vertex <span class="op">=</span> new_graph.find_or_create_vertex(np.append(current_state, new_rewards))</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>                <span class="co"># stopifnot(sum(new_child_vertex$state) &gt; 4)</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>                <span class="co"># cat(new_child_vertex$state, "\n")</span></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>                new_vertex.add_edge(</span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>                    new_child_vertex, <span class="co"># if I use create_vertex here, I cannot find it again with find_vertex...</span></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>                    rate</span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>                <span class="co"># # if new child was absorbing, record at "t-states":                </span></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>                <span class="co"># if (length(edges(find_vertex(graph, new_child_state[state_indices]))) == 0) {</span></span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>                <span class="co">#     t_vertex_indices = c(t_vertex_indices, new_child_vertex$index) </span></span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>        index <span class="op">=</span> index <span class="op">+</span> <span class="dv">1</span> </span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> index <span class="op">%</span> <span class="dv">10_000</span>:</span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>            graph_size <span class="op">=</span> new_graph.vertices_length()</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'index: </span><span class="sc">{</span>index<span class="sc">:&gt;6}</span><span class="ss">      vertices: </span><span class="sc">{</span>graph_size<span class="sc">:&gt;6}</span><span class="ss">      ratio: </span><span class="sc">{</span>graph_size<span class="op">/</span>index<span class="sc">:&gt;4.2}</span><span class="ss">'</span>, <span class="bu">file</span><span class="op">=</span>sys.stderr)</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>            sys.stderr.flush()</span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># trash states</span></span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>    trash_vertex <span class="op">=</span> new_graph.find_or_create_vertex(np.repeat(<span class="dv">0</span>, state_vector_length))</span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>    trash_loop_vertex <span class="op">=</span> new_graph.create_vertex(np.repeat(<span class="dv">0</span>, state_vector_length))</span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>    trash_vertex.add_edge(trash_loop_vertex, <span class="dv">1</span>)</span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>    trash_loop_vertex.add_edge(trash_vertex, <span class="dv">1</span>)</span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add trash edges</span></span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, rate <span class="kw">in</span> trash_rates.items():</span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>        new_graph.vertex_at(i).add_edge(trash_vertex, rate) </span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add edges from t-states to new final absorbing</span></span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>    new_absorbing <span class="op">=</span> new_graph.create_vertex(np.repeat(<span class="dv">0</span>, state_vector_length))</span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>    t_vertex_indices <span class="op">=</span> np.unique(t_vertex_indices)</span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> t_vertex_indices:</span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>        new_graph.vertex_at(i).add_edge(new_absorbing, <span class="dv">1</span>)</span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># normalize graph                            </span></span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>    weights_were_multiplied_with <span class="op">=</span> new_graph.normalize()</span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> return_graph:                           </span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span>(new_graph)                                             </span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># time spent in each of the the t-states at time stop or after some appropriately large time (these are the joint probs)</span></span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a>    prev <span class="op">=</span> <span class="va">None</span></span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> decade <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>):</span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a>        accum_time_all <span class="op">=</span> new_graph.accumulated_visiting_time(decade<span class="op">*</span><span class="dv">10</span>)</span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a>        accum_time <span class="op">=</span> np.array(accum_time_all)[t_vertex_indices]</span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> prev <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> np.<span class="bu">all</span>(np.<span class="bu">abs</span>(accum_time <span class="op">-</span> prev) <span class="op">&lt;</span> precision):</span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a>        prev <span class="op">=</span> accum_time</span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> decade <span class="op">&lt;</span> <span class="dv">100</span></span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> Fun():</span>
<span id="cb20-120"><a href="#cb20-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-121"><a href="#cb20-121" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, new_graph, t_vertex_indices):</span>
<span id="cb20-122"><a href="#cb20-122" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.new_graph <span class="op">=</span> new_graph</span>
<span id="cb20-123"><a href="#cb20-123" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.t_vertex_indices <span class="op">=</span> t_vertex_indices</span>
<span id="cb20-124"><a href="#cb20-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-125"><a href="#cb20-125" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tup):</span>
<span id="cb20-126"><a href="#cb20-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-127"><a href="#cb20-127" aria-hidden="true" tabindex="-1"></a>        <span class="co"># def __call__(self, stop):</span></span>
<span id="cb20-128"><a href="#cb20-128" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     accum_time_all = self.new_graph.accumulated_visiting_time(stop)</span></span>
<span id="cb20-129"><a href="#cb20-129" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     accum_time = np.array(accum_time_all)[self.t_vertex_indices]</span></span>
<span id="cb20-130"><a href="#cb20-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-131"><a href="#cb20-131" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     states = new_graph.states()</span></span>
<span id="cb20-132"><a href="#cb20-132" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     state_reward_matrix = states[self.t_vertex_indices, :][:, reward_indices]</span></span>
<span id="cb20-133"><a href="#cb20-133" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     joint_probs = pd.DataFrame(state_reward_matrix)</span></span>
<span id="cb20-134"><a href="#cb20-134" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     index_cols = joint_probs.columns.values.tolist()</span></span>
<span id="cb20-135"><a href="#cb20-135" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     joint_probs['time'] = stop</span></span>
<span id="cb20-136"><a href="#cb20-136" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     joint_probs['prob'] = accum_time</span></span>
<span id="cb20-137"><a href="#cb20-137" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     joint_probs.set_index(index_cols, inplace=True)</span></span>
<span id="cb20-138"><a href="#cb20-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-139"><a href="#cb20-139" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> joint_probs </span>
<span id="cb20-140"><a href="#cb20-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-141"><a href="#cb20-141" aria-hidden="true" tabindex="-1"></a>    fun <span class="op">=</span> Fun(new_graph, t_vertex_indices)</span>
<span id="cb20-142"><a href="#cb20-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-143"><a href="#cb20-143" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> return_fun:</span>
<span id="cb20-144"><a href="#cb20-144" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fun</span>
<span id="cb20-145"><a href="#cb20-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-146"><a href="#cb20-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fun(decade<span class="op">*</span><span class="dv">10</span>).drop(columns<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb20-147"><a href="#cb20-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-148"><a href="#cb20-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I can test if the graph is acyclic and if so, use accumulated_residence_time instead?</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d5b68f6f-6a1a-4294-9b9f-95d1c0566ffc" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> Graph(callback<span class="op">=</span>coalescent, nr_samples<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>graph.plot()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-16-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="coalescent-jointprob-ffi_files/figure-html/cell-16-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="8c03f903" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>graph.variance()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>1.1388888888888884</code></pre>
</div>
</div>
<div id="88359730-211d-48b3-98c5-32e67b71a40a" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># gam = graph.as_matrices()</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># gam</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="2bfcf845" class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>graph.plot()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-19-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="coalescent-jointprob-ffi_files/figure-html/cell-19-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="06cc8ec3" class="cell" data-execution_count="37">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>graph.pdf(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>8.140105759241116e-05</code></pre>
</div>
</div>
<div id="746cd80c" class="cell" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>graph.plot(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>            nodesep<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>             subgraphfun<span class="op">=</span><span class="kw">lambda</span> state: <span class="st">'has singletons'</span> <span class="cf">if</span> np.<span class="bu">all</span>(state[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="cf">else</span> <span class="st">'no singletons'</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>               )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-21-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="coalescent-jointprob-ffi_files/figure-html/cell-21-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="6562d956" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reward_callback(state, current_rewards<span class="op">=</span><span class="va">None</span>, mutation_rate<span class="op">=</span><span class="dv">1</span>, reward_limit<span class="op">=</span><span class="dv">10</span>, tot_reward_limit<span class="op">=</span>np.inf):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    reward_limits <span class="op">=</span> np.append(np.repeat(reward_limit, <span class="bu">len</span>(state)<span class="op">-</span><span class="dv">1</span>), <span class="dv">0</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    reward_dims <span class="op">=</span> <span class="bu">len</span>(reward_limits)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> current_rewards <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        current_rewards <span class="op">=</span> np.zeros(reward_dims)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    reward_rates <span class="op">=</span> np.zeros(reward_dims)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    trash_rate <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(reward_dims):</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>        rate <span class="op">=</span> state[i] <span class="op">*</span> mutation_rate </span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> np.zeros(reward_dims)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>        r[i] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.<span class="bu">all</span>(current_rewards <span class="op">+</span> r <span class="op">&lt;=</span> reward_limits) <span class="kw">and</span> np.<span class="bu">sum</span>(current_rewards <span class="op">+</span> r) <span class="op">&lt;=</span> tot_reward_limit:</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>            reward_rates[i] <span class="op">=</span> rate</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>            trash_rate <span class="op">=</span> trash_rate <span class="op">+</span> rate</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.append(reward_rates, trash_rate)</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>joint_probs <span class="op">=</span> discrete_joint_prob(graph, reward_callback)</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>joint_probs    </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[39]</span><span class="ansi-green-fg">, line 23</span>
<span class="ansi-green-fg">     19</span>             trash_rate = trash_rate + rate
<span class="ansi-green-fg">     21</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> np.append(reward_rates, trash_rate)
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">23</span> joint_probs = <span class="ansi-yellow-bg">discrete_joint_prob</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">graph</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">reward_callback</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">     25</span> joint_probs    

<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[32]</span><span class="ansi-green-fg">, line 145</span>, in <span class="ansi-cyan-fg">discrete_joint_prob</span><span class="ansi-blue-fg">(graph, reward_rates, precision, return_fun, return_graph)</span>
<span class="ansi-green-fg">    142</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> return_fun:
<span class="ansi-green-fg">    143</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> fun
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">145</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">fun</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">decade</span><span class="ansi-yellow-bg">*</span><span class="ansi-green-fg ansi-yellow-bg">10</span><span class="ansi-yellow-bg">)</span>.drop(columns=<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">time</span><span class="ansi-yellow-fg">'</span>)

<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[32]</span><span class="ansi-green-fg">, line 138</span>, in <span class="ansi-cyan-fg">discrete_joint_prob.&lt;locals&gt;.Fun.__call__</span><span class="ansi-blue-fg">(self, tup)</span>
<span class="ansi-green-fg">    124</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span class="ansi-blue-fg">__call__</span>(<span style="color:rgb(0,135,0)">self</span>, tup):
<span class="ansi-green-fg">    125</span> 
<span class="ansi-green-fg">    126</span> <span style="font-style:italic;color:rgb(95,135,135)"># def __call__(self, stop):</span>
<span class="ansi-green-fg">   (...)</span><span class="ansi-green-fg">    135</span> <span style="font-style:italic;color:rgb(95,135,135)">#     joint_probs['prob'] = accum_time</span>
<span class="ansi-green-fg">    136</span> <span style="font-style:italic;color:rgb(95,135,135)">#     joint_probs.set_index(index_cols, inplace=True)</span>
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">138</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">joint_probs</span>

<span class="ansi-red-fg">NameError</span>: name 'joint_probs' is not defined</pre>
</div>
</div>
</div>
<div id="1fc2cdbc-354d-45f1-bc0c-8864b7c593e2" class="cell" data-execution_count="41">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reward_callback(state, current_rewards<span class="op">=</span><span class="va">None</span>, mutation_rate<span class="op">=</span><span class="dv">1</span>, reward_limit<span class="op">=</span><span class="dv">10</span>, tot_reward_limit<span class="op">=</span>np.inf):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    reward_limits <span class="op">=</span> np.append(np.repeat(reward_limit, <span class="bu">len</span>(state)<span class="op">-</span><span class="dv">1</span>), <span class="dv">0</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    reward_dims <span class="op">=</span> <span class="bu">len</span>(reward_limits)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> current_rewards <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>        current_rewards <span class="op">=</span> np.zeros(reward_dims)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    reward_rates <span class="op">=</span> np.zeros(reward_dims)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    trash_rate <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(reward_dims):</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        rate <span class="op">=</span> state[i] <span class="op">*</span> mutation_rate </span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> np.zeros(reward_dims)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>        r[i] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.<span class="bu">all</span>(current_rewards <span class="op">+</span> r <span class="op">&lt;=</span> reward_limits) <span class="kw">and</span> np.<span class="bu">sum</span>(current_rewards <span class="op">+</span> r) <span class="op">&lt;=</span> tot_reward_limit:</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>            reward_rates[i] <span class="op">=</span> rate</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>            trash_rate <span class="op">=</span> trash_rate <span class="op">+</span> rate</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.append(reward_rates, trash_rate)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> joint_pmf(graph, rate_fun, reward_limit<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a joint probability mass function for the graph</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reward_callback(state, current_rewards<span class="op">=</span><span class="va">None</span>, mutation_rate<span class="op">=</span><span class="dv">1</span>, reward_limit<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>        reward_limits <span class="op">=</span> np.append(np.repeat(reward_limit, <span class="bu">len</span>(state)<span class="op">-</span><span class="dv">1</span>), <span class="dv">0</span>)</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>        reward_dims <span class="op">=</span> <span class="bu">len</span>(reward_limits)</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_rewards <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>            current_rewards <span class="op">=</span> np.zeros(reward_dims)</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>        reward_rates <span class="op">=</span> np.zeros(reward_dims)</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>        trash_rate <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(reward_dims):</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>            rate <span class="op">=</span> rate_fun(state[i])</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>            r <span class="op">=</span> np.zeros(reward_dims)</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>            r[i] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> np.<span class="bu">all</span>(current_rewards <span class="op">+</span> r <span class="op">&lt;=</span> reward_limits):</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>                reward_rates[i] <span class="op">=</span> rate</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>                trash_rate <span class="op">=</span> trash_rate <span class="op">+</span> rate</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.append(reward_rates, trash_rate)</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> discrete_joint_prob(graph, reward_callback, return_fun<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>fun <span class="op">=</span> joint_pmf(graph, <span class="kw">lambda</span> x: x<span class="op">*</span><span class="dv">1</span>, reward_limit<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>fun</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>&lt;__main__.discrete_joint_prob.&lt;locals&gt;.Fun at 0x10e6d4440&gt;</code></pre>
</div>
</div>
<div id="6cee8c00" class="cell" data-execution_count="42">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>joint_probs.at[(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="st">'prob'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[42]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> <span class="ansi-yellow-bg">joint_probs</span>.at[(<span class="ansi-green-fg">0</span>, <span class="ansi-green-fg">1</span>, <span class="ansi-green-fg">0</span>, <span class="ansi-green-fg">0</span>, <span class="ansi-green-fg">0</span>), <span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">prob</span><span class="ansi-yellow-fg">'</span>]

<span class="ansi-red-fg">NameError</span>: name 'joint_probs' is not defined</pre>
</div>
</div>
</div>
<div id="bfaa4d3d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> joint_pmf(graph, reward_callback):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    df.loc[(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="8ebb7cc0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>outcomes <span class="op">=</span> np.matrix(<span class="bu">list</span>(<span class="bu">map</span>(<span class="bu">list</span>, joint_probs.index.values)))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>probs <span class="op">=</span> joint_probs[<span class="st">'prob'</span>].values</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>with_deficit <span class="op">=</span> probs <span class="op">@</span> outcomes</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>with_deficit <span class="op">=</span> with_deficit[:,:nr_samples<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>no_deficit <span class="op">=</span> np.matrix([<span class="dv">2</span><span class="op">/</span>x <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">4</span>)])</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>deficit <span class="op">=</span> (no_deficit <span class="op">-</span> with_deficit) <span class="op">/</span> no_deficit</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>deficit</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[36], line 4</span>
<span class="ansi-green-fg ansi-bold">      2</span> probs <span style="color:rgb(98,98,98)">=</span> joint_probs[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">prob</span><span style="color:rgb(175,0,0)">'</span>]<span style="color:rgb(98,98,98)">.</span>values
<span class="ansi-green-fg ansi-bold">      3</span> with_deficit <span style="color:rgb(98,98,98)">=</span> probs <span style="color:rgb(98,98,98)">@</span> outcomes
<span class="ansi-green-fg">----&gt; 4</span> with_deficit <span style="color:rgb(98,98,98)">=</span> with_deficit[:,:<span class="ansi-yellow-bg">nr_samples</span><span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">1</span>]
<span class="ansi-green-fg ansi-bold">      5</span> no_deficit <span style="color:rgb(98,98,98)">=</span> np<span style="color:rgb(98,98,98)">.</span>matrix([<span style="color:rgb(98,98,98)">2</span><span style="color:rgb(98,98,98)">/</span>x <span style="font-weight:bold;color:rgb(0,135,0)">for</span> x <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">range</span>(<span style="color:rgb(98,98,98)">1</span>, <span style="color:rgb(98,98,98)">4</span>)])
<span class="ansi-green-fg ansi-bold">      6</span> deficit <span style="color:rgb(98,98,98)">=</span> (no_deficit <span style="color:rgb(98,98,98)">-</span> with_deficit) <span style="color:rgb(98,98,98)">/</span> no_deficit

<span class="ansi-red-fg">NameError</span>: name 'nr_samples' is not defined</pre>
</div>
</div>
</div>
<div id="61d4e959" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>joint_prob_at_time <span class="op">=</span> discrete_joint_prob(graph, reward_rates, return_fun<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>joint_prob_at_time</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>&lt;__main__.discrete_joint_prob.&lt;locals&gt;.Fun at 0x10900b390&gt;</code></pre>
</div>
</div>
<div id="805d27e8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.concat([joint_prob_at_time(t) <span class="cf">for</span> t <span class="kw">in</span> np.arange(<span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">1</span>)])</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">20</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">time</th>
<th data-quarto-table-cell-role="th">prob</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th rowspan="2" data-quarto-table-cell-role="th" data-valign="top">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>1</td>
<td>0.001899</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>1</td>
<td>0.000081</td>
</tr>
<tr class="odd">
<th rowspan="4" data-quarto-table-cell-role="th" data-valign="top">1</th>
<th rowspan="2" data-quarto-table-cell-role="th" data-valign="top">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>1</td>
<td>0.000349</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>1</td>
<td>0.000095</td>
</tr>
<tr class="odd">
<th rowspan="2" data-quarto-table-cell-role="th" data-valign="top">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>1</td>
<td>0.000078</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>1</td>
<td>0.000002</td>
</tr>
<tr class="odd">
<th rowspan="2" data-quarto-table-cell-role="th" data-valign="top">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>2</td>
<td>0.014296</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>2</td>
<td>0.001170</td>
</tr>
<tr class="odd">
<th rowspan="4" data-quarto-table-cell-role="th" data-valign="top">1</th>
<th rowspan="2" data-quarto-table-cell-role="th" data-valign="top">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>2</td>
<td>0.005031</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>2</td>
<td>0.001562</td>
</tr>
<tr class="odd">
<th rowspan="2" data-quarto-table-cell-role="th" data-valign="top">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>2</td>
<td>0.001349</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>2</td>
<td>0.000074</td>
</tr>
<tr class="odd">
<th rowspan="2" data-quarto-table-cell-role="th" data-valign="top">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>3</td>
<td>0.035299</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>3</td>
<td>0.004107</td>
</tr>
<tr class="odd">
<th rowspan="4" data-quarto-table-cell-role="th" data-valign="top">1</th>
<th rowspan="2" data-quarto-table-cell-role="th" data-valign="top">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>3</td>
<td>0.017660</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>3</td>
<td>0.006096</td>
</tr>
<tr class="odd">
<th rowspan="2" data-quarto-table-cell-role="th" data-valign="top">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>3</td>
<td>0.005474</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>3</td>
<td>0.000402</td>
</tr>
<tr class="odd">
<th rowspan="2" data-quarto-table-cell-role="th" data-valign="top">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>4</td>
<td>0.056682</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>4</td>
<td>0.008252</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="1c40390d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df.pivot(columns<span class="op">=</span><span class="st">'time'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th colspan="9" data-quarto-table-cell-role="th" data-halign="left">prob</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">time</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
</tr>
<tr class="header">
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th rowspan="2" data-quarto-table-cell-role="th" data-valign="top">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>0.001899</td>
<td>0.014296</td>
<td>0.035299</td>
<td>0.056682</td>
<td>0.073525</td>
<td>0.084901</td>
<td>0.091839</td>
<td>0.095772</td>
<td>0.097883</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>0.000081</td>
<td>0.001170</td>
<td>0.004107</td>
<td>0.008252</td>
<td>0.012439</td>
<td>0.015893</td>
<td>0.018383</td>
<td>0.020012</td>
<td>0.021003</td>
</tr>
<tr class="odd">
<th rowspan="4" data-quarto-table-cell-role="th" data-valign="top">1</th>
<th rowspan="2" data-quarto-table-cell-role="th" data-valign="top">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>0.000349</td>
<td>0.005031</td>
<td>0.017660</td>
<td>0.035485</td>
<td>0.053489</td>
<td>0.068342</td>
<td>0.079047</td>
<td>0.086051</td>
<td>0.090314</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>0.000095</td>
<td>0.001562</td>
<td>0.006096</td>
<td>0.013347</td>
<td>0.021546</td>
<td>0.029038</td>
<td>0.034965</td>
<td>0.039188</td>
<td>0.041969</td>
</tr>
<tr class="odd">
<th rowspan="2" data-quarto-table-cell-role="th" data-valign="top">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>0.000078</td>
<td>0.001349</td>
<td>0.005474</td>
<td>0.012319</td>
<td>0.020287</td>
<td>0.027735</td>
<td>0.033737</td>
<td>0.038080</td>
<td>0.040977</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">0</th>
<td>0.000002</td>
<td>0.000074</td>
<td>0.000402</td>
<td>0.001097</td>
<td>0.002069</td>
<td>0.003124</td>
<td>0.004086</td>
<td>0.004862</td>
<td>0.005431</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="dfa78f42-a109-470b-bdbe-ecf75d2b9cec" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>new_graph <span class="op">=</span> discrete_joint_prob(graph, reward_rates, return_graph<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9b7749bd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>new_graph.plot(size<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>), ranksep<span class="op">=</span><span class="fl">0.6</span>, nodesep<span class="op">=</span><span class="fl">0.3</span>, rainbow<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-31-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="coalescent-jointprob-ffi_files/figure-html/cell-31-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="fcddd2ba" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>new_graph.plot(size<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>), ranksep<span class="op">=</span><span class="dv">3</span>, nodesep<span class="op">=</span><span class="fl">0.3</span>, rainbow<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    subgraphfun<span class="op">=</span><span class="kw">lambda</span> state: <span class="st">','</span>.join(<span class="bu">map</span>(<span class="bu">str</span>, state[:nr_samples])),</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    splines<span class="op">=</span><span class="st">'line'</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-32-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="coalescent-jointprob-ffi_files/figure-html/cell-32-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="finite-markov-chains-fmc" class="level2">
<h2 class="anchored" data-anchor-id="finite-markov-chains-fmc">Finite Markov Chains (FMC)</h2>
<section id="distribution-of-steps-spent-in-a-state" class="level3">
<h3 class="anchored" data-anchor-id="distribution-of-steps-spent-in-a-state">Distribution of steps spent in a state</h3>
<div id="27cbebdf" class="cell" data-execution_count="45">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loop():</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> callback(state):</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> state.size:</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [([<span class="dv">1</span>, <span class="dv">0</span>], <span class="fl">0.5</span>), ([<span class="dv">0</span>, <span class="dv">1</span>], <span class="fl">0.5</span>)]</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        transitions <span class="op">=</span> []</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> state.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> transitions</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> state[<span class="dv">0</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>            new_state <span class="op">=</span> state.copy()</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>            new_state[<span class="dv">0</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>            new_state[<span class="dv">1</span>] <span class="op">-=</span> <span class="dv">1</span>            </span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>            transitions.append((new_state, <span class="dv">1</span>))</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>            new_state <span class="op">=</span> state.copy()</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>            new_state[<span class="dv">0</span>] <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>            new_state[<span class="dv">1</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>            transitions.append((new_state, <span class="dv">1</span>))</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>        new_state <span class="op">=</span> state.copy()</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>        new_state[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">9</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>        new_state[<span class="dv">1</span>] <span class="op">=</span> <span class="dv">9</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>        transitions.append((new_state, <span class="dv">1</span>))</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> transitions</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">=</span> Graph(callback<span class="op">=</span>callback)</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> graph</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> loop()</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>graph.plot(rainbow<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-33-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="coalescent-jointprob-ffi_files/figure-html/cell-33-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="01990f01" class="cell" data-execution_count="46">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loop_reward_rates(new_state, current_rewards<span class="op">=</span><span class="va">None</span>, mutation_rate<span class="op">=</span><span class="va">None</span>, reward_limit<span class="op">=</span><span class="dv">10</span>, tot_reward_limit<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    target_state <span class="op">=</span> np.array([<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    reward_limits <span class="op">=</span> np.append(np.repeat(reward_limit, <span class="bu">len</span>(new_state)<span class="op">-</span><span class="dv">1</span>), <span class="dv">0</span>)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    reward_dims <span class="op">=</span> <span class="bu">len</span>(reward_limits)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> current_rewards <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        current_rewards <span class="op">=</span> np.zeros(reward_dims)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> np.zeros(reward_dims)</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    trash_rate <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(reward_dims):</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        rate <span class="op">=</span> new_state[i] <span class="op">*</span> mutation_rate </span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> np.zeros(reward_dims)</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>        r[i] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.<span class="bu">all</span>(new_state <span class="op">==</span> target_state) <span class="kw">and</span> np.<span class="bu">sum</span>(current_rewards <span class="op">+</span> r) <span class="op">&lt;=</span> tot_reward_limit:</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if np.all(current_rewards + r &lt;= reward_limits) and np.sum(current_rewards + r) &lt;= tot_reward_limit:</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>            result[i] <span class="op">=</span> rate</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>            trash_rate <span class="op">=</span> trash_rate <span class="op">+</span> rate</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.append(result, trash_rate)</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a><span class="co"># reward_rates = partial(coalescent_reward_rates, mutation_rate=1, reward_limit=1, tot_reward_limit=2)</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>reward_rates <span class="op">=</span> partial(loop_reward_rates, mutation_rate<span class="op">=</span><span class="dv">1</span>, reward_limit<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>joint_probs <span class="op">=</span> discrete_joint_prob(graph, reward_rates)</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>joint_probs<span class="co">#.head()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[46]</span><span class="ansi-green-fg">, line 31</span>
<span class="ansi-green-fg">     28</span> <span style="font-style:italic;color:rgb(95,135,135)"># reward_rates = partial(coalescent_reward_rates, mutation_rate=1, reward_limit=1, tot_reward_limit=2)</span>
<span class="ansi-green-fg">     29</span> reward_rates = partial(loop_reward_rates, mutation_rate=<span class="ansi-green-fg">1</span>, reward_limit=<span class="ansi-green-fg">2</span>)
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">31</span> joint_probs = <span class="ansi-yellow-bg">discrete_joint_prob</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">graph</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">reward_rates</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">     33</span> joint_probs<span style="font-style:italic;color:rgb(95,135,135)">#.head()</span>

<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[32]</span><span class="ansi-green-fg">, line 145</span>, in <span class="ansi-cyan-fg">discrete_joint_prob</span><span class="ansi-blue-fg">(graph, reward_rates, precision, return_fun, return_graph)</span>
<span class="ansi-green-fg">    142</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> return_fun:
<span class="ansi-green-fg">    143</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> fun
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">145</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">fun</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">decade</span><span class="ansi-yellow-bg">*</span><span class="ansi-green-fg ansi-yellow-bg">10</span><span class="ansi-yellow-bg">)</span>.drop(columns=<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">time</span><span class="ansi-yellow-fg">'</span>)

<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[32]</span><span class="ansi-green-fg">, line 138</span>, in <span class="ansi-cyan-fg">discrete_joint_prob.&lt;locals&gt;.Fun.__call__</span><span class="ansi-blue-fg">(self, tup)</span>
<span class="ansi-green-fg">    124</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span class="ansi-blue-fg">__call__</span>(<span style="color:rgb(0,135,0)">self</span>, tup):
<span class="ansi-green-fg">    125</span> 
<span class="ansi-green-fg">    126</span> <span style="font-style:italic;color:rgb(95,135,135)"># def __call__(self, stop):</span>
<span class="ansi-green-fg">   (...)</span><span class="ansi-green-fg">    135</span> <span style="font-style:italic;color:rgb(95,135,135)">#     joint_probs['prob'] = accum_time</span>
<span class="ansi-green-fg">    136</span> <span style="font-style:italic;color:rgb(95,135,135)">#     joint_probs.set_index(index_cols, inplace=True)</span>
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">138</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">joint_probs</span>

<span class="ansi-red-fg">NameError</span>: name 'joint_probs' is not defined</pre>
</div>
</div>
</div>
<div id="43402c5e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>discrete_joint_prob(graph, reward_rates, return_graph<span class="op">=</span><span class="va">True</span>).plot(size<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>), ranksep<span class="op">=</span><span class="dv">1</span>, nodesep<span class="op">=</span><span class="fl">0.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-35-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="coalescent-jointprob-ffi_files/figure-html/cell-35-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="nr-of-runs-of-a-particular-state" class="level3">
<h3 class="anchored" data-anchor-id="nr-of-runs-of-a-particular-state">Nr of runs of a particular state</h3>
<div id="8c7f625d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>sample_size <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> coalescent(sample_size)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>graph.plot(rainbow<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="81">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-36-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="coalescent-jointprob-ffi_files/figure-html/cell-36-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="67513870" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>new_graph <span class="op">=</span> graph.copy()</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>target_vertex <span class="op">=</span> new_graph.vertex_at(<span class="dv">5</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>new_vertices <span class="op">=</span> []</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> vertex <span class="kw">in</span> new_graph.vertices():</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> edge <span class="kw">in</span> vertex.edges():</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> edge.to() <span class="op">==</span> target_vertex:</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>            <span class="co"># create new vertex</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>            new_vertex <span class="op">=</span> new_graph.find_or_create_vertex(np.repeat(<span class="op">-</span>vertex.index(), vertex.state().size))</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>            <span class="co"># make edge point that instead</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>            edge.update_to(new_vertex)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>            <span class="co"># add edge from new_vertex to target_vertex with weight 1</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>            new_vertex.add_edge(target_vertex, <span class="dv">1</span>)</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># keep index of added vertex</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>            new_vertices.append(new_vertex.index())</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a><span class="co"># rewards = make_discrete(new_graph, mutation_rate, skip=new_vertices)</span></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>rewards <span class="op">=</span> make_discrete(new_graph, <span class="dv">1</span>, skip_states<span class="op">=</span>new_vertices)</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rewards)</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>rev <span class="op">=</span> np.zeros(new_graph.vertices_length())</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> new_vertices:</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>    rev[i] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(new_graph.expectation(rev))</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a><span class="co"># print(new_graph.accumulated_visiting_time(10))</span></span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(new_graph.accumulated_visits_discrete(<span class="dv">1000</span>))</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>new_graph.plot(rainbow<span class="op">=</span><span class="va">True</span>, size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 1. 1. 0. 1. 0. 0. 0. 0. 0. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 1. 0. 1. 0. 0. 0. 0. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]]
0.5
[0.0, 1.5, 1.6666666666666654, 0.9999999999999998, 0.9999999999999997, 1.5000000000000009, 1.5000000000000009, 0.0, 0.3333333333333333, 0.16666666666666666, 0.49999999999999983, 0.5000000000000001, 0.16666666666666663, 0.16666666666666666, 0.3333333333333333, 0.3333333333333333, 0.16666666666666666, 0.5, 0.5, 0.5, 0.5]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: building reward compute graph...</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="82">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-37-output-3.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="coalescent-jointprob-ffi_files/figure-html/cell-37-output-3.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="6ae8d8c1" class="cell" data-execution_count="67">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loop(state):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> state.size:</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [([<span class="dv">1</span>], <span class="dv">1</span>)]</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> state[<span class="dv">0</span>] <span class="op">&lt;</span> <span class="dv">3</span>:</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [(state<span class="op">+</span><span class="dv">1</span>, <span class="dv">4</span>)]</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> ptd.Graph(callback<span class="op">=</span>loop)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>graph.plot()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="67">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-38-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="coalescent-jointprob-ffi_files/figure-html/cell-38-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="05d76bde" class="cell" data-execution_count="68">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>graph.expectation(), graph.expected_waiting_time()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: building reward compute graph...</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>(0.5, [0.5, 0.5, 0.25, 0.0])</code></pre>
</div>
</div>
<div id="3c1ac8ea" class="cell" data-execution_count="64">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>discr_graph, discr_rewards <span class="op">=</span> graph.discretize(reward_rate<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>discr_graph.plot()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-40-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="coalescent-jointprob-ffi_files/figure-html/cell-40-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="718c19c2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: building reward compute graph...</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>(0.5, [0.5, 0.5, 0.25, 0.0])</code></pre>
</div>
</div>
<div id="34adcba0" class="cell" data-execution_count="58">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>np.<span class="bu">sum</span>(discr_rewards, axis<span class="op">=</span><span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>array([0, 0, 0, 0, 1, 1])</code></pre>
</div>
</div>
<div id="c553e1b0" class="cell" data-execution_count="61">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>discr_graph.expected_waiting_time()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>[3.4999999999999996,
 3.4999999999999996,
 1.9999999999999996,
 0.0,
 4.5,
 2.9999999999999996]</code></pre>
</div>
</div>
<div id="8b3ef695" class="cell" data-execution_count="59">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>discr_graph.expectation(np.<span class="bu">sum</span>(discr_rewards, axis<span class="op">=</span><span class="dv">0</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>0.7499999999999999</code></pre>
</div>
</div>
<div id="e22d29bb" class="cell" data-execution_count="60">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>np.<span class="bu">sum</span>(discr_rewards, axis<span class="op">=</span><span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>array([0, 0, 0, 0, 1, 1])</code></pre>
</div>
</div>
<div id="14b3609f" class="cell" data-execution_count="44">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>discr_graph.expectation(discr_rewards)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">TypeError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[44], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> <span class="ansi-yellow-bg">discr_graph</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">expectation</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">discr_rewards</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">TypeError</span>: expectation(): incompatible function arguments. The following argument types are supported:
    1. (self: ptdalgorithms.ptdalgorithmscpp_pybind.Graph, rewards: list[float] = []) -&gt; float

Invoked with: &lt;Graph (6 vertices)&gt;, array([[0, 0, 0, 0, 1, 1]])</pre>
</div>
</div>
</div>
<div id="5f5330e7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>graph.expectation(np.<span class="bu">sum</span>(discr_rewards, axis<span class="op">=</span><span class="dv">1</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>array([2])</code></pre>
</div>
</div>
<div id="3c4f8240" class="cell" data-execution_count="42">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>discr_graph.expectation(rewards <span class="op">=</span> np.<span class="bu">sum</span>(discr_rewards, axis<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="co">#graph.expectation(np.sum(discr_rewards, axis=1) * 0.1)</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[42], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> <span class="ansi-yellow-bg">discr_graph</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">expectation</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">rewards</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">np</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">sum</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">discr_rewards</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">axis</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">1</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">      2</span> <span style="font-style:italic;color:rgb(95,135,135)">#graph.expectation(np.sum(discr_rewards, axis=1) * 0.1)</span>

<span class="ansi-red-fg">RuntimeError</span>: Failed: Rewards must match the number of vertices. Expected 6, got 1</pre>
</div>
</div>
</div>
<div id="f749e493" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loop():</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> callback(state):</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>        transitions <span class="op">=</span> []</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> state[<span class="dv">0</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>            new_state <span class="op">=</span> state[:]</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>            new_state[<span class="dv">0</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>            new_state[<span class="dv">1</span>] <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>            transitions.append((new_state, <span class="dv">1</span>))</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>            new_state <span class="op">=</span> state[:]</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>            new_state[<span class="dv">0</span>] <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>            new_state[<span class="dv">1</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>            transitions.append((new_state, <span class="dv">1</span>))</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> transitions</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">=</span> ptd.Graph(callback<span class="op">=</span>callback, initial<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> graph</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> loop()</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>graph.plot(rainbow<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="199">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-49-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-17"><img src="coalescent-jointprob-ffi_files/figure-html/cell-49-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="i-could-add-an-fmc-argument-that-adds-a-slot-to-initial-and-increments-that-for-all-states-returned-by-callback" class="level3">
<h3 class="anchored" data-anchor-id="i-could-add-an-fmc-argument-that-adds-a-slot-to-initial-and-increments-that-for-all-states-returned-by-callback">I could add an fmc argument that adds a slot to initial and increments that for all states returned by callback</h3>
<div id="1110f440" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loop():</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> callback(state):</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> state.size:</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [([<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>], <span class="dv">1</span>)]</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> state[<span class="dv">2</span>] <span class="op">==</span> <span class="dv">5</span>:</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> state[<span class="dv">0</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>            new_state <span class="op">=</span> state[:]</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>            new_state[<span class="dv">0</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>            new_state[<span class="dv">1</span>] <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>            new_state[<span class="dv">2</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [(new_state, <span class="dv">1</span>)]</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>            new_state <span class="op">=</span> state[:]</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>            new_state[<span class="dv">0</span>] <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>            new_state[<span class="dv">1</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>            new_state[<span class="dv">2</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [(new_state, <span class="dv">1</span>)]</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">=</span> ptd.Graph(callback<span class="op">=</span>callback)</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> graph</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> loop()</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>graph.plot(rainbow<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="87">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-50-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-18"><img src="coalescent-jointprob-ffi_files/figure-html/cell-50-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="c459c1d3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>rewards <span class="op">=</span> make_discrete(graph, <span class="dv">1</span>, skip_slots<span class="op">=</span>[graph.state_length()<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>graph.plot(rainbow<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="88">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-51-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-19"><img src="coalescent-jointprob-ffi_files/figure-html/cell-51-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="2ab778e0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>graph.states()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="202">
<pre><code>array([[0, 0, 0],
       [1, 0, 0],
       [0, 1, 1],
       [1, 0, 2],
       [0, 1, 3],
       [1, 0, 4],
       [0, 1, 5],
       [0, 0, 0],
       [0, 0, 0],
       [0, 0, 0],
       [0, 0, 0],
       [0, 0, 0]], dtype=int32)</code></pre>
</div>
</div>
<div id="aeb37f80" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>graph.accumulated_visits_discrete(<span class="dv">1000</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="203">
<pre><code>[0.0,
 2.0,
 1.9999999999999998,
 2.0,
 1.9999999999999996,
 2.0,
 0.0,
 1.0,
 0.9999999999999999,
 1.0,
 0.9999999999999998,
 1.0]</code></pre>
</div>
</div>
</section>
<section id="length-of-longest-run-of-a-state-in-an-fmc" class="level3">
<h3 class="anchored" data-anchor-id="length-of-longest-run-of-a-state-in-an-fmc">Length of longest run of a state in an FMC</h3>
<div id="ac6807d1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># D: A-&gt;A</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="co"># A: A-&gt;B</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="co"># B: B-&gt;A</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="co"># D: B-&gt;B</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> maxlen():</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> callback(state):</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>        A, B, C, D <span class="op">=</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> state.size:</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [([<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>], <span class="dv">1</span>)]</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>        x, y, z <span class="op">=</span> state</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>        max_y, max_z <span class="op">=</span> <span class="dv">2</span>, <span class="dv">6</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>        absorb <span class="op">=</span> (<span class="dv">0</span>, max_y, max_z)</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># absorb = (0, 0, 0)</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.<span class="bu">all</span>(state <span class="op">==</span> absorb):</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>        trash1, trash2 <span class="op">=</span> (<span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>), (<span class="op">-</span><span class="dv">2</span>, <span class="op">-</span><span class="dv">2</span>, <span class="op">-</span><span class="dv">2</span>)</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># trash1, trash2 = (0, 0, 0), (0, 0, 0)</span></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.<span class="bu">all</span>(state <span class="op">==</span> trash1):</span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [(trash2, <span class="dv">1</span>)]</span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.<span class="bu">all</span>(state <span class="op">==</span> trash2):</span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [(trash1, <span class="dv">1</span>)]</span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> z<span class="op">+</span><span class="dv">1</span> <span class="op">==</span> max_z:</span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [(absorb, <span class="dv">1</span>)]</span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> y <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [((x, y, z<span class="op">+</span><span class="dv">1</span>), C<span class="op">/</span>(B<span class="op">+</span>C)),</span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>                    ((x, y<span class="op">+</span><span class="dv">1</span>, z<span class="op">+</span><span class="dv">1</span>), A<span class="op">/</span>(A<span class="op">+</span>D))]</span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> y <span class="op">==</span> max_y:</span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [(trash1, D<span class="op">/</span>(A<span class="op">+</span>D)), <span class="co"># trash</span></span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>                    ((y, <span class="dv">0</span>, z<span class="op">+</span><span class="dv">1</span>), B<span class="op">/</span>(B<span class="op">+</span>C))]</span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [((x, y<span class="op">+</span><span class="dv">1</span>, z<span class="op">+</span><span class="dv">1</span>), D<span class="op">/</span>(A<span class="op">+</span>D)),</span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a>                ((y, <span class="dv">0</span>, z<span class="op">+</span><span class="dv">1</span>), B<span class="op">/</span>(B<span class="op">+</span>C))]</span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">=</span> ptd.Graph(callback<span class="op">=</span>callback)</span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> graph</span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> maxlen()</span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a>graph.plot(rainbow<span class="op">=</span><span class="va">True</span>, ranksep<span class="op">=</span><span class="dv">1</span>, nodesep<span class="op">=</span><span class="fl">0.3</span>, size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="112">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-54-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-20"><img src="coalescent-jointprob-ffi_files/figure-html/cell-54-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="262b5946" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>graph.states()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="230">
<pre><code>array([[0, 0, 0],
       [1, 0, 0],
       [1, 0, 1],
       [1, 1, 1],
       [1, 0, 2],
       [1, 1, 2],
       [1, 2, 2],
       [0, 0, 0],
       [0, 0, 1],
       [0, 1, 1],
       [0, 0, 2],
       [0, 1, 2],
       [0, 2, 2]], dtype=int32)</code></pre>
</div>
</div>
<div id="49be9860-add0-4ab4-bff4-03c4677f747b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>joint_probs <span class="op">%&gt;%</span> <span class="bu">filter</span>(V1<span class="op">==</span><span class="dv">1</span>, V2<span class="op">==</span><span class="dv">0</span>, V3<span class="op">==</span><span class="dv">1</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small">
<caption>A data.frame: 1 × 5</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">V1</th>
<th data-quarto-table-cell-role="th" scope="col">V2</th>
<th data-quarto-table-cell-role="th" scope="col">V3</th>
<th data-quarto-table-cell-role="th" scope="col">V4</th>
<th data-quarto-table-cell-role="th" scope="col">accum_time</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0.03111111</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>With <code>sample_size &lt;- 4</code>, <code>mutation_rate &lt;- 1</code>, <code>reward_limits &lt;- rep(20, sample_size-1)</code>, and <code>tot_reward_limit &lt;- Inf</code>, tothe marginal probabilities match the SFS:</p>
<pre><code>c(sum(joint_probs$V1 * joint_probs$accum_time), 
  sum(joint_probs$V2 * joint_probs$accum_time), 
  sum(joint_probs$V3 * joint_probs$accum_time))</code></pre>
<pre><code>1.99981743759578 0.998152771395828 0.666638375487117</code></pre>
<p>and the joint prob of a singleton and a trippleton is:</p>
<pre><code>1   0   1   0.03111111</code></pre>
<p>which is exactly what we also get with <code>reward_limits &lt;- rep(1, sample_size-1)</code>.</p>
<p>Setting <code>tot_reward_limit &lt;- 2</code> also produces <code>0.03111111</code>.</p>
<div id="7920bcae-7a9f-45da-82d4-4ade2c6fb72e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>joint_probs <span class="op">%&gt;%</span> rename_with(gsub, pattern<span class="op">=</span><span class="st">"V"</span>, replacement<span class="op">=</span><span class="st">"ton"</span>) <span class="op">%&gt;%</span> group_by(ton1, ton2) <span class="op">%&gt;%</span> summarize(prob<span class="op">=</span><span class="bu">sum</span>(accum_time), .groups<span class="op">=</span><span class="st">"keep"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small">
<caption>A grouped_df: 4 × 3</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">ton1</th>
<th data-quarto-table-cell-role="th" scope="col">ton2</th>
<th data-quarto-table-cell-role="th" scope="col">prob</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>0.12222222</td>
</tr>
<tr class="even">
<td>0</td>
<td>1</td>
<td>0.04259259</td>
</tr>
<tr class="odd">
<td>1</td>
<td>0</td>
<td>0.12666667</td>
</tr>
<tr class="even">
<td>1</td>
<td>1</td>
<td>0.03777778</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="f54088fd-f165-46b6-bf9d-dd93f40e1120" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>plot_df <span class="op">&lt;-</span> joint_probs <span class="op">%&gt;%</span> </span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>    rename_with(gsub, pattern<span class="op">=</span><span class="st">"V"</span>, replacement<span class="op">=</span><span class="st">"ton"</span>) <span class="op">%&gt;%</span> </span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    group_by(ton1, ton2) <span class="op">%&gt;%</span> </span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    summarize(prob<span class="op">=</span><span class="bu">sum</span>(accum_time), .groups<span class="op">=</span><span class="st">"keep"</span>)</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (colname <span class="kw">in</span> colnames(plot_df)) {</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (startsWith(colname, <span class="st">'ton'</span>)) {</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>        plot_df[[colname]] <span class="op">&lt;-</span> <span class="im">as</span>.factor(plot_df[[colname]])</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>ggplot(plot_df, aes(x<span class="op">=</span>ton1, y<span class="op">=</span>ton2)) <span class="op">+</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>    geom_tile(aes(fill <span class="op">=</span> prob)) <span class="op">+</span> </span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>    geom_text(aes(label <span class="op">=</span> <span class="bu">round</span>(prob, <span class="dv">3</span>))) <span class="op">+</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>    scale_fill_viridis() <span class="op">+</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># scale_fill_distiller(palette = 'PiYG',direction = 1,</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                 limit=max(abs(plot_df$prob)) * c(-1, 1)</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                 ) +</span></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>     theme(panel.grid.major <span class="op">=</span> element_blank(), </span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>            panel.grid.minor <span class="op">=</span> element_blank(), </span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>            text<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">17</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-58-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-21"><img src="coalescent-jointprob-ffi_files/figure-html/cell-58-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="49fbab45-6e6d-49cc-93b4-33ead5c1b2cd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># map_state &lt;- function(state) {</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="co">#         lumped_state &lt;- c(sum(state[1:sample_size]), head(state, sample_size) * (reward_limits - tail(state, sample_size)))</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="co">#         lumped_state &lt;- as.integer(lumped_state)</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="co">#         return(lumped_state)</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="co"># label_fun &lt;- function(state, index) {</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     return(paste(map_state(state), collapse=""))</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="co"># if (vertices_length(graph) &lt; 30) {    </span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     new_graph &lt;- discrete_joint_prob(graph, reward_rates, return_graph=TRUE)</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     plot_graph(graph_as_matrix(new_graph), size=c(10, 10), align=TRUE, #rainbow=TRUE,</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a><span class="co">#                    fontsize=26, ranksep=4, nodesep=0.9, rankdir="LR",</span></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a><span class="co">#               subgraphs=TRUE, subgraphfun=label_fun,</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a><span class="co">#               # subgraphs=TRUE, subgraphfun=function(state, index) sum(head(state, sample_size)),</span></span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a><span class="co">#             splines='line'</span></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a><span class="co">#               )  </span></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a><span class="co"># }           </span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="0451910e-9280-4b08-9d34-f070329e09bc" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>graph_vec <span class="op">&lt;-</span> c()</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>new_graph_vec <span class="op">&lt;-</span> c()</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>sample_sizes <span class="op">&lt;-</span> <span class="dv">4</span>:<span class="dv">15</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (sample_size <span class="kw">in</span> sample_sizes) {</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">&lt;-</span> standard_coalescent(sample_size)</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    graph_vec <span class="op">&lt;-</span> c(graph_vec, vertices_length(graph))</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    reward_limits <span class="op">&lt;-</span> c(rep(<span class="dv">1</span>, sample_size<span class="op">-</span><span class="dv">1</span>), <span class="dv">0</span>)</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    tot_reward_limit <span class="op">&lt;-</span> Inf</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>    new_graph <span class="op">&lt;-</span> discrete_joint_prob(graph, reward_rates, return_graph<span class="op">=</span>TRUE)</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># new_graph &lt;- discrete_joint_prob(graph, reward_limits, mutation_rate, reward_possible, tot_reward_limit=tot_reward_limit, return_graph=TRUE)</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>    new_graph_vec <span class="op">&lt;-</span> c(new_graph_vec, vertices_length(new_graph))</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># new_graph_vec &lt;- c(new_graph_vec, length(unique(apply(apply(states(new_graph), 1, map_state), 2, paste, collapse=""))))</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>1000 1311 
1000 1443 
2000 2178 
1000 1579 
2000 2687 
3000 3185 
1000 1656 
2000 2979 
3000 3930 
4000 4451 </code></pre>
</div>
</div>
<div id="1e1ac977-b555-4cb6-b7b7-b45a94632abd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>theme_set(theme_bw() <span class="op">+</span> theme(axis.line <span class="op">=</span> element_line(colour <span class="op">=</span> <span class="st">"black"</span>),</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>                 text<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">17</span>),</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>                 axis.text <span class="op">=</span> element_text(size<span class="op">=</span><span class="dv">15</span>),</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>                 plot.margin <span class="op">=</span> unit(c(<span class="fl">0.3</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>), <span class="st">"inch"</span>)))</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>palette <span class="op">&lt;-</span> c(<span class="st">"#888888"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>, <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span>)</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>opt <span class="op">&lt;-</span> options(<span class="bu">repr</span>.plot.width<span class="op">=</span><span class="dv">7</span>, <span class="bu">repr</span>.plot.height<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>               ggplot2.discrete.colour<span class="op">=</span>palette, ggplot2.discrete.fill<span class="op">=</span>palette) <span class="op">;</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>despine <span class="op">&lt;-</span>  theme(panel.border <span class="op">=</span> element_blank(), </span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>                 panel.grid.major <span class="op">=</span> element_blank(),</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>                 panel.grid.minor <span class="op">=</span> element_blank())</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>library(gridExtra)</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>df <span class="op">&lt;-</span> data.frame(</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>  samples <span class="op">=</span> sample_sizes,</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>  graph_states <span class="op">=</span> graph_vec,</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>  new_graph_states <span class="op">=</span>new_graph_vec</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>df_long <span class="op">&lt;-</span> pivot_longer(df, c(graph_states, new_graph_states))</span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>p1 <span class="op">&lt;-</span> ggplot(df_long, aes(x<span class="op">=</span>samples, y<span class="op">=</span>value, color<span class="op">=</span>name)) <span class="op">+</span></span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>    geom_line(linewidth<span class="op">=</span><span class="dv">1</span>) <span class="op">+</span> geom_point(size<span class="op">=</span><span class="dv">3</span>) <span class="op">+</span> </span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>    despine <span class="op">+</span></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>    xlim(<span class="dv">0</span>, NA) <span class="op">+</span> ylim(<span class="dv">0</span>, NA) <span class="op">+</span></span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">"Sample size"</span>, y<span class="op">=</span><span class="st">"Vertices"</span>, color<span class="op">=</span><span class="st">"Graph"</span>) <span class="op">+</span></span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>    scale_color_discrete(labels <span class="op">=</span> c(<span class="st">"Original"</span>, <span class="st">"Augmented"</span>))</span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a>p2 <span class="op">&lt;-</span> ggplot(df, aes(x<span class="op">=</span>samples, y<span class="op">=</span>new_graph_vec <span class="op">/</span> graph_vec)) <span class="op">+</span> </span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a>    geom_line(linewidth<span class="op">=</span><span class="dv">1</span>) <span class="op">+</span> geom_point(size<span class="op">=</span><span class="dv">3</span>) <span class="op">+</span> </span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a>    geom_abline(slope<span class="op">=</span><span class="dv">1</span>, intercept<span class="op">=</span><span class="dv">0</span>) <span class="op">+</span></span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geom_abline(slope=0.25, intercept=1.5) +</span></span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a>    despine <span class="op">+</span></span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a>    xlim(<span class="dv">0</span>, NA) <span class="op">+</span> ylim(<span class="dv">0</span>, NA) <span class="op">+</span></span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">"Sample size"</span>, y<span class="op">=</span><span class="st">"Augmented / original vertices"</span>, color<span class="op">=</span><span class="st">"Graph"</span>)</span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a>opt <span class="op">&lt;-</span> options(<span class="bu">repr</span>.plot.width<span class="op">=</span><span class="dv">12</span>, <span class="bu">repr</span>.plot.height<span class="op">=</span><span class="fl">5.5</span>)</span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a>grid.arrange(p1, p2, nrow <span class="op">=</span> <span class="dv">1</span>, widths <span class="op">=</span> <span class="dv">3</span>:<span class="dv">2</span>)</span>
<span id="cb88-35"><a href="#cb88-35" aria-hidden="true" tabindex="-1"></a>options(opt) <span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-61-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-22"><img src="coalescent-jointprob-ffi_files/figure-html/cell-61-output-1.png" width="720" height="330" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="e72d9b43-6d4e-405c-b820-212fbb9bdb40" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># nr_states_vec &lt;- c()</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="co"># nr_lumped_states_vec &lt;- c()</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="co"># sample_sizes &lt;- 4:10</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for (sample_size in sample_sizes) {</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     graph &lt;- standard_coalescent(sample_size)</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     state_length &lt;- length(vertex_at(graph, 1)$state)</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     # last state index is absorbing where no rewards can be earned</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     reward_limits &lt;- c(rep(1, state_length-1), 0)    </span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     new_graph &lt;- discrete_joint_prob(graph, reward_rates, return_graph=TRUE)</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     # new_graph &lt;- discrete_joint_prob(graph, reward_limits, mutation_rate, reward_possible, return_graph=TRUE)</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     nr_states_vec &lt;- c(nr_states_vec, vertices_length(new_graph))</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     nr_lumped_states_vec &lt;- c(nr_lumped_states_vec, length(unique(apply(apply(states(new_graph), 1, map_state), 2, paste, collapse=""))))</span></span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a><span class="co"># df &lt;- data.frame(</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   samples = sample_sizes,</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   nr_states = nr_states_vec,</span></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   nr_lumped_states =nr_lumped_states_vec</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a><span class="co"># df_long &lt;- pivot_longer(df, c(nr_states, nr_lumped_states))</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(df_long, aes(x=samples, y=value, hue=name)) + geom_line() + geom_point()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="two-locus-arg" class="level2">
<h2 class="anchored" data-anchor-id="two-locus-arg">Two-locus ARG</h2>
<div id="40264356-a7d3-4cb8-8239-a2a2628fa771" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>Rcpp::sourceCpp(<span class="st">"./cpp/index_prop_mapping.cpp"</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>two_locus_arg <span class="op">&lt;-</span> function(s, N, R) {</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># state vector length</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    n <span class="op">&lt;-</span> (s<span class="op">+</span><span class="dv">1</span>)<span class="op">**</span><span class="dv">2</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">&lt;-</span> create_graph(n)</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    index <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># first_vertex &lt;- create_vertex(graph, c(rep(0, s+2), s, rep(0, n-s-3))) # assumes that p=2</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>    state <span class="op">&lt;-</span> rep(<span class="dv">0</span>, n)</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>    state[props_to_index_two_locus(s, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)] <span class="op">&lt;-</span> s</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>    first_vertex <span class="op">&lt;-</span> find_or_create_vertex(graph, state) <span class="co"># assumes that p=2</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>    add_edge(starting_vertex(graph), first_vertex, <span class="dv">1</span>)</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>    index <span class="op">&lt;-</span> <span class="dv">2</span></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (index <span class="op">&lt;=</span> vertices_length(graph)) {</span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>      vertex <span class="op">&lt;-</span> vertex_at(graph, index)</span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>      state <span class="op">&lt;-</span> vertex$state</span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>      count <span class="op">&lt;-</span> <span class="dv">0</span></span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:n) {</span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>          count <span class="op">&lt;-</span> count <span class="op">+</span> state[i]</span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (count <span class="op">&lt;=</span> <span class="dv">1</span>) {</span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Only one lineage, stop</span></span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a>          index <span class="op">&lt;-</span> index <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a>          <span class="bu">next</span></span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a>      }    </span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:n) {</span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (state[i] <span class="op">==</span> <span class="dv">0</span>) <span class="bu">next</span></span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-35"><a href="#cb90-35" aria-hidden="true" tabindex="-1"></a>        conf_i <span class="op">&lt;-</span> index_to_props_two_locus(s, i)</span>
<span id="cb90-36"><a href="#cb90-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-37"><a href="#cb90-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># coalescence #########################</span></span>
<span id="cb90-38"><a href="#cb90-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="kw">in</span> i:n) {</span>
<span id="cb90-39"><a href="#cb90-39" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (state[j] <span class="op">==</span> <span class="dv">0</span>) <span class="bu">next</span></span>
<span id="cb90-40"><a href="#cb90-40" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb90-41"><a href="#cb90-41" aria-hidden="true" tabindex="-1"></a>          conf_j <span class="op">&lt;-</span> index_to_props_two_locus(s, j)</span>
<span id="cb90-42"><a href="#cb90-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-43"><a href="#cb90-43" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (i <span class="op">==</span> j) {</span>
<span id="cb90-44"><a href="#cb90-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (state[i] <span class="op">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb90-45"><a href="#cb90-45" aria-hidden="true" tabindex="-1"></a>              <span class="bu">next</span><span class="op">;</span></span>
<span id="cb90-46"><a href="#cb90-46" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb90-47"><a href="#cb90-47" aria-hidden="true" tabindex="-1"></a>            rate <span class="op">&lt;-</span> state[i] <span class="op">*</span> (state[i] <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> <span class="dv">2</span> <span class="op">/</span> N</span>
<span id="cb90-48"><a href="#cb90-48" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb90-49"><a href="#cb90-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (state[i] <span class="op">&lt;</span> <span class="dv">1</span> <span class="op">||</span> state[j] <span class="op">&lt;</span> <span class="dv">1</span>) {</span>
<span id="cb90-50"><a href="#cb90-50" aria-hidden="true" tabindex="-1"></a>              <span class="bu">next</span><span class="op">;</span></span>
<span id="cb90-51"><a href="#cb90-51" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb90-52"><a href="#cb90-52" aria-hidden="true" tabindex="-1"></a>            rate <span class="op">&lt;-</span> state[i] <span class="op">*</span> state[j] <span class="op">/</span> N</span>
<span id="cb90-53"><a href="#cb90-53" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb90-54"><a href="#cb90-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-55"><a href="#cb90-55" aria-hidden="true" tabindex="-1"></a>          child_state <span class="op">&lt;-</span> state</span>
<span id="cb90-56"><a href="#cb90-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb90-57"><a href="#cb90-57" aria-hidden="true" tabindex="-1"></a>          <span class="co"># lineages with index i and j coalesce:  </span></span>
<span id="cb90-58"><a href="#cb90-58" aria-hidden="true" tabindex="-1"></a>          child_state[i] <span class="op">&lt;-</span> child_state[i] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb90-59"><a href="#cb90-59" aria-hidden="true" tabindex="-1"></a>          child_state[j] <span class="op">&lt;-</span> child_state[j] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb90-60"><a href="#cb90-60" aria-hidden="true" tabindex="-1"></a>          stopifnot(conf_i$descendants_l1<span class="op">+</span>conf_j$descendants_l1 <span class="op">&lt;=</span> s)</span>
<span id="cb90-61"><a href="#cb90-61" aria-hidden="true" tabindex="-1"></a>          stopifnot(conf_i$descendants_l2<span class="op">+</span>conf_j$descendants_l2 <span class="op">&lt;=</span> s)</span>
<span id="cb90-62"><a href="#cb90-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-63"><a href="#cb90-63" aria-hidden="true" tabindex="-1"></a>          <span class="co"># coalescene into lineage with index k</span></span>
<span id="cb90-64"><a href="#cb90-64" aria-hidden="true" tabindex="-1"></a>          k <span class="op">=</span> props_to_index_two_locus(s, conf_i$descendants_l1<span class="op">+</span>conf_j$descendants_l1, conf_i$descendants_l2<span class="op">+</span>conf_j$descendants_l2)</span>
<span id="cb90-65"><a href="#cb90-65" aria-hidden="true" tabindex="-1"></a>          child_state[k] <span class="op">&lt;-</span> child_state[k] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb90-66"><a href="#cb90-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-67"><a href="#cb90-67" aria-hidden="true" tabindex="-1"></a>          child_vertex <span class="op">&lt;-</span> find_or_create_vertex(graph, child_state)</span>
<span id="cb90-68"><a href="#cb90-68" aria-hidden="true" tabindex="-1"></a>          add_edge(vertex, child_vertex, rate)</span>
<span id="cb90-69"><a href="#cb90-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-70"><a href="#cb90-70" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb90-71"><a href="#cb90-71" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb90-72"><a href="#cb90-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-73"><a href="#cb90-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># recombination #######################</span></span>
<span id="cb90-74"><a href="#cb90-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (state[i] <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> conf_i$descendants_l1 <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> conf_i$descendants_l2 <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb90-75"><a href="#cb90-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-76"><a href="#cb90-76" aria-hidden="true" tabindex="-1"></a>          <span class="co"># </span><span class="al">TODO</span><span class="co">: make sure this should not be R * state[i]</span></span>
<span id="cb90-77"><a href="#cb90-77" aria-hidden="true" tabindex="-1"></a>          rate <span class="op">&lt;-</span> R <span class="co">#* state[i] </span></span>
<span id="cb90-78"><a href="#cb90-78" aria-hidden="true" tabindex="-1"></a>          child_state <span class="op">&lt;-</span> state</span>
<span id="cb90-79"><a href="#cb90-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-80"><a href="#cb90-80" aria-hidden="true" tabindex="-1"></a>          <span class="co"># a lineage with index i recombines to produce lineages with index k and l</span></span>
<span id="cb90-81"><a href="#cb90-81" aria-hidden="true" tabindex="-1"></a>          k <span class="op">=</span> props_to_index_two_locus(s, conf_i$descendants_l1, <span class="dv">0</span>)</span>
<span id="cb90-82"><a href="#cb90-82" aria-hidden="true" tabindex="-1"></a>          l <span class="op">=</span> props_to_index_two_locus(s, <span class="dv">0</span>, conf_i$descendants_l2)</span>
<span id="cb90-83"><a href="#cb90-83" aria-hidden="true" tabindex="-1"></a>          child_state[i] <span class="op">&lt;-</span> child_state[i] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb90-84"><a href="#cb90-84" aria-hidden="true" tabindex="-1"></a>          child_state[k] <span class="op">&lt;-</span> child_state[k] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb90-85"><a href="#cb90-85" aria-hidden="true" tabindex="-1"></a>          child_state[l] <span class="op">&lt;-</span> child_state[l] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb90-86"><a href="#cb90-86" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb90-87"><a href="#cb90-87" aria-hidden="true" tabindex="-1"></a>          child_vertex <span class="op">&lt;-</span> find_or_create_vertex(graph, child_state)</span>
<span id="cb90-88"><a href="#cb90-88" aria-hidden="true" tabindex="-1"></a>          add_edge(vertex, child_vertex, rate)</span>
<span id="cb90-89"><a href="#cb90-89" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb90-90"><a href="#cb90-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-91"><a href="#cb90-91" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb90-92"><a href="#cb90-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-93"><a href="#cb90-93" aria-hidden="true" tabindex="-1"></a>      index <span class="op">&lt;-</span> index <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb90-94"><a href="#cb90-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-95"><a href="#cb90-95" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if ((index %% 50) == 0) {</span></span>
<span id="cb90-96"><a href="#cb90-96" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   cat(index, vertices_length(graph), "\n")</span></span>
<span id="cb90-97"><a href="#cb90-97" aria-hidden="true" tabindex="-1"></a>      <span class="co"># }</span></span>
<span id="cb90-98"><a href="#cb90-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-99"><a href="#cb90-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb90-100"><a href="#cb90-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-101"><a href="#cb90-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(graph)</span>
<span id="cb90-102"><a href="#cb90-102" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6c857476" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>arg_reward_rates <span class="op">&lt;-</span> function(new_state, current_rewards, mutation_rate, reward_limit, locus_ton_reward_limit)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>{    </span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    reward_limits <span class="op">&lt;-</span> c(rep(reward_limit, length(new_state)<span class="op">-</span><span class="dv">1</span>), <span class="dv">0</span>)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    reward_limits <span class="op">&lt;-</span> c(reward_limits, reward_limits) <span class="co"># duplicate to account for separate mutations at each locus</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    reward_dims <span class="op">&lt;-</span> length(reward_limits)</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">is</span>.null(current_rewards))</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>        current_rewards <span class="op">&lt;-</span> rep(<span class="dv">0</span>, reward_dims)</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a><span class="co"># allowed_l1 &lt;- sapply(1:(reward_dims %/% 2), function(i) index_to_props_two_locus(sample_size, i)$descendants_l1 &gt; 0)</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="co"># allowed_l2 &lt;- sapply((reward_dims %/% 2 + 1):reward_dims, function(i) index_to_props_two_locus(sample_size, i)$descendants_l2 &gt; 0)                   </span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a><span class="co"># allowed_mask &lt;- as.integer(c(allowed_l1, allowed_l2))</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>    result <span class="op">&lt;-</span> rep(<span class="dv">0</span>, reward_dims)</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>    trash_rate <span class="op">&lt;-</span> <span class="dv">0</span></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:reward_dims) {</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>        rate <span class="op">&lt;-</span> new_state[(i<span class="op">-</span><span class="dv">1</span>) <span class="op">%%</span> (reward_dims <span class="op">%/%</span> <span class="dv">2</span>) <span class="op">+</span> <span class="dv">1</span>] <span class="op">*</span> mutation_rate <span class="co"># fancy index to map state index to duplicted reward index</span></span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>        r <span class="op">&lt;-</span> rep(<span class="dv">0</span>, reward_dims)</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>        r[i] <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a>        proposed_rewards <span class="op">&lt;-</span> current_rewards <span class="op">+</span> r</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ( <span class="bu">all</span>(proposed_rewards <span class="op">&lt;=</span> reward_limits) <span class="op">&amp;&amp;</span> </span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a>            <span class="bu">sum</span>(head(proposed_rewards, reward_dims <span class="op">%/%</span> <span class="dv">2</span>)) <span class="op">&lt;=</span> locus_ton_reward_limit <span class="op">&amp;&amp;</span> </span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">sum</span>(tail(proposed_rewards, reward_dims <span class="op">%/%</span> <span class="dv">2</span>)) <span class="op">&lt;=</span> locus_ton_reward_limit ) {</span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a>            result[i] <span class="op">&lt;-</span> rate</span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a>            trash_rate <span class="op">&lt;-</span> trash_rate <span class="op">+</span> rate</span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a>    }     </span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(c(result, trash_rate))</span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a>sample_size <span class="op">&lt;-</span> <span class="dv">4</span></span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a>graph <span class="op">&lt;-</span> two_locus_arg(sample_size, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true" tabindex="-1"></a>vertices_length(graph)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
110
</div>
</div>
<div id="2beabc99-62a2-43bc-a02f-b1c2b8864de4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>reward_rates <span class="op">&lt;-</span> partial(arg_reward_rates, mutation_rate<span class="op">=</span><span class="dv">1</span>, reward_limit<span class="op">=</span><span class="dv">1</span>, locus_ton_reward_limit<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>start <span class="op">&lt;-</span> proc.time()[<span class="dv">3</span>]</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>joint_probs <span class="op">&lt;-</span> discrete_joint_prob(graph, reward_rates)</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>proc.time()[<span class="dv">3</span>] <span class="op">-</span> start</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>tail(joint_probs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>1000 3020 
2000 4887 
3000 6721 
4000 8038 
5000 9302 
6000 10563 
7000 11123 
8000 11872 
9000 12493 
10000 13150 
11000 13551 
12000 13976 
13000 14322 
14000 14526 
[1]   110.0000 14593.0000   132.6636</code></pre>
</div>
<div class="cell-output cell-output-display">
<strong>elapsed:</strong> 32.5500000000001
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small">
<caption>A data.frame: 6 × 51</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">V1</th>
<th data-quarto-table-cell-role="th" scope="col">V2</th>
<th data-quarto-table-cell-role="th" scope="col">V3</th>
<th data-quarto-table-cell-role="th" scope="col">V4</th>
<th data-quarto-table-cell-role="th" scope="col">V5</th>
<th data-quarto-table-cell-role="th" scope="col">V6</th>
<th data-quarto-table-cell-role="th" scope="col">V7</th>
<th data-quarto-table-cell-role="th" scope="col">V8</th>
<th data-quarto-table-cell-role="th" scope="col">V9</th>
<th data-quarto-table-cell-role="th" scope="col">V10</th>
<th data-quarto-table-cell-role="th" scope="col">⋯</th>
<th data-quarto-table-cell-role="th" scope="col">V42</th>
<th data-quarto-table-cell-role="th" scope="col">V43</th>
<th data-quarto-table-cell-role="th" scope="col">V44</th>
<th data-quarto-table-cell-role="th" scope="col">V45</th>
<th data-quarto-table-cell-role="th" scope="col">V46</th>
<th data-quarto-table-cell-role="th" scope="col">V47</th>
<th data-quarto-table-cell-role="th" scope="col">V48</th>
<th data-quarto-table-cell-role="th" scope="col">V49</th>
<th data-quarto-table-cell-role="th" scope="col">V50</th>
<th data-quarto-table-cell-role="th" scope="col">accum_time</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">⋯</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">539</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>5.350590e-08</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">540</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1.670565e-07</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">541</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>5.778167e-09</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">542</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>5.778167e-09</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">543</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>5.778167e-09</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">544</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>5.778167e-09</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="c65ff819-c145-4a3a-ad18-52dee15d22fd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="co"># sample_size &lt;- 3</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="co"># graph &lt;- two_locus_arg(sample_size, 1, 1)</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # plot_graph(graph_as_matrix(graph), size=c(10, 10), align=TRUE, rainbow=TRUE,</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="co"># #                fontsize=16, ranksep=2, nodesep=0.5,</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="co"># #           subgraphs=TRUE,         </span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="co"># #            subgraphfun=function(state, index) paste(state[1:sample_size], collapse=""))  </span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="co"># state_length &lt;- length(vertex_at(graph, 1)$state)</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="co"># reward_limits &lt;- list()</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a><span class="co"># for (i in 1:state_length) {</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     prop_i &lt;- index_to_props_two_locus(sample_size, i)</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (prop_i$descendants_l1 == sample_size &amp;&amp; prop_i$descendants_l2 == sample_size) {</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a><span class="co">#         # absorbing state has no reward</span></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a><span class="co">#         next</span></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (prop_i$descendants_l1 &gt; 0 &amp;&amp; prop_i$descendants_l2 &gt; 0) {</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a><span class="co">#         r &lt;- rep(0, state_length)</span></span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a><span class="co">#         r[i] &lt;- 1</span></span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a><span class="co">#         # cat(prop_i$descendants_l1, " ", prop_i$descendants_l2, " ", r, "\n")</span></span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a><span class="co">#         reward_limits &lt;- c(reward_limits,  list(r))</span></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a><span class="co">#         next</span></span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     for (j in i:state_length) {</span></span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a><span class="co">#         prop_j &lt;- index_to_props_two_locus(sample_size, j)</span></span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (prop_j$descendants_l1 &gt; 0 &amp;&amp; prop_j$descendants_l2 &gt; 0) {</span></span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a><span class="co">#             next</span></span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a><span class="co">#         }        </span></span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a><span class="co">#         r &lt;- rep(0, state_length)</span></span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a><span class="co">#         if ((prop_i$descendants_l1 &gt; 0 &amp;&amp; prop_j$descendants_l2 &gt; 0) || (prop_j$descendants_l1 &gt; 0 &amp;&amp; prop_i$descendants_l2 &gt; 0)) {</span></span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a><span class="co">#             r[i] &lt;- 1</span></span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a><span class="co">#             r[j] &lt;- 1</span></span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true" tabindex="-1"></a><span class="co">#             reward_limits &lt;- c(reward_limits, list(r))</span></span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true" tabindex="-1"></a><span class="co">#             # cat(prop_i$descendants_l1, " ", prop_i$descendants_l2, " ", prop_j$descendants_l1, " ", prop_j$descendants_l2, " ", r, "\n")            </span></span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb94-37"><a href="#cb94-37" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb94-38"><a href="#cb94-38" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb94-39"><a href="#cb94-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-40"><a href="#cb94-40" aria-hidden="true" tabindex="-1"></a><span class="co"># tot_reward_limit &lt;- Inf</span></span>
<span id="cb94-41"><a href="#cb94-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-42"><a href="#cb94-42" aria-hidden="true" tabindex="-1"></a><span class="co"># mutation_rate &lt;- 1</span></span>
<span id="cb94-43"><a href="#cb94-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-44"><a href="#cb94-44" aria-hidden="true" tabindex="-1"></a><span class="co"># reward_possible &lt;- function(state, rewards) {</span></span>
<span id="cb94-45"><a href="#cb94-45" aria-hidden="true" tabindex="-1"></a><span class="co">#     max_nrs_descendants &lt;- function(state) {</span></span>
<span id="cb94-46"><a href="#cb94-46" aria-hidden="true" tabindex="-1"></a><span class="co">#        l1 &lt;- 0</span></span>
<span id="cb94-47"><a href="#cb94-47" aria-hidden="true" tabindex="-1"></a><span class="co">#        l2 &lt;- 0</span></span>
<span id="cb94-48"><a href="#cb94-48" aria-hidden="true" tabindex="-1"></a><span class="co">#        for (i in 1:length(state)) {</span></span>
<span id="cb94-49"><a href="#cb94-49" aria-hidden="true" tabindex="-1"></a><span class="co">#            if (state[i] &gt; 0) {</span></span>
<span id="cb94-50"><a href="#cb94-50" aria-hidden="true" tabindex="-1"></a><span class="co">#                props &lt;- index_to_props_two_locus(sample_size, i) # SAMPLE SIZE SHOULD NOT BE A GLOBAL HERE...</span></span>
<span id="cb94-51"><a href="#cb94-51" aria-hidden="true" tabindex="-1"></a><span class="co">#                l1 &lt;- max(c(l1, props$descendants_l1))</span></span>
<span id="cb94-52"><a href="#cb94-52" aria-hidden="true" tabindex="-1"></a><span class="co">#                l2 &lt;- max(c(l2, props$descendants_l2))</span></span>
<span id="cb94-53"><a href="#cb94-53" aria-hidden="true" tabindex="-1"></a><span class="co">#            }</span></span>
<span id="cb94-54"><a href="#cb94-54" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb94-55"><a href="#cb94-55" aria-hidden="true" tabindex="-1"></a><span class="co">#        return(c(l1, l2))</span></span>
<span id="cb94-56"><a href="#cb94-56" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb94-57"><a href="#cb94-57" aria-hidden="true" tabindex="-1"></a><span class="co">#     return (all(max_nrs_descendants(rewards) &lt;= max_nrs_descendants(state)))</span></span>
<span id="cb94-58"><a href="#cb94-58" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb94-59"><a href="#cb94-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-60"><a href="#cb94-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-61"><a href="#cb94-61" aria-hidden="true" tabindex="-1"></a><span class="co"># #reward_limits</span></span>
<span id="cb94-62"><a href="#cb94-62" aria-hidden="true" tabindex="-1"></a><span class="co"># #reward_limits &lt;- reward_limits[[1]]</span></span>
<span id="cb94-63"><a href="#cb94-63" aria-hidden="true" tabindex="-1"></a><span class="co"># state_length &lt;- length(vertex_at(graph, 1)$state)</span></span>
<span id="cb94-64"><a href="#cb94-64" aria-hidden="true" tabindex="-1"></a><span class="co"># # last state index is absorbing where no rewards can be earned</span></span>
<span id="cb94-65"><a href="#cb94-65" aria-hidden="true" tabindex="-1"></a><span class="co"># reward_limits &lt;- c(rep(1, state_length-1), 0)</span></span>
<span id="cb94-66"><a href="#cb94-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-67"><a href="#cb94-67" aria-hidden="true" tabindex="-1"></a><span class="co"># start &lt;- proc.time()[3]</span></span>
<span id="cb94-68"><a href="#cb94-68" aria-hidden="true" tabindex="-1"></a><span class="co"># joint_probs &lt;- discrete_joint_prob(graph, reward_limits, mutation_rate, reward_possible, tot_reward_limit=tot_reward_limit)</span></span>
<span id="cb94-69"><a href="#cb94-69" aria-hidden="true" tabindex="-1"></a><span class="co"># proc.time()[3] - start</span></span>
<span id="cb94-70"><a href="#cb94-70" aria-hidden="true" tabindex="-1"></a><span class="co"># tail(joint_probs)                                </span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="3d16edc5-3ce8-45a5-8109-9eef06bc7d13" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>state_length <span class="op">&lt;-</span> ncol(joint_probs) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>mat <span class="op">&lt;-</span> joint_probs <span class="op">%&gt;%</span> select(starts_with(<span class="st">'V'</span>)) <span class="op">%&gt;%</span> <span class="im">as</span>.matrix</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>fun <span class="op">&lt;-</span> function(x, marg_ton, sample_size) {</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>     <span class="bu">any</span>(sapply((<span class="dv">1</span>:state_length)[which(x<span class="op">==</span><span class="dv">1</span>)], function(i) index_to_props_two_locus(sample_size, i)$descendants_l1 <span class="op">==</span> marg_ton))</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (marg_ton <span class="kw">in</span> <span class="dv">1</span>:sample_size) {               </span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">&lt;-</span> <span class="bu">apply</span>(mat, <span class="dv">1</span>, fun, marg_ton<span class="op">=</span>marg_ton, sample_size<span class="op">=</span>sample_size)</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>( <span class="bu">sum</span>(joint_probs$accum_time[mask]) )</span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.04359551
[1] 0.018509
[1] 0.009337695
[1] 0.00101796</code></pre>
</div>
</div>
<div id="a4cd2852-56da-45ae-aab2-d14f593a5b19" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>fun <span class="op">&lt;-</span> function(name, sample_size) {</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>     f <span class="op">&lt;-</span> function(name, sample_size) {</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="op">!</span>startsWith(name, <span class="st">"V"</span>))</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span>(name)</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">&lt;-</span> <span class="im">as</span>.integer(gsub(<span class="st">'V'</span>, <span class="st">''</span>, name))</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>        props <span class="op">&lt;-</span> index_to_props_two_locus(sample_size, idx)</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># new_name &lt;- paste(c("(", props$descendants_l1, ", ", props$descendants_l2, ")"), collapse="")</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>        new_name <span class="op">&lt;-</span> paste(c(<span class="st">"ton"</span>, props$descendants_l1, <span class="st">"x"</span>, props$descendants_l2, <span class="st">"_"</span>, props$population, props$population), collapse<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span>(new_name)</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    sapply(name, f, sample_size<span class="op">=</span>sample_size)</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>}    </span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>df <span class="op">&lt;-</span> joint_probs <span class="op">%&gt;%</span> </span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rename_with(gsub, pattern="V", replacement="ton") %&gt;% </span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>    rename_with(fun, sample_size<span class="op">=</span>sample_size)</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>head(df)</span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>tonnames <span class="op">&lt;-</span> df <span class="op">%&gt;%</span> select(<span class="op">!</span>accum_time) <span class="op">%&gt;%</span> names() <span class="op">%&gt;%</span> str_extract(<span class="st">"^ton[:digit:]x[:digit:]"</span>) <span class="op">%&gt;%</span> unique()</span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>l <span class="op">&lt;-</span> <span class="bu">map</span>(tonnames, function (n) rowSums(select(df, ends_with(n))))</span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a>plot_df <span class="op">&lt;-</span> <span class="im">as</span>.data.frame(do.call(cbind, l))</span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a>colnames(plot_df) <span class="op">&lt;-</span> tonnames</span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>plot_df[<span class="st">'accum_time'</span>] <span class="op">&lt;-</span> df[<span class="st">'accum_time'</span>]</span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>head(plot_df)         </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small">
<caption>A data.frame: 6 × 51</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">ton0x0_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x0_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x0_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x0_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x0_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton0x1_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x1_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x1_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x1_11</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x1_11</th>
<th data-quarto-table-cell-role="th" scope="col">⋯</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x3_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x3_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x3_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x3_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton0x4_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x4_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x4_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x4_22</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x4_22</th>
<th data-quarto-table-cell-role="th" scope="col">accum_time</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">⋯</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">1</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.020014967</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">2</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.004216329</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">3</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.004216329</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">4</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.011198623</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">5</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.001859383</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">6</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.011198623</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small">
<caption>A data.frame: 6 × 26</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">ton0x0</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x0</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x0</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x0</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x0</th>
<th data-quarto-table-cell-role="th" scope="col">ton0x1</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x1</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x1</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x1</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x1</th>
<th data-quarto-table-cell-role="th" scope="col">⋯</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x3</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x3</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x3</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x3</th>
<th data-quarto-table-cell-role="th" scope="col">ton0x4</th>
<th data-quarto-table-cell-role="th" scope="col">ton1x4</th>
<th data-quarto-table-cell-role="th" scope="col">ton2x4</th>
<th data-quarto-table-cell-role="th" scope="col">ton3x4</th>
<th data-quarto-table-cell-role="th" scope="col">ton4x4</th>
<th data-quarto-table-cell-role="th" scope="col">accum_time</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">⋯</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">1</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.020014967</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">2</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.004216329</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">3</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.004216329</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">4</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.011198623</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">5</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.001859383</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">6</th>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>⋯</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.011198623</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="8f2ee2f8-7caa-4654-97c5-6295571a62d9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_df &lt;- joint_probs %&gt;% </span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     # rename_with(gsub, pattern="V", replacement="ton") %&gt;% </span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     rename_with(fun, sample_size=sample_size) %&gt;%</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     group_by(ton0x1, ton1x0) %&gt;% </span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     summarize(prob=sum(accum_time), .groups="keep")</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="co"># for (colname in colnames(plot_df)) {</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     # if (startsWith(colname, 'ton')) {</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (colname != 'prob') {</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a><span class="co">#         plot_df[[colname]] &lt;- as.factor(plot_df[[colname]])</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_df</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fe590e73-841c-405a-bec7-8cc66a1b1d42" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>ggplot(plot_df, aes(x<span class="op">=</span>ton0x1, y<span class="op">=</span>ton1x0)) <span class="op">+</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>    geom_tile(aes(fill <span class="op">=</span> accum_time)) <span class="op">+</span> </span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>    geom_text(aes(label <span class="op">=</span> <span class="bu">round</span>(accum_time, <span class="dv">3</span>))) <span class="op">+</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    scale_fill_viridis() <span class="op">+</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># scale_fill_distiller(palette = 'PiYG',direction = 1,</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                 limit=max(abs(plot_df$prob)) * c(-1, 1)</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                 ) +</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>     theme(panel.grid.major <span class="op">=</span> element_blank(), </span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>            panel.grid.minor <span class="op">=</span> element_blank(), </span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>            text<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">17</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-72-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-23"><img src="coalescent-jointprob-ffi_files/figure-html/cell-72-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="085018aa-4437-44a2-918f-c56bcba1e7e6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>get_exp_mat <span class="op">&lt;-</span> function(graph, rewards, s) </span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    exp_mat <span class="op">&lt;-</span> matrix(nrow<span class="op">=</span>s<span class="op">+</span><span class="dv">1</span>,ncol<span class="op">=</span>s<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">0</span>:s) {</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="kw">in</span> <span class="dv">0</span>:s) {</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>        exp_mat[i<span class="op">+</span><span class="dv">1</span>,j<span class="op">+</span><span class="dv">1</span>] <span class="op">&lt;-</span> expectation(graph, rewards[props_to_index_two_locus(s, i, j), ])</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(exp_mat)</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>plot_exp_mat <span class="op">&lt;-</span> function(exp_mat, title<span class="op">=</span><span class="st">"Expectations"</span>) </span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>{  </span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>    df <span class="op">&lt;-</span> <span class="im">as</span>.data.frame(exp_mat) <span class="co">#%&gt;% gather()</span></span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>    df <span class="op">&lt;-</span> df <span class="op">%&gt;%</span> rownames_to_column(<span class="st">'ton1'</span>) <span class="op">%&gt;%</span> gather(<span class="st">'ton2'</span>, <span class="st">'value'</span>, <span class="op">-</span>c(ton1))</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>    limit <span class="op">&lt;-</span> <span class="bu">max</span>(<span class="bu">abs</span>(df$value)) <span class="op">*</span> c(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>    ggplot(df, aes(ton1, ton2)) <span class="op">+</span></span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>        geom_tile(aes(fill <span class="op">=</span> value)) <span class="op">+</span> </span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>        geom_text(aes(label <span class="op">=</span> <span class="bu">round</span>(value, <span class="dv">2</span>)), size<span class="op">=</span><span class="dv">5</span>) <span class="op">+</span></span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>        ggtitle(title) <span class="op">+</span></span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a>    scale_x_discrete(labels<span class="op">=</span> seq(<span class="dv">0</span>, nrow(exp_mat))) <span class="op">+</span> </span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a>    scale_y_discrete(labels<span class="op">=</span> seq(<span class="dv">0</span>, nrow(exp_mat))) <span class="op">+</span> </span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a>    scale_fill_distiller(palette <span class="op">=</span> <span class="st">'PiYG'</span>,direction <span class="op">=</span> <span class="dv">1</span>, limit<span class="op">=</span>limit) <span class="op">+</span></span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a>     theme(panel.grid.major <span class="op">=</span> element_blank(), </span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a>            panel.grid.minor <span class="op">=</span> element_blank(), </span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a>            text<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">17</span>))</span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb100-32"><a href="#cb100-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-33"><a href="#cb100-33" aria-hidden="true" tabindex="-1"></a>exp_mat <span class="op">&lt;-</span> get_exp_mat(graph, reward_matrix, sample_size)</span>
<span id="cb100-34"><a href="#cb100-34" aria-hidden="true" tabindex="-1"></a>new_exp_mat <span class="op">&lt;-</span> get_exp_mat(new_graph, rbind(<span class="dv">0</span>, new_reward_matrix, <span class="dv">0</span>), sample_size)</span>
<span id="cb100-35"><a href="#cb100-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-36"><a href="#cb100-36" aria-hidden="true" tabindex="-1"></a>options(<span class="bu">repr</span>.plot.width <span class="op">=</span> <span class="dv">20</span>, <span class="bu">repr</span>.plot.height <span class="op">=</span> <span class="dv">5</span>, <span class="bu">repr</span>.plot.res <span class="op">=</span> <span class="dv">100</span>)</span>
<span id="cb100-37"><a href="#cb100-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-38"><a href="#cb100-38" aria-hidden="true" tabindex="-1"></a>p1 <span class="op">&lt;-</span> plot_exp_mat(exp_mat, <span class="st">"Original graph"</span>)    </span>
<span id="cb100-39"><a href="#cb100-39" aria-hidden="true" tabindex="-1"></a>p2 <span class="op">&lt;-</span> plot_exp_mat(new_exp_mat, <span class="st">"Lumped graph"</span>)    </span>
<span id="cb100-40"><a href="#cb100-40" aria-hidden="true" tabindex="-1"></a>p3 <span class="op">&lt;-</span> plot_exp_mat(exp_mat <span class="op">-</span> new_exp_mat, <span class="st">"Absolute difference"</span>)    </span>
<span id="cb100-41"><a href="#cb100-41" aria-hidden="true" tabindex="-1"></a>rel_diff <span class="op">&lt;-</span> (exp_mat <span class="op">-</span> new_exp_mat)<span class="op">/</span>exp_mat</span>
<span id="cb100-42"><a href="#cb100-42" aria-hidden="true" tabindex="-1"></a>rel_diff[<span class="kw">is</span>.na(rel_diff)] <span class="op">&lt;-</span> <span class="dv">0</span></span>
<span id="cb100-43"><a href="#cb100-43" aria-hidden="true" tabindex="-1"></a>p4 <span class="op">&lt;-</span> plot_exp_mat(rel_diff, <span class="st">"Relative difference"</span>)    </span>
<span id="cb100-44"><a href="#cb100-44" aria-hidden="true" tabindex="-1"></a>grid.arrange(p1, p2, p3, p4, nrow <span class="op">=</span> <span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<pre><code>ERROR: Error in eval(expr, envir, enclos): objekt 'reward_matrix' blev ikke fundet

Error in eval(expr, envir, enclos): objekt 'reward_matrix' blev ikke fundet
Traceback:

1. get_exp_mat(graph, reward_matrix, sample_size)
2. expectation(graph, rewards[props_to_index_two_locus(s, i, j), 
 .     ])   # at line 6 of file &lt;text&gt;</code></pre>
</div>
</div>
</section>
<section id="base-n-approach" class="level1">
<h1>Base-n approach</h1>
<section id="state-space-for-joint-proability-computation" class="level2">
<h2 class="anchored" data-anchor-id="state-space-for-joint-proability-computation">State space for joint proability computation</h2>
<p>Generate coalescent state space like normal with the following modifications</p>
<ul>
<li>Change state space from (4, 0, 0, 0) to (4, 0, 0, 0, t1, t2, t3, t4). The last extra “ton” states keep track of the number accumulated mutations of each kind. We simply double the state vector so we keep track of the counts lineages with descendants, but also the counts of mutations happened on such lineages.</li>
<li>Each state can mutate to accumulate a “ton” in accordance with its state vector. E.g., a <code>(4, 0, 0, 0, 0, 0, 0, 0)</code> state can only make singletons, a <code>(2, 1, 0, 0, 0, 0, 0, 0)</code> state can only make singletons and doubletons.</li>
<li>A mutation event is a transition to a siter state E.g., <code>(4, 0, 0, 0, 0, 0, 0, 0) -&gt; (4, 0, 0, 0, 1, 0, 0, 0)</code></li>
<li>The ton counts have a maximum value (base-1). If this value is reached, the mutation transition instead leads to a trash state with an infinite self loop. The transitions to trash represents the part of the deficient PDF not covered because we only run up to a max nr of tons.</li>
</ul>
</section>
<section id="reward-transform" class="level2">
<h2 class="anchored" data-anchor-id="reward-transform">Reward transform</h2>
<ul>
<li>Convert the last half of each state (with ton counts) to numbers in some base.</li>
<li>Use these for reward transformation.</li>
<li>Compute PDF for t &lt;- 1:sample_size^(base-1)</li>
<li>Convert each time t back to the corresponding ton vector and associate it with the probability</li>
<li>group by two tons and sum probs in groups to get all pairwise combinations for a joint probability matrix.</li>
</ul>
</section>
<section id="figure-out-why-you-get-nas-in-multi_rewards-with-max_tons---1" class="level2">
<h2 class="anchored" data-anchor-id="figure-out-why-you-get-nas-in-multi_rewards-with-max_tons---1">Figure out why you get NAs in multi_rewards with max_tons &lt;- 1</h2>
<div id="57964fd0-735e-4a8c-9e3c-765483320541" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># joint_prob_coalescent &lt;- function(n, mutation_rate, max_tons, total_tons=Inf) {</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     state_vector_length &lt;- n + n + 1</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     graph &lt;- create_graph(state_vector_length)</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     starting_vertex &lt;- vertex_at(graph, 1)</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     initial_state &lt;- c(rep(0, n), 0)</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     initial_state[1] &lt;- n</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     add_edge(</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="co">#       starting_vertex,</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="co">#       create_vertex(graph, initial_state),</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="co">#       1</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     index &lt;- 2</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     while (index &lt;= vertices_length(graph)) {</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="co">#       vertex &lt;- vertex_at(graph, index)</span></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a><span class="co">#       # skip if we only have one lineage left or if this is a trash state</span></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a><span class="co">#       if (sum(vertex$state[1:n]) &lt;= 1) {</span></span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a><span class="co">#         index &lt;- index + 1</span></span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a><span class="co">#         next</span></span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a><span class="co">#       }</span></span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-25"><a href="#cb102-25" aria-hidden="true" tabindex="-1"></a><span class="co">#       # mutations</span></span>
<span id="cb102-26"><a href="#cb102-26" aria-hidden="true" tabindex="-1"></a><span class="co">#       trash_rate &lt;- 0 </span></span>
<span id="cb102-27"><a href="#cb102-27" aria-hidden="true" tabindex="-1"></a><span class="co">#       for (i in 1:n)  {</span></span>
<span id="cb102-28"><a href="#cb102-28" aria-hidden="true" tabindex="-1"></a><span class="co">#         state &lt;- vertex$state          </span></span>
<span id="cb102-29"><a href="#cb102-29" aria-hidden="true" tabindex="-1"></a><span class="co">#         rate &lt;- vertex$state[i] * mutation_rate</span></span>
<span id="cb102-30"><a href="#cb102-30" aria-hidden="true" tabindex="-1"></a><span class="co">#         nr_tons &lt;- state[n+i]</span></span>
<span id="cb102-31"><a href="#cb102-31" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (rate &gt; 0) {</span></span>
<span id="cb102-32"><a href="#cb102-32" aria-hidden="true" tabindex="-1"></a><span class="co">#             if (nr_tons &lt; max_tons &amp;&amp; sum(vertex$state[(n+1):(2*n)]) &lt; total_tons) {</span></span>
<span id="cb102-33"><a href="#cb102-33" aria-hidden="true" tabindex="-1"></a><span class="co">#               child_state &lt;- state</span></span>
<span id="cb102-34"><a href="#cb102-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-35"><a href="#cb102-35" aria-hidden="true" tabindex="-1"></a><span class="co">#               mutation_vertex &lt;- create_vertex(graph, rep(0, state_vector_length))</span></span>
<span id="cb102-36"><a href="#cb102-36" aria-hidden="true" tabindex="-1"></a><span class="co">#               add_edge(vertex, mutation_vertex, rate)</span></span>
<span id="cb102-37"><a href="#cb102-37" aria-hidden="true" tabindex="-1"></a><span class="co">#               child_state[n+i] &lt;- child_state[i+n] + 1</span></span>
<span id="cb102-38"><a href="#cb102-38" aria-hidden="true" tabindex="-1"></a><span class="co">#               add_edge(mutation_vertex, find_or_create_vertex(graph, child_state), 1)</span></span>
<span id="cb102-39"><a href="#cb102-39" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb102-40"><a href="#cb102-40" aria-hidden="true" tabindex="-1"></a><span class="co">#               # child_state[n+i] &lt;- child_state[i+n] + 1</span></span>
<span id="cb102-41"><a href="#cb102-41" aria-hidden="true" tabindex="-1"></a><span class="co">#               # add_edge(vertex, find_or_create_vertex(graph, child_state), rate)</span></span>
<span id="cb102-42"><a href="#cb102-42" aria-hidden="true" tabindex="-1"></a><span class="co">#             } else {</span></span>
<span id="cb102-43"><a href="#cb102-43" aria-hidden="true" tabindex="-1"></a><span class="co">#               trash_rate &lt;- trash_rate + rate</span></span>
<span id="cb102-44"><a href="#cb102-44" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb102-45"><a href="#cb102-45" aria-hidden="true" tabindex="-1"></a><span class="co">#         }          </span></span>
<span id="cb102-46"><a href="#cb102-46" aria-hidden="true" tabindex="-1"></a><span class="co">#       }</span></span>
<span id="cb102-47"><a href="#cb102-47" aria-hidden="true" tabindex="-1"></a><span class="co">#       if (trash_rate &gt; 0) {</span></span>
<span id="cb102-48"><a href="#cb102-48" aria-hidden="true" tabindex="-1"></a><span class="co">#         add_edge(vertex, find_or_create_vertex(graph, rep(0, state_vector_length)), trash_rate)</span></span>
<span id="cb102-49"><a href="#cb102-49" aria-hidden="true" tabindex="-1"></a><span class="co">#       }</span></span>
<span id="cb102-50"><a href="#cb102-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-51"><a href="#cb102-51" aria-hidden="true" tabindex="-1"></a><span class="co">#       # loop over all classes of lineages</span></span>
<span id="cb102-52"><a href="#cb102-52" aria-hidden="true" tabindex="-1"></a><span class="co">#       for (i in 1:n) {</span></span>
<span id="cb102-53"><a href="#cb102-53" aria-hidden="true" tabindex="-1"></a><span class="co">#         for (j in i:n) {</span></span>
<span id="cb102-54"><a href="#cb102-54" aria-hidden="true" tabindex="-1"></a><span class="co">#           state &lt;- vertex$state</span></span>
<span id="cb102-55"><a href="#cb102-55" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb102-56"><a href="#cb102-56" aria-hidden="true" tabindex="-1"></a><span class="co">#           # if same class, there need to be at least two to coalesce</span></span>
<span id="cb102-57"><a href="#cb102-57" aria-hidden="true" tabindex="-1"></a><span class="co">#           if (i == j) {</span></span>
<span id="cb102-58"><a href="#cb102-58" aria-hidden="true" tabindex="-1"></a><span class="co">#             if (state[i] &lt; 2) {</span></span>
<span id="cb102-59"><a href="#cb102-59" aria-hidden="true" tabindex="-1"></a><span class="co">#               next;</span></span>
<span id="cb102-60"><a href="#cb102-60" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb102-61"><a href="#cb102-61" aria-hidden="true" tabindex="-1"></a><span class="co">#             # coal rate</span></span>
<span id="cb102-62"><a href="#cb102-62" aria-hidden="true" tabindex="-1"></a><span class="co">#             rate &lt;- state[i] * (state[i] - 1) / 2</span></span>
<span id="cb102-63"><a href="#cb102-63" aria-hidden="true" tabindex="-1"></a><span class="co">#           } else {</span></span>
<span id="cb102-64"><a href="#cb102-64" aria-hidden="true" tabindex="-1"></a><span class="co">#             # else at least one in each class to coalesce</span></span>
<span id="cb102-65"><a href="#cb102-65" aria-hidden="true" tabindex="-1"></a><span class="co">#             if (state[i] &lt; 1 || state[j] &lt; 1) {</span></span>
<span id="cb102-66"><a href="#cb102-66" aria-hidden="true" tabindex="-1"></a><span class="co">#               next;</span></span>
<span id="cb102-67"><a href="#cb102-67" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb102-68"><a href="#cb102-68" aria-hidden="true" tabindex="-1"></a><span class="co">#             # number of combinations</span></span>
<span id="cb102-69"><a href="#cb102-69" aria-hidden="true" tabindex="-1"></a><span class="co">#             rate &lt;- state[i] * state[j]</span></span>
<span id="cb102-70"><a href="#cb102-70" aria-hidden="true" tabindex="-1"></a><span class="co">#           }</span></span>
<span id="cb102-71"><a href="#cb102-71" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb102-72"><a href="#cb102-72" aria-hidden="true" tabindex="-1"></a><span class="co">#           # copy state</span></span>
<span id="cb102-73"><a href="#cb102-73" aria-hidden="true" tabindex="-1"></a><span class="co">#           child_state &lt;- state</span></span>
<span id="cb102-74"><a href="#cb102-74" aria-hidden="true" tabindex="-1"></a><span class="co">#           # update child state</span></span>
<span id="cb102-75"><a href="#cb102-75" aria-hidden="true" tabindex="-1"></a><span class="co">#           child_state[i] &lt;- child_state[i] - 1</span></span>
<span id="cb102-76"><a href="#cb102-76" aria-hidden="true" tabindex="-1"></a><span class="co">#           child_state[j] &lt;- child_state[j] - 1</span></span>
<span id="cb102-77"><a href="#cb102-77" aria-hidden="true" tabindex="-1"></a><span class="co">#           child_state[i+j] &lt;- child_state[i+j] + 1</span></span>
<span id="cb102-78"><a href="#cb102-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-79"><a href="#cb102-79" aria-hidden="true" tabindex="-1"></a><span class="co">#           add_edge(</span></span>
<span id="cb102-80"><a href="#cb102-80" aria-hidden="true" tabindex="-1"></a><span class="co">#               vertex,</span></span>
<span id="cb102-81"><a href="#cb102-81" aria-hidden="true" tabindex="-1"></a><span class="co">#               find_or_create_vertex(graph, child_state),</span></span>
<span id="cb102-82"><a href="#cb102-82" aria-hidden="true" tabindex="-1"></a><span class="co">#               rate</span></span>
<span id="cb102-83"><a href="#cb102-83" aria-hidden="true" tabindex="-1"></a><span class="co">#             )</span></span>
<span id="cb102-84"><a href="#cb102-84" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb102-85"><a href="#cb102-85" aria-hidden="true" tabindex="-1"></a><span class="co">#       }</span></span>
<span id="cb102-86"><a href="#cb102-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-87"><a href="#cb102-87" aria-hidden="true" tabindex="-1"></a><span class="co">#       index &lt;- index + 1</span></span>
<span id="cb102-88"><a href="#cb102-88" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb102-89"><a href="#cb102-89" aria-hidden="true" tabindex="-1"></a><span class="co">#     trash_vertex &lt;- find_or_create_vertex(graph, rep(0, state_vector_length))</span></span>
<span id="cb102-90"><a href="#cb102-90" aria-hidden="true" tabindex="-1"></a><span class="co">#     trash_loop_vertex &lt;- create_vertex(graph, rep(0, state_vector_length))</span></span>
<span id="cb102-91"><a href="#cb102-91" aria-hidden="true" tabindex="-1"></a><span class="co">#     add_edge(trash_vertex, trash_loop_vertex, 1)</span></span>
<span id="cb102-92"><a href="#cb102-92" aria-hidden="true" tabindex="-1"></a><span class="co">#     add_edge(trash_loop_vertex, trash_vertex, 1)</span></span>
<span id="cb102-93"><a href="#cb102-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb102-94"><a href="#cb102-94" aria-hidden="true" tabindex="-1"></a><span class="co">#     return(graph)</span></span>
<span id="cb102-95"><a href="#cb102-95" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb102-96"><a href="#cb102-96" aria-hidden="true" tabindex="-1"></a><span class="co"># # states &lt;- t(sapply(1:vertices_length(graph), function(index) vertex_at(graph, index)$state ))</span></span>
<span id="cb102-97"><a href="#cb102-97" aria-hidden="true" tabindex="-1"></a><span class="co"># # ipv &lt;- graph_as_matrix(graph)$IPV</span></span>
<span id="cb102-98"><a href="#cb102-98" aria-hidden="true" tabindex="-1"></a><span class="co"># # sim &lt;- graph_as_matrix(graph)$SIM</span></span>
<span id="cb102-99"><a href="#cb102-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-100"><a href="#cb102-100" aria-hidden="true" tabindex="-1"></a><span class="co"># # sample_size &lt;- 4</span></span>
<span id="cb102-101"><a href="#cb102-101" aria-hidden="true" tabindex="-1"></a><span class="co"># # # mutation_rate &lt;- 20000 * 31 * 5e-10 # 0.00031</span></span>
<span id="cb102-102"><a href="#cb102-102" aria-hidden="true" tabindex="-1"></a><span class="co"># # mutation_rate &lt;- 1</span></span>
<span id="cb102-103"><a href="#cb102-103" aria-hidden="true" tabindex="-1"></a><span class="co"># # max_tons &lt;- 3</span></span>
<span id="cb102-104"><a href="#cb102-104" aria-hidden="true" tabindex="-1"></a><span class="co"># # base &lt;- max_tons + 1</span></span>
<span id="cb102-105"><a href="#cb102-105" aria-hidden="true" tabindex="-1"></a><span class="co"># # # graph &lt;- joint_prob_coalescent(sample_size, mutation_rate, max_tons)</span></span>
<span id="cb102-106"><a href="#cb102-106" aria-hidden="true" tabindex="-1"></a><span class="co"># # # gam &lt;- graph_as_matrix(graph)</span></span>
<span id="cb102-107"><a href="#cb102-107" aria-hidden="true" tabindex="-1"></a><span class="co"># # # #gam</span></span>
<span id="cb102-108"><a href="#cb102-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-109"><a href="#cb102-109" aria-hidden="true" tabindex="-1"></a><span class="co"># # graph &lt;- joint_prob_coalescent(sample_size, mutation_rate, max_tons, total_tons)</span></span>
<span id="cb102-110"><a href="#cb102-110" aria-hidden="true" tabindex="-1"></a><span class="co"># # gam &lt;- graph_as_matrix(graph)</span></span>
<span id="cb102-111"><a href="#cb102-111" aria-hidden="true" tabindex="-1"></a><span class="co"># # plot_graph(gam, #subgraphs=TRUE, </span></span>
<span id="cb102-112"><a href="#cb102-112" aria-hidden="true" tabindex="-1"></a><span class="co"># #            rainbow=TRUE,</span></span>
<span id="cb102-113"><a href="#cb102-113" aria-hidden="true" tabindex="-1"></a><span class="co"># #            size=c(10, 8), </span></span>
<span id="cb102-114"><a href="#cb102-114" aria-hidden="true" tabindex="-1"></a><span class="co"># #            align=TRUE,</span></span>
<span id="cb102-115"><a href="#cb102-115" aria-hidden="true" tabindex="-1"></a><span class="co"># #            fontsize=16, ranksep=1, nodesep=0.25,          </span></span>
<span id="cb102-116"><a href="#cb102-116" aria-hidden="true" tabindex="-1"></a><span class="co"># #            # subgraphfun=function(state) paste(state[-length(state)], collapse="")</span></span>
<span id="cb102-117"><a href="#cb102-117" aria-hidden="true" tabindex="-1"></a><span class="co"># #            )</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4f0ef20f-3e4a-4df9-846d-084bc8925677" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>joint_prob_coalescent <span class="op">&lt;-</span> function(n, mutation_rate, max_tons, total_tons<span class="op">=</span>Inf) {</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    stopifnot(total_tons <span class="op">==</span> Inf)</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>    state_vector_length <span class="op">&lt;-</span> n <span class="op">+</span> n <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">&lt;-</span> create_graph(state_vector_length)</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>    starting_vertex <span class="op">&lt;-</span> vertex_at(graph, <span class="dv">1</span>)</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>    initial_state <span class="op">&lt;-</span> c(rep(<span class="dv">0</span>, n), <span class="dv">0</span>)</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>    initial_state[<span class="dv">1</span>] <span class="op">&lt;-</span> n</span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>    add_edge(</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>      starting_vertex,</span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>      create_vertex(graph, initial_state),</span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>    index <span class="op">&lt;-</span> <span class="dv">2</span></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (index <span class="op">&lt;=</span> vertices_length(graph)) {</span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a>      vertex <span class="op">&lt;-</span> vertex_at(graph, index)</span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a>      <span class="co"># skip if we only have one lineage left or if this is a trash state</span></span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="bu">sum</span>(vertex$state[<span class="dv">1</span>:n]) <span class="op">&lt;=</span> <span class="dv">1</span>) {</span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a>        index <span class="op">&lt;-</span> index <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">next</span></span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb103-27"><a href="#cb103-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb103-28"><a href="#cb103-28" aria-hidden="true" tabindex="-1"></a>      <span class="co"># loop over all classes of lineages</span></span>
<span id="cb103-29"><a href="#cb103-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:n) {</span>
<span id="cb103-30"><a href="#cb103-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="kw">in</span> i:n) {</span>
<span id="cb103-31"><a href="#cb103-31" aria-hidden="true" tabindex="-1"></a>          state <span class="op">&lt;-</span> vertex$state</span>
<span id="cb103-32"><a href="#cb103-32" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb103-33"><a href="#cb103-33" aria-hidden="true" tabindex="-1"></a>          <span class="co"># if same class, there need to be at least two to coalesce</span></span>
<span id="cb103-34"><a href="#cb103-34" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (i <span class="op">==</span> j) {</span>
<span id="cb103-35"><a href="#cb103-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (state[i] <span class="op">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb103-36"><a href="#cb103-36" aria-hidden="true" tabindex="-1"></a>              <span class="bu">next</span><span class="op">;</span></span>
<span id="cb103-37"><a href="#cb103-37" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb103-38"><a href="#cb103-38" aria-hidden="true" tabindex="-1"></a>            <span class="co"># coal rate</span></span>
<span id="cb103-39"><a href="#cb103-39" aria-hidden="true" tabindex="-1"></a>            rate <span class="op">&lt;-</span> state[i] <span class="op">*</span> (state[i] <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb103-40"><a href="#cb103-40" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb103-41"><a href="#cb103-41" aria-hidden="true" tabindex="-1"></a>            <span class="co"># else at least one in each class to coalesce</span></span>
<span id="cb103-42"><a href="#cb103-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (state[i] <span class="op">&lt;</span> <span class="dv">1</span> <span class="op">||</span> state[j] <span class="op">&lt;</span> <span class="dv">1</span>) {</span>
<span id="cb103-43"><a href="#cb103-43" aria-hidden="true" tabindex="-1"></a>              <span class="bu">next</span><span class="op">;</span></span>
<span id="cb103-44"><a href="#cb103-44" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb103-45"><a href="#cb103-45" aria-hidden="true" tabindex="-1"></a>            <span class="co"># number of combinations</span></span>
<span id="cb103-46"><a href="#cb103-46" aria-hidden="true" tabindex="-1"></a>            rate <span class="op">&lt;-</span> state[i] <span class="op">*</span> state[j]</span>
<span id="cb103-47"><a href="#cb103-47" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb103-48"><a href="#cb103-48" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb103-49"><a href="#cb103-49" aria-hidden="true" tabindex="-1"></a>          <span class="co"># copy state</span></span>
<span id="cb103-50"><a href="#cb103-50" aria-hidden="true" tabindex="-1"></a>          child_state <span class="op">&lt;-</span> state</span>
<span id="cb103-51"><a href="#cb103-51" aria-hidden="true" tabindex="-1"></a>          <span class="co"># update child state</span></span>
<span id="cb103-52"><a href="#cb103-52" aria-hidden="true" tabindex="-1"></a>          child_state[i] <span class="op">&lt;-</span> child_state[i] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb103-53"><a href="#cb103-53" aria-hidden="true" tabindex="-1"></a>          child_state[j] <span class="op">&lt;-</span> child_state[j] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb103-54"><a href="#cb103-54" aria-hidden="true" tabindex="-1"></a>          child_state[i<span class="op">+</span>j] <span class="op">&lt;-</span> child_state[i<span class="op">+</span>j] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb103-55"><a href="#cb103-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-56"><a href="#cb103-56" aria-hidden="true" tabindex="-1"></a>          add_edge(</span>
<span id="cb103-57"><a href="#cb103-57" aria-hidden="true" tabindex="-1"></a>              vertex,</span>
<span id="cb103-58"><a href="#cb103-58" aria-hidden="true" tabindex="-1"></a>              find_or_create_vertex(graph, child_state),</span>
<span id="cb103-59"><a href="#cb103-59" aria-hidden="true" tabindex="-1"></a>              rate</span>
<span id="cb103-60"><a href="#cb103-60" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb103-61"><a href="#cb103-61" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb103-62"><a href="#cb103-62" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb103-63"><a href="#cb103-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-64"><a href="#cb103-64" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mutations</span></span>
<span id="cb103-65"><a href="#cb103-65" aria-hidden="true" tabindex="-1"></a>      trash_rate <span class="op">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb103-66"><a href="#cb103-66" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:n)  {</span>
<span id="cb103-67"><a href="#cb103-67" aria-hidden="true" tabindex="-1"></a>        rate <span class="op">&lt;-</span> vertex$state[i] <span class="op">*</span> mutation_rate</span>
<span id="cb103-68"><a href="#cb103-68" aria-hidden="true" tabindex="-1"></a>        nr_tons <span class="op">&lt;-</span> child_state[n<span class="op">+</span>i]</span>
<span id="cb103-69"><a href="#cb103-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (rate <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb103-70"><a href="#cb103-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (nr_tons <span class="op">&lt;</span> max_tons <span class="op">&amp;&amp;</span> <span class="bu">sum</span>(vertex$state[(n<span class="op">+</span><span class="dv">1</span>):(<span class="dv">2</span><span class="op">*</span>n)]) <span class="op">&lt;</span> total_tons) {</span>
<span id="cb103-71"><a href="#cb103-71" aria-hidden="true" tabindex="-1"></a>              child_state <span class="op">&lt;-</span> state</span>
<span id="cb103-72"><a href="#cb103-72" aria-hidden="true" tabindex="-1"></a>              child_state[n<span class="op">+</span>i] <span class="op">&lt;-</span> child_state[i<span class="op">+</span>n] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb103-73"><a href="#cb103-73" aria-hidden="true" tabindex="-1"></a>              add_edge(vertex, find_or_create_vertex(graph, child_state), rate)</span>
<span id="cb103-74"><a href="#cb103-74" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> {</span>
<span id="cb103-75"><a href="#cb103-75" aria-hidden="true" tabindex="-1"></a>              trash_rate <span class="op">&lt;-</span> trash_rate <span class="op">+</span> rate</span>
<span id="cb103-76"><a href="#cb103-76" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb103-77"><a href="#cb103-77" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb103-78"><a href="#cb103-78" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb103-79"><a href="#cb103-79" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (trash_rate <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb103-80"><a href="#cb103-80" aria-hidden="true" tabindex="-1"></a>        add_edge(vertex, find_or_create_vertex(graph, rep(<span class="dv">0</span>, state_vector_length)), trash_rate)</span>
<span id="cb103-81"><a href="#cb103-81" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb103-82"><a href="#cb103-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-83"><a href="#cb103-83" aria-hidden="true" tabindex="-1"></a>      index <span class="op">&lt;-</span> index <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb103-84"><a href="#cb103-84" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb103-85"><a href="#cb103-85" aria-hidden="true" tabindex="-1"></a>    trash_vertex <span class="op">&lt;-</span> find_or_create_vertex(graph, rep(<span class="dv">0</span>, state_vector_length))</span>
<span id="cb103-86"><a href="#cb103-86" aria-hidden="true" tabindex="-1"></a>    trash_loop_vertex <span class="op">&lt;-</span> create_vertex(graph, rep(<span class="dv">0</span>, state_vector_length))</span>
<span id="cb103-87"><a href="#cb103-87" aria-hidden="true" tabindex="-1"></a>    add_edge(trash_vertex, trash_loop_vertex, <span class="dv">1</span>)</span>
<span id="cb103-88"><a href="#cb103-88" aria-hidden="true" tabindex="-1"></a>    add_edge(trash_loop_vertex, trash_vertex, <span class="dv">1</span>)</span>
<span id="cb103-89"><a href="#cb103-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb103-90"><a href="#cb103-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(graph)</span>
<span id="cb103-91"><a href="#cb103-91" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fc2ff96d-666d-4b53-8802-f86279938c25" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>ndigits <span class="op">&lt;-</span> function(x){</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  y <span class="op">&lt;-</span> floor(<span class="bu">abs</span>(x))</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(y <span class="op">!=</span> <span class="dv">0</span>){</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>    floor(log10(y)) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>rev_number<span class="op">=</span>function(n){</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>    m<span class="op">=</span><span class="im">as</span>.integer(rev(strsplit(<span class="im">as</span>.character(n),<span class="st">""</span>)))</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (m<span class="op">==</span>rev(m)) <span class="bu">print</span>(<span class="st">"reversed number"</span>)</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>forth <span class="op">&lt;-</span> function(vec, base) {</span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return( as.integer( c(vec %*%  (base ^ rev(seq_along(vec)) / base)) ) )</span></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return( as.integer( c(vec %*%  (base ^ (seq_along(vec)) / base)) ) )</span></span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return( c(vec %*%  (base ^ (rev(seq_along(vec))) / base)) ) </span></span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>( c(vec <span class="op">%*%</span>  (base <span class="op">^</span> (seq_along(vec)) <span class="op">/</span> base)) ) </span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>back <span class="op">&lt;-</span> function(x, base, state_length) {</span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x &lt;- as.integer(rev(paste(x, collapse='')))</span></span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x &lt;- floor(as.numeric(rev(paste(x, collapse=''))))</span></span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a>    vec <span class="op">&lt;-</span> c()</span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">1</span>:state_length) {</span>
<span id="cb104-25"><a href="#cb104-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if (x &gt; 0) {</span></span>
<span id="cb104-26"><a href="#cb104-26" aria-hidden="true" tabindex="-1"></a>            vec <span class="op">&lt;-</span> c(x <span class="op">%%</span> (base), vec)</span>
<span id="cb104-27"><a href="#cb104-27" aria-hidden="true" tabindex="-1"></a>            x <span class="op">&lt;-</span> x <span class="op">%/%</span> (base)</span>
<span id="cb104-28"><a href="#cb104-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># }</span></span>
<span id="cb104-29"><a href="#cb104-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb104-30"><a href="#cb104-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-31"><a href="#cb104-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># while (x &gt; 0) {</span></span>
<span id="cb104-32"><a href="#cb104-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     vec &lt;- c(x %% (base), vec)</span></span>
<span id="cb104-33"><a href="#cb104-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     x &lt;- x %/% (base)</span></span>
<span id="cb104-34"><a href="#cb104-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># }</span></span>
<span id="cb104-35"><a href="#cb104-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb104-36"><a href="#cb104-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for (i in 1:ndigits(x)) {</span></span>
<span id="cb104-37"><a href="#cb104-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     if (x &gt; 0) {</span></span>
<span id="cb104-38"><a href="#cb104-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         vec &lt;- c(x %% (base), vec)</span></span>
<span id="cb104-39"><a href="#cb104-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         x &lt;- x %/% (base)</span></span>
<span id="cb104-40"><a href="#cb104-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     }</span></span>
<span id="cb104-41"><a href="#cb104-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># }</span></span>
<span id="cb104-42"><a href="#cb104-42" aria-hidden="true" tabindex="-1"></a>    vec <span class="op">&lt;-</span> <span class="im">as</span>.integer(vec)</span>
<span id="cb104-43"><a href="#cb104-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>( rev(c(rep(<span class="dv">0</span>, state_length<span class="op">-</span>length(vec)), vec) ))</span>
<span id="cb104-44"><a href="#cb104-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return( c(rep(0, state_length-length(vec)), vec) )</span></span>
<span id="cb104-45"><a href="#cb104-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb104-46"><a href="#cb104-46" aria-hidden="true" tabindex="-1"></a><span class="co"># vec &lt;- c(1, 2, 0)</span></span>
<span id="cb104-47"><a href="#cb104-47" aria-hidden="true" tabindex="-1"></a><span class="co"># base &lt;- max(vec)+1</span></span>
<span id="cb104-48"><a href="#cb104-48" aria-hidden="true" tabindex="-1"></a><span class="co"># state_length &lt;- length(vec)</span></span>
<span id="cb104-49"><a href="#cb104-49" aria-hidden="true" tabindex="-1"></a><span class="co"># print(vec)</span></span>
<span id="cb104-50"><a href="#cb104-50" aria-hidden="true" tabindex="-1"></a><span class="co"># f &lt;- forth(vec, base)</span></span>
<span id="cb104-51"><a href="#cb104-51" aria-hidden="true" tabindex="-1"></a><span class="co"># print(f)</span></span>
<span id="cb104-52"><a href="#cb104-52" aria-hidden="true" tabindex="-1"></a><span class="co"># b &lt;- back(f, base, state_length)</span></span>
<span id="cb104-53"><a href="#cb104-53" aria-hidden="true" tabindex="-1"></a><span class="co"># print(b)</span></span>
<span id="cb104-54"><a href="#cb104-54" aria-hidden="true" tabindex="-1"></a><span class="co"># b &lt;- c(rep(0, length(vec)-length(b)), b)</span></span>
<span id="cb104-55"><a href="#cb104-55" aria-hidden="true" tabindex="-1"></a><span class="co"># print(b)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="1d2b1941-b5a7-417f-8a46-3146fcc59e76" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>graph <span class="op">&lt;-</span> standard_coalescent(sample_size)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>graph_as_matrix(graph)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<dl>
    <dt>$states</dt>
        <dd>
<table class="dataframe caption-top table table-sm table-striped small">
<caption>A matrix: 4 × 4 of type dbl</caption>
<tbody>
<tr class="odd">
<td>4</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>0</td>
<td>2</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>

</dd>
    <dt>$SIM</dt>
        <dd>
<table class="dataframe caption-top table table-sm table-striped small">
<caption>A matrix: 4 × 4 of type dbl</caption>
<tbody>
<tr class="odd">
<td>-6</td>
<td>6</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>0</td>
<td>-3</td>
<td>1</td>
<td>2</td>
</tr>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>-1</td>
<td>0</td>
</tr>
<tr class="even">
<td>0</td>
<td>0</td>
<td>0</td>
<td>-1</td>
</tr>
</tbody>
</table>

</dd>
    <dt>$IPV</dt>
        <dd><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>1</li><li>0</li><li>0</li><li>0</li></ol>
</dd>
    <dt>$indices</dt>
        <dd><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>2</li><li>3</li><li>4</li><li>5</li></ol>
</dd>
</dl>
</div>
</div>
<div id="6f49ff62-0311-4847-85c9-7f9dd27021b8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>plot_graph(graph_as_matrix(graph), size<span class="op">=</span>c(<span class="dv">10</span>, <span class="dv">8</span>), align<span class="op">=</span>TRUE, <span class="co"># rainbow=TRUE,</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>               fontsize<span class="op">=</span><span class="dv">16</span>, ranksep<span class="op">=</span><span class="dv">1</span>, nodesep<span class="op">=</span><span class="fl">0.25</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-78-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-24"><img src="coalescent-jointprob-ffi_files/figure-html/cell-78-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="82416c05-7eb3-4520-94a9-522a24c6589d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>expectation(graph)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
1.5
</div>
</div>
<div id="1dc37e54-99dd-4d0a-a8fb-b9fb10120f27" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>rewards <span class="op">&lt;-</span> make_discrete(graph, <span class="dv">1</span>)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>graph_as_matrix(graph)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<dl>
    <dt>$states</dt>
        <dd>
<table class="dataframe caption-top table table-sm table-striped small">
<caption>A matrix: 10 × 4 of type dbl</caption>
<tbody>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>4</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>0</td>
<td>2</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>

</dd>
    <dt>$SIM</dt>
        <dd>
<table class="dataframe caption-top table table-sm table-striped small">
<caption>A matrix: 10 × 10 of type dbl</caption>
<tbody>
<tr class="odd">
<td>-1.0</td>
<td>1</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
</tr>
<tr class="even">
<td>0.4</td>
<td>-1</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.6</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
</tr>
<tr class="odd">
<td>0.0</td>
<td>0</td>
<td>-1.0000000</td>
<td>0.0000000</td>
<td>1.0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
</tr>
<tr class="even">
<td>0.0</td>
<td>0</td>
<td>0.0000000</td>
<td>-1.0000000</td>
<td>1.0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
</tr>
<tr class="odd">
<td>0.0</td>
<td>0</td>
<td>0.1666667</td>
<td>0.3333333</td>
<td>-1.0</td>
<td>0.0000000</td>
<td>0.1666667</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.3333333</td>
</tr>
<tr class="even">
<td>0.0</td>
<td>0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0</td>
<td>-1.0000000</td>
<td>1.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
</tr>
<tr class="odd">
<td>0.0</td>
<td>0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0</td>
<td>0.6666667</td>
<td>-1.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
</tr>
<tr class="even">
<td>0.0</td>
<td>0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>-1.0000000</td>
<td>0.0000000</td>
<td>1.0000000</td>
</tr>
<tr class="odd">
<td>0.0</td>
<td>0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>-1.0000000</td>
<td>1.0000000</td>
</tr>
<tr class="even">
<td>0.0</td>
<td>0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.0</td>
<td>0.0000000</td>
<td>0.0000000</td>
<td>0.3333333</td>
<td>0.3333333</td>
<td>-1.0000000</td>
</tr>
</tbody>
</table>

</dd>
    <dt>$IPV</dt>
        <dd><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>0</li><li>1</li><li>0</li><li>0</li><li>0</li><li>0</li><li>0</li><li>0</li><li>0</li><li>0</li></ol>
</dd>
    <dt>$indices</dt>
        <dd><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>7</li><li>2</li><li>9</li><li>8</li><li>3</li><li>10</li><li>4</li><li>12</li><li>11</li><li>5</li></ol>
</dd>
</dl>
</div>
</div>
<div id="46158f28-d1cc-427d-afd7-9f1bb128068d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>plot_graph(graph_as_matrix(graph), <span class="co">#rainbow=TRUE, </span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>           size<span class="op">=</span>c(<span class="dv">10</span>, <span class="dv">8</span>), <span class="co">#align=TRUE,</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>               fontsize<span class="op">=</span><span class="dv">16</span>, ranksep<span class="op">=</span><span class="dv">1</span>, nodesep<span class="op">=</span><span class="fl">0.25</span>,</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>             <span class="co"># subgraph=TRUE, subgraphfun=function(state, index) as.character((index+1) %/% 2)</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-81-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-25"><img src="coalescent-jointprob-ffi_files/figure-html/cell-81-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="d683f31f-d798-4920-929f-d4f6ad22e424" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="bu">apply</span>(rewards[<span class="dv">1</span>:<span class="dv">3</span>,], <span class="dv">1</span>, function(x) expectation(graph, x))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>2</li><li>1</li><li>0.666666666666667</li></ol>
</div>
</div>
<div id="830882cd-1edd-4db5-9b0c-91387aa4cabd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>rev_graph <span class="op">&lt;-</span> reward_transform(graph, rewards[<span class="dv">1</span>,])</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>plot_graph(graph_as_matrix(rev_graph), <span class="co">#rainbow=TRUE, </span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>           size<span class="op">=</span>c(<span class="dv">10</span>, <span class="dv">8</span>), <span class="co">#align=TRUE,</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>               fontsize<span class="op">=</span><span class="dv">16</span>, ranksep<span class="op">=</span><span class="dv">1</span>, nodesep<span class="op">=</span><span class="fl">0.25</span>,</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>             <span class="co"># subgraph=TRUE, subgraphfun=function(state, index) as.character((index+1) %/% 2)</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-83-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-26"><img src="coalescent-jointprob-ffi_files/figure-html/cell-83-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="d27fa354-9ee0-4311-88c8-b90f4a40c0c6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>pdph(<span class="dv">1</span>:<span class="dv">10</span>, rev_graph)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>0.492</li><li>0.6852</li><li>0.81444</li><li>0.89442</li><li>0.9414756</li><li>0.96819828</li><li>0.982985028</li><li>0.9910075476</li><li>0.9952940586</li><li>0.997556851764</li></ol>
</div>
</div>
</section>
<section id="compute-joint-prob" class="level2">
<h2 class="anchored" data-anchor-id="compute-joint-prob">Compute joint prob</h2>
<blockquote class="blockquote">
<p><strong>Constraining the total number of mutations does not work</strong></p>
<p>The deficit is computed correctly as long as all max rewards so that all r scalar values in the CDF represents a reward combination in the MDF</p>
<p>Just like we can limit the number of each king of tons in the state space contruction, we might also limit the total number of mutations so that we, for example, can have at most one instance of two different tons (<code>total_tons=2</code>). E.g., a singleton and a tripleton.</p>
<p>However, this gives a a deficit problem I am not sure I can solve with this approach. In principle, the deficit should be taken care of, and I should just discard all joint probs for total numbers of tons larger than <code>total_tons</code> - but that does not seem to be the case…</p>
</blockquote>
<p><strong>maybe I don’t need loops if they are not selff-loops anyway. If aux-&gt;C has rate 1 then A-&gt;aux-&gt;C is the same as A-&gt;C. Below I just changed two things</strong></p>
<ol type="1">
<li>normalize the graph</li>
<li>use pdph instead of pph</li>
</ol>
<p><strong>BUT</strong> if I normalize I need to represent the residual prob as reward, which means I need to reward transform, which I cannot if I want to do everying in one go with the scalar trick.</p>
<div id="ec06ea81-05b9-46c2-8f08-37cb37421dde" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>sample_size <span class="op">&lt;-</span> <span class="dv">4</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>graph <span class="op">&lt;-</span> standard_coalescent(sample_size)</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>plot_graph(graph_as_matrix(graph), size<span class="op">=</span>c(<span class="dv">10</span>, <span class="dv">8</span>), align<span class="op">=</span>TRUE, rainbow<span class="op">=</span>TRUE,</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>               fontsize<span class="op">=</span><span class="dv">16</span>, ranksep<span class="op">=</span><span class="dv">1</span>, nodesep<span class="op">=</span><span class="fl">0.25</span>,</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>            subgraphs<span class="op">=</span>TRUE,         </span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>           subgraphfun<span class="op">=</span>function(state, index) paste(state[<span class="dv">1</span>:sample_size], collapse<span class="op">=</span><span class="st">""</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-85-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-27"><img src="coalescent-jointprob-ffi_files/figure-html/cell-85-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="99f17d1d-68c1-4911-90bb-55fd01cef866" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mutation_rate &lt;- 20000 * 31 * 5e-10 # 0.00031</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>mutation_rate <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>max_tons <span class="op">&lt;-</span> <span class="dv">20</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>total_tons <span class="op">&lt;-</span> Inf</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>base <span class="op">&lt;-</span> max_tons <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>graph <span class="op">&lt;-</span> joint_prob_coalescent(sample_size, mutation_rate, max_tons, total_tons<span class="op">=</span>total_tons)</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>weights_were_multiplied_with <span class="op">&lt;-</span> normalize_graph(graph)</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a><span class="co"># gam &lt;- graph_as_matrix(graph)</span></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a><span class="co">#gam</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="93aeb425-e499-4e97-b49e-3cab56d5b3aa" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (vertices_length(graph) <span class="op">&lt;</span> <span class="dv">50</span>)</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>    plot_graph(graph_as_matrix(graph), size<span class="op">=</span>c(<span class="dv">10</span>, <span class="dv">8</span>), align<span class="op">=</span>TRUE, rainbow<span class="op">=</span>TRUE,</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>               fontsize<span class="op">=</span><span class="dv">16</span>, ranksep<span class="op">=</span><span class="dv">2</span>, nodesep<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>             subgraphs<span class="op">=</span>TRUE,         </span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>           subgraphfun<span class="op">=</span>function(state, index) paste(state[<span class="dv">1</span>:sample_size], collapse<span class="op">=</span><span class="st">""</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Get last halves of states that server as mutation rewards:</p>
<div id="bb3f7312-8d03-49e3-9d65-5b8bda45f274" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>rewards <span class="op">&lt;-</span> states(graph)[, (sample_size<span class="op">+</span><span class="dv">1</span>):(<span class="dv">2</span><span class="op">*</span>sample_size)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Turn reward vectors into scalars (with the appropriate base):</p>
<div id="8c272e26-d72b-416d-8bfd-6bbd933f016b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>multi_rewards <span class="op">&lt;-</span> <span class="bu">apply</span>(rewards, <span class="dv">1</span>, forth, base<span class="op">=</span>base)</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>multi_rewards</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>0</li><li>0</li><li>0</li><li>1</li><li>0</li><li>0</li><li>1</li><li>21</li><li>2</li><li>0</li><li>21</li><li>1</li><li>441</li><li>1</li><li>2</li><li>22</li><li>21</li><li>42</li><li>3</li><li>21</li><li>42</li><li>1</li><li>2</li><li>442</li><li>441</li><li>882</li><li>22</li><li>2</li><li>3</li><li>23</li><li>22</li><li>43</li><li>462</li><li>42</li><li>63</li><li>4</li><li>42</li><li>63</li><li>2</li><li>3</li><li>443</li><li>442</li><li>883</li><li>882</li><li>1323</li><li>22</li><li>43</li><li>23</li><li>3</li><li>4</li><li>24</li><li>23</li><li>44</li><li>463</li><li>43</li><li>64</li><li>462</li><li>903</li><li>483</li><li>63</li><li>84</li><li>5</li><li>63</li><li>84</li><li>3</li><li>4</li><li>444</li><li>443</li><li>884</li><li>883</li><li>1324</li><li>1323</li><li>1764</li><li>43</li><li>64</li><li>23</li><li>44</li><li>24</li><li>4</li><li>5</li><li>25</li><li>24</li><li>45</li><li>464</li><li>44</li><li>65</li><li>463</li><li>904</li><li>484</li><li>64</li><li>85</li><li>903</li><li>1344</li><li>483</li><li>924</li><li>504</li><li>84</li><li>105</li><li>6</li><li>84</li><li>105</li><li>4</li><li>5</li><li>445</li><li>444</li><li>885</li><li>884</li><li>1325</li><li>1324</li><li>1765</li><li>1764</li><li>2205</li><li>64</li><li>85</li><li>44</li><li>65</li><li>24</li><li>45</li><li>25</li><li>5</li><li>6</li><li>26</li><li>25</li><li>46</li><li>465</li><li>45</li><li>66</li><li>464</li><li>905</li><li>485</li><li>65</li><li>86</li><li>904</li><li>1345</li><li>484</li><li>925</li><li>505</li><li>85</li><li>106</li><li>1344</li><li>1785</li><li>924</li><li>1365</li><li>504</li><li>945</li><li>525</li><li>105</li><li>126</li><li>7</li><li>105</li><li>126</li><li>5</li><li>6</li><li>446</li><li>445</li><li>886</li><li>885</li><li>1326</li><li>1325</li><li>1766</li><li>1765</li><li>2206</li><li>2205</li><li>2646</li><li>85</li><li>106</li><li>65</li><li>86</li><li>45</li><li>66</li><li>25</li><li>46</li><li>26</li><li>6</li><li>7</li><li>27</li><li>26</li><li>47</li><li>466</li><li>46</li><li>67</li><li>465</li><li>906</li><li>486</li><li>66</li><li>87</li><li>905</li><li>1346</li><li>485</li><li>926</li><li>506</li><li>86</li><li>107</li><li>1345</li><li>1786</li><li>925</li><li>1366</li><li>505</li><li>946</li><li>526</li><li>⋯</li><li>7853</li><li>8294</li><li>7433</li><li>7874</li><li>7013</li><li>7454</li><li>6593</li><li>7034</li><li>6173</li><li>6614</li><li>9133</li><li>8713</li><li>9154</li><li>8293</li><li>8734</li><li>7873</li><li>8314</li><li>7453</li><li>7894</li><li>7033</li><li>7474</li><li>6613</li><li>7054</li><li>9153</li><li>8733</li><li>9174</li><li>8313</li><li>8754</li><li>7893</li><li>8334</li><li>7473</li><li>7914</li><li>7053</li><li>7494</li><li>9173</li><li>8753</li><li>9194</li><li>8333</li><li>8774</li><li>7913</li><li>8354</li><li>7493</li><li>7934</li><li>9193</li><li>8773</li><li>9214</li><li>8353</li><li>8794</li><li>7933</li><li>8374</li><li>9213</li><li>8793</li><li>9234</li><li>8373</li><li>8814</li><li>9233</li><li>8813</li><li>9254</li><li>9253</li><li>9134</li><li>8714</li><li>9155</li><li>8294</li><li>8735</li><li>7874</li><li>8315</li><li>7454</li><li>7895</li><li>7034</li><li>7475</li><li>6614</li><li>7055</li><li>9154</li><li>8734</li><li>9175</li><li>8314</li><li>8755</li><li>7894</li><li>8335</li><li>7474</li><li>7915</li><li>7054</li><li>7495</li><li>9174</li><li>8754</li><li>9195</li><li>8334</li><li>8775</li><li>7914</li><li>8355</li><li>7494</li><li>7935</li><li>9194</li><li>8774</li><li>9215</li><li>8354</li><li>8795</li><li>7934</li><li>8375</li><li>9214</li><li>8794</li><li>9235</li><li>8374</li><li>8815</li><li>9234</li><li>8814</li><li>9255</li><li>9254</li><li>9155</li><li>8735</li><li>9176</li><li>8315</li><li>8756</li><li>7895</li><li>8336</li><li>7475</li><li>7916</li><li>7055</li><li>7496</li><li>9175</li><li>8755</li><li>9196</li><li>8335</li><li>8776</li><li>7915</li><li>8356</li><li>7495</li><li>7936</li><li>9195</li><li>8775</li><li>9216</li><li>8355</li><li>8796</li><li>7935</li><li>8376</li><li>9215</li><li>8795</li><li>9236</li><li>8375</li><li>8816</li><li>9235</li><li>8815</li><li>9256</li><li>9255</li><li>9176</li><li>8756</li><li>9197</li><li>8336</li><li>8777</li><li>7916</li><li>8357</li><li>7496</li><li>7937</li><li>9196</li><li>8776</li><li>9217</li><li>8356</li><li>8797</li><li>7936</li><li>8377</li><li>9216</li><li>8796</li><li>9237</li><li>8376</li><li>8817</li><li>9236</li><li>8816</li><li>9257</li><li>9256</li><li>9197</li><li>8777</li><li>9218</li><li>8357</li><li>8798</li><li>7937</li><li>8378</li><li>9217</li><li>8797</li><li>9238</li><li>8377</li><li>8818</li><li>9237</li><li>8817</li><li>9258</li><li>9257</li><li>9218</li><li>8798</li><li>9239</li><li>8378</li><li>8819</li><li>9238</li><li>8818</li><li>9259</li><li>9258</li><li>9239</li><li>8819</li><li>9260</li><li>9259</li><li>9260</li><li>0</li></ol>
</div>
</div>
<p>Loop over states except starting to find trash vertices and give them a reward so they won’t dissapear in the reward transformation. They will not contribute this reward because they are dead ends:</p>
<div id="801b1b24-d944-48ca-a947-6f54e377b71c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>trash_states <span class="op">&lt;-</span> c()</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="kw">in</span> <span class="dv">2</span>:vertices_length(graph)) {</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  vertex <span class="op">&lt;-</span> vertex_at(graph, i)</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="bu">sum</span>(vertex$state) <span class="op">==</span> <span class="dv">0</span>) {</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    multi_rewards[i] <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>    trash_states <span class="op">&lt;-</span> c(trash_states, i)</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>trash_states</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>3334</li><li>19428</li></ol>
</div>
</div>
<div id="e0cc56fb-78ed-4293-8ed7-41bed9b15530" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>multi_rewards</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>0</li><li>0</li><li>0</li><li>1</li><li>0</li><li>0</li><li>1</li><li>21</li><li>2</li><li>0</li><li>21</li><li>1</li><li>441</li><li>1</li><li>2</li><li>22</li><li>21</li><li>42</li><li>3</li><li>21</li><li>42</li><li>1</li><li>2</li><li>442</li><li>441</li><li>882</li><li>22</li><li>2</li><li>3</li><li>23</li><li>22</li><li>43</li><li>462</li><li>42</li><li>63</li><li>4</li><li>42</li><li>63</li><li>2</li><li>3</li><li>443</li><li>442</li><li>883</li><li>882</li><li>1323</li><li>22</li><li>43</li><li>23</li><li>3</li><li>4</li><li>24</li><li>23</li><li>44</li><li>463</li><li>43</li><li>64</li><li>462</li><li>903</li><li>483</li><li>63</li><li>84</li><li>5</li><li>63</li><li>84</li><li>3</li><li>4</li><li>444</li><li>443</li><li>884</li><li>883</li><li>1324</li><li>1323</li><li>1764</li><li>43</li><li>64</li><li>23</li><li>44</li><li>24</li><li>4</li><li>5</li><li>25</li><li>24</li><li>45</li><li>464</li><li>44</li><li>65</li><li>463</li><li>904</li><li>484</li><li>64</li><li>85</li><li>903</li><li>1344</li><li>483</li><li>924</li><li>504</li><li>84</li><li>105</li><li>6</li><li>84</li><li>105</li><li>4</li><li>5</li><li>445</li><li>444</li><li>885</li><li>884</li><li>1325</li><li>1324</li><li>1765</li><li>1764</li><li>2205</li><li>64</li><li>85</li><li>44</li><li>65</li><li>24</li><li>45</li><li>25</li><li>5</li><li>6</li><li>26</li><li>25</li><li>46</li><li>465</li><li>45</li><li>66</li><li>464</li><li>905</li><li>485</li><li>65</li><li>86</li><li>904</li><li>1345</li><li>484</li><li>925</li><li>505</li><li>85</li><li>106</li><li>1344</li><li>1785</li><li>924</li><li>1365</li><li>504</li><li>945</li><li>525</li><li>105</li><li>126</li><li>7</li><li>105</li><li>126</li><li>5</li><li>6</li><li>446</li><li>445</li><li>886</li><li>885</li><li>1326</li><li>1325</li><li>1766</li><li>1765</li><li>2206</li><li>2205</li><li>2646</li><li>85</li><li>106</li><li>65</li><li>86</li><li>45</li><li>66</li><li>25</li><li>46</li><li>26</li><li>6</li><li>7</li><li>27</li><li>26</li><li>47</li><li>466</li><li>46</li><li>67</li><li>465</li><li>906</li><li>486</li><li>66</li><li>87</li><li>905</li><li>1346</li><li>485</li><li>926</li><li>506</li><li>86</li><li>107</li><li>1345</li><li>1786</li><li>925</li><li>1366</li><li>505</li><li>946</li><li>526</li><li>⋯</li><li>7853</li><li>8294</li><li>7433</li><li>7874</li><li>7013</li><li>7454</li><li>6593</li><li>7034</li><li>6173</li><li>6614</li><li>9133</li><li>8713</li><li>9154</li><li>8293</li><li>8734</li><li>7873</li><li>8314</li><li>7453</li><li>7894</li><li>7033</li><li>7474</li><li>6613</li><li>7054</li><li>9153</li><li>8733</li><li>9174</li><li>8313</li><li>8754</li><li>7893</li><li>8334</li><li>7473</li><li>7914</li><li>7053</li><li>7494</li><li>9173</li><li>8753</li><li>9194</li><li>8333</li><li>8774</li><li>7913</li><li>8354</li><li>7493</li><li>7934</li><li>9193</li><li>8773</li><li>9214</li><li>8353</li><li>8794</li><li>7933</li><li>8374</li><li>9213</li><li>8793</li><li>9234</li><li>8373</li><li>8814</li><li>9233</li><li>8813</li><li>9254</li><li>9253</li><li>9134</li><li>8714</li><li>9155</li><li>8294</li><li>8735</li><li>7874</li><li>8315</li><li>7454</li><li>7895</li><li>7034</li><li>7475</li><li>6614</li><li>7055</li><li>9154</li><li>8734</li><li>9175</li><li>8314</li><li>8755</li><li>7894</li><li>8335</li><li>7474</li><li>7915</li><li>7054</li><li>7495</li><li>9174</li><li>8754</li><li>9195</li><li>8334</li><li>8775</li><li>7914</li><li>8355</li><li>7494</li><li>7935</li><li>9194</li><li>8774</li><li>9215</li><li>8354</li><li>8795</li><li>7934</li><li>8375</li><li>9214</li><li>8794</li><li>9235</li><li>8374</li><li>8815</li><li>9234</li><li>8814</li><li>9255</li><li>9254</li><li>9155</li><li>8735</li><li>9176</li><li>8315</li><li>8756</li><li>7895</li><li>8336</li><li>7475</li><li>7916</li><li>7055</li><li>7496</li><li>9175</li><li>8755</li><li>9196</li><li>8335</li><li>8776</li><li>7915</li><li>8356</li><li>7495</li><li>7936</li><li>9195</li><li>8775</li><li>9216</li><li>8355</li><li>8796</li><li>7935</li><li>8376</li><li>9215</li><li>8795</li><li>9236</li><li>8375</li><li>8816</li><li>9235</li><li>8815</li><li>9256</li><li>9255</li><li>9176</li><li>8756</li><li>9197</li><li>8336</li><li>8777</li><li>7916</li><li>8357</li><li>7496</li><li>7937</li><li>9196</li><li>8776</li><li>9217</li><li>8356</li><li>8797</li><li>7936</li><li>8377</li><li>9216</li><li>8796</li><li>9237</li><li>8376</li><li>8817</li><li>9236</li><li>8816</li><li>9257</li><li>9256</li><li>9197</li><li>8777</li><li>9218</li><li>8357</li><li>8798</li><li>7937</li><li>8378</li><li>9217</li><li>8797</li><li>9238</li><li>8377</li><li>8818</li><li>9237</li><li>8817</li><li>9258</li><li>9257</li><li>9218</li><li>8798</li><li>9239</li><li>8378</li><li>8819</li><li>9238</li><li>8818</li><li>9259</li><li>9258</li><li>9239</li><li>8819</li><li>9260</li><li>9259</li><li>9260</li><li>1</li></ol>
</div>
</div>
<p>Reward transform graph using scalar rewards:</p>
<div id="ac1e6694-be7c-40fd-a763-353ab911e4c0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>rew_graph <span class="op">&lt;-</span> reward_transform(graph, multi_rewards)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="a7b5cde1-fba9-465e-b690-8c2694f62712" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (vertices_length(graph) <span class="op">&lt;</span> <span class="dv">50</span>)</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>    plot_graph(graph_as_matrix(rew_graph),</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>           rainbow<span class="op">=</span>TRUE,</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>           size<span class="op">=</span>c(<span class="dv">8</span>, <span class="dv">8</span>), </span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>           align<span class="op">=</span>TRUE,</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>           fontsize<span class="op">=</span><span class="dv">14</span>, ranksep<span class="op">=</span><span class="dv">1</span>, nodesep<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>           <span class="co"># subgraphs=TRUE, subgraphfun=function(state, index) as.character((index+1) %/% 2)</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>           )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Compute CDF assming no mutation count exceeds <code>max_tons</code>:</p>
<div id="999ec5ff-a494-4327-9f68-5bf34b74f404" class="cell" data-scrolled="true">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>cdf_df <span class="op">&lt;-</span> data.frame(t<span class="op">=</span>seq(<span class="dv">0</span>, base<span class="op">^</span>(sample_size<span class="op">-</span><span class="dv">1</span>) <span class="op">-</span> <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>cdf_df[<span class="st">'cdf'</span>] <span class="op">&lt;-</span> sapply(cdf_df$t, function (t) pdph(t, rew_graph))</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="co"># cdf_df['cdf'] &lt;- sapply(cdf_df$t, function (t) pph(t, rew_graph))</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>tail(cdf_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small">
<caption>A data.frame: 6 × 2</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">t</th>
<th data-quarto-table-cell-role="th" scope="col">cdf</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">9256</th>
<td>9255</td>
<td>0.9796789</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">9257</th>
<td>9256</td>
<td>0.9796824</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">9258</th>
<td>9257</td>
<td>0.9796860</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">9259</th>
<td>9258</td>
<td>0.9796896</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">9260</th>
<td>9259</td>
<td>0.9796932</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">9261</th>
<td>9260</td>
<td>0.9796968</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Convert reward scalars back into state vectors representing ton counts:</p>
<div id="d9f818e0-e545-426a-a3fe-0f8961fd6035" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">&lt;-</span> lapply(cdf_df$t, back, base<span class="op">=</span>base, state_length<span class="op">=</span>sample_size)</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">&lt;-</span> do.call(rbind, x)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="caa3d9cd-7b88-48ec-99f1-f80f9732e045" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># is_additional_deficit &lt;- as.integer(rowSums(m) &gt; total_tons)</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="co"># p &lt;- df$cdf</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="co"># pdf_from_cdf &lt;- c(p[1], p[2:length(p)] - p[-length(p)])</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a><span class="co"># additional_deficit &lt;- cumsum(pdf_from_cdf * is_additional_deficit)</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a><span class="co"># additional_deficit</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9fec6e9d-49a6-4126-b5f4-6b82a87728d0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">&lt;-</span> cbind(cdf_df, data.frame(m))</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>tail(df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small">
<caption>A data.frame: 6 × 6</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">t</th>
<th data-quarto-table-cell-role="th" scope="col">cdf</th>
<th data-quarto-table-cell-role="th" scope="col">X1</th>
<th data-quarto-table-cell-role="th" scope="col">X2</th>
<th data-quarto-table-cell-role="th" scope="col">X3</th>
<th data-quarto-table-cell-role="th" scope="col">X4</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">9256</th>
<td>9255</td>
<td>0.9796789</td>
<td>15</td>
<td>20</td>
<td>20</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">9257</th>
<td>9256</td>
<td>0.9796824</td>
<td>16</td>
<td>20</td>
<td>20</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">9258</th>
<td>9257</td>
<td>0.9796860</td>
<td>17</td>
<td>20</td>
<td>20</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">9259</th>
<td>9258</td>
<td>0.9796896</td>
<td>18</td>
<td>20</td>
<td>20</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">9260</th>
<td>9259</td>
<td>0.9796932</td>
<td>19</td>
<td>20</td>
<td>20</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">9261</th>
<td>9260</td>
<td>0.9796968</td>
<td>20</td>
<td>20</td>
<td>20</td>
<td>0</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The deficit is taken care of, so you should discard all joint probs for total numbers of tons larger than <code>total_tons</code>:</p>
<div id="7a2f46c6-1b58-4e62-b80c-1e0a3fac8350" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># df &lt;- df[!is_additional_deficit, ]</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="co"># df</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="dbf1c74a-c439-453c-a576-eba749223cd1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">%&gt;%</span> ggplot(aes(x<span class="op">=</span>t, y<span class="op">=</span>cdf)) <span class="op">+</span> </span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>    geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">'scaled time'</span>, y<span class="op">=</span><span class="st">'probability'</span>) <span class="op">+</span> </span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>    despine <span class="op">+</span> ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-99-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-28"><img src="coalescent-jointprob-ffi_files/figure-html/cell-99-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Compute probability of standing in on of the trash states for each time t in our CDF. These represent the deficit of the computed CDF:</p>
<blockquote class="blockquote">
<p>Make sure the stop_probability is the discrete version of that is what we are doing</p>
</blockquote>
<div id="0fa499b3-04fd-4c08-a028-c4b01d9487da" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>trash_prob <span class="op">&lt;-</span> c()</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="kw">in</span> df$t) {</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># s &lt;- stop_probability(graph, t)</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    s <span class="op">&lt;-</span> dph_stop_probability(graph, t)</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>    trash_prob <span class="op">&lt;-</span> c(trash_prob, <span class="bu">sum</span>(s[trash_states]))</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'cdf_deficit'</span>] <span class="op">&lt;-</span> trash_prob</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>head(df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small">
<caption>A data.frame: 6 × 7</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">t</th>
<th data-quarto-table-cell-role="th" scope="col">cdf</th>
<th data-quarto-table-cell-role="th" scope="col">X1</th>
<th data-quarto-table-cell-role="th" scope="col">X2</th>
<th data-quarto-table-cell-role="th" scope="col">X3</th>
<th data-quarto-table-cell-role="th" scope="col">X4</th>
<th data-quarto-table-cell-role="th" scope="col">cdf_deficit</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">1</th>
<td>0</td>
<td>0.1000000</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">2</th>
<td>1</td>
<td>0.1233308</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">3</th>
<td>2</td>
<td>0.1614973</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">4</th>
<td>3</td>
<td>0.2117425</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">5</th>
<td>4</td>
<td>0.2303889</td>
<td>4</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="row">6</th>
<td>5</td>
<td>0.2476603</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>CDF deficit:</p>
<div id="1471ec49-49c1-4772-805d-72e24bb6c8da" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">%&gt;%</span> ggplot(aes(x<span class="op">=</span>t, y<span class="op">=</span>cdf_deficit)) <span class="op">+</span> </span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>    geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">'scaled time'</span>, y<span class="op">=</span><span class="st">'probability'</span>) <span class="op">+</span> </span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    despine <span class="op">+</span> ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-101-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-29"><img src="coalescent-jointprob-ffi_files/figure-html/cell-101-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Sanity check: adding CDF and deficit should produce a CDF that goes to 1:</p>
<div id="76270025-fc59-49ab-a135-02b77151274c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'cdf_incl_deficit'</span>] <span class="op">&lt;-</span> df$cdf <span class="op">+</span> df$cdf_deficit</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="a78bc3da-717f-477e-901f-3f2e1ef35c53" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">%&gt;%</span> ggplot(aes(x<span class="op">=</span>t, y<span class="op">=</span>cdf_incl_deficit)) <span class="op">+</span> </span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>    geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">'scaled time'</span>, y<span class="op">=</span><span class="st">'probability'</span>) <span class="op">+</span> </span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>    despine <span class="op">+</span> </span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    ylim(<span class="dv">0</span>, <span class="dv">1</span>) <span class="op">+</span> </span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>    geom_hline(yintercept<span class="op">=</span><span class="dv">1</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-103-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-30"><img src="coalescent-jointprob-ffi_files/figure-html/cell-103-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>I.e., and a PDF that sum to one:</p>
<div id="f4ee9fa0-7e6f-468f-9101-43c1efa029fd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">&lt;-</span> df$cdf_incl_deficit</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'pdf_from_cdf_incl_deficit'</span>] <span class="op">&lt;-</span> c(p[<span class="dv">1</span>], p[<span class="dv">2</span>:length(p)] <span class="op">-</span> p[<span class="op">-</span>length(p)])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="5c46909e-c74d-4e79-9394-ac6899092f30" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">%&gt;%</span> ggplot(aes(x<span class="op">=</span>t, y<span class="op">=</span>pdf_from_cdf_incl_deficit)) <span class="op">+</span> </span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>    geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">'scaled time'</span>, y<span class="op">=</span><span class="st">'probability'</span>) <span class="op">+</span> </span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>    despine</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-105-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-31"><img src="coalescent-jointprob-ffi_files/figure-html/cell-105-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="7d72c9ff-5ec9-4289-b5e7-a15a0ada4eba" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="bu">sum</span>(df$pdf_from_cdf_incl_deficit)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
0.979780061019623
</div>
</div>
<p>It <strong>almost</strong> does… Maybe a numerical issue</p>
<p>Compute PDF from the CDF (<strong>this is the one we are after</strong>):</p>
<div id="a14baebd-3d2c-4ee3-b27a-58cacaab541b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">&lt;-</span> df$cdf</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'pdf_from_cdf'</span>] <span class="op">&lt;-</span> c(p[<span class="dv">1</span>], p[<span class="dv">2</span>:length(p)] <span class="op">-</span> p[<span class="op">-</span>length(p)])</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'prob'</span>] <span class="op">=</span> df$pdf_from_cdf</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="3c326fb1-4c0c-4fae-90ba-9bd4455553b9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">%&gt;%</span> ggplot(aes(x<span class="op">=</span>t, y<span class="op">=</span>pdf_from_cdf)) <span class="op">+</span> </span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>    geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">'scaled time'</span>, y<span class="op">=</span><span class="st">'probability'</span>) <span class="op">+</span> </span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>    despine</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-108-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-32"><img src="coalescent-jointprob-ffi_files/figure-html/cell-108-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>The reason we need to go through the CDF to get the PDF is that the PDF function in PtD computes the distribution of times when the absorbing state is reached. It this cannot take the deficit in trash_states into account. The PDF commputed directly looks like this:</p>
<blockquote class="blockquote">
<p>Make sure I ues the discrete version here if I also use the dicscrete CDF above</p>
</blockquote>
<div id="283654b8-f944-4b9d-9306-e5de3bffe524" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># df['pdf'] &lt;- sapply(df$t, function (t) dph(t, rew_graph))</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'pdf'</span>] <span class="op">&lt;-</span> sapply(df$t, function (t) ddph(t, rew_graph))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4d720eae-e9bc-464c-a78a-18afe6a2afbd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">%&gt;%</span> ggplot(aes(x<span class="op">=</span>t, y<span class="op">=</span>pdf)) <span class="op">+</span> </span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>    geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">'scaled time'</span>, y<span class="op">=</span><span class="st">'probability'</span>) <span class="op">+</span> </span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    despine </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-110-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-33"><img src="coalescent-jointprob-ffi_files/figure-html/cell-110-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="when-we-do-the-discrete-version-we-dont-need-to-go-through-the-cdf-to-get-the-pdf.-we-can-just-use-the-ddph-directly" class="level2">
<h2 class="anchored" data-anchor-id="when-we-do-the-discrete-version-we-dont-need-to-go-through-the-cdf-to-get-the-pdf.-we-can-just-use-the-ddph-directly">When we do the discrete version, we don’t need to go through the CDF to get the PDF. We can just use the <code>ddph</code> directly</h2>
<div id="0694dfdc-91fc-4a49-9f03-28756eb82fbf" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'diff'</span>] <span class="op">&lt;-</span> df[<span class="st">'pdf_from_cdf'</span>] <span class="op">-</span> df[<span class="st">'pdf'</span>]</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">%&gt;%</span> ggplot(aes(x<span class="op">=</span>t, y<span class="op">=</span>diff)) <span class="op">+</span> </span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>    geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">'scaled time'</span>, y<span class="op">=</span><span class="st">'probability'</span>) <span class="op">+</span> </span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>    despine </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-111-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-34"><img src="coalescent-jointprob-ffi_files/figure-html/cell-111-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>The marginal expectations does not match the SFS proportions, because paths that accumulate more than <code>max_tons</code> singletons will end in the trash state and not have the opportunity to also accumulate doubletons etc. That reflects that the the joint prob of a singleton <em>and</em> a doubleton is be a subset of the singleton probability. That way the total marginal singleton prob will be roughly sfs expectation, but the total marginal doubleton prob will be much too small:</p>
<div id="1bb84df6-565f-4e56-a866-35c8f568829f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>sfs <span class="op">&lt;-</span> c(<span class="dv">1</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>)</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>sfs <span class="op">/</span> <span class="bu">sum</span>(sfs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>0.545454545454546</li><li>0.272727272727273</li><li>0.181818181818182</li></ol>
</div>
</div>
<div id="cfda6f75-20a4-4340-aa27-33ae20428d7e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>df[df$X1<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span> df$X2<span class="op">==</span><span class="dv">0</span> <span class="op">&amp;</span> df$X3<span class="op">==</span><span class="dv">1</span>, ]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small">
<caption>A data.frame: 1 × 13</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">t</th>
<th data-quarto-table-cell-role="th" scope="col">cdf</th>
<th data-quarto-table-cell-role="th" scope="col">X1</th>
<th data-quarto-table-cell-role="th" scope="col">X2</th>
<th data-quarto-table-cell-role="th" scope="col">X3</th>
<th data-quarto-table-cell-role="th" scope="col">X4</th>
<th data-quarto-table-cell-role="th" scope="col">cdf_deficit</th>
<th data-quarto-table-cell-role="th" scope="col">cdf_incl_deficit</th>
<th data-quarto-table-cell-role="th" scope="col">pdf_from_cdf_incl_deficit</th>
<th data-quarto-table-cell-role="th" scope="col">pdf_from_cdf</th>
<th data-quarto-table-cell-role="th" scope="col">prob</th>
<th data-quarto-table-cell-role="th" scope="col">pdf</th>
<th data-quarto-table-cell-role="th" scope="col">diff</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="row">443</th>
<td>442</td>
<td>0.7136648</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.7137481</td>
<td>0.0002646858</td>
<td>0.0002646858</td>
<td>0.0002646858</td>
<td>0.0002646858</td>
<td>-2.238877e-17</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="4fe560a8-3a2b-4989-a113-54f5213cca5e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small">
<caption>A data.frame: 9261 × 13</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">t</th>
<th data-quarto-table-cell-role="th" scope="col">cdf</th>
<th data-quarto-table-cell-role="th" scope="col">X1</th>
<th data-quarto-table-cell-role="th" scope="col">X2</th>
<th data-quarto-table-cell-role="th" scope="col">X3</th>
<th data-quarto-table-cell-role="th" scope="col">X4</th>
<th data-quarto-table-cell-role="th" scope="col">cdf_deficit</th>
<th data-quarto-table-cell-role="th" scope="col">cdf_incl_deficit</th>
<th data-quarto-table-cell-role="th" scope="col">pdf_from_cdf_incl_deficit</th>
<th data-quarto-table-cell-role="th" scope="col">pdf_from_cdf</th>
<th data-quarto-table-cell-role="th" scope="col">prob</th>
<th data-quarto-table-cell-role="th" scope="col">pdf</th>
<th data-quarto-table-cell-role="th" scope="col">diff</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.1000000</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.1000000</td>
<td>0.100000000</td>
<td>0.100000000</td>
<td>0.100000000</td>
<td>0.100000000</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.1233308</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.1233308</td>
<td>0.023330814</td>
<td>0.023330814</td>
<td>0.023330814</td>
<td>0.023330814</td>
<td>-6.938894e-18</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.1614973</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.1614973</td>
<td>0.038166529</td>
<td>0.038166529</td>
<td>0.038166529</td>
<td>0.038166529</td>
<td>-6.938894e-18</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.2117425</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.2117425</td>
<td>0.050245196</td>
<td>0.050245196</td>
<td>0.050245196</td>
<td>0.050245196</td>
<td>6.938894e-18</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.2303889</td>
<td>4</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.2303889</td>
<td>0.018646386</td>
<td>0.018646386</td>
<td>0.018646386</td>
<td>0.018646386</td>
<td>-3.469447e-18</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.2476603</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.2476603</td>
<td>0.017271404</td>
<td>0.017271404</td>
<td>0.017271404</td>
<td>0.017271404</td>
<td>-1.387779e-17</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.2629493</td>
<td>6</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.2629493</td>
<td>0.015288932</td>
<td>0.015288932</td>
<td>0.015288932</td>
<td>0.015288932</td>
<td>2.428613e-17</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.2762541</td>
<td>7</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.2762541</td>
<td>0.013304841</td>
<td>0.013304841</td>
<td>0.013304841</td>
<td>0.013304841</td>
<td>5.204170e-18</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.2878150</td>
<td>8</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.2878150</td>
<td>0.011560939</td>
<td>0.011560939</td>
<td>0.011560939</td>
<td>0.011560939</td>
<td>-1.040834e-17</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.2979278</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.2979278</td>
<td>0.010112710</td>
<td>0.010112710</td>
<td>0.010112710</td>
<td>0.010112710</td>
<td>-2.255141e-17</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.3068648</td>
<td>10</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3068648</td>
<td>0.008937019</td>
<td>0.008937019</td>
<td>0.008937019</td>
<td>0.008937019</td>
<td>-2.081668e-17</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.3148516</td>
<td>11</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3148516</td>
<td>0.007986783</td>
<td>0.007986783</td>
<td>0.007986783</td>
<td>0.007986783</td>
<td>-1.734723e-17</td>
</tr>
<tr class="odd">
<td>12</td>
<td>0.3220662</td>
<td>12</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3220662</td>
<td>0.007214610</td>
<td>0.007214610</td>
<td>0.007214610</td>
<td>0.007214610</td>
<td>-1.127570e-17</td>
</tr>
<tr class="even">
<td>13</td>
<td>0.3286470</td>
<td>13</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3286470</td>
<td>0.006580816</td>
<td>0.006580816</td>
<td>0.006580816</td>
<td>0.006580816</td>
<td>8.673617e-19</td>
</tr>
<tr class="odd">
<td>14</td>
<td>0.3347016</td>
<td>14</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3347016</td>
<td>0.006054616</td>
<td>0.006054616</td>
<td>0.006054616</td>
<td>0.006054616</td>
<td>2.428613e-17</td>
</tr>
<tr class="even">
<td>15</td>
<td>0.3403145</td>
<td>15</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3403145</td>
<td>0.005612866</td>
<td>0.005612866</td>
<td>0.005612866</td>
<td>0.005612866</td>
<td>-1.301043e-17</td>
</tr>
<tr class="odd">
<td>16</td>
<td>0.3455527</td>
<td>16</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3455527</td>
<td>0.005238284</td>
<td>0.005238284</td>
<td>0.005238284</td>
<td>0.005238284</td>
<td>-6.938894e-18</td>
</tr>
<tr class="even">
<td>17</td>
<td>0.3504706</td>
<td>17</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3504706</td>
<td>0.004917865</td>
<td>0.004917865</td>
<td>0.004917865</td>
<td>0.004917865</td>
<td>1.734723e-18</td>
</tr>
<tr class="odd">
<td>18</td>
<td>0.3551123</td>
<td>18</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3551123</td>
<td>0.004641673</td>
<td>0.004641673</td>
<td>0.004641673</td>
<td>0.004641673</td>
<td>-2.168404e-17</td>
</tr>
<tr class="even">
<td>19</td>
<td>0.3595143</td>
<td>19</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3595143</td>
<td>0.004401981</td>
<td>0.004401981</td>
<td>0.004401981</td>
<td>0.004401981</td>
<td>-6.938894e-18</td>
</tr>
<tr class="odd">
<td>20</td>
<td>0.3637069</td>
<td>20</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.000000e+00</td>
<td>0.3637069</td>
<td>0.004192673</td>
<td>0.004192673</td>
<td>0.004192673</td>
<td>0.004192673</td>
<td>2.602085e-18</td>
</tr>
<tr class="even">
<td>21</td>
<td>0.3677158</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>4.398047e-09</td>
<td>0.3677158</td>
<td>0.004008840</td>
<td>0.004008836</td>
<td>0.004008836</td>
<td>0.004008836</td>
<td>2.602085e-18</td>
</tr>
<tr class="odd">
<td>22</td>
<td>0.3715622</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1.730539e-08</td>
<td>0.3715623</td>
<td>0.003846485</td>
<td>0.003846472</td>
<td>0.003846472</td>
<td>0.003846472</td>
<td>-1.778092e-17</td>
</tr>
<tr class="even">
<td>23</td>
<td>0.3752645</td>
<td>2</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>2.678447e-05</td>
<td>0.3752913</td>
<td>0.003729069</td>
<td>0.003702302</td>
<td>0.003702302</td>
<td>0.003702302</td>
<td>-1.301043e-17</td>
</tr>
<tr class="odd">
<td>24</td>
<td>0.3788382</td>
<td>3</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>4.942828e-05</td>
<td>0.3788876</td>
<td>0.003596256</td>
<td>0.003573612</td>
<td>0.003573612</td>
<td>0.003573612</td>
<td>-1.301043e-17</td>
</tr>
<tr class="even">
<td>25</td>
<td>0.3822963</td>
<td>4</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>6.385415e-05</td>
<td>0.3823602</td>
<td>0.003472572</td>
<td>0.003458146</td>
<td>0.003458146</td>
<td>0.003458146</td>
<td>-1.387779e-17</td>
</tr>
<tr class="odd">
<td>26</td>
<td>0.3856503</td>
<td>5</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>7.209272e-05</td>
<td>0.3857224</td>
<td>0.003362254</td>
<td>0.003354016</td>
<td>0.003354016</td>
<td>0.003354016</td>
<td>6.071532e-18</td>
</tr>
<tr class="even">
<td>27</td>
<td>0.3889100</td>
<td>6</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>7.658223e-05</td>
<td>0.3889865</td>
<td>0.003264130</td>
<td>0.003259640</td>
<td>0.003259640</td>
<td>0.003259640</td>
<td>-5.204170e-18</td>
</tr>
<tr class="odd">
<td>28</td>
<td>0.3920836</td>
<td>7</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>7.901387e-05</td>
<td>0.3921627</td>
<td>0.003176117</td>
<td>0.003173686</td>
<td>0.003173686</td>
<td>0.003173686</td>
<td>-1.040834e-17</td>
</tr>
<tr class="even">
<td>29</td>
<td>0.3951787</td>
<td>8</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>8.037496e-05</td>
<td>0.3952590</td>
<td>0.003096387</td>
<td>0.003095026</td>
<td>0.003095026</td>
<td>0.003095026</td>
<td>-2.385245e-17</td>
</tr>
<tr class="odd">
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
</tr>
<tr class="even">
<td>9231</td>
<td>0.9795925</td>
<td>12</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9796758</td>
<td>3.607475e-06</td>
<td>3.607475e-06</td>
<td>3.607475e-06</td>
<td>3.607475e-06</td>
<td>1.581919e-17</td>
</tr>
<tr class="odd">
<td>9232</td>
<td>0.9795961</td>
<td>13</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9796794</td>
<td>3.606640e-06</td>
<td>3.606640e-06</td>
<td>3.606640e-06</td>
<td>3.606640e-06</td>
<td>3.827276e-17</td>
</tr>
<tr class="even">
<td>9233</td>
<td>0.9795997</td>
<td>14</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9796830</td>
<td>3.605805e-06</td>
<td>3.605805e-06</td>
<td>3.605805e-06</td>
<td>3.605805e-06</td>
<td>-8.857000e-18</td>
</tr>
<tr class="odd">
<td>9234</td>
<td>0.9796033</td>
<td>15</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9796866</td>
<td>3.604971e-06</td>
<td>3.604971e-06</td>
<td>3.604971e-06</td>
<td>3.604971e-06</td>
<td>-3.186792e-17</td>
</tr>
<tr class="even">
<td>9235</td>
<td>0.9796069</td>
<td>16</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9796902</td>
<td>3.604136e-06</td>
<td>3.604136e-06</td>
<td>3.604136e-06</td>
<td>3.604136e-06</td>
<td>-4.810512e-17</td>
</tr>
<tr class="odd">
<td>9236</td>
<td>0.9796106</td>
<td>17</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9796938</td>
<td>3.603302e-06</td>
<td>3.603302e-06</td>
<td>3.603302e-06</td>
<td>3.603302e-06</td>
<td>3.612087e-17</td>
</tr>
<tr class="even">
<td>9237</td>
<td>0.9796142</td>
<td>18</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9796974</td>
<td>3.602468e-06</td>
<td>3.602468e-06</td>
<td>3.602468e-06</td>
<td>3.602468e-06</td>
<td>-1.868893e-17</td>
</tr>
<tr class="odd">
<td>9238</td>
<td>0.9796178</td>
<td>19</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797010</td>
<td>3.601635e-06</td>
<td>3.601635e-06</td>
<td>3.601635e-06</td>
<td>3.601635e-06</td>
<td>-7.936699e-18</td>
</tr>
<tr class="even">
<td>9239</td>
<td>0.9796214</td>
<td>20</td>
<td>19</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797046</td>
<td>3.600801e-06</td>
<td>3.600801e-06</td>
<td>3.600801e-06</td>
<td>3.600801e-06</td>
<td>5.086136e-17</td>
</tr>
<tr class="odd">
<td>9240</td>
<td>0.9796250</td>
<td>0</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797082</td>
<td>3.599968e-06</td>
<td>3.599968e-06</td>
<td>3.599968e-06</td>
<td>3.599968e-06</td>
<td>2.912480e-17</td>
</tr>
<tr class="even">
<td>9241</td>
<td>0.9796286</td>
<td>1</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797118</td>
<td>3.599135e-06</td>
<td>3.599135e-06</td>
<td>3.599135e-06</td>
<td>3.599135e-06</td>
<td>2.031481e-17</td>
</tr>
<tr class="odd">
<td>9242</td>
<td>0.9796322</td>
<td>2</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797154</td>
<td>3.598303e-06</td>
<td>3.598303e-06</td>
<td>3.598303e-06</td>
<td>3.598303e-06</td>
<td>6.763982e-18</td>
</tr>
<tr class="even">
<td>9243</td>
<td>0.9796358</td>
<td>3</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797190</td>
<td>3.597470e-06</td>
<td>3.597470e-06</td>
<td>3.597470e-06</td>
<td>3.597470e-06</td>
<td>-2.921163e-17</td>
</tr>
<tr class="odd">
<td>9244</td>
<td>0.9796393</td>
<td>4</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797226</td>
<td>3.596638e-06</td>
<td>3.596638e-06</td>
<td>3.596638e-06</td>
<td>3.596638e-06</td>
<td>5.699685e-18</td>
</tr>
<tr class="even">
<td>9245</td>
<td>0.9796429</td>
<td>5</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797262</td>
<td>3.595806e-06</td>
<td>3.595806e-06</td>
<td>3.595806e-06</td>
<td>3.595806e-06</td>
<td>-1.727397e-17</td>
</tr>
<tr class="odd">
<td>9246</td>
<td>0.9796465</td>
<td>6</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797298</td>
<td>3.594975e-06</td>
<td>3.594975e-06</td>
<td>3.594975e-06</td>
<td>3.594975e-06</td>
<td>-4.977589e-18</td>
</tr>
<tr class="even">
<td>9247</td>
<td>0.9796501</td>
<td>7</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797334</td>
<td>3.594143e-06</td>
<td>3.594143e-06</td>
<td>3.594143e-06</td>
<td>3.594143e-06</td>
<td>2.477444e-17</td>
</tr>
<tr class="odd">
<td>9248</td>
<td>0.9796537</td>
<td>8</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797370</td>
<td>3.593312e-06</td>
<td>3.593312e-06</td>
<td>3.593312e-06</td>
<td>3.593312e-06</td>
<td>5.409449e-17</td>
</tr>
<tr class="even">
<td>9249</td>
<td>0.9796573</td>
<td>9</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797406</td>
<td>3.592481e-06</td>
<td>3.592481e-06</td>
<td>3.592481e-06</td>
<td>3.592481e-06</td>
<td>-4.600659e-17</td>
</tr>
<tr class="odd">
<td>9250</td>
<td>0.9796609</td>
<td>10</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797442</td>
<td>3.591651e-06</td>
<td>3.591651e-06</td>
<td>3.591651e-06</td>
<td>3.591651e-06</td>
<td>3.956999e-17</td>
</tr>
<tr class="even">
<td>9251</td>
<td>0.9796645</td>
<td>11</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797478</td>
<td>3.590820e-06</td>
<td>3.590820e-06</td>
<td>3.590820e-06</td>
<td>3.590820e-06</td>
<td>-4.026117e-17</td>
</tr>
<tr class="odd">
<td>9252</td>
<td>0.9796681</td>
<td>12</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797514</td>
<td>3.589990e-06</td>
<td>3.589990e-06</td>
<td>3.589990e-06</td>
<td>3.589990e-06</td>
<td>2.947717e-17</td>
</tr>
<tr class="even">
<td>9253</td>
<td>0.9796717</td>
<td>13</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797550</td>
<td>3.589160e-06</td>
<td>3.589160e-06</td>
<td>3.589160e-06</td>
<td>3.589160e-06</td>
<td>8.646512e-18</td>
</tr>
<tr class="odd">
<td>9254</td>
<td>0.9796753</td>
<td>14</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797585</td>
<td>3.588330e-06</td>
<td>3.588330e-06</td>
<td>3.588330e-06</td>
<td>3.588330e-06</td>
<td>-9.917909e-18</td>
</tr>
<tr class="even">
<td>9255</td>
<td>0.9796789</td>
<td>15</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797621</td>
<td>3.587501e-06</td>
<td>3.587501e-06</td>
<td>3.587501e-06</td>
<td>3.587501e-06</td>
<td>-4.435573e-17</td>
</tr>
<tr class="odd">
<td>9256</td>
<td>0.9796824</td>
<td>16</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797657</td>
<td>3.586672e-06</td>
<td>3.586672e-06</td>
<td>3.586672e-06</td>
<td>3.586672e-06</td>
<td>-1.940129e-18</td>
</tr>
<tr class="even">
<td>9257</td>
<td>0.9796860</td>
<td>17</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797693</td>
<td>3.585843e-06</td>
<td>3.585843e-06</td>
<td>3.585843e-06</td>
<td>3.585843e-06</td>
<td>-1.196561e-17</td>
</tr>
<tr class="odd">
<td>9258</td>
<td>0.9796896</td>
<td>18</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797729</td>
<td>3.585014e-06</td>
<td>3.585014e-06</td>
<td>3.585014e-06</td>
<td>3.585014e-06</td>
<td>1.828617e-17</td>
</tr>
<tr class="even">
<td>9259</td>
<td>0.9796932</td>
<td>19</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797765</td>
<td>3.584186e-06</td>
<td>3.584186e-06</td>
<td>3.584186e-06</td>
<td>3.584186e-06</td>
<td>-4.061396e-17</td>
</tr>
<tr class="odd">
<td>9260</td>
<td>0.9796968</td>
<td>20</td>
<td>20</td>
<td>20</td>
<td>0</td>
<td>8.327853e-05</td>
<td>0.9797801</td>
<td>3.583358e-06</td>
<td>3.583358e-06</td>
<td>3.583358e-06</td>
<td>3.583358e-06</td>
<td>1.500222e-17</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="d3c73019-41ba-42c0-846f-f3fb83e13b63" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>c(<span class="bu">sum</span>(joint_probs$V1 <span class="op">*</span> joint_probs$accum_time), </span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">sum</span>(joint_probs$V2 <span class="op">*</span> joint_probs$accum_time), </span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">sum</span>(joint_probs$V3 <span class="op">*</span> joint_probs$accum_time))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>0</li><li>0.000961598286934138</li><li>0.00057948368296313</li></ol>
</div>
</div>
<div id="3d176e56-84f1-4659-86f8-43a7fbc8c022" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>c(<span class="bu">sum</span>(df$X1 <span class="op">*</span> df$prob), <span class="bu">sum</span>(df$X2 <span class="op">*</span> df$prob), <span class="bu">sum</span>(df$X3 <span class="op">*</span> df$prob))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>7.73112709440204</li><li>4.69424968356727</li><li>1.19250319602024</li></ol>
</div>
</div>
<div id="42d2cdcb-38ed-48b5-a9f7-d2ab28ab1e6c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>plot_df <span class="op">&lt;-</span> df <span class="op">%&gt;%</span> group_by(X2, X3) <span class="op">%&gt;%</span> summarise(prob <span class="op">=</span> <span class="bu">sum</span>(prob))</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>plot_df[,<span class="op">-</span>ncol(plot_df)] <span class="op">&lt;-</span> lapply(plot_df[,<span class="op">-</span>ncol(plot_df)], <span class="im">as</span>.factor)</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>head(plot_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<div class="ansi-escaped-output">
<pre>`summarise()` has grouped output by 'X2'. You can override using the `.groups` argument.
</pre>
</div>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small">
<caption>A grouped_df: 6 × 3</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">X2</th>
<th data-quarto-table-cell-role="th" scope="col">X3</th>
<th data-quarto-table-cell-role="th" scope="col">prob</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;fct&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;fct&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>0.3637069369</td>
</tr>
<tr class="even">
<td>0</td>
<td>1</td>
<td>0.0054461936</td>
</tr>
<tr class="odd">
<td>0</td>
<td>2</td>
<td>0.0026874034</td>
</tr>
<tr class="even">
<td>0</td>
<td>3</td>
<td>0.0016935722</td>
</tr>
<tr class="odd">
<td>0</td>
<td>4</td>
<td>0.0011754205</td>
</tr>
<tr class="even">
<td>0</td>
<td>5</td>
<td>0.0008663035</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="b00fd888-4a56-4a58-bbfc-ef5826c96ba7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>ggplot(plot_df, aes(x<span class="op">=</span>X2, y<span class="op">=</span>X3)) <span class="op">+</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>    geom_tile(aes(fill <span class="op">=</span> prob)) <span class="op">+</span> </span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    geom_text(aes(label <span class="op">=</span> <span class="bu">round</span>(prob, <span class="dv">3</span>))) <span class="op">+</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    scale_fill_distiller(palette <span class="op">=</span> <span class="st">'PiYG'</span>,direction <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>                    limit<span class="op">=</span><span class="bu">max</span>(<span class="bu">abs</span>(plot_df$prob)) <span class="op">*</span> c(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>                    ) <span class="op">+</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>     theme(panel.grid.major <span class="op">=</span> element_blank(), </span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>            panel.grid.minor <span class="op">=</span> element_blank(), </span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>            text<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">17</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-118-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-35"><img src="coalescent-jointprob-ffi_files/figure-html/cell-118-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="4654714c-5a1f-429c-8fab-52f254888578" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>ggplot(plot_df, aes(x<span class="op">=</span>X2, y<span class="op">=</span>X3)) <span class="op">+</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>    geom_tile(aes(fill <span class="op">=</span> log10(prob))) <span class="op">+</span> </span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>    geom_text(aes(label <span class="op">=</span> <span class="bu">round</span>(log10(prob), <span class="dv">2</span>))) <span class="op">+</span></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>    scale_fill_distiller(palette <span class="op">=</span> <span class="st">'PiYG'</span>,direction <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>                    limit<span class="op">=</span><span class="bu">max</span>(<span class="bu">abs</span>(log10(plot_df$prob))) <span class="op">*</span> c(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>                    ) <span class="op">+</span></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>theme_minimal() <span class="op">+</span></span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a> theme(panel.grid.major <span class="op">=</span> element_blank(), </span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>        panel.grid.minor <span class="op">=</span> element_blank(), </span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>        text<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">17</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-119-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-36"><img src="coalescent-jointprob-ffi_files/figure-html/cell-119-output-1.png" width="420" height="300" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="5aff04ee-d895-448a-9e69-c7383aa9e013" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_graph &lt;- function(gam, constrained=TRUE, </span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="co">#                        subgraphs=FALSE, ranksep=2, nodesep=1,</span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a><span class="co">#                        subgraphfun=function(state, index) paste(state[-length(state)], collapse=""), </span></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="co">#                        size=c(6, 6), fontsize=10, rankdir="LR", align=FALSE, nodecolor='white', rainbow=FALSE, penwidth=1) {</span></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     format_rate &lt;- function(rate) {</span></span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         # tol = .Machine$double.eps^0.5</span></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a><span class="co">#         # if (min(abs(c(rate%%1, rate%%1-1))) &lt; tol) {</span></span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (rate == round(rate)) {</span></span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a><span class="co">#             return(rate)</span></span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a><span class="co">#         } else {</span></span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a><span class="co">#             return(formatC(rate, format = "e", digits = 2))</span></span>
<span id="cb148-15"><a href="#cb148-15" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb148-16"><a href="#cb148-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb148-17"><a href="#cb148-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-18"><a href="#cb148-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     random_color &lt;- function() {</span></span>
<span id="cb148-19"><a href="#cb148-19" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (rainbow) {</span></span>
<span id="cb148-20"><a href="#cb148-20" aria-hidden="true" tabindex="-1"></a><span class="co">#             return(paste("#", paste0(sample(c(0:9, LETTERS[1:6]), 6, T), collapse = ''), sep=''))</span></span>
<span id="cb148-21"><a href="#cb148-21" aria-hidden="true" tabindex="-1"></a><span class="co">#         } else {</span></span>
<span id="cb148-22"><a href="#cb148-22" aria-hidden="true" tabindex="-1"></a><span class="co">#             return('#000000')</span></span>
<span id="cb148-23"><a href="#cb148-23" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb148-24"><a href="#cb148-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb148-25"><a href="#cb148-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-26"><a href="#cb148-26" aria-hidden="true" tabindex="-1"></a><span class="co">#     sub_graphs = list()</span></span>
<span id="cb148-27"><a href="#cb148-27" aria-hidden="true" tabindex="-1"></a><span class="co">#     state_classes = list()</span></span>
<span id="cb148-28"><a href="#cb148-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-29"><a href="#cb148-29" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (constrained) {</span></span>
<span id="cb148-30"><a href="#cb148-30" aria-hidden="true" tabindex="-1"></a><span class="co">#         constrained &lt;- 'true'</span></span>
<span id="cb148-31"><a href="#cb148-31" aria-hidden="true" tabindex="-1"></a><span class="co">#     } else {</span></span>
<span id="cb148-32"><a href="#cb148-32" aria-hidden="true" tabindex="-1"></a><span class="co">#         constrained &lt;- 'false'</span></span>
<span id="cb148-33"><a href="#cb148-33" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb148-34"><a href="#cb148-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-35"><a href="#cb148-35" aria-hidden="true" tabindex="-1"></a><span class="co">#     states &lt;- c()</span></span>
<span id="cb148-36"><a href="#cb148-36" aria-hidden="true" tabindex="-1"></a><span class="co">#     for (i in 1:(nrow(gam$states))) {</span></span>
<span id="cb148-37"><a href="#cb148-37" aria-hidden="true" tabindex="-1"></a><span class="co">#         states &lt;- c(states, paste0(i, ' [label="', paste(gam$states[i,], collapse = ","), '"];'))</span></span>
<span id="cb148-38"><a href="#cb148-38" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb148-39"><a href="#cb148-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-40"><a href="#cb148-40" aria-hidden="true" tabindex="-1"></a><span class="co">#     edge_templ &lt;- '"FROM" -&gt; "TO" [constraint=true, label="LABEL",labelfloat=false,color="COLOR",fontcolor="COLOR"];'</span></span>
<span id="cb148-41"><a href="#cb148-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-42"><a href="#cb148-42" aria-hidden="true" tabindex="-1"></a><span class="co">#     subgraph_template &lt;- '</span></span>
<span id="cb148-43"><a href="#cb148-43" aria-hidden="true" tabindex="-1"></a><span class="co">#     subgraph cluster_FREQBIN {</span></span>
<span id="cb148-44"><a href="#cb148-44" aria-hidden="true" tabindex="-1"></a><span class="co">#         rank=same;</span></span>
<span id="cb148-45"><a href="#cb148-45" aria-hidden="true" tabindex="-1"></a><span class="co">#         style=filled;</span></span>
<span id="cb148-46"><a href="#cb148-46" aria-hidden="true" tabindex="-1"></a><span class="co">#         color=whitesmoke;</span></span>
<span id="cb148-47"><a href="#cb148-47" aria-hidden="true" tabindex="-1"></a><span class="co">#         node [style=filled];</span></span>
<span id="cb148-48"><a href="#cb148-48" aria-hidden="true" tabindex="-1"></a><span class="co">#         NODES;</span></span>
<span id="cb148-49"><a href="#cb148-49" aria-hidden="true" tabindex="-1"></a><span class="co">#         label = "FREQBIN";</span></span>
<span id="cb148-50"><a href="#cb148-50" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb148-51"><a href="#cb148-51" aria-hidden="true" tabindex="-1"></a><span class="co">#     '</span></span>
<span id="cb148-52"><a href="#cb148-52" aria-hidden="true" tabindex="-1"></a><span class="co">#     start_name &lt;- 'IPV'</span></span>
<span id="cb148-53"><a href="#cb148-53" aria-hidden="true" tabindex="-1"></a><span class="co">#     absorbing_name &lt;- 'Absorb'</span></span>
<span id="cb148-54"><a href="#cb148-54" aria-hidden="true" tabindex="-1"></a><span class="co">#     edges &lt;- c()</span></span>
<span id="cb148-55"><a href="#cb148-55" aria-hidden="true" tabindex="-1"></a><span class="co">#     # IPV edges</span></span>
<span id="cb148-56"><a href="#cb148-56" aria-hidden="true" tabindex="-1"></a><span class="co">#     for (i in 1:length(gam$IPV)) {</span></span>
<span id="cb148-57"><a href="#cb148-57" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (gam$IPV[i] &gt; 0) {</span></span>
<span id="cb148-58"><a href="#cb148-58" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- edge_templ</span></span>
<span id="cb148-59"><a href="#cb148-59" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- sub('FROM', start_name, edge)</span></span>
<span id="cb148-60"><a href="#cb148-60" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- sub('TO', i, edge)</span></span>
<span id="cb148-61"><a href="#cb148-61" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- sub('LABEL', gam$IPV[i], edge)</span></span>
<span id="cb148-62"><a href="#cb148-62" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- gsub('COLOR', random_color(), edge)                        </span></span>
<span id="cb148-63"><a href="#cb148-63" aria-hidden="true" tabindex="-1"></a><span class="co">#             edges &lt;- c(edges, edge)</span></span>
<span id="cb148-64"><a href="#cb148-64" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb148-65"><a href="#cb148-65" aria-hidden="true" tabindex="-1"></a><span class="co">#     }    </span></span>
<span id="cb148-66"><a href="#cb148-66" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Matrix edges</span></span>
<span id="cb148-67"><a href="#cb148-67" aria-hidden="true" tabindex="-1"></a><span class="co">#     for (i in 1:(nrow(gam$states))) {</span></span>
<span id="cb148-68"><a href="#cb148-68" aria-hidden="true" tabindex="-1"></a><span class="co">#         for (j in 1:nrow(gam$states)) {</span></span>
<span id="cb148-69"><a href="#cb148-69" aria-hidden="true" tabindex="-1"></a><span class="co">#             if ((i != j) &amp;&amp; (gam$SIM[i, j] &gt; 0)) {</span></span>
<span id="cb148-70"><a href="#cb148-70" aria-hidden="true" tabindex="-1"></a><span class="co">#                 edge &lt;- edge_templ</span></span>
<span id="cb148-71"><a href="#cb148-71" aria-hidden="true" tabindex="-1"></a><span class="co">#                 edge &lt;- sub('FROM', i, edge)</span></span>
<span id="cb148-72"><a href="#cb148-72" aria-hidden="true" tabindex="-1"></a><span class="co">#                 edge &lt;- sub('TO', j, edge)</span></span>
<span id="cb148-73"><a href="#cb148-73" aria-hidden="true" tabindex="-1"></a><span class="co">#                 edge &lt;- sub('LABEL', format_rate(gam$SIM[i, j]), edge)</span></span>
<span id="cb148-74"><a href="#cb148-74" aria-hidden="true" tabindex="-1"></a><span class="co">#                 edge &lt;- gsub('COLOR', random_color(), edge)</span></span>
<span id="cb148-75"><a href="#cb148-75" aria-hidden="true" tabindex="-1"></a><span class="co">#                 edges &lt;- c(edges, edge)</span></span>
<span id="cb148-76"><a href="#cb148-76" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb148-77"><a href="#cb148-77" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb148-78"><a href="#cb148-78" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb148-79"><a href="#cb148-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-80"><a href="#cb148-80" aria-hidden="true" tabindex="-1"></a><span class="co">#     absorb_rates &lt;- -rowSums(gam$SIM)</span></span>
<span id="cb148-81"><a href="#cb148-81" aria-hidden="true" tabindex="-1"></a><span class="co">#     for (i in 1:nrow(gam$states)) {</span></span>
<span id="cb148-82"><a href="#cb148-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-83"><a href="#cb148-83" aria-hidden="true" tabindex="-1"></a><span class="co">#         # </span><span class="al">TODO</span><span class="co">: Avoid the hack below by changing the function to use the graph instead of the matrix</span></span>
<span id="cb148-84"><a href="#cb148-84" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (absorb_rates[i] &gt; abs(1e-14)) {</span></span>
<span id="cb148-85"><a href="#cb148-85" aria-hidden="true" tabindex="-1"></a><span class="co">#         # if (absorb_rates[i] &gt; 0) {</span></span>
<span id="cb148-86"><a href="#cb148-86" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- edge_templ</span></span>
<span id="cb148-87"><a href="#cb148-87" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- sub('FROM', i, edge)</span></span>
<span id="cb148-88"><a href="#cb148-88" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- sub('TO', absorbing_name, edge)</span></span>
<span id="cb148-89"><a href="#cb148-89" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- sub('LABEL', absorb_rates[i], edge)</span></span>
<span id="cb148-90"><a href="#cb148-90" aria-hidden="true" tabindex="-1"></a><span class="co">#             edge &lt;- gsub('COLOR', random_color(), edge)            </span></span>
<span id="cb148-91"><a href="#cb148-91" aria-hidden="true" tabindex="-1"></a><span class="co">#             edges &lt;- c(edges, edge)</span></span>
<span id="cb148-92"><a href="#cb148-92" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb148-93"><a href="#cb148-93" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb148-94"><a href="#cb148-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-95"><a href="#cb148-95" aria-hidden="true" tabindex="-1"></a><span class="co">#     graph_spec &lt;- paste(c(states, edges), collapse = '\n')</span></span>
<span id="cb148-96"><a href="#cb148-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-97"><a href="#cb148-97" aria-hidden="true" tabindex="-1"></a><span class="co">#     rank_same &lt;- ''</span></span>
<span id="cb148-98"><a href="#cb148-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-99"><a href="#cb148-99" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (subgraphs) {        </span></span>
<span id="cb148-100"><a href="#cb148-100" aria-hidden="true" tabindex="-1"></a><span class="co">#         for (i in 1:(nrow(gam$states))) {</span></span>
<span id="cb148-101"><a href="#cb148-101" aria-hidden="true" tabindex="-1"></a><span class="co">#             sg &lt;- subgraphfun(gam$states[i,], index=i)</span></span>
<span id="cb148-102"><a href="#cb148-102" aria-hidden="true" tabindex="-1"></a><span class="co">#             sub_graphs[[sg]] &lt;- c(sub_graphs[[sg]], i)</span></span>
<span id="cb148-103"><a href="#cb148-103" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb148-104"><a href="#cb148-104" aria-hidden="true" tabindex="-1"></a><span class="co">#         for (sg in labels(sub_graphs)) {</span></span>
<span id="cb148-105"><a href="#cb148-105" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb148-106"><a href="#cb148-106" aria-hidden="true" tabindex="-1"></a><span class="co">#             nodes &lt;- sub_graphs[[sg]]</span></span>
<span id="cb148-107"><a href="#cb148-107" aria-hidden="true" tabindex="-1"></a><span class="co">#             tmpl &lt;- subgraph_template</span></span>
<span id="cb148-108"><a href="#cb148-108" aria-hidden="true" tabindex="-1"></a><span class="co">#             node_str &lt;- ''</span></span>
<span id="cb148-109"><a href="#cb148-109" aria-hidden="true" tabindex="-1"></a><span class="co">#             for (i in 1:length(nodes)) {</span></span>
<span id="cb148-110"><a href="#cb148-110" aria-hidden="true" tabindex="-1"></a><span class="co">#                 node_str &lt;- paste(node_str, paste('"', nodes[i], '" ', sep=''), sep=' ')</span></span>
<span id="cb148-111"><a href="#cb148-111" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb148-112"><a href="#cb148-112" aria-hidden="true" tabindex="-1"></a><span class="co">#             tmpl &lt;- sub('NODES', node_str, tmpl)</span></span>
<span id="cb148-113"><a href="#cb148-113" aria-hidden="true" tabindex="-1"></a><span class="co">#             tmpl &lt;- sub('FREQBIN', sg, tmpl)            </span></span>
<span id="cb148-114"><a href="#cb148-114" aria-hidden="true" tabindex="-1"></a><span class="co">#             tmpl &lt;- sub('FREQBIN', sg, tmpl)            </span></span>
<span id="cb148-115"><a href="#cb148-115" aria-hidden="true" tabindex="-1"></a><span class="co">#             graph_spec &lt;- paste(graph_spec, tmpl)</span></span>
<span id="cb148-116"><a href="#cb148-116" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb148-117"><a href="#cb148-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-118"><a href="#cb148-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-119"><a href="#cb148-119" aria-hidden="true" tabindex="-1"></a><span class="co">#         if (align) {</span></span>
<span id="cb148-120"><a href="#cb148-120" aria-hidden="true" tabindex="-1"></a><span class="co">#             for (i in 1:(nrow(gam$states))) {</span></span>
<span id="cb148-121"><a href="#cb148-121" aria-hidden="true" tabindex="-1"></a><span class="co">#                 sc &lt;- paste(head(gam$states[i,], -1), collapse = ",")</span></span>
<span id="cb148-122"><a href="#cb148-122" aria-hidden="true" tabindex="-1"></a><span class="co">#                 state_classes[[sc]] &lt;- c(state_classes[[sc]], i)</span></span>
<span id="cb148-123"><a href="#cb148-123" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb148-124"><a href="#cb148-124" aria-hidden="true" tabindex="-1"></a><span class="co">#             for (sc in labels(state_classes)) {</span></span>
<span id="cb148-125"><a href="#cb148-125" aria-hidden="true" tabindex="-1"></a><span class="co">#                 rank_same &lt;- paste(rank_same, '{rank=same; ', sep='')</span></span>
<span id="cb148-126"><a href="#cb148-126" aria-hidden="true" tabindex="-1"></a><span class="co">#                 nodes &lt;- state_classes[[sc]]</span></span>
<span id="cb148-127"><a href="#cb148-127" aria-hidden="true" tabindex="-1"></a><span class="co">#                 for (i in 1:length(nodes)) {</span></span>
<span id="cb148-128"><a href="#cb148-128" aria-hidden="true" tabindex="-1"></a><span class="co">#                     rank_same &lt;- paste(rank_same, paste('"', nodes[i], '" ', sep=''), sep=' ')</span></span>
<span id="cb148-129"><a href="#cb148-129" aria-hidden="true" tabindex="-1"></a><span class="co">#                 }            </span></span>
<span id="cb148-130"><a href="#cb148-130" aria-hidden="true" tabindex="-1"></a><span class="co">#                 rank_same &lt;- paste(rank_same, ' }', sep='\n')</span></span>
<span id="cb148-131"><a href="#cb148-131" aria-hidden="true" tabindex="-1"></a><span class="co">#             }</span></span>
<span id="cb148-132"><a href="#cb148-132" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb148-133"><a href="#cb148-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-134"><a href="#cb148-134" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb148-135"><a href="#cb148-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-136"><a href="#cb148-136" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- '</span></span>
<span id="cb148-137"><a href="#cb148-137" aria-hidden="true" tabindex="-1"></a><span class="co">#         graph [compound=true newrank=true pad="0.5", ranksep="RANKSEP", nodesep="NODESEP"] </span></span>
<span id="cb148-138"><a href="#cb148-138" aria-hidden="true" tabindex="-1"></a><span class="co">#         rankdir=RANKDIR;</span></span>
<span id="cb148-139"><a href="#cb148-139" aria-hidden="true" tabindex="-1"></a><span class="co">#         size="SIZEX,SIZEY";</span></span>
<span id="cb148-140"><a href="#cb148-140" aria-hidden="true" tabindex="-1"></a><span class="co">#         fontname="Helvetica,Arial,sans-serif"</span></span>
<span id="cb148-141"><a href="#cb148-141" aria-hidden="true" tabindex="-1"></a><span class="co">#       node [fontname="Helvetica,Arial,sans-serif", fontsize=FONTSIZE, style=filled, fillcolor="NODECOLOR"]</span></span>
<span id="cb148-142"><a href="#cb148-142" aria-hidden="true" tabindex="-1"></a><span class="co">#       edge [fontname="Helvetica,Arial,sans-serif", fontsize=FONTSIZE, penwidth=PENWIDTH]</span></span>
<span id="cb148-143"><a href="#cb148-143" aria-hidden="true" tabindex="-1"></a><span class="co">#         Absorb [style=filled,color="lightgrey"]</span></span>
<span id="cb148-144"><a href="#cb148-144" aria-hidden="true" tabindex="-1"></a><span class="co">#         IPV [style=filled,color="lightgrey"]</span></span>
<span id="cb148-145"><a href="#cb148-145" aria-hidden="true" tabindex="-1"></a><span class="co">#         RANKSAME</span></span>
<span id="cb148-146"><a href="#cb148-146" aria-hidden="true" tabindex="-1"></a><span class="co">#     '</span></span>
<span id="cb148-147"><a href="#cb148-147" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- sub('SIZEX', size[1], style_str)</span></span>
<span id="cb148-148"><a href="#cb148-148" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- sub('SIZEY', size[2], style_str)</span></span>
<span id="cb148-149"><a href="#cb148-149" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- gsub('FONTSIZE', fontsize, style_str)    </span></span>
<span id="cb148-150"><a href="#cb148-150" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- gsub('RANKDIR', rankdir, style_str)    </span></span>
<span id="cb148-151"><a href="#cb148-151" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- gsub('RANKSAME', rank_same, style_str)</span></span>
<span id="cb148-152"><a href="#cb148-152" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- gsub('RANKSEP', ranksep, style_str)</span></span>
<span id="cb148-153"><a href="#cb148-153" aria-hidden="true" tabindex="-1"></a><span class="co">#     style_str &lt;- gsub('NODESEP', nodesep, style_str)</span></span>
<span id="cb148-154"><a href="#cb148-154" aria-hidden="true" tabindex="-1"></a><span class="co">#     graph_string &lt;- paste('digraph G {', style_str, graph_spec, '}', sep='\n')</span></span>
<span id="cb148-155"><a href="#cb148-155" aria-hidden="true" tabindex="-1"></a><span class="co">#     graph_string &lt;- gsub('NODECOLOR', nodecolor, graph_string)  </span></span>
<span id="cb148-156"><a href="#cb148-156" aria-hidden="true" tabindex="-1"></a><span class="co">#     graph_string &lt;- gsub('PENWIDTH', penwidth, graph_string)  </span></span>
<span id="cb148-157"><a href="#cb148-157" aria-hidden="true" tabindex="-1"></a><span class="co">#     system("dot -Tsvg -o tmp.svg", input=graph_string, intern=TRUE)</span></span>
<span id="cb148-158"><a href="#cb148-158" aria-hidden="true" tabindex="-1"></a><span class="co">#     return(display_svg(file="tmp.svg"))</span></span>
<span id="cb148-159"><a href="#cb148-159" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb148-160"><a href="#cb148-160" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb148-161"><a href="#cb148-161" aria-hidden="true" tabindex="-1"></a>sample_size <span class="op">&lt;-</span> <span class="dv">3</span></span>
<span id="cb148-162"><a href="#cb148-162" aria-hidden="true" tabindex="-1"></a>mutation_rate <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb148-163"><a href="#cb148-163" aria-hidden="true" tabindex="-1"></a>max_tons <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb148-164"><a href="#cb148-164" aria-hidden="true" tabindex="-1"></a>total_tons <span class="op">&lt;-</span> Inf</span>
<span id="cb148-165"><a href="#cb148-165" aria-hidden="true" tabindex="-1"></a>base <span class="op">&lt;-</span> max_tons <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb148-166"><a href="#cb148-166" aria-hidden="true" tabindex="-1"></a>graph <span class="op">&lt;-</span> joint_prob_coalescent(sample_size, mutation_rate, max_tons, total_tons<span class="op">=</span>total_tons)</span>
<span id="cb148-167"><a href="#cb148-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-168"><a href="#cb148-168" aria-hidden="true" tabindex="-1"></a>plot_graph(graph_as_matrix(graph), rainbow<span class="op">=</span>TRUE, size<span class="op">=</span>c(<span class="dv">10</span>, <span class="dv">8</span>), align<span class="op">=</span>TRUE,</span>
<span id="cb148-169"><a href="#cb148-169" aria-hidden="true" tabindex="-1"></a>           fontsize<span class="op">=</span><span class="dv">16</span>, ranksep<span class="op">=</span><span class="dv">1</span>, nodesep<span class="op">=</span><span class="fl">0.25</span>,</span>
<span id="cb148-170"><a href="#cb148-170" aria-hidden="true" tabindex="-1"></a>           subgraphs<span class="op">=</span>TRUE,</span>
<span id="cb148-171"><a href="#cb148-171" aria-hidden="true" tabindex="-1"></a>           <span class="co"># rankdir="TB",</span></span>
<span id="cb148-172"><a href="#cb148-172" aria-hidden="true" tabindex="-1"></a>           subgraphfun<span class="op">=</span>function(state, index) <span class="im">as</span>.character((index<span class="op">+</span><span class="dv">1</span>) <span class="op">%/%</span> <span class="dv">2</span>)</span>
<span id="cb148-173"><a href="#cb148-173" aria-hidden="true" tabindex="-1"></a>           <span class="co"># subgraphfun=function(state, index) paste(state[-length(state)], collapse="")</span></span>
<span id="cb148-174"><a href="#cb148-174" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="coalescent-jointprob-ffi_files/figure-html/cell-120-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-37"><img src="coalescent-jointprob-ffi_files/figure-html/cell-120-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/munch-group\.github\.io\/PtDAlgorithms\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>