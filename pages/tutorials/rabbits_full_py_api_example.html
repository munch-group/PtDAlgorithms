<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Rabbits Islands - Full API</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../pages/tutorials/coalescent_full_py_api_example.html" rel="next">
<link href="../../pages/getting_started.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-a4e33bbe4f8c8978a0e41d3bc496056e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../api/_styles-quartodoc.css">
<link rel="stylesheet" href="../../numpy.css">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../logo.png" alt="Phasic" class="navbar-logo light-content">
    <img src="../../logo.png" alt="Phasic" class="navbar-logo dark-content">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../../pages/getting_started.html" aria-current="page"> 
<span class="menu-text">Documentation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../api/"> 
<span class="menu-text">Python API reference</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../r_api/"> 
<span class="menu-text">R API reference</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../c_api/"> 
<span class="menu-text">C API reference</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/munch-group/ptdalgorithms/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Tutorials</li><li class="breadcrumb-item"><a href="../../pages/tutorials/rabbits_full_py_api_example.html">Rabbits Islands - Full API</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../../index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
 <span class="menu-text">pages/background/quickstart.qmd</span>
  </li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/tutorials/rabbits_full_py_api_example.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Rabbits Islands - Full API</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/tutorials/coalescent_full_py_api_example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Coalescent - Full API</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/tutorials/state_space_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Building models</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Bayesian inference</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/svgd/svgd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SVGD Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/svgd/caching.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Caching System Guide</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/svgd/svgd_trace_eval.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SVGD analyze_trace() Method Documentation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/svgd/svgd_step_sizes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SVGD Schedule System Implementation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/svgd/ffi_and_openmp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">FFI+OpenMP Default Implementation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Distributed Computing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/distributed/distributed_computing_complete_guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distributed Computing with PtDAlgorithms - Complete Guide</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/distributed/slurm_cluster_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SLURM Cluster Setup and Configuration</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/distributed/cpu_monitoring.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CPU monitoring</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">State space patterns</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/modelling/state_lumping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">State lumping</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/modelling/laplace.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Laplace transform</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/modelling/epochs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Epochs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/modelling/joint_prob.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Joint probabilities</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Popgen examples</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
 <span class="menu-text">pages/modelling/coalescent-jointprob.ipynb</span>
  </li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/popgen/isolation_migration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">isolation_migration.html</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/popgen/two-island-two-locus-arg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Two Island Two Locus Argument</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Phase-type distributions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/background/math_and_alg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Math and Algorithms</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/background/symbolic_gauss_elimination.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Symbolic Graph Elimination for Efficient Parameterized Phase-Type Distributions</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Devel</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/devel/architecture.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Library Architecture</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://github.com/munch-group/ptdalgorithms/issues" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Issue Tracker</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#state-space-construction" id="toc-state-space-construction" class="nav-link active" data-scroll-target="#state-space-construction">State-space construction</a>
  <ul class="collapse">
  <li><a href="#matrix-interface" id="toc-matrix-interface" class="nav-link" data-scroll-target="#matrix-interface">Matrix interface</a></li>
  <li><a href="#continuous-phase-type-distribution" id="toc-continuous-phase-type-distribution" class="nav-link" data-scroll-target="#continuous-phase-type-distribution">Continuous phase-type distribution</a></li>
  <li><a href="#rewards" id="toc-rewards" class="nav-link" data-scroll-target="#rewards">Rewards</a></li>
  </ul></li>
  <li><a href="#random-sampling" id="toc-random-sampling" class="nav-link" data-scroll-target="#random-sampling">Random sampling</a>
  <ul class="collapse">
  <li><a href="#discrete-phase-type-distributions" id="toc-discrete-phase-type-distributions" class="nav-link" data-scroll-target="#discrete-phase-type-distributions">Discrete phase-type distributions</a></li>
  </ul></li>
  <li><a href="#multivariate-phase-type-distributions" id="toc-multivariate-phase-type-distributions" class="nav-link" data-scroll-target="#multivariate-phase-type-distributions">Multivariate phase-type distributions</a></li>
  <li><a href="#parameterized-edges" id="toc-parameterized-edges" class="nav-link" data-scroll-target="#parameterized-edges">Parameterized edges</a></li>
  <li><a href="#state-space-modelling" id="toc-state-space-modelling" class="nav-link" data-scroll-target="#state-space-modelling">State space modelling</a>
  <ul class="collapse">
  <li><a href="#time-inhomogeneity" id="toc-time-inhomogeneity" class="nav-link" data-scroll-target="#time-inhomogeneity">Time inhomogeneity</a></li>
  <li><a href="#modelling-epochs-in-state-space" id="toc-modelling-epochs-in-state-space" class="nav-link" data-scroll-target="#modelling-epochs-in-state-space">Modelling epochs in state space</a></li>
  <li><a href="#laplace-transform" id="toc-laplace-transform" class="nav-link" data-scroll-target="#laplace-transform">Laplace transform</a></li>
  <li><a href="#joint-probability" id="toc-joint-probability" class="nav-link" data-scroll-target="#joint-probability">Joint probability</a></li>
  </ul></li>
  <li><a href="#building-the-state-space-in-c" id="toc-building-the-state-space-in-c" class="nav-link" data-scroll-target="#building-the-state-space-in-c">Building the state space in C</a></li>
  <li><a href="#inference" id="toc-inference" class="nav-link" data-scroll-target="#inference">Inference</a>
  <ul class="collapse">
  <li><a href="#bayesian-inference-with-svgd-stein-variational-gradient-descent" id="toc-bayesian-inference-with-svgd-stein-variational-gradient-descent" class="nav-link" data-scroll-target="#bayesian-inference-with-svgd-stein-variational-gradient-descent">Bayesian Inference with SVGD (Stein Variational Gradient Descent)</a></li>
  <li><a href="#model-caching-and-distribution" id="toc-model-caching-and-distribution" class="nav-link" data-scroll-target="#model-caching-and-distribution">Model Caching and Distribution</a>
  <ul class="collapse">
  <li><a href="#sharing-models-with-collaborators" id="toc-sharing-models-with-collaborators" class="nav-link" data-scroll-target="#sharing-models-with-collaborators">Sharing Models with Collaborators</a></li>
  </ul></li>
  <li><a href="#distributed-computing" id="toc-distributed-computing" class="nav-link" data-scroll-target="#distributed-computing">Distributed Computing</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Tutorials</li><li class="breadcrumb-item"><a href="../../pages/tutorials/rabbits_full_py_api_example.html">Rabbits Islands - Full API</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Rabbits Islands - Full API</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This comprehensive tutorial explores the complete Python API of the ptdalgorithms library, a high-performance computational framework for working with phase-type distributions. At its core, the library implements sophisticated graph-based algorithms published in peer-reviewed literature, offering performance improvements of several orders of magnitude compared to traditional matrix-based approaches that have dominated the field for decades. The implementation leverages C for computational efficiency, with carefully designed bindings to Python through C++ and pybind11, ensuring that Python users can access near-native performance without sacrificing the convenience and flexibility of high-level scripting.</p>
<p>Throughout this tutorial, we will construct increasingly sophisticated models using a simple but illustrative example: rabbits living on two islands that can jump between islands and face periodic flooding events. This seemingly simple scenario will allow us to explore the full richness of the library’s capabilities, from basic state space construction and moment calculations to advanced features like reward transformations, multivariate distributions, parameterized models, symbolic elimination for ultra-fast parameter sweeps, distributed computing across SLURM clusters, and Bayesian inference using Stein Variational Gradient Descent (SVGD).</p>
<p>The tutorial begins with fundamental operations—constructing state spaces, computing expectations and variances, evaluating distribution functions—and progressively builds toward advanced topics. We will see how to work with both continuous phase-type distributions (modeling time until absorption) and discrete phase-type distributions (modeling the number of transitions before absorption). We will explore rewards, which allow us to compute accumulated quantities along paths through the state space, and multivariate extensions that capture joint distributions of multiple quantities. We will learn how to parameterize edge weights, enabling efficient exploration of parameter space, and how symbolic elimination can accelerate this exploration by orders of magnitude.</p>
<p>In the advanced sections, we will discover how to leverage distributed computing infrastructure, scaling our computations from a single machine to hundreds of nodes on a SLURM cluster. We will see how the library integrates seamlessly with JAX, enabling automatic differentiation and GPU acceleration. Finally, we will apply these tools to Bayesian inference problems, using SVGD to estimate model parameters from observed data—a workflow that combines graph construction, symbolic elimination, distributed computing, and gradient-based optimization into a unified, high-performance pipeline.</p>
<p>By the end of this tutorial, you will have mastered not just the mechanics of the API, but the underlying concepts and workflows that make ptdalgorithms a powerful tool for probabilistic modeling, statistical inference, and computational biology.</p>
<div id="cell-2" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># %load_ext autoreload</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># %autoreload 2</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-3" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ptdalgorithms <span class="im">import</span> Graph, set_theme</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>config InlineBackend.figure_format <span class="op">=</span> <span class="st">'retina'</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.style.use('dark_background')</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># import matplotlib</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># matplotlib.rcParams['axes.facecolor'] = '#1F1F1F'</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># matplotlib.rcParams['figure.facecolor'] = '#1F1F1F'</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.rcParams.update({'figure.facecolor': '#1F1F1F', 'axes.facecolor': '#1F1F1F'})</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>set_theme(<span class="st">'light'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="state-space-construction" class="level1">
<h1>State-space construction</h1>
<div id="cell-5" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> c(<span class="op">*</span>args):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    elem <span class="op">=</span> []</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> arg <span class="kw">in</span> args:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(arg, <span class="st">'__len__'</span>) <span class="kw">and</span> <span class="bu">len</span>(arg) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>            elem.extend(arg)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>            elem.append(arg)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(elem)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-6" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_states(vertex):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(vertex.state())</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> edge <span class="kw">in</span> vertex.edges():</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">" "</span>, edge.weight() , <span class="st">"-&gt;"</span>, edge.to().state())    </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>This phase-type distribution models the time until all rabits have died We can find the expectation, variance, moments</p>
<div id="cell-8" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_rabbit_graph(nr_rabbits, flood_left, flood_right):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we represent the vector as two integers, the number of </span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rabbits on the left and right island</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    state_vector_length <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">=</span> Graph(state_vector_length)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the initial state is the only starting state, with probability 1</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    initial_state <span class="op">=</span> [nr_rabbits, <span class="dv">0</span>]</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    vertex <span class="op">=</span> graph.find_or_create_vertex(initial_state)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    graph.starting_vertex().add_edge(vertex, <span class="dv">1</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># iterate over all unvisited vertices</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> index <span class="op">&lt;</span> graph.vertices_length():</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        vertex <span class="op">=</span> graph.vertex_at(index)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        state <span class="op">=</span> vertex.state()</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> state[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># rabbit jump left to right</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>            child_state <span class="op">=</span> [state[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span>, state[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>            vertex.add_edge(</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>                graph.find_or_create_vertex(child_state),</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>                weight<span class="op">=</span><span class="dv">1</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># left island flooding</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>            child_state <span class="op">=</span> [<span class="dv">0</span>, state[<span class="dv">1</span>]]</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>            vertex.add_edge(</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>                graph.find_or_create_vertex(child_state), </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>                weight<span class="op">=</span>flood_left</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> state[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">0</span>:   </span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>            child_state <span class="op">=</span> [state[<span class="dv">0</span>] <span class="op">+</span> <span class="dv">1</span>, state[<span class="dv">1</span>] <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>            vertex.add_edge(</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>                graph.find_or_create_vertex(child_state),</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>                weight<span class="op">=</span><span class="dv">1</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>            <span class="co"># right island flooding</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>            child_state <span class="op">=</span> [state[<span class="dv">0</span>], <span class="dv">0</span>]</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>            vertex.add_edge(</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>                graph.find_or_create_vertex(child_state), </span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>                weight<span class="op">=</span>flood_right</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>        index <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> graph</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-9" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> construct_rabbit_graph(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">4</span>)        </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>graph.states()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>array([[0, 0],
       [2, 0],
       [1, 1],
       [0, 0],
       [0, 2],
       [0, 1],
       [1, 0]], dtype=int32)</code></pre>
</div>
</div>
<p>You can plot the graph for visual inspection:</p>
<div id="cell-11" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>graph.plot()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>
<figure class="figure">
<p><a href="rabbits_full_py_api_example_files/figure-html/cell-8-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="rabbits_full_py_api_example_files/figure-html/cell-8-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>and group, states by some property, by supplying a lambda function for the <code>subgraphfun</code> keyword argument:</p>
<div id="cell-13" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>graph.plot(subgraphfun<span class="op">=</span><span class="kw">lambda</span> state: <span class="ss">f"#rabbits: </span><span class="sc">{</span><span class="bu">sum</span>(state)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>
<figure class="figure">
<p><a href="rabbits_full_py_api_example_files/figure-html/cell-9-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="rabbits_full_py_api_example_files/figure-html/cell-9-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>In an abbreviated version using the aliases <code>ae</code> and <code>focv</code> for <code>add_edge</code> and <code>find_and_create_vertex</code></p>
<div id="cell-15" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>nr_rabbits, flood_left, flood_right <span class="op">=</span> <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">4</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> Graph(<span class="dv">2</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>graph.starting_vertex().add_edge(graph.focv(c(nr_rabbits, <span class="dv">0</span>)), <span class="dv">1</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>i <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> i <span class="op">&lt;</span> graph.vertices_length():</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> graph.vertex_at(i)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    st <span class="op">=</span> v.state()</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> st[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        v.ae(graph.focv([st[<span class="dv">0</span>]<span class="op">-</span><span class="dv">1</span>, st[<span class="dv">1</span>]<span class="op">+</span><span class="dv">1</span>]), <span class="dv">1</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        v.ae(graph.focv([<span class="dv">0</span>, st[<span class="dv">1</span>]]), flood_left)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> st[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">0</span>:   </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        v.ae(graph.focv([st[<span class="dv">0</span>]<span class="op">+</span><span class="dv">1</span>, st[<span class="dv">1</span>]<span class="op">-</span><span class="dv">1</span>]), <span class="dv">1</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        v.ae(graph.focv([st[<span class="dv">0</span>], <span class="dv">0</span>]), flood_right)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co">#graph.states()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>You can skip some of the boilerplate code by passing a callback function and an initial state to <code>Graph</code>. The call back function has the signature <code>callback(List[int]) -&gt; List[Dict]</code>. It takes a list argument specifying a state and returns a list of dictionaries each specifying a child state and an edge weight: <code>{'state': [0, 1], 'weight': 0.4}</code>. This approach is slower and is intended mainly for speed up model development and exploration, and to reduce the amount of code needed to represent many models.</p>
<p>To create a callback function, just think of rules of your model and ask yourself: “Given some state, what are the allowed transitions to other states and with what rates to these transititons occur?”. Make a small dictionary for each such transition with the child state and rate (weight) and return them as a list. Here is an example. If the current state is “two rabbits on the left island” (<code>[2, 0]</code>), the reachable states are: “one rabbit on each island” (<code>[1, 1]</code>) if one rabbit jumps and and “no rabbits” (<code>[0, 0]</code>) if the island is flodded. The callback function should in that case produce the mapping:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>[<span class="dv">2</span>, <span class="dv">0</span>] <span class="op">-&gt;</span> [{<span class="st">'state'</span>: [<span class="dv">1</span>, <span class="dv">1</span>], <span class="st">'weight'</span>: <span class="dv">1</span>, }, {<span class="st">'state'</span>: [<span class="dv">0</span>, <span class="dv">0</span>], <span class="st">'weight'</span>: flood_left}]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Here is what the callback function looks like for the rabbit model:</p>
<div id="cell-17" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rabbit_islands(state):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    children <span class="op">=</span> []</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> state[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        children.append({<span class="st">'state'</span>: [state[<span class="dv">0</span>]<span class="op">-</span><span class="dv">1</span>, state[<span class="dv">1</span>]<span class="op">+</span><span class="dv">1</span>], <span class="st">'weight'</span>: <span class="dv">1</span>})</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        children.append({<span class="st">'state'</span>: [<span class="dv">0</span>,          state[<span class="dv">1</span>]  ], <span class="st">'weight'</span>: flood_left})</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> state[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">0</span>:   </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        children.append({<span class="st">'state'</span>: [state[<span class="dv">0</span>]<span class="op">+</span><span class="dv">1</span>, state[<span class="dv">1</span>]<span class="op">-</span><span class="dv">1</span>], <span class="st">'weight'</span>: <span class="dv">1</span>})</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        children.append({<span class="st">'state'</span>: [state[<span class="dv">0</span>],   <span class="dv">0</span>         ], <span class="st">'weight'</span>: flood_right})</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> children</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>initial_state <span class="op">=</span> [nr_rabbits, <span class="dv">0</span>]    </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Notice that the usual scoping rules apply to the callback functions: the variables defined outside the function <code>flood_left</code> and <code>flood_right</code> are accessible to the function as for any Python function.</p>
<section id="matrix-interface" class="level2">
<h2 class="anchored" data-anchor-id="matrix-interface">Matrix interface</h2>
<p>To allow imbedding in a matrix based workflow, a matrix-based representation of the phase-type distribution can be extracted from the graph. Note that the indices in the matrix representation do not correspond to vertex indices in the graph.</p>
<div id="cell-21" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>mats <span class="op">=</span> graph.as_matrices()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Initial probability vector:"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mats.ipv)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Subintensity matrix:"</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mats.sim)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"States:"</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mats.states)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Indicies:"</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mats.indices)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Initial probability vector:
[0. 0. 1. 0. 0.]
Subintensity matrix:
[[-5.  1.  0.  0.  0.]
 [ 1. -8.  1.  4.  2.]
 [ 0.  1. -3.  0.  0.]
 [ 0.  0.  0. -3.  1.]
 [ 0.  0.  0.  1. -5.]]
States:
[[0 2]
 [1 1]
 [2 0]
 [1 0]
 [0 1]]
Indicies:
[5 3 2 7 6]</code></pre>
</div>
</div>
<p>Although computationally inefficient, the graph can also be constructed from an initial probability vector and a subintensity matrix:</p>
<div id="cell-23" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> Graph.from_matrices(mats.ipv, mats.sim, mats.states)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>graph.plot()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>
<figure class="figure">
<p><a href="rabbits_full_py_api_example_files/figure-html/cell-13-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="rabbits_full_py_api_example_files/figure-html/cell-13-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>If the state argument is not provided, matrix indices are used as matrix states:</p>
<div id="cell-25" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> Graph.from_matrices(mats.ipv, mats.sim)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>graph.plot()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>
<figure class="figure">
<p><a href="rabbits_full_py_api_example_files/figure-html/cell-14-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="rabbits_full_py_api_example_files/figure-html/cell-14-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="continuous-phase-type-distribution" class="level2">
<h2 class="anchored" data-anchor-id="continuous-phase-type-distribution">Continuous phase-type distribution</h2>
<p>We can now construct the graphs by the function. The flooding rates are set to 2 and 4</p>
<div id="cell-29" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> construct_rabbit_graph(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Get the number of vertices in the graph:</p>
<div id="cell-31" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>graph.vertices_length()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>7</code></pre>
</div>
</div>
<p>as well as integer vector states that those vertices represent:</p>
<div id="cell-33" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> graph.states()</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>M</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>array([[0, 0],
       [2, 0],
       [1, 1],
       [0, 0],
       [0, 2],
       [0, 1],
       [1, 0]], dtype=int32)</code></pre>
</div>
</div>
<p>(or nicely as a dataframe):</p>
<div id="cell-35" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(M, columns<span class="op">=</span>[<span class="st">"Rabbits left"</span>, <span class="st">"Rabbits right"</span>])<span class="co">#.style.hide()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Rabbits left</th>
<th data-quarto-table-cell-role="th">Rabbits right</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>0</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>0</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>This phase-type distribution models the time until all rabits have died. For convenience, we can get its expectation and variance like this:</p>
<div id="cell-37" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>graph.expectation()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>0.5038265306122448</code></pre>
</div>
</div>
<div id="cell-38" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>graph.variance()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>0.2264567497917534</code></pre>
</div>
</div>
<p>But if you want you can get any number of moments like this (here three):</p>
<div id="cell-40" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>graph.moments(<span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>[0.5038265306122448, 0.48029792274052463, 0.6559101757731152]</code></pre>
</div>
</div>
<p>We can find the expected waiting time given that we start in any of the states, not just the starting state:</p>
<div id="cell-42" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>graph.expected_waiting_time()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>[0.5038265306122448,
 0.5038265306122448,
 0.5114795918367346,
 0.0,
 0.30229591836734687,
 0.28571428571428564,
 0.4285714285714285]</code></pre>
</div>
</div>
<p>We can get the CDF and PDF. The distribution methods reuse cached computations and recompute only if the graph changes. Compare the running times for the first and second call to the function:</p>
<div id="cell-45" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>time <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="dv">4</span>, <span class="fl">0.001</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-46" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>cdf <span class="op">=</span> graph.cdf(time)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 424 μs, sys: 140 μs, total: 564 μs
Wall time: 629 μs</code></pre>
</div>
</div>
<div id="cell-47" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>cdf <span class="op">=</span> graph.cdf(time)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 50 μs, sys: 23 μs, total: 73 μs
Wall time: 70.8 μs</code></pre>
</div>
</div>
<div id="cell-48" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>pdf <span class="op">=</span> graph.pdf(time)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 47 μs, sys: 19 μs, total: 66 μs
Wall time: 66 μs</code></pre>
</div>
</div>
<p>PDF and CDF of distribution. Observe the long tails!</p>
<div id="cell-50" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">3</span>))</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>ax1.plot(time, pdf)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">"PDF"</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>ax1.set_ylim(bottom<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>ax2.plot(time, cdf)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">"CDF"</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>ax2.set_ylim(bottom<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>sns.despine()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="rabbits_full_py_api_example_files/figure-html/cell-29-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="rabbits_full_py_api_example_files/figure-html/cell-29-output-1.png" width="671" height="296" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="rewards" class="level2">
<h2 class="anchored" data-anchor-id="rewards">Rewards</h2>
<p>We can add rewards which are based on the number of rabbits on the second island.</p>
<div id="cell-53" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>rewards <span class="op">=</span> graph.states()[:, <span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Can also be computed like this:</p>
<div id="cell-55" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>rewards <span class="op">=</span> np.array([graph.vertex_at(i).state()[<span class="dv">1</span>] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(graph.vertices_length())])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Adding these rewards, the phase-type distribution now represent the total accumulated time that any rabbits spends on the right island.</p>
<p>Using rewards to the moment functions etc. is much faster than changing the graph.</p>
<p>The expectation and variance are now:</p>
<div id="cell-59" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>graph.expectation(rewards), graph.variance(rewards)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>(0.09438775510204081, 0.04634787588504788)</code></pre>
</div>
</div>
<p>Using rewards to the moment functions etc. is much faster than actually changing the graph, but sometimes we might want to be interested in reward transforming the phase-type distribution, giving us the full distribution of accumulated rewards. For example if we want the pdf/cdf.</p>
<div id="cell-61" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>right_graph <span class="op">=</span> graph.reward_transform(rewards)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now we get the expectation and variance from before without adding any rewards:</p>
<div id="cell-63" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>right_graph.expectation(), right_graph.variance()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>(0.09438775510204078, 0.046347875885047865)</code></pre>
</div>
</div>
<p>We can find the distribution function for the the total accumulate time spent by any rabbit on an island. We show here the PDF and CDF</p>
<div id="cell-65" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>accumulated_rewards <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="dv">2</span>, <span class="fl">0.01</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>pdf <span class="op">=</span> right_graph.pdf(accumulated_rewards)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>cdf <span class="op">=</span> right_graph.cdf(accumulated_rewards)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>PDF and CDF of distribution. Notice how we have a “defect” i.e.&nbsp;a probability of obtaining no rewards:</p>
<div id="cell-67" class="cell" data-tags="[]" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>right_graph.defect()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>0.6666666666666666</code></pre>
</div>
</div>
<p>The defect is shown with a dotted line below. Remember to always consider this defect.</p>
<div id="cell-69" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">3</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>ax1.plot(accumulated_rewards, pdf)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">"PDF"</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>ax1.set_ylim(bottom<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>ax2.plot(accumulated_rewards, cdf)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">"CDF"</span>)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>ax2.set_ylim(bottom<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>ax2.axhline(y<span class="op">=</span>right_graph.defect(), linestyle<span class="op">=</span><span class="st">'dotted'</span>, color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>sns.despine()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="rabbits_full_py_api_example_files/figure-html/cell-37-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="rabbits_full_py_api_example_files/figure-html/cell-37-output-1.png" width="671" height="296" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>There are also utility methods to get the stop probability i.e.&nbsp;probabilities of occupying each state at time t.</p>
<div id="cell-71" class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>graph.stop_probability(<span class="fl">0.2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>[0.0,
 0.5561531639166896,
 0.07040541534825098,
 0.0,
 0.007095725804629082,
 0.016348108066650276,
 0.03374890558205247]</code></pre>
</div>
</div>
<p>We can use that to compute the expected number of rabbits across time:</p>
<div id="cell-73" class="cell" data-execution_count="37">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>times <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="dv">2</span>, <span class="fl">0.05</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>expected_rabbits_left <span class="op">=</span> [</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    np.<span class="bu">sum</span>(graph.stop_probability(i) </span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>           <span class="op">*</span> np.<span class="bu">sum</span>(graph.states(), axis<span class="op">=</span><span class="dv">1</span>)) </span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> times</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">3</span>))</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>ax.plot(times, expected_rabbits_left)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'time'</span>)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Expected nr rabbits"</span>)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>sns.despine()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="rabbits_full_py_api_example_files/figure-html/cell-39-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="rabbits_full_py_api_example_files/figure-html/cell-39-output-1.png" width="385" height="294" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>We can also get the accumulated visiting time of a particular state. E.g. the total time before time t=0.5 where there was a rabbit on the right island:</p>
<div id="cell-75" class="cell" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>rewards <span class="op">=</span> (graph.states()[:,<span class="dv">1</span>]<span class="op">&gt;</span><span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>np.<span class="bu">sum</span>(graph.accumulated_visiting_time(time<span class="op">=</span><span class="fl">0.5</span>) <span class="op">*</span> rewards)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>np.float64(0.04053231796047568)</code></pre>
</div>
</div>
<div id="cell-76" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>graph.expected_residence_time()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>[0.0, 0.5038265306122448, 0.0, 0.0, 0.0, 0.0, 0.0]</code></pre>
</div>
</div>
</section>
</section>
<section id="random-sampling" class="level1">
<h1>Random sampling</h1>
<p>The library includes functions to do random sampling. These are useful to also validate the computations</p>
<div id="cell-79" class="cell" data-execution_count="40">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>graph.sample(<span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>[0.2735907117529687,
 0.7130005401770035,
 0.9255082267425577,
 1.0230524508925858,
 0.6393963250475255]</code></pre>
</div>
</div>
<div id="cell-80" class="cell" data-execution_count="41">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">3</span>))</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> graph.sample(<span class="dv">1000000</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>ax.hist(samples, bins<span class="op">=</span><span class="dv">50</span>, density<span class="op">=</span><span class="va">True</span>, label<span class="op">=</span><span class="st">'Samples'</span>)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="dv">2</span>, <span class="fl">0.05</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>ax.plot(x, [graph.pdf(t) <span class="cf">for</span> t <span class="kw">in</span> x], label<span class="op">=</span><span class="st">'PDF'</span>)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>sns.despine()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="rabbits_full_py_api_example_files/figure-html/cell-43-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="rabbits_full_py_api_example_files/figure-html/cell-43-output-1.png" width="372" height="274" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>You can produce the moments from sampling if needed. Compare to the sampled and exact second moments:</p>
<div id="cell-82" class="cell" data-execution_count="42">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>np.<span class="bu">sum</span>(np.array(graph.sample(<span class="dv">1000000</span>))<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">1000000</span>, graph.moments(<span class="dv">2</span>)[<span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>(np.float64(0.479080131313076), 0.48029792274052463)</code></pre>
</div>
</div>
<div id="cell-83" class="cell" data-execution_count="43">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>rewards <span class="op">=</span> graph.states()[:,<span class="dv">1</span>]</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>np.<span class="bu">sum</span>(np.array(graph.sample(<span class="dv">1000000</span>, rewards))<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">1000000</span>, graph.moments(<span class="dv">2</span>, rewards)[<span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>(np.float64(0.055115586773096616), 0.055256924198250706)</code></pre>
</div>
</div>
<p>Reward-transforming first and then computing without rewards achieves the same thing:</p>
<div id="cell-85" class="cell" data-execution_count="44">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>revtr_graph <span class="op">=</span> graph.reward_transform(rewards)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>np.<span class="bu">sum</span>(np.array(revtr_graph.sample(<span class="dv">1000000</span>))<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">1000000</span>, revtr_graph.moments(<span class="dv">2</span>)[<span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>(np.float64(0.05514900471875006), 0.05525692419825069)</code></pre>
</div>
</div>
<section id="discrete-phase-type-distributions" class="level2">
<h2 class="anchored" data-anchor-id="discrete-phase-type-distributions">Discrete phase-type distributions</h2>
<p>We can also work with discrete phase-type distributions. This is the number of jumps in a Markov Chain before absorption. We will model that any rabbit can find a carrot at each time with rate 0.1 and see how many carrots the rabbits will have found. We could of course just make a new state-space creation function, but we can also manipulate existing.</p>
<div id="cell-88" class="cell" data-execution_count="45">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>carrot_graph <span class="op">=</span> graph.copy()</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>vlength <span class="op">=</span> carrot_graph.vertices_length()</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>carrot_vertices <span class="op">=</span> np.repeat(<span class="va">False</span>, vlength<span class="op">*</span><span class="dv">2</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(vlength):</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    vertex <span class="op">=</span> carrot_graph.vertex_at(i)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    rabbits <span class="op">=</span> <span class="bu">sum</span>(vertex.state())</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rabbits <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>        obtained_carrot_vertex <span class="op">=</span> carrot_graph.create_vertex([<span class="dv">0</span>])</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Go directly back to the state we came from</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>        obtained_carrot_vertex.add_edge(vertex, <span class="dv">1</span>)</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rate of finding carrot</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>        vertex.add_edge(obtained_carrot_vertex, rabbits <span class="op">*</span> <span class="fl">0.1</span>)</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>        carrot_vertices[obtained_carrot_vertex.index()] <span class="op">=</span> <span class="va">True</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-89" class="cell" data-execution_count="46">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>carrot_graph.plot()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<div>
<figure class="figure">
<p><a href="rabbits_full_py_api_example_files/figure-html/cell-48-output-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="rabbits_full_py_api_example_files/figure-html/cell-48-output-1.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-90" class="cell" data-execution_count="47">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>vlength <span class="op">=</span> carrot_graph.vertices_length()</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>carrot_vertices <span class="op">=</span> np.repeat(<span class="va">False</span>, vlength<span class="op">*</span><span class="dv">2</span>)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(vlength):</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    vertex <span class="op">=</span> carrot_graph.vertex_at(i)</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    rabbits <span class="op">=</span> <span class="bu">sum</span>(vertex.state())</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rabbits <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>        obtained_carrot_vertex <span class="op">=</span> carrot_graph.create_vertex([<span class="dv">0</span>])</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Go directly back to the state we came from</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>        obtained_carrot_vertex.add_edge(vertex, <span class="dv">1</span>)</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rate of finding carrot</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>        vertex.add_edge(obtained_carrot_vertex, rabbits <span class="op">*</span> <span class="fl">0.1</span>)</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>        carrot_vertices[obtained_carrot_vertex.index()] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>carrot_vertices <span class="op">=</span> carrot_vertices[np.arange(carrot_graph.vertices_length())]</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a><span class="co"># We now want to make the graph discrete. We do this by 'normalizing' the edges</span></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a><span class="co"># This is imply scaling the vertices such that the total out-going rate is 1</span></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a><span class="co"># As it is now the probability of transitions</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>weights_were_multiplied_with <span class="op">=</span> carrot_graph.normalize()</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"This is the discrete state space as a sub-transition matrix:"</span>)</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a><span class="co">#carrot_graph.as_matrices()</span></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'GRAPH AS MATRIX MAKES THE KERNEL DIE...'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>This is the discrete state space as a sub-transition matrix:
GRAPH AS MATRIX MAKES THE KERNEL DIE...</code></pre>
</div>
</div>
<div id="cell-91" class="cell" data-execution_count="48">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for vertex in carrot_graph.vertices():</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(vertex.index(),vertex.state(), vertex.edges())</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-92" class="cell" data-execution_count="49">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for vertex in carrot_graph.vertices():</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(vertex)</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     for edge in vertex.edges():</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="co">#         print("  ", edge)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-93" class="cell" data-execution_count="50">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># carrot_vertices.astype(int)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We now want to find the expected number of eaten carrots. We set the reward such that the carrot vertex has a reward of ‘1’.</p>
<div id="cell-95" class="cell" data-execution_count="51">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>rewards <span class="op">=</span> carrot_vertices.astype(<span class="bu">int</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>carrot_graph.expectation_discrete(rewards)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>0.09056122448979592</code></pre>
</div>
</div>
<p>We can verify that the number of carrots correspond to scaling the continuous graph:</p>
<div id="cell-97" class="cell" data-execution_count="52">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>graph.expectation(graph.states().<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)) <span class="op">*</span> <span class="fl">0.1</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>0.09056122448979591</code></pre>
</div>
</div>
<p>Of course we cannot do this for other moments:</p>
<div id="cell-99" class="cell" data-execution_count="53">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>carrot_graph.variance_discrete(rewards)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>0.09723142700957937</code></pre>
</div>
</div>
<p>Verified by sampling:</p>
<div id="cell-101" class="cell" data-execution_count="54">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> carrot_graph.sample_discrete(<span class="dv">1000000</span>, rewards)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> np.array(samples)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>np.<span class="bu">sum</span>(samples<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> <span class="dv">1000000</span> <span class="op">-</span> ((np.<span class="bu">sum</span>(samples)) <span class="op">/</span> <span class="dv">1000000</span>)<span class="op">**</span><span class="dv">2</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>np.float64(0.097703180656)</code></pre>
</div>
</div>
<div id="cell-102" class="cell" data-execution_count="55">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can find the distribution function for the the total number of carrots found</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>carrots <span class="op">=</span> np.arange(<span class="dv">10</span>)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Notice that with this reward transformation the graph is no longer sparse, as all paths through</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the graph are represented!!</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>found_carrots_graph  <span class="op">=</span> carrot_graph.reward_transform_discrete(rewards)</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>pmf <span class="op">=</span> found_carrots_graph.pmf_discrete(carrots)</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>cdf <span class="op">=</span> found_carrots_graph.cdf_discrete(carrots)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-103" class="cell" data-execution_count="56">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">3</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">1</span>)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>ax1.bar(x, pmf)</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">"PDF"</span>)</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Total number of carrots found'</span>)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ax1.set_ylim(bottom=0)</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="co">#ax2.plot(x, cdf)</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>left, right <span class="op">=</span> x, np.arange(<span class="dv">1</span>, x.size<span class="op">+</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>ax2.hlines(y<span class="op">=</span>cdf, xmin<span class="op">=</span>left, xmax<span class="op">=</span>right, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>ax2.scatter(left, cdf, s<span class="op">=</span><span class="dv">18</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">"CDF"</span>)</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ax2.set_ylim(bottom=0)</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Total number of carrots found'</span>)</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>ax2.axhline(y<span class="op">=</span>right_graph.defect(), linestyle<span class="op">=</span><span class="st">'dotted'</span>)</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>sns.despine()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="rabbits_full_py_api_example_files/figure-html/cell-58-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="rabbits_full_py_api_example_files/figure-html/cell-58-output-1.png" width="671" height="315" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="multivariate-phase-type-distributions" class="level1">
<h1>Multivariate phase-type distributions</h1>
<p>Instead of a univariate reward, we can have the distribution earn a <em>vector</em> of rewards for each time unit spent at a vertex. We will continue with the rabbit example. We will now show the relationship between total time spent by any rabbit on either of the two islands.</p>
<div id="cell-106" class="cell" data-execution_count="57">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>states <span class="op">=</span> graph.states()</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>states[:, <span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>array([0, 0, 1, 0, 2, 1, 0], dtype=int32)</code></pre>
</div>
</div>
<div id="cell-107" class="cell" data-execution_count="58">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>states <span class="op">=</span> graph.states()</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>graph.covariance(states[:,<span class="dv">0</span>], states[:,<span class="dv">1</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>0.030003774468971296</code></pre>
</div>
</div>
<div id="cell-108" class="cell" data-execution_count="59">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>simulations <span class="op">=</span> graph.sample_multivariate(<span class="dv">100000</span>, graph.states())</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>simulated_cov <span class="op">=</span> <span class="bu">sum</span>(simulations[<span class="dv">0</span>,:]<span class="op">*</span>simulations[<span class="dv">1</span>,:])<span class="op">/</span><span class="dv">100000</span> <span class="op">-</span> <span class="op">\</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">sum</span>(simulations[<span class="dv">0</span>,:])<span class="op">/</span><span class="dv">100000</span><span class="op">*</span><span class="bu">sum</span>(simulations[<span class="dv">1</span>,:])<span class="op">/</span><span class="dv">100000</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>simulated_cov</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>np.float64(0.029969904529399002)</code></pre>
</div>
</div>
<p>The api also supports multivariate <em>discrete</em> phase-type distributions. We show the covariance between carrots found on either island.</p>
<div id="cell-110" class="cell" data-execution_count="60">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>mdph_carrot_graph <span class="op">=</span> graph.clone()</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>vlength <span class="op">=</span> mdph_carrot_graph.vertices_length()</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>carrot_vertices_left <span class="op">=</span> np.repeat(<span class="va">False</span>, vlength<span class="op">*</span><span class="dv">2</span>)</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>carrot_vertices_right <span class="op">=</span> np.repeat(<span class="va">False</span>, vlength<span class="op">*</span><span class="dv">2</span>)</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(vlength):</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>    vertex <span class="op">=</span> mdph_carrot_graph.vertex_at(i)</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>    rabbits <span class="op">=</span> vertex.state()</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rabbits[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>        obtained_carrot_vertex <span class="op">=</span> mdph_carrot_graph.create_vertex([<span class="dv">0</span>])</span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Go directly back to the state we came from</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>        obtained_carrot_vertex.add_edge(vertex, <span class="dv">1</span>)</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rate of finding carrot</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>        vertex.add_edge(obtained_carrot_vertex, rabbits[<span class="dv">0</span>] <span class="op">*</span> <span class="fl">0.1</span>)</span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>        carrot_vertices_left[obtained_carrot_vertex.index()] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rabbits[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>        obtained_carrot_vertex <span class="op">=</span> mdph_carrot_graph.create_vertex([<span class="dv">0</span>])</span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Go directly back to the state we came from</span></span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>        obtained_carrot_vertex.add_edge(vertex, <span class="dv">1</span>)</span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rate of finding carrot</span></span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a>        vertex.add_edge(obtained_carrot_vertex, rabbits[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.1</span>)</span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a>        carrot_vertices_right[obtained_carrot_vertex.index()] <span class="op">=</span> <span class="va">True</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Covariance:</p>
<div id="cell-112" class="cell" data-execution_count="61">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>carrot_vertices_left <span class="op">=</span> carrot_vertices_left[<span class="dv">0</span>:mdph_carrot_graph.vertices_length()]</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>carrot_vertices_right <span class="op">=</span> carrot_vertices_right[<span class="dv">0</span>:mdph_carrot_graph.vertices_length()]</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>mdph_carrot_graph.normalize()</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>rewards <span class="op">=</span> np.column_stack((carrot_vertices_left, carrot_vertices_right)).astype(<span class="bu">int</span>)</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>mdph_carrot_graph.covariance_discrete(rewards[:,<span class="dv">0</span>], rewards[:,<span class="dv">1</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>-0.0005338270512286547</code></pre>
</div>
</div>
<p>Sampled covariance:</p>
<div id="cell-114" class="cell" data-execution_count="62">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>simulations <span class="op">=</span> mdph_carrot_graph.sample_multivariate_discrete(<span class="dv">1000000</span>, rewards)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>simulated_cov <span class="op">&lt;-</span> np.<span class="bu">sum</span>(simulations[<span class="dv">0</span>,:]<span class="op">*</span>simulations[<span class="dv">1</span>,:])<span class="op">/</span><span class="dv">1000000</span> <span class="op">-</span> <span class="op">\</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>                    np.<span class="bu">sum</span>(simulations[<span class="dv">0</span>,:])<span class="op">/</span><span class="dv">1000000</span><span class="op">*</span>np.<span class="bu">sum</span>(simulations[<span class="dv">1</span>,:])<span class="op">/</span><span class="dv">1000000</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>simulated_cov</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>np.float64(0.029969904529399002)</code></pre>
</div>
</div>
</section>
<section id="parameterized-edges" class="level1">
<h1>Parameterized edges</h1>
<p>We can <em>parameterize</em> the edges to easily update the weights of the edge</p>
<p>We do this by assigning a <em>state</em> to the <em>edge</em>.</p>
<p>We will now also say that the rate of rabbits jumping is proportional to the number of rabbits on the island.</p>
<p>Our state is [rabbits able to jump, left flooding, right flooding]</p>
<div id="cell-117" class="cell" data-execution_count="63">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_rabbit_graph_params(nr_rabbits):</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We represent the vector as two integers, the number of rabbits on the left and right island</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    state_vector_length <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">=</span> Graph(state_vector_length)</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    initial_state <span class="op">=</span> [nr_rabbits, <span class="dv">0</span>]</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The initial state is the only starting state, with 100% starting probability</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>    graph.starting_vertex().add_edge(</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>      graph.find_or_create_vertex(initial_state),</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterate over all unvisited vertices</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> index <span class="op">&lt;</span> graph.vertices_length():</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>      vertex <span class="op">=</span> graph.vertex_at(index)</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>      state <span class="op">=</span> vertex.state()</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> state[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rabbit jump left to right</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>        child_state <span class="op">=</span> [state[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span>, state[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>        vertex.add_edge_parameterized(</span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>          graph.find_or_create_vertex(child_state),</span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>          <span class="dv">0</span>,</span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>          [state[<span class="dv">0</span>],<span class="dv">0</span>,<span class="dv">0</span>]</span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Left island flooding</span></span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a>        child_state <span class="op">=</span> c(<span class="dv">0</span>, state[<span class="dv">1</span>])</span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a>        vertex.add_edge_parameterized(</span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a>          graph.find_or_create_vertex(child_state),</span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a>          <span class="dv">0</span>,</span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a>          [<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>]</span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> state[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rabbit jump right to left</span></span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true" tabindex="-1"></a>        child_state <span class="op">=</span> [state[<span class="dv">0</span>] <span class="op">+</span> <span class="dv">1</span>, state[<span class="dv">1</span>] <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true" tabindex="-1"></a>        vertex.add_edge_parameterized(</span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true" tabindex="-1"></a>          graph.find_or_create_vertex(child_state),</span>
<span id="cb94-37"><a href="#cb94-37" aria-hidden="true" tabindex="-1"></a>          <span class="dv">0</span>, </span>
<span id="cb94-38"><a href="#cb94-38" aria-hidden="true" tabindex="-1"></a>          [state[<span class="dv">1</span>],<span class="dv">0</span>,<span class="dv">0</span>]</span>
<span id="cb94-39"><a href="#cb94-39" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb94-40"><a href="#cb94-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Right island flooding with rate of 4</span></span>
<span id="cb94-41"><a href="#cb94-41" aria-hidden="true" tabindex="-1"></a>        child_state <span class="op">=</span> [state[<span class="dv">0</span>], <span class="dv">0</span>]</span>
<span id="cb94-42"><a href="#cb94-42" aria-hidden="true" tabindex="-1"></a>        vertex.add_edge_parameterized(</span>
<span id="cb94-43"><a href="#cb94-43" aria-hidden="true" tabindex="-1"></a>          graph.find_or_create_vertex(child_state),</span>
<span id="cb94-44"><a href="#cb94-44" aria-hidden="true" tabindex="-1"></a>          <span class="dv">0</span>,</span>
<span id="cb94-45"><a href="#cb94-45" aria-hidden="true" tabindex="-1"></a>          [<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>]</span>
<span id="cb94-46"><a href="#cb94-46" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb94-47"><a href="#cb94-47" aria-hidden="true" tabindex="-1"></a>      index <span class="op">=</span> index <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb94-48"><a href="#cb94-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-49"><a href="#cb94-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(graph)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The parameterized edges have what ever weight is assigned to them, and the state does not by itself mean anything.</p>
<div id="cell-119" class="cell" data-execution_count="64">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>param_graph <span class="op">=</span> construct_rabbit_graph_params(<span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>If we let the edge have a state, this gives us an easy way of changing the weights based on some model parameters. In this case, it is the rate of jumping left rate of flooding and right rate of flooding.</p>
<p>The update simply takes the inner product of the state vector and the model parameters, e.g.&nbsp;if the state is x1, x2 and the parameters are p1, p2, then the weight of the edge become x1<em>p1+x2</em>p2</p>
<div id="cell-121" class="cell" data-execution_count="65">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>param_graph.update_parameterized_weights([<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>])</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Expectation (1,2,4):"</span>, param_graph.expectation())</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>param_graph.update_parameterized_weights([<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">4</span>])</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Expectation (1,2,4):"</span>, param_graph.expectation())</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>param_graph.update_parameterized_weights([<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">4</span>])</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Expectation (1,2,4):"</span>, param_graph.expectation())</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>param_graph.update_parameterized_weights([<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">18</span>])</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Expectation (1,2,4):"</span>, param_graph.expectation())</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>param_graph.update_parameterized_weights([<span class="dv">8</span>, <span class="dv">4</span>, <span class="dv">18</span>])</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Expectation (1,2,4):"</span>, param_graph.expectation())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Expectation (1,2,4): 0.453843669250646
Expectation (1,2,4): 0.3829988851727981
Expectation (1,2,4): 0.2558080808080808
Expectation (1,2,4): 0.2123466140255808
Expectation (1,2,4): 0.1274895365841465</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: trace cache file exists but deserialization not yet implemented: /Users/kmt/.ptdalgorithms_cache/traces/4d2926c87dfd55392e0dd4bcde8576c0d537eae292bb0af1668e2c7b418823c7.json
INFO: recording elimination trace for parameterized graph...
INFO: trace cache file exists but deserialization not yet implemented: /Users/kmt/.ptdalgorithms_cache/traces/4d2926c87dfd55392e0dd4bcde8576c0d537eae292bb0af1668e2c7b418823c7.json
INFO: cache miss, recording elimination trace...
INFO: saved trace to cache (6184 bytes): /Users/kmt/.ptdalgorithms_cache/traces/4d2926c87dfd55392e0dd4bcde8576c0d537eae292bb0af1668e2c7b418823c7.json
INFO: saved trace to cache (6184 bytes): /Users/kmt/.ptdalgorithms_cache/traces/4d2926c87dfd55392e0dd4bcde8576c0d537eae292bb0af1668e2c7b418823c7.json</code></pre>
</div>
</div>
<div id="cell-122" class="cell" data-execution_count="66">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>param_graph.update_parameterized_weights([<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>])</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="co">#param_graph.as_matrices()</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>param_graph.update_parameterized_weights([<span class="dv">8</span>, <span class="dv">4</span>, <span class="dv">18</span>])</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="co">#param_graph.as_matrices()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The speedup is substantial even for this modestly-sized model with only ~10 states. For larger models with hundreds or thousands of states, the speedup can easily reach 100× or 1000×. This makes the difference between inference being computationally infeasible and running in reasonable time.</p>
<p>The symbolic elimination approach is particularly powerful when combined with JAX for automatic differentiation and JIT compilation. The JAX integration allows us to convert the symbolic DAG into a JAX function that can be differentiated (for gradient-based inference) and compiled to highly optimized machine code. Let’s see how this works.</p>
<div id="cell-124" class="cell" data-execution_count="68">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>param_graph.svgd( [[<span class="dv">2</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">2</span>]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">TypeError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[68]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> <span class="ansi-yellow-bg">param_graph</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">svgd</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">[</span><span class="ansi-yellow-bg">[</span><span class="ansi-green-fg ansi-yellow-bg">2</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-green-fg ansi-yellow-bg">0</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">[</span><span class="ansi-green-fg ansi-yellow-bg">0</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-green-fg ansi-yellow-bg">2</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">TypeError</span>: Graph.svgd() missing 1 required positional argument: 'observed_data'</pre>
</div>
</div>
</div>
<p>The combination of symbolic elimination, JAX compilation, and automatic differentiation creates a powerful workflow for parameter inference. The symbolic DAG removes the O(n³) bottleneck, JIT compilation optimizes the resulting O(n) evaluation, and automatic differentiation provides exact gradients without manual derivation or finite differences. This is precisely the workflow we will use in the SVGD section later in this tutorial, where we will estimate rabbit model parameters from observed data.</p>
<p>For now, the key takeaway is that whenever you have a parameterized model that you need to evaluate many times—whether for parameter exploration, sensitivity analysis, or Bayesian inference—symbolic elimination should be your default choice. The performance improvement is dramatic, and the integration with JAX opens the door to gradient-based methods and GPU acceleration.</p>
</section>
<section id="state-space-modelling" class="level1">
<h1>State space modelling</h1>
<section id="time-inhomogeneity" class="level2">
<h2 class="anchored" data-anchor-id="time-inhomogeneity">Time inhomogeneity</h2>
<p>If the weights change over time - or new edges are added!</p>
<p>Then the distribution is time inhomogeneous. The api also supports such distributions, but in limited manner.</p>
<p>Like the pph, dph, etc. functions, it is a (very good) approximation based on very small steps. If the rates change dramatically, set the granularity as an argument to the functions!! E.g. set it to a high enough value.</p>
<p>If we pick a time far into the future, we can integrate under the pdf to find the expectation!</p>
<p>Integrating over accumulated visiting time:</p>
<div id="cell-130" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="bu">sum</span>(graph.accumulated_visiting_time(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>0.5038265306014538</code></pre>
</div>
</div>
<p>The first moment (expectation):</p>
<div id="cell-132" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>graph.expectation()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>0.5038265306122448</code></pre>
</div>
</div>
<p>Say at a certain point in time, the flooding starts!</p>
<p>In the beginning, there is <em>no</em> flooding</p>
<div id="cell-134" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>param_graph.update_parameterized_weights([<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can build a context to step over the distribution. Weights can be freely changed and edges added in such a context</p>
<div id="cell-136" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import ptdalgorithms as ptd</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="co"># import numpy as np</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="co"># def c(*args):</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     elem = []</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     for arg in args:</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="co">#         if hasattr(arg, '__len__') and len(arg) &gt; 1:</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="co">#             elem.extend(arg)</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         else:</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a><span class="co">#             elem.append(arg)</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     return np.array(elem)</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a><span class="co"># nr_rabbits, flood_left, flood_right = 2, 2, 4</span></span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a><span class="co"># # we represent the vector as two integers, the number of </span></span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a><span class="co"># # rabbits on the left and right island</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a><span class="co"># state_vector_length = 2</span></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a><span class="co"># graph = ptd.Graph(state_vector_length)</span></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a><span class="co"># # the initial state is the only starting state, with probability 1</span></span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a><span class="co"># initial_state = c(nr_rabbits, 0)</span></span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a><span class="co"># vertex = graph.find_or_create_vertex(initial_state)</span></span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a><span class="co"># graph.starting_vertex().add_edge(vertex, 1)</span></span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a><span class="co"># index = 1</span></span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a><span class="co"># # iterate over all unvisited vertices</span></span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a><span class="co"># while index &lt; graph.vertices_length():</span></span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a><span class="co">#     vertex = graph.vertex_at(index)</span></span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a><span class="co">#     state = vertex.state()</span></span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a><span class="co">#     if state[0] &gt; 0:</span></span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a><span class="co">#         # rabbit jump left to right</span></span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a><span class="co">#         child_state = c(state[0] - 1, state[1] + 1)</span></span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a><span class="co">#         vertex.add_edge(</span></span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a><span class="co">#             graph.find_or_create_vertex(child_state),</span></span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a><span class="co">#             weight=1</span></span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a><span class="co">#         )</span></span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a><span class="co">#         # left island flooding</span></span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a><span class="co">#         child_state = c(0, state[1])</span></span>
<span id="cb106-41"><a href="#cb106-41" aria-hidden="true" tabindex="-1"></a><span class="co">#         vertex.add_edge(</span></span>
<span id="cb106-42"><a href="#cb106-42" aria-hidden="true" tabindex="-1"></a><span class="co">#             graph.find_or_create_vertex(child_state), </span></span>
<span id="cb106-43"><a href="#cb106-43" aria-hidden="true" tabindex="-1"></a><span class="co">#             weight=flood_left</span></span>
<span id="cb106-44"><a href="#cb106-44" aria-hidden="true" tabindex="-1"></a><span class="co">#         )</span></span>
<span id="cb106-45"><a href="#cb106-45" aria-hidden="true" tabindex="-1"></a><span class="co">#     if state[1] &gt; 0:   </span></span>
<span id="cb106-46"><a href="#cb106-46" aria-hidden="true" tabindex="-1"></a><span class="co">#         child_state = c(state[0] + 1, state[1] - 1)</span></span>
<span id="cb106-47"><a href="#cb106-47" aria-hidden="true" tabindex="-1"></a><span class="co">#         vertex.add_edge(</span></span>
<span id="cb106-48"><a href="#cb106-48" aria-hidden="true" tabindex="-1"></a><span class="co">#             graph.find_or_create_vertex(child_state),</span></span>
<span id="cb106-49"><a href="#cb106-49" aria-hidden="true" tabindex="-1"></a><span class="co">#             weight=1</span></span>
<span id="cb106-50"><a href="#cb106-50" aria-hidden="true" tabindex="-1"></a><span class="co">#         )</span></span>
<span id="cb106-51"><a href="#cb106-51" aria-hidden="true" tabindex="-1"></a><span class="co">#         # right island flooding</span></span>
<span id="cb106-52"><a href="#cb106-52" aria-hidden="true" tabindex="-1"></a><span class="co">#         child_state = c(state[0], 0)</span></span>
<span id="cb106-53"><a href="#cb106-53" aria-hidden="true" tabindex="-1"></a><span class="co">#         vertex.add_edge(</span></span>
<span id="cb106-54"><a href="#cb106-54" aria-hidden="true" tabindex="-1"></a><span class="co">#             graph.find_or_create_vertex(child_state), </span></span>
<span id="cb106-55"><a href="#cb106-55" aria-hidden="true" tabindex="-1"></a><span class="co">#             weight=flood_right</span></span>
<span id="cb106-56"><a href="#cb106-56" aria-hidden="true" tabindex="-1"></a><span class="co">#         )</span></span>
<span id="cb106-57"><a href="#cb106-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-58"><a href="#cb106-58" aria-hidden="true" tabindex="-1"></a><span class="co">#     index += 1</span></span>
<span id="cb106-59"><a href="#cb106-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-60"><a href="#cb106-60" aria-hidden="true" tabindex="-1"></a><span class="co"># # graph.plot(nodesep=1, ranksep=0.1)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-137" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ctx = graph.distribution_context()</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="co"># cdfs = []</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="co"># times = []</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="co"># # while ctx.time() &lt; 1.5:</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="co"># while ctx.cdf() &lt; 0.999:</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     cdfs.append(ctx.cdf())</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     times.append(ctx.time())</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     param_graph.update_parameterized_weights(</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a><span class="co">#         [1,</span></span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a><span class="co">#         ctx.time() - 1.5, </span></span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a><span class="co">#         2 * ctx.time() - 1.5</span></span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a><span class="co">#         ]</span></span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a><span class="co">#     ctx.step()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>It increases by every time step. Time until all rabbits are dead. Flooding increases linearly after 1.5 time units:</p>
<div id="cell-139" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>param_graph.update_parameterized_weights([<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>ctx <span class="op">=</span> param_graph.distribution_context()</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>cdfs <span class="op">=</span> []</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>times <span class="op">=</span> []</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> ctx.time() <span class="op">&lt;</span> <span class="fl">1.5</span>:</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>    cdfs.append(ctx.cdf())</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>    times.append(ctx.time())</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>    ctx.step()</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a><span class="co">#param_graph.update_parameterized_weights([1, 1, 1])</span></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a><span class="co"># at time 1.5, the flooding starts!</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> ctx.cdf() <span class="op">&lt;</span> <span class="fl">0.999</span>:</span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>    cdfs.append(ctx.cdf())</span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a>    times.append(ctx.time())</span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>    param_graph.update_parameterized_weights(</span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">1</span>,</span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a>        ctx.time() <span class="op">-</span> <span class="fl">1.5</span>, </span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span> <span class="op">*</span> ctx.time() <span class="op">-</span> <span class="fl">1.5</span></span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a>    ctx.step()</span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">3</span>))</span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a>ax.plot(times, cdfs)</span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a>sns.despine()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="rabbits_full_py_api_example_files/figure-html/cell-75-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="rabbits_full_py_api_example_files/figure-html/cell-75-output-1.png" width="361" height="274" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>If we pick a time far into the future, we can integrate under it to find the expectation. This means that we can scale by a reward, and thereby find the marginal expectation.</p>
<p>Summing over accumulated visiting time (with reward):</p>
<div id="cell-142" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>np.<span class="bu">sum</span>(graph.accumulated_visiting_time(<span class="dv">10</span>)<span class="op">*</span>graph.states()[:,<span class="dv">1</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>np.float64(0.09438775509887067)</code></pre>
</div>
</div>
<p>The first moment (expectation) (with reward):</p>
<div id="cell-144" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>graph.expectation(graph.states()[:,<span class="dv">1</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>0.09438775510204081</code></pre>
</div>
</div>
<p>But if the time is <em>not</em> far into the future, we get the expectation up to a certain point in time.</p>
<p>Expectation (rewarded) when truncating at 0.05 time:</p>
<div id="cell-147" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>np.<span class="bu">sum</span>(graph.accumulated_visiting_time(<span class="fl">0.05</span>)<span class="op">*</span>graph.states()[:,<span class="dv">1</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>np.float64(0.0011713234985744549)</code></pre>
</div>
</div>
<p>Untruncated expectation:</p>
<div id="cell-149" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>graph.expectation(graph.states()[:,<span class="dv">1</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>0.09438775510204081</code></pre>
</div>
</div>
<p>Expectation (rewarded) when <em>starting</em> at 0.05 time:</p>
</section>
<section id="modelling-epochs-in-state-space" class="level2">
<h2 class="anchored" data-anchor-id="modelling-epochs-in-state-space">Modelling epochs in state space</h2>
</section>
<section id="laplace-transform" class="level2">
<h2 class="anchored" data-anchor-id="laplace-transform">Laplace transform</h2>
<p>The Laplace transform is a fundamental tool for analyzing continuous phase-type distributions. For a random variable T with probability density function f(t), the Laplace transform is defined as L(s) = E[e^(-sT)] = ∫₀^∞ e^(-st) f(t) dt. For phase-type distributions represented as absorbing Markov chains, the Laplace transform has an elegant matrix form that can be computed efficiently from the graph structure.</p>
<p>The Laplace transform is particularly useful because it provides an alternative characterization of the distribution that often simplifies analytical calculations. Moments can be recovered by differentiating the Laplace transform: the n-th moment is E[T^n] = (-1)^n (d^n L/ds^n)|_{s=0}. The Laplace transform also plays a crucial role in analyzing time-inhomogeneous processes and in computing convolutions of distributions.</p>
<p>In our rabbit model, the Laplace transform captures the moment generating function of the time until all rabbits have died. Let’s compute it and verify that we can recover moments by differentiation.</p>
<div id="cell-156" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute Laplace transform for several values of s</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>s_values <span class="op">=</span> np.array([<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">2.0</span>, <span class="fl">5.0</span>, <span class="fl">10.0</span>])</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>laplace_values <span class="op">=</span> graph.laplace_transform(s_values)</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Laplace transform L(s) = E[e^(-sT)]:"</span>)</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> s, L_s <span class="kw">in</span> <span class="bu">zip</span>(s_values, laplace_values):</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  L(</span><span class="sc">{</span>s<span class="sc">:4.1f}</span><span class="ss">) = </span><span class="sc">{</span>L_s<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify that L(0) = 1 (certain event)</span></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>L_0 <span class="op">=</span> graph.laplace_transform(np.array([<span class="fl">0.0</span>]))[<span class="dv">0</span>]</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Verification: L(0) = </span><span class="sc">{</span>L_0<span class="sc">:.10f}</span><span class="ss"> (should be 1.0)"</span>)</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify relationship to moments using numerical differentiation</span></span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a><span class="co"># E[T] = -L'(0), so we approximate with finite differences</span></span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> <span class="fl">1e-6</span></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>L_h <span class="op">=</span> graph.laplace_transform(np.array([h]))[<span class="dv">0</span>]</span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a>L_0 <span class="op">=</span> graph.laplace_transform(np.array([<span class="fl">0.0</span>]))[<span class="dv">0</span>]</span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a>numerical_expectation <span class="op">=</span> <span class="op">-</span>(L_h <span class="op">-</span> L_0) <span class="op">/</span> h</span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>analytical_expectation <span class="op">=</span> graph.expectation()</span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Expectation from Laplace derivative: </span><span class="sc">{</span>numerical_expectation<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Expectation from direct computation: </span><span class="sc">{</span>analytical_expectation<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Relative error: </span><span class="sc">{</span><span class="bu">abs</span>(numerical_expectation <span class="op">-</span> analytical_expectation)<span class="op">/</span>analytical_expectation <span class="op">*</span> <span class="dv">100</span><span class="sc">:.4f}</span><span class="ss">%"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="joint-probability" class="level2">
<h2 class="anchored" data-anchor-id="joint-probability">Joint probability</h2>
<p>Phase-type distributions can be extended to model joint probabilities of multiple random variables. This is particularly important in applications like population genetics, where we might be interested in the joint distribution of coalescence times for multiple lineages, or in reliability theory, where we might want the joint distribution of failure times for multiple components. The library provides tools for constructing and analyzing such joint distributions through the concept of multi-dimensional phase-type distributions.</p>
<p>The key idea is that we can embed multiple independent or dependent processes into a single state space, where the state vector encodes the progress of all processes simultaneously. Transitions in this joint state space then correspond to events in any of the individual processes. By carefully constructing the edge weights and using reward transformations, we can extract marginal distributions, conditional distributions, and joint distribution functions.</p>
<p>In our rabbit model, we might be interested in the joint distribution of two quantities: the time until the left island is depleted (either by jumping or flooding) and the time until the right island is depleted. These two times are not independent—they are coupled through the rabbits jumping between islands. Let’s construct a model that tracks both times simultaneously.</p>
<div id="cell-158" class="cell" data-execution_count="70">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct a rabbit model that tracks time to depletion for each island separately</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_joint_time_model(nr_rabbits, flood_left, flood_right):</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct a model tracking joint distribution of depletion times.</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="co">    State: [rabbits_left, rabbits_right, left_depleted, right_depleted]</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">=</span> Graph(state_length<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>    initial_state <span class="op">=</span> [nr_rabbits, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>]  <span class="co"># Start with all rabbits on left</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>    graph.starting_vertex().add_edge(graph.find_or_create_vertex(initial_state), <span class="dv">1</span>)</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> index <span class="op">&lt;</span> graph.vertices_length():</span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>        vertex <span class="op">=</span> graph.vertex_at(index)</span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>        state <span class="op">=</span> <span class="bu">list</span>(vertex.state())</span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If left island has rabbits and not yet depleted</span></span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> state[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> state[<span class="dv">2</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Jump to right</span></span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>            child_state <span class="op">=</span> [state[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span>, state[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span>, state[<span class="dv">2</span>], state[<span class="dv">3</span>]]</span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> child_state[<span class="dv">0</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>                child_state[<span class="dv">2</span>] <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Mark left as depleted</span></span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>            vertex.add_edge(graph.find_or_create_vertex(child_state), weight<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Left flooding</span></span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a>            child_state <span class="op">=</span> [<span class="dv">0</span>, state[<span class="dv">1</span>], <span class="dv">1</span>, state[<span class="dv">3</span>]]  <span class="co"># All left rabbits die, mark depleted</span></span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a>            vertex.add_edge(graph.find_or_create_vertex(child_state), weight<span class="op">=</span>flood_left)</span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-29"><a href="#cb118-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If right island has rabbits and not yet depleted</span></span>
<span id="cb118-30"><a href="#cb118-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> state[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> state[<span class="dv">3</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb118-31"><a href="#cb118-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Jump to left</span></span>
<span id="cb118-32"><a href="#cb118-32" aria-hidden="true" tabindex="-1"></a>            child_state <span class="op">=</span> [state[<span class="dv">0</span>] <span class="op">+</span> <span class="dv">1</span>, state[<span class="dv">1</span>] <span class="op">-</span> <span class="dv">1</span>, state[<span class="dv">2</span>], state[<span class="dv">3</span>]]</span>
<span id="cb118-33"><a href="#cb118-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> child_state[<span class="dv">1</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb118-34"><a href="#cb118-34" aria-hidden="true" tabindex="-1"></a>                child_state[<span class="dv">3</span>] <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Mark right as depleted</span></span>
<span id="cb118-35"><a href="#cb118-35" aria-hidden="true" tabindex="-1"></a>            vertex.add_edge(graph.find_or_create_vertex(child_state), weight<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb118-36"><a href="#cb118-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-37"><a href="#cb118-37" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Right flooding</span></span>
<span id="cb118-38"><a href="#cb118-38" aria-hidden="true" tabindex="-1"></a>            child_state <span class="op">=</span> [state[<span class="dv">0</span>], <span class="dv">0</span>, state[<span class="dv">2</span>], <span class="dv">1</span>]  <span class="co"># All right rabbits die, mark depleted</span></span>
<span id="cb118-39"><a href="#cb118-39" aria-hidden="true" tabindex="-1"></a>            vertex.add_edge(graph.find_or_create_vertex(child_state), weight<span class="op">=</span>flood_right)</span>
<span id="cb118-40"><a href="#cb118-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-41"><a href="#cb118-41" aria-hidden="true" tabindex="-1"></a>        index <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb118-42"><a href="#cb118-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-43"><a href="#cb118-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> graph</span>
<span id="cb118-44"><a href="#cb118-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-45"><a href="#cb118-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the joint model</span></span>
<span id="cb118-46"><a href="#cb118-46" aria-hidden="true" tabindex="-1"></a>joint_graph <span class="op">=</span> construct_joint_time_model(<span class="dv">3</span>, <span class="fl">2.0</span>, <span class="fl">4.0</span>)</span>
<span id="cb118-47"><a href="#cb118-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Created joint model with </span><span class="sc">{</span>joint_graph<span class="sc">.</span>vertices_length()<span class="sc">}</span><span class="ss"> states"</span>)</span>
<span id="cb118-48"><a href="#cb118-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">First few states (rabbits_left, rabbits_right, left_depleted, right_depleted):"</span>)</span>
<span id="cb118-49"><a href="#cb118-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">min</span>(<span class="dv">10</span>, joint_graph.vertices_length())):</span>
<span id="cb118-50"><a href="#cb118-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  State </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>joint_graph<span class="sc">.</span>vertex_at(i)<span class="sc">.</span>state()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Created joint model with 24 states

First few states (rabbits_left, rabbits_right, left_depleted, right_depleted):
  State 0: [0 0 0 0]
  State 1: [3 0 0 0]
  State 2: [2 1 0 0]
  State 3: [0 0 1 0]
  State 4: [1 2 0 0]
  State 5: [0 1 1 0]
  State 6: [3 0 0 1]
  State 7: [2 0 0 1]
  State 8: [0 3 1 0]
  State 9: [0 2 1 0]</code></pre>
</div>
</div>
<p>Now we can use rewards to extract information about the joint distribution. By defining rewards that are non-zero only until each island is depleted, we can compute the marginal time until depletion for each island. By looking at the joint accumulated rewards, we can explore the correlation between these depletion times.</p>
<div id="cell-160" class="cell" data-execution_count="71">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define rewards: earn reward while island is not depleted</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>states <span class="op">=</span> joint_graph.states()</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reward 1: time spent before left depletion (left_depleted == 0)</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>reward_before_left_depletion <span class="op">=</span> (states[:, <span class="dv">2</span>] <span class="op">==</span> <span class="dv">0</span>).astype(<span class="bu">float</span>)</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Reward 2: time spent before right depletion (right_depleted == 0)</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>reward_before_right_depletion <span class="op">=</span> (states[:, <span class="dv">3</span>] <span class="op">==</span> <span class="dv">0</span>).astype(<span class="bu">float</span>)</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute expectations</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>E_time_to_left_depletion <span class="op">=</span> joint_graph.expectation(reward_before_left_depletion)</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>E_time_to_right_depletion <span class="op">=</span> joint_graph.expectation(reward_before_right_depletion)</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Expected time until left island depleted: </span><span class="sc">{</span>E_time_to_left_depletion<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Expected time until right island depleted: </span><span class="sc">{</span>E_time_to_right_depletion<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute covariance between the two times</span></span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>cov <span class="op">=</span> joint_graph.covariance(reward_before_left_depletion, reward_before_right_depletion)</span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a>var_left <span class="op">=</span> joint_graph.variance(reward_before_left_depletion)</span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>var_right <span class="op">=</span> joint_graph.variance(reward_before_right_depletion)</span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>correlation <span class="op">=</span> cov <span class="op">/</span> np.sqrt(var_left <span class="op">*</span> var_right)</span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Covariance between depletion times: </span><span class="sc">{</span>cov<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Correlation: </span><span class="sc">{</span>correlation<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">The positive correlation indicates that when the left island takes longer to deplete,"</span>)</span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"the right island also tends to take longer (rabbits jumping back and forth prolongs both)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Expected time until left island depleted: 0.4836
Expected time until right island depleted: 0.4017

Covariance between depletion times: 0.131722
Correlation: 0.7704

The positive correlation indicates that when the left island takes longer to deplete,
the right island also tends to take longer (rabbits jumping back and forth prolongs both)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO: building reward compute graph...</code></pre>
</div>
</div>
<p>This framework for joint probabilities extends naturally to more complex scenarios. We can model multiple dependent processes, extract conditional distributions, and analyze the dependencies between different random variables in our model. The key is careful state space construction that encodes all relevant information, combined with judicious use of rewards to extract the quantities of interest. In population genetics applications, this approach is used to model the joint distribution of coalescence times across multiple loci or populations, capturing the complex dependencies induced by recombination and migration.</p>
<p>We can increase granularity for better performance:</p>
<div id="cell-163" class="cell" data-execution_count="72">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>np.<span class="bu">sum</span>(graph.accumulated_visiting_time(<span class="fl">0.05</span>, granularity<span class="op">=</span><span class="dv">1000000</span>)<span class="op">*</span>graph.states()[:,<span class="dv">1</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>np.float64(0.0011138317897953385)</code></pre>
</div>
</div>
</section>
</section>
<section id="building-the-state-space-in-c" class="level1">
<h1>Building the state space in C</h1>
<p>Very very large models can be take a long time to construct. So if you have deloped a model that you need to construct repeatedly, the library allow you to implement the state construction as a stand-alone C/C++ extension available as python module.</p>
<p>The C code building the state space for the rabit model looks like this:</p>
<pre class="{c}"><code>ptdalgorithms::Graph build(int starting_rabbits, float flooding_left, float flooding_right) {

    size_t state_size = 2;
    struct ptd_graph *graph = ptd_graph_create(state_size);
    struct ptd_avl_tree *avl_tree = ptd_avl_tree_create(state_size);
    int *initial_state = (int*)calloc(graph-&gt;state_length, sizeof(*initial_state));
    int *child_state = (int*)calloc(graph-&gt;state_length, sizeof(*initial_state));
    initial_state[0] = starting_rabbits;
    ptd_graph_add_edge(
            graph-&gt;starting_vertex,
            ptd_find_or_create_vertex(graph, avl_tree, initial_state),
            1
    );
    for (size_t k = 1; k &lt; graph-&gt;vertices_length; k++) {
        struct ptd_vertex *vertex = graph-&gt;vertices[k];
        int *state = vertex-&gt;state;
        if (state[0] &gt; 0) {
            memcpy(child_state, vertex-&gt;state, graph-&gt;state_length * sizeof(int));
            child_state[0] -= 1;
            child_state[1] += 1;

            ptd_graph_add_edge(
                    vertex,
                    ptd_find_or_create_vertex(graph, avl_tree, child_state),
                    1
            );
            memcpy(child_state, vertex-&gt;state, graph-&gt;state_length * sizeof(int));
            child_state[0] = 0;
            ptd_graph_add_edge(
                    vertex,
                    ptd_find_or_create_vertex(graph, avl_tree, child_state),
                    flooding_left
            );
        }
        if (state[1] &gt; 0) {
            memcpy(child_state, vertex-&gt;state, graph-&gt;state_length * sizeof(int));
            child_state[1] -= 1;
            child_state[0] += 1;
            ptd_graph_add_edge(
                    vertex,
                    ptd_find_or_create_vertex(graph, avl_tree, child_state),
                    1
            );
            memcpy(child_state, vertex-&gt;state, graph-&gt;state_length * sizeof(int));
            child_state[1] = 0;
            ptd_graph_add_edge(
                    vertex,
                    ptd_find_or_create_vertex(graph, avl_tree, child_state),
                    flooding_right
            );
        }
    }
    free(child_state);
    ptdalgorithms::Graph *result = new ptdalgorithms::Graph(graph, avl_tree);
    return *result;
}

To access the function from python, you need to put it a separate file (`rabbit_state_space.cpp`) with the header and footer shown below:

```{c}
#include &lt;pybind11/pybind11.h&gt;
#include &lt;ptdalgorithms.h&gt;
#include "stdint.h"
#include "stdlib.h"

namespace py = pybind11;
using namespace pybind11::literals;
/*******************************************/


/* Your build function goes here */


/********************************************/
PYBIND11_MODULE(rabbit_state_space, m) {     /* &lt;- NB: the model name must match the file name */
     m.def("build", &amp;build);
}

/*
&lt;%
setup_pybind11(cfg)
%&gt;
*/</code></pre>
<p>You can see the complete code in <a href="rabbit_state_space.cpp">rabbit_state_space.cpp</a>.</p>
<p>Then all you need to do is install cppimport</p>
<pre><code>pixi add cppimport</code></pre>
<p>or</p>
<pre><code>pip install cppimport</code></pre>
<p>and then run this code to import your build function.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import ptdalgorithms</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cppimport.import_hook</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rabbit_state_space <span class="co"># this will pause for a moment to compile the module</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then you can use it to construct your graph like this:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> ptd.Graph(rabbit_state_space.build(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">4</span>))</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>graph.plot()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="inference" class="level1">
<h1>Inference</h1>
<section id="bayesian-inference-with-svgd-stein-variational-gradient-descent" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-inference-with-svgd-stein-variational-gradient-descent">Bayesian Inference with SVGD (Stein Variational Gradient Descent)</h2>
<p>Having explored how to construct models, compute their properties, evaluate them efficiently, and scale computations across distributed clusters, we now turn to a fundamental question: given observed data, how do we estimate the parameters of our model? This is the domain of statistical inference. In a Bayesian framework, we seek not just point estimates but entire posterior distributions over parameters, quantifying our uncertainty about parameter values given the data we have observed.</p>
<p>Traditional Markov Chain Monte Carlo (MCMC) methods like Metropolis-Hastings and Hamiltonian Monte Carlo have been the workhorses of Bayesian inference for decades. However, these methods face challenges with high-dimensional parameter spaces, complex posterior geometries, and the need for many sequential samples to achieve convergence. Stein Variational Gradient Descent (SVGD) offers a compelling alternative. Instead of generating samples sequentially through a Markov chain, SVGD represents the posterior with a set of particles (parameter vectors) and updates these particles iteratively to move them toward the posterior distribution. The method combines ideas from optimization, kernel methods, and functional analysis to create a deterministic algorithm that is highly parallelizable and works well in high dimensions.</p>
<p>The key insight of SVGD is to treat inference as an optimization problem in the space of probability distributions. We start with an initial set of particles (typically drawn from the prior or from a simple distribution) and iteratively transport these particles toward the posterior using gradient information. Each particle interacts with all other particles through a kernel function, with the interaction strength depending on the distance between particles. This interaction ensures that particles spread out to cover the posterior distribution rather than collapsing to a single mode. The updates use gradients of the log-likelihood and log-prior, which we can compute efficiently using JAX’s automatic differentiation.</p>
<p>For our rabbit model, imagine we have observed data: the time until all rabbits died. Based on this observation, we want to estimate the three parameters of our model—jump rate, left flooding rate, and right flooding rate—along with quantifying our uncertainty about these parameters. We will set up a likelihood function, specify a prior distribution, and use SVGD to approximate the posterior distribution with a set of particles. This workflow showcases the entire pipeline: model construction, JAX integration, gradient-based inference, and (optionally) distributed computing. Now we need to define our inference problem in terms of a log-posterior function. According to Bayes’ theorem, the posterior is proportional to the likelihood times the prior: p(θ|data) ∝ p(data|θ) × p(θ). Taking logarithms gives us log p(θ|data) = log p(data|θ) + log p(θ) + constant. The SVGD algorithm requires us to provide a function that computes this log-posterior (up to an additive constant, which doesn’t affect gradients).</p>
<p>For the likelihood, we use the probability density function of our phase-type distribution evaluated at the observed times. For the prior, we will use independent log-normal distributions for each parameter, reflecting our prior belief that parameters are positive with uncertainty spanning orders of magnitude.</p>
<div id="cell-176" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the rabbit model with parameterized rates</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> jnp</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ptdalgorithms <span class="im">import</span> Graph</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create parameterized rabbit model</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters: [jump_rate, left_flood_rate, right_flood_rate]</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_rabbit_model():</span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>    graph <span class="op">=</span> Graph(state_length<span class="op">=</span><span class="dv">3</span>)  <span class="co"># [left_rabbits, right_rabbits, flooding_started]</span></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Starting state: 2 rabbits on left, 2 on right, no flooding</span></span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> graph.starting_vertex()</span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Helper to get/create vertex</span></span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_vertex(left, right, flooded):</span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> graph.find_or_create_vertex([left, right, flooded])</span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build state space</span></span>
<span id="cb130-20"><a href="#cb130-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> flooded <span class="kw">in</span> [<span class="dv">0</span>, <span class="dv">1</span>]:</span>
<span id="cb130-21"><a href="#cb130-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> left <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb130-22"><a href="#cb130-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> right <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb130-23"><a href="#cb130-23" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> left <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> right <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb130-24"><a href="#cb130-24" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span>  <span class="co"># Absorbing state</span></span>
<span id="cb130-25"><a href="#cb130-25" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb130-26"><a href="#cb130-26" aria-hidden="true" tabindex="-1"></a>                v <span class="op">=</span> get_vertex(left, right, flooded)</span>
<span id="cb130-27"><a href="#cb130-27" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb130-28"><a href="#cb130-28" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Jump transitions (param 0: jump_rate)</span></span>
<span id="cb130-29"><a href="#cb130-29" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> left <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> right <span class="op">&lt;</span> <span class="dv">4</span>:</span>
<span id="cb130-30"><a href="#cb130-30" aria-hidden="true" tabindex="-1"></a>                    v_next <span class="op">=</span> get_vertex(left <span class="op">-</span> <span class="dv">1</span>, right <span class="op">+</span> <span class="dv">1</span>, flooded)</span>
<span id="cb130-31"><a href="#cb130-31" aria-hidden="true" tabindex="-1"></a>                    v.add_edge_parameterized(v_next, <span class="fl">0.0</span>, [<span class="fl">1.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>])  <span class="co"># θ[0]</span></span>
<span id="cb130-32"><a href="#cb130-32" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb130-33"><a href="#cb130-33" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> right <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> left <span class="op">&lt;</span> <span class="dv">4</span>:</span>
<span id="cb130-34"><a href="#cb130-34" aria-hidden="true" tabindex="-1"></a>                    v_next <span class="op">=</span> get_vertex(left <span class="op">+</span> <span class="dv">1</span>, right <span class="op">-</span> <span class="dv">1</span>, flooded)</span>
<span id="cb130-35"><a href="#cb130-35" aria-hidden="true" tabindex="-1"></a>                    v.add_edge_parameterized(v_next, <span class="fl">0.0</span>, [<span class="fl">1.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>])  <span class="co"># θ[0]</span></span>
<span id="cb130-36"><a href="#cb130-36" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb130-37"><a href="#cb130-37" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Flooding transitions</span></span>
<span id="cb130-38"><a href="#cb130-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> flooded <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb130-39"><a href="#cb130-39" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Pre-flooding: can trigger flooding (constant rate)</span></span>
<span id="cb130-40"><a href="#cb130-40" aria-hidden="true" tabindex="-1"></a>                    v_flooded <span class="op">=</span> get_vertex(left, right, <span class="dv">1</span>)</span>
<span id="cb130-41"><a href="#cb130-41" aria-hidden="true" tabindex="-1"></a>                    v.add_edge(v_flooded, <span class="fl">1.0</span>)  <span class="co"># Constant rate</span></span>
<span id="cb130-42"><a href="#cb130-42" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb130-43"><a href="#cb130-43" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Post-flooding: death by drowning</span></span>
<span id="cb130-44"><a href="#cb130-44" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> left <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb130-45"><a href="#cb130-45" aria-hidden="true" tabindex="-1"></a>                        v_next <span class="op">=</span> get_vertex(left <span class="op">-</span> <span class="dv">1</span>, right, <span class="dv">1</span>)</span>
<span id="cb130-46"><a href="#cb130-46" aria-hidden="true" tabindex="-1"></a>                        v.add_edge_parameterized(v_next, <span class="fl">0.0</span>, [<span class="fl">0.0</span>, <span class="bu">float</span>(left), <span class="fl">0.0</span>])  <span class="co"># left*θ[1]</span></span>
<span id="cb130-47"><a href="#cb130-47" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb130-48"><a href="#cb130-48" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> right <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb130-49"><a href="#cb130-49" aria-hidden="true" tabindex="-1"></a>                        v_next <span class="op">=</span> get_vertex(left, right <span class="op">-</span> <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb130-50"><a href="#cb130-50" aria-hidden="true" tabindex="-1"></a>                        v.add_edge_parameterized(v_next, <span class="fl">0.0</span>, [<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="bu">float</span>(right)])  <span class="co"># right*θ[2]</span></span>
<span id="cb130-51"><a href="#cb130-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-52"><a href="#cb130-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Built rabbit model with </span><span class="sc">{</span><span class="bu">len</span>(graph.vertices())<span class="sc">}</span><span class="ss"> vertices"</span>)</span>
<span id="cb130-53"><a href="#cb130-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> graph</span>
<span id="cb130-54"><a href="#cb130-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-55"><a href="#cb130-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb130-56"><a href="#cb130-56" aria-hidden="true" tabindex="-1"></a>rabbit_model <span class="op">=</span> build_rabbit_model()</span>
<span id="cb130-57"><a href="#cb130-57" aria-hidden="true" tabindex="-1"></a>rabbit_model.svgd( [[<span class="dv">2</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">2</span>]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Built rabbit model with 50 vertices</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">TypeError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[77]</span><span class="ansi-green-fg">, line 57</span>
<span class="ansi-green-fg">     55</span> <span style="font-style:italic;color:rgb(95,135,135)"># Build the model</span>
<span class="ansi-green-fg">     56</span> rabbit_model = build_rabbit_model()
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">57</span> <span class="ansi-yellow-bg">rabbit_model</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">svgd</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">TypeError</span>: Graph.svgd() missing 2 required positional arguments: 'model' and 'observed_data'</pre>
</div>
</div>
</div>
<div id="cell-177" class="cell" data-execution_count="70">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate synthetic observed data</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="co"># True parameters: jump_rate=1.0, left_flood=0.5, right_flood=0.3</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>true_params <span class="op">=</span> np.array([<span class="fl">1.0</span>, <span class="fl">0.5</span>, <span class="fl">0.3</span>])</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate from the model (using true parameters)</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a><span class="co"># For this tutorial, we'll use pre-generated observations</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>observed_times <span class="op">=</span> np.array([<span class="fl">2.1</span>, <span class="fl">3.5</span>, <span class="fl">1.8</span>, <span class="fl">4.2</span>, <span class="fl">2.9</span>])  <span class="co"># Times until extinction</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Observed extinction times: </span><span class="sc">{</span>observed_times<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"True parameters: jump=</span><span class="sc">{</span>true_params[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">, left_flood=</span><span class="sc">{</span>true_params[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">, right_flood=</span><span class="sc">{</span>true_params[<span class="dv">2</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Observed extinction times: [2.1 3.5 1.8 4.2 2.9]
True parameters: jump=1.0, left_flood=0.5, right_flood=0.3</code></pre>
</div>
</div>
<div id="cell-178" class="cell" data-execution_count="71">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Save and load model structure for distribution</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Get model structure (serialize returns a dict)</span></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>model_data <span class="op">=</span> rabbit_model.serialize()</span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert numpy arrays to lists for JSON serialization</span></span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_json_serializable(obj):</span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(obj, np.ndarray):</span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> obj.tolist()</span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(obj, <span class="bu">dict</span>):</span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {k: make_json_serializable(v) <span class="cf">for</span> k, v <span class="kw">in</span> obj.items()}</span>
<span id="cb134-15"><a href="#cb134-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(obj, <span class="bu">list</span>):</span>
<span id="cb134-16"><a href="#cb134-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [make_json_serializable(item) <span class="cf">for</span> item <span class="kw">in</span> obj]</span>
<span id="cb134-17"><a href="#cb134-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb134-18"><a href="#cb134-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> obj</span>
<span id="cb134-19"><a href="#cb134-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-20"><a href="#cb134-20" aria-hidden="true" tabindex="-1"></a>model_json <span class="op">=</span> make_json_serializable(model_data)</span>
<span id="cb134-21"><a href="#cb134-21" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> Path(<span class="st">"rabbit_model_structure.json"</span>)</span>
<span id="cb134-22"><a href="#cb134-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-23"><a href="#cb134-23" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(output_path, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb134-24"><a href="#cb134-24" aria-hidden="true" tabindex="-1"></a>    json.dump(model_json, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb134-25"><a href="#cb134-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-26"><a href="#cb134-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Model structure saved to: </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb134-27"><a href="#cb134-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"File size: </span><span class="sc">{</span>output_path<span class="sc">.</span>stat()<span class="sc">.</span>st_size <span class="op">/</span> <span class="dv">1024</span><span class="sc">:.1f}</span><span class="ss"> KB"</span>)</span>
<span id="cb134-28"><a href="#cb134-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-29"><a href="#cb134-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Model can be version-controlled and shared via:"</span>)</span>
<span id="cb134-30"><a href="#cb134-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Git repository (JSON structure)"</span>)</span>
<span id="cb134-31"><a href="#cb134-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Shared file system (cache files)"</span>)</span>
<span id="cb134-32"><a href="#cb134-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Package distribution (bundled cache)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Recording elimination trace...
  Trace recorded: 50 vertices, 5474 operations</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ERROR:2025-10-15 20:34:10,924:jax._src.callback:94: jax.pure_callback failed
Traceback (most recent call last):
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/callback.py", line 92, in pure_callback_impl
    return tree_util.tree_map(np.asarray, callback(*args))
                                          ~~~~~~~~^^^^^^^
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/callback.py", line 70, in __call__
    return tree_util.tree_leaves(self.callback_func(*args, **kwargs))
                                 ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/Users/kmt/PtDAlgorithms/src/ptdalgorithms/ffi_wrappers.py", line 175, in &lt;lambda&gt;
    lambda theta_jax, times_jax: _compute_pmf_impl(
                                 ~~~~~~~~~~~~~~~~~^
        structure_json,
        ^^^^^^^^^^^^^^^
    ...&lt;3 lines&gt;...
        granularity
        ^^^^^^^^^^^
    ),
    ^
  File "/Users/kmt/PtDAlgorithms/src/ptdalgorithms/ffi_wrappers.py", line 136, in _compute_pmf_impl
    builder = cpp_module.parameterized.GraphBuilder(structure_json)
TypeError: __init__(): incompatible constructor arguments. The following argument types are supported:
    1. ptdalgorithms.ptdalgorithmscpp_pybind.parameterized.GraphBuilder(structure_json: str)

Invoked with: {'states': array([[0, 0, 0],
       [0, 1, 0],
       [1, 0, 0],
       [0, 1, 1],
       [0, 2, 0],
       [1, 1, 0],
       [0, 2, 1],
       [0, 3, 0],
       [1, 2, 0],
       [0, 3, 1],
       [0, 4, 0],
       [1, 3, 0],
       [0, 4, 1],
       [1, 0, 1],
       [2, 0, 0],
       [1, 1, 1],
       [2, 1, 0],
       [1, 2, 1],
       [2, 2, 0],
       [1, 3, 1],
       [1, 4, 0],
       [2, 3, 0],
       [1, 4, 1],
       [2, 0, 1],
       [3, 0, 0],
       [2, 1, 1],
       [3, 1, 0],
       [2, 2, 1],
       [3, 2, 0],
       [2, 3, 1],
       [2, 4, 0],
       [3, 3, 0],
       [2, 4, 1],
       [3, 0, 1],
       [4, 0, 0],
       [3, 1, 1],
       [4, 1, 0],
       [3, 2, 1],
       [4, 2, 0],
       [3, 3, 1],
       [3, 4, 0],
       [4, 3, 0],
       [3, 4, 1],
       [4, 0, 1],
       [4, 1, 1],
       [4, 2, 1],
       [4, 3, 1],
       [4, 4, 0],
       [4, 4, 1],
       [0, 0, 1]], dtype=int32), 'edges': array([[ 1.,  2.,  0.],
       [ 1.,  3.,  1.],
       [ 2.,  1.,  0.],
       [ 2., 13.,  1.],
       [ 3., 13.,  0.],
       [ 3., 49.,  0.],
       [ 4.,  5.,  0.],
       [ 4.,  6.,  1.],
       [ 5.,  4.,  0.],
       [ 5., 14.,  0.],
       [ 5., 15.,  1.],
       [ 6., 15.,  0.],
       [ 6.,  3.,  0.],
       [ 7.,  8.,  0.],
       [ 7.,  9.,  1.],
       [ 8.,  7.,  0.],
       [ 8., 16.,  0.],
       [ 8., 17.,  1.],
       [ 9., 17.,  0.],
       [ 9.,  6.,  0.],
       [10., 11.,  0.],
       [10., 12.,  1.],
       [11., 10.,  0.],
       [11., 18.,  0.],
       [11., 19.,  1.],
       [12., 19.,  0.],
       [12.,  9.,  0.],
       [13.,  3.,  0.],
       [13., 49.,  0.],
       [14.,  5.,  0.],
       [14., 23.,  1.],
       [15.,  6.,  0.],
       [15., 23.,  0.],
       [15.,  3.,  0.],
       [15., 13.,  0.],
       [16.,  8.,  0.],
       [16., 24.,  0.],
       [16., 25.,  1.],
       [17.,  9.,  0.],
       [17., 25.,  0.],
       [17.,  6.,  0.],
       [17., 15.,  0.],
       [18., 11.,  0.],
       [18., 26.,  0.],
       [18., 27.,  1.],
       [19., 12.,  0.],
       [19., 27.,  0.],
       [19.,  9.,  0.],
       [19., 17.,  0.],
       [20., 21.,  0.],
       [20., 22.,  1.],
       [21., 20.,  0.],
       [21., 28.,  0.],
       [21., 29.,  1.],
       [22., 29.,  0.],
       [22., 12.,  0.],
       [22., 19.,  0.],
       [23., 15.,  0.],
       [23., 13.,  0.],
       [24., 16.,  0.],
       [24., 33.,  1.],
       [25., 17.,  0.],
       [25., 33.,  0.],
       [25., 15.,  0.],
       [25., 23.,  0.],
       [26., 18.,  0.],
       [26., 34.,  0.],
       [26., 35.,  1.],
       [27., 19.,  0.],
       [27., 35.,  0.],
       [27., 17.,  0.],
       [27., 25.,  0.],
       [28., 21.,  0.],
       [28., 36.,  0.],
       [28., 37.,  1.],
       [29., 22.,  0.],
       [29., 37.,  0.],
       [29., 19.,  0.],
       [29., 27.,  0.],
       [30., 31.,  0.],
       [30., 32.,  1.],
       [31., 30.,  0.],
       [31., 38.,  0.],
       [31., 39.,  1.],
       [32., 39.,  0.],
       [32., 22.,  0.],
       [32., 29.,  0.],
       [33., 25.,  0.],
       [33., 23.,  0.],
       [34., 26.,  0.],
       [34., 43.,  1.],
       [35., 27.,  0.],
       [35., 43.,  0.],
       [35., 25.,  0.],
       [35., 33.,  0.],
       [36., 28.,  0.],
       [36., 44.,  1.],
       [37., 29.,  0.],
       [37., 44.,  0.],
       [37., 27.,  0.],
       [37., 35.,  0.],
       [38., 31.,  0.],
       [38., 45.,  1.],
       [39., 32.,  0.],
       [39., 45.,  0.],
       [39., 29.,  0.],
       [39., 37.,  0.],
       [40., 41.,  0.],
       [40., 42.,  1.],
       [41., 40.,  0.],
       [41., 46.,  1.],
       [42., 46.,  0.],
       [42., 32.,  0.],
       [42., 39.,  0.],
       [43., 35.,  0.],
       [43., 33.,  0.],
       [44., 37.,  0.],
       [44., 35.,  0.],
       [44., 43.,  0.],
       [45., 39.,  0.],
       [45., 37.,  0.],
       [45., 44.,  0.],
       [46., 42.,  0.],
       [46., 39.,  0.],
       [46., 45.,  0.],
       [47., 48.,  1.],
       [48., 42.,  0.],
       [48., 46.,  0.]]), 'start_edges': array([], shape=(0, 2), dtype=float64), 'param_edges': array([[ 1.,  2.,  1.,  0.,  0.,  0.],
       [ 2.,  1.,  1.,  0.,  0.,  0.],
       [ 3., 13.,  1.,  0.,  0.,  0.],
       [ 3., 49.,  0.,  0.,  1.,  0.],
       [ 4.,  5.,  1.,  0.,  0.,  0.],
       [ 5.,  4.,  1.,  0.,  0.,  0.],
       [ 5., 14.,  1.,  0.,  0.,  0.],
       [ 6., 15.,  1.,  0.,  0.,  0.],
       [ 6.,  3.,  0.,  0.,  2.,  0.],
       [ 7.,  8.,  1.,  0.,  0.,  0.],
       [ 8.,  7.,  1.,  0.,  0.,  0.],
       [ 8., 16.,  1.,  0.,  0.,  0.],
       [ 9., 17.,  1.,  0.,  0.,  0.],
       [ 9.,  6.,  0.,  0.,  3.,  0.],
       [10., 11.,  1.,  0.,  0.,  0.],
       [11., 10.,  1.,  0.,  0.,  0.],
       [11., 18.,  1.,  0.,  0.,  0.],
       [12., 19.,  1.,  0.,  0.,  0.],
       [12.,  9.,  0.,  0.,  4.,  0.],
       [13.,  3.,  1.,  0.,  0.,  0.],
       [13., 49.,  0.,  1.,  0.,  0.],
       [14.,  5.,  1.,  0.,  0.,  0.],
       [15.,  6.,  1.,  0.,  0.,  0.],
       [15., 23.,  1.,  0.,  0.,  0.],
       [15.,  3.,  0.,  1.,  0.,  0.],
       [15., 13.,  0.,  0.,  1.,  0.],
       [16.,  8.,  1.,  0.,  0.,  0.],
       [16., 24.,  1.,  0.,  0.,  0.],
       [17.,  9.,  1.,  0.,  0.,  0.],
       [17., 25.,  1.,  0.,  0.,  0.],
       [17.,  6.,  0.,  1.,  0.,  0.],
       [17., 15.,  0.,  0.,  2.,  0.],
       [18., 11.,  1.,  0.,  0.,  0.],
       [18., 26.,  1.,  0.,  0.,  0.],
       [19., 12.,  1.,  0.,  0.,  0.],
       [19., 27.,  1.,  0.,  0.,  0.],
       [19.,  9.,  0.,  1.,  0.,  0.],
       [19., 17.,  0.,  0.,  3.,  0.],
       [20., 21.,  1.,  0.,  0.,  0.],
       [21., 20.,  1.,  0.,  0.,  0.],
       [21., 28.,  1.,  0.,  0.,  0.],
       [22., 29.,  1.,  0.,  0.,  0.],
       [22., 12.,  0.,  1.,  0.,  0.],
       [22., 19.,  0.,  0.,  4.,  0.],
       [23., 15.,  1.,  0.,  0.,  0.],
       [23., 13.,  0.,  2.,  0.,  0.],
       [24., 16.,  1.,  0.,  0.,  0.],
       [25., 17.,  1.,  0.,  0.,  0.],
       [25., 33.,  1.,  0.,  0.,  0.],
       [25., 15.,  0.,  2.,  0.,  0.],
       [25., 23.,  0.,  0.,  1.,  0.],
       [26., 18.,  1.,  0.,  0.,  0.],
       [26., 34.,  1.,  0.,  0.,  0.],
       [27., 19.,  1.,  0.,  0.,  0.],
       [27., 35.,  1.,  0.,  0.,  0.],
       [27., 17.,  0.,  2.,  0.,  0.],
       [27., 25.,  0.,  0.,  2.,  0.],
       [28., 21.,  1.,  0.,  0.,  0.],
       [28., 36.,  1.,  0.,  0.,  0.],
       [29., 22.,  1.,  0.,  0.,  0.],
       [29., 37.,  1.,  0.,  0.,  0.],
       [29., 19.,  0.,  2.,  0.,  0.],
       [29., 27.,  0.,  0.,  3.,  0.],
       [30., 31.,  1.,  0.,  0.,  0.],
       [31., 30.,  1.,  0.,  0.,  0.],
       [31., 38.,  1.,  0.,  0.,  0.],
       [32., 39.,  1.,  0.,  0.,  0.],
       [32., 22.,  0.,  2.,  0.,  0.],
       [32., 29.,  0.,  0.,  4.,  0.],
       [33., 25.,  1.,  0.,  0.,  0.],
       [33., 23.,  0.,  3.,  0.,  0.],
       [34., 26.,  1.,  0.,  0.,  0.],
       [35., 27.,  1.,  0.,  0.,  0.],
       [35., 43.,  1.,  0.,  0.,  0.],
       [35., 25.,  0.,  3.,  0.,  0.],
       [35., 33.,  0.,  0.,  1.,  0.],
       [36., 28.,  1.,  0.,  0.,  0.],
       [37., 29.,  1.,  0.,  0.,  0.],
       [37., 44.,  1.,  0.,  0.,  0.],
       [37., 27.,  0.,  3.,  0.,  0.],
       [37., 35.,  0.,  0.,  2.,  0.],
       [38., 31.,  1.,  0.,  0.,  0.],
       [39., 32.,  1.,  0.,  0.,  0.],
       [39., 45.,  1.,  0.,  0.,  0.],
       [39., 29.,  0.,  3.,  0.,  0.],
       [39., 37.,  0.,  0.,  3.,  0.],
       [40., 41.,  1.,  0.,  0.,  0.],
       [41., 40.,  1.,  0.,  0.,  0.],
       [42., 46.,  1.,  0.,  0.,  0.],
       [42., 32.,  0.,  3.,  0.,  0.],
       [42., 39.,  0.,  0.,  4.,  0.],
       [43., 35.,  1.,  0.,  0.,  0.],
       [43., 33.,  0.,  4.,  0.,  0.],
       [44., 37.,  1.,  0.,  0.,  0.],
       [44., 35.,  0.,  4.,  0.,  0.],
       [44., 43.,  0.,  0.,  1.,  0.],
       [45., 39.,  1.,  0.,  0.,  0.],
       [45., 37.,  0.,  4.,  0.,  0.],
       [45., 44.,  0.,  0.,  2.,  0.],
       [46., 42.,  1.,  0.,  0.,  0.],
       [46., 39.,  0.,  4.,  0.,  0.],
       [46., 45.,  0.,  0.,  3.,  0.],
       [48., 42.,  0.,  4.,  0.,  0.],
       [48., 46.,  0.,  0.,  4.,  0.]]), 'start_param_edges': array([], shape=(0, 5), dtype=float64), 'param_length': 4, 'state_length': 3, 'n_vertices': 50}
[ERROR] jax.pure_callback failed
Traceback (most recent call last):
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/callback.py", line 92, in pure_callback_impl
    return tree_util.tree_map(np.asarray, callback(*args))
                                          ~~~~~~~~^^^^^^^
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/callback.py", line 70, in __call__
    return tree_util.tree_leaves(self.callback_func(*args, **kwargs))
                                 ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/Users/kmt/PtDAlgorithms/src/ptdalgorithms/ffi_wrappers.py", line 175, in &lt;lambda&gt;
    lambda theta_jax, times_jax: _compute_pmf_impl(
                                 ~~~~~~~~~~~~~~~~~^
        structure_json,
        ^^^^^^^^^^^^^^^
    ...&lt;3 lines&gt;...
        granularity
        ^^^^^^^^^^^
    ),
    ^
  File "/Users/kmt/PtDAlgorithms/src/ptdalgorithms/ffi_wrappers.py", line 136, in _compute_pmf_impl
    builder = cpp_module.parameterized.GraphBuilder(structure_json)
TypeError: __init__(): incompatible constructor arguments. The following argument types are supported:
    1. ptdalgorithms.ptdalgorithmscpp_pybind.parameterized.GraphBuilder(structure_json: str)

Invoked with: {'states': array([[0, 0, 0],
       [0, 1, 0],
       [1, 0, 0],
       [0, 1, 1],
       [0, 2, 0],
       [1, 1, 0],
       [0, 2, 1],
       [0, 3, 0],
       [1, 2, 0],
       [0, 3, 1],
       [0, 4, 0],
       [1, 3, 0],
       [0, 4, 1],
       [1, 0, 1],
       [2, 0, 0],
       [1, 1, 1],
       [2, 1, 0],
       [1, 2, 1],
       [2, 2, 0],
       [1, 3, 1],
       [1, 4, 0],
       [2, 3, 0],
       [1, 4, 1],
       [2, 0, 1],
       [3, 0, 0],
       [2, 1, 1],
       [3, 1, 0],
       [2, 2, 1],
       [3, 2, 0],
       [2, 3, 1],
       [2, 4, 0],
       [3, 3, 0],
       [2, 4, 1],
       [3, 0, 1],
       [4, 0, 0],
       [3, 1, 1],
       [4, 1, 0],
       [3, 2, 1],
       [4, 2, 0],
       [3, 3, 1],
       [3, 4, 0],
       [4, 3, 0],
       [3, 4, 1],
       [4, 0, 1],
       [4, 1, 1],
       [4, 2, 1],
       [4, 3, 1],
       [4, 4, 0],
       [4, 4, 1],
       [0, 0, 1]], dtype=int32), 'edges': array([[ 1.,  2.,  0.],
       [ 1.,  3.,  1.],
       [ 2.,  1.,  0.],
       [ 2., 13.,  1.],
       [ 3., 13.,  0.],
       [ 3., 49.,  0.],
       [ 4.,  5.,  0.],
       [ 4.,  6.,  1.],
       [ 5.,  4.,  0.],
       [ 5., 14.,  0.],
       [ 5., 15.,  1.],
       [ 6., 15.,  0.],
       [ 6.,  3.,  0.],
       [ 7.,  8.,  0.],
       [ 7.,  9.,  1.],
       [ 8.,  7.,  0.],
       [ 8., 16.,  0.],
       [ 8., 17.,  1.],
       [ 9., 17.,  0.],
       [ 9.,  6.,  0.],
       [10., 11.,  0.],
       [10., 12.,  1.],
       [11., 10.,  0.],
       [11., 18.,  0.],
       [11., 19.,  1.],
       [12., 19.,  0.],
       [12.,  9.,  0.],
       [13.,  3.,  0.],
       [13., 49.,  0.],
       [14.,  5.,  0.],
       [14., 23.,  1.],
       [15.,  6.,  0.],
       [15., 23.,  0.],
       [15.,  3.,  0.],
       [15., 13.,  0.],
       [16.,  8.,  0.],
       [16., 24.,  0.],
       [16., 25.,  1.],
       [17.,  9.,  0.],
       [17., 25.,  0.],
       [17.,  6.,  0.],
       [17., 15.,  0.],
       [18., 11.,  0.],
       [18., 26.,  0.],
       [18., 27.,  1.],
       [19., 12.,  0.],
       [19., 27.,  0.],
       [19.,  9.,  0.],
       [19., 17.,  0.],
       [20., 21.,  0.],
       [20., 22.,  1.],
       [21., 20.,  0.],
       [21., 28.,  0.],
       [21., 29.,  1.],
       [22., 29.,  0.],
       [22., 12.,  0.],
       [22., 19.,  0.],
       [23., 15.,  0.],
       [23., 13.,  0.],
       [24., 16.,  0.],
       [24., 33.,  1.],
       [25., 17.,  0.],
       [25., 33.,  0.],
       [25., 15.,  0.],
       [25., 23.,  0.],
       [26., 18.,  0.],
       [26., 34.,  0.],
       [26., 35.,  1.],
       [27., 19.,  0.],
       [27., 35.,  0.],
       [27., 17.,  0.],
       [27., 25.,  0.],
       [28., 21.,  0.],
       [28., 36.,  0.],
       [28., 37.,  1.],
       [29., 22.,  0.],
       [29., 37.,  0.],
       [29., 19.,  0.],
       [29., 27.,  0.],
       [30., 31.,  0.],
       [30., 32.,  1.],
       [31., 30.,  0.],
       [31., 38.,  0.],
       [31., 39.,  1.],
       [32., 39.,  0.],
       [32., 22.,  0.],
       [32., 29.,  0.],
       [33., 25.,  0.],
       [33., 23.,  0.],
       [34., 26.,  0.],
       [34., 43.,  1.],
       [35., 27.,  0.],
       [35., 43.,  0.],
       [35., 25.,  0.],
       [35., 33.,  0.],
       [36., 28.,  0.],
       [36., 44.,  1.],
       [37., 29.,  0.],
       [37., 44.,  0.],
       [37., 27.,  0.],
       [37., 35.,  0.],
       [38., 31.,  0.],
       [38., 45.,  1.],
       [39., 32.,  0.],
       [39., 45.,  0.],
       [39., 29.,  0.],
       [39., 37.,  0.],
       [40., 41.,  0.],
       [40., 42.,  1.],
       [41., 40.,  0.],
       [41., 46.,  1.],
       [42., 46.,  0.],
       [42., 32.,  0.],
       [42., 39.,  0.],
       [43., 35.,  0.],
       [43., 33.,  0.],
       [44., 37.,  0.],
       [44., 35.,  0.],
       [44., 43.,  0.],
       [45., 39.,  0.],
       [45., 37.,  0.],
       [45., 44.,  0.],
       [46., 42.,  0.],
       [46., 39.,  0.],
       [46., 45.,  0.],
       [47., 48.,  1.],
       [48., 42.,  0.],
       [48., 46.,  0.]]), 'start_edges': array([], shape=(0, 2), dtype=float64), 'param_edges': array([[ 1.,  2.,  1.,  0.,  0.,  0.],
       [ 2.,  1.,  1.,  0.,  0.,  0.],
       [ 3., 13.,  1.,  0.,  0.,  0.],
       [ 3., 49.,  0.,  0.,  1.,  0.],
       [ 4.,  5.,  1.,  0.,  0.,  0.],
       [ 5.,  4.,  1.,  0.,  0.,  0.],
       [ 5., 14.,  1.,  0.,  0.,  0.],
       [ 6., 15.,  1.,  0.,  0.,  0.],
       [ 6.,  3.,  0.,  0.,  2.,  0.],
       [ 7.,  8.,  1.,  0.,  0.,  0.],
       [ 8.,  7.,  1.,  0.,  0.,  0.],
       [ 8., 16.,  1.,  0.,  0.,  0.],
       [ 9., 17.,  1.,  0.,  0.,  0.],
       [ 9.,  6.,  0.,  0.,  3.,  0.],
       [10., 11.,  1.,  0.,  0.,  0.],
       [11., 10.,  1.,  0.,  0.,  0.],
       [11., 18.,  1.,  0.,  0.,  0.],
       [12., 19.,  1.,  0.,  0.,  0.],
       [12.,  9.,  0.,  0.,  4.,  0.],
       [13.,  3.,  1.,  0.,  0.,  0.],
       [13., 49.,  0.,  1.,  0.,  0.],
       [14.,  5.,  1.,  0.,  0.,  0.],
       [15.,  6.,  1.,  0.,  0.,  0.],
       [15., 23.,  1.,  0.,  0.,  0.],
       [15.,  3.,  0.,  1.,  0.,  0.],
       [15., 13.,  0.,  0.,  1.,  0.],
       [16.,  8.,  1.,  0.,  0.,  0.],
       [16., 24.,  1.,  0.,  0.,  0.],
       [17.,  9.,  1.,  0.,  0.,  0.],
       [17., 25.,  1.,  0.,  0.,  0.],
       [17.,  6.,  0.,  1.,  0.,  0.],
       [17., 15.,  0.,  0.,  2.,  0.],
       [18., 11.,  1.,  0.,  0.,  0.],
       [18., 26.,  1.,  0.,  0.,  0.],
       [19., 12.,  1.,  0.,  0.,  0.],
       [19., 27.,  1.,  0.,  0.,  0.],
       [19.,  9.,  0.,  1.,  0.,  0.],
       [19., 17.,  0.,  0.,  3.,  0.],
       [20., 21.,  1.,  0.,  0.,  0.],
       [21., 20.,  1.,  0.,  0.,  0.],
       [21., 28.,  1.,  0.,  0.,  0.],
       [22., 29.,  1.,  0.,  0.,  0.],
       [22., 12.,  0.,  1.,  0.,  0.],
       [22., 19.,  0.,  0.,  4.,  0.],
       [23., 15.,  1.,  0.,  0.,  0.],
       [23., 13.,  0.,  2.,  0.,  0.],
       [24., 16.,  1.,  0.,  0.,  0.],
       [25., 17.,  1.,  0.,  0.,  0.],
       [25., 33.,  1.,  0.,  0.,  0.],
       [25., 15.,  0.,  2.,  0.,  0.],
       [25., 23.,  0.,  0.,  1.,  0.],
       [26., 18.,  1.,  0.,  0.,  0.],
       [26., 34.,  1.,  0.,  0.,  0.],
       [27., 19.,  1.,  0.,  0.,  0.],
       [27., 35.,  1.,  0.,  0.,  0.],
       [27., 17.,  0.,  2.,  0.,  0.],
       [27., 25.,  0.,  0.,  2.,  0.],
       [28., 21.,  1.,  0.,  0.,  0.],
       [28., 36.,  1.,  0.,  0.,  0.],
       [29., 22.,  1.,  0.,  0.,  0.],
       [29., 37.,  1.,  0.,  0.,  0.],
       [29., 19.,  0.,  2.,  0.,  0.],
       [29., 27.,  0.,  0.,  3.,  0.],
       [30., 31.,  1.,  0.,  0.,  0.],
       [31., 30.,  1.,  0.,  0.,  0.],
       [31., 38.,  1.,  0.,  0.,  0.],
       [32., 39.,  1.,  0.,  0.,  0.],
       [32., 22.,  0.,  2.,  0.,  0.],
       [32., 29.,  0.,  0.,  4.,  0.],
       [33., 25.,  1.,  0.,  0.,  0.],
       [33., 23.,  0.,  3.,  0.,  0.],
       [34., 26.,  1.,  0.,  0.,  0.],
       [35., 27.,  1.,  0.,  0.,  0.],
       [35., 43.,  1.,  0.,  0.,  0.],
       [35., 25.,  0.,  3.,  0.,  0.],
       [35., 33.,  0.,  0.,  1.,  0.],
       [36., 28.,  1.,  0.,  0.,  0.],
       [37., 29.,  1.,  0.,  0.,  0.],
       [37., 44.,  1.,  0.,  0.,  0.],
       [37., 27.,  0.,  3.,  0.,  0.],
       [37., 35.,  0.,  0.,  2.,  0.],
       [38., 31.,  1.,  0.,  0.,  0.],
       [39., 32.,  1.,  0.,  0.,  0.],
       [39., 45.,  1.,  0.,  0.,  0.],
       [39., 29.,  0.,  3.,  0.,  0.],
       [39., 37.,  0.,  0.,  3.,  0.],
       [40., 41.,  1.,  0.,  0.,  0.],
       [41., 40.,  1.,  0.,  0.,  0.],
       [42., 46.,  1.,  0.,  0.,  0.],
       [42., 32.,  0.,  3.,  0.,  0.],
       [42., 39.,  0.,  0.,  4.,  0.],
       [43., 35.,  1.,  0.,  0.,  0.],
       [43., 33.,  0.,  4.,  0.,  0.],
       [44., 37.,  1.,  0.,  0.,  0.],
       [44., 35.,  0.,  4.,  0.,  0.],
       [44., 43.,  0.,  0.,  1.,  0.],
       [45., 39.,  1.,  0.,  0.,  0.],
       [45., 37.,  0.,  4.,  0.,  0.],
       [45., 44.,  0.,  0.,  2.,  0.],
       [46., 42.,  1.,  0.,  0.,  0.],
       [46., 39.,  0.,  4.,  0.,  0.],
       [46., 45.,  0.,  0.,  3.,  0.],
       [48., 42.,  0.,  4.,  0.,  0.],
       [48., 46.,  0.,  0.,  4.,  0.]]), 'start_param_edges': array([], shape=(0, 5), dtype=float64), 'param_length': 4, 'state_length': 3, 'n_vertices': 50}</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Testing log-posterior at true parameters:</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">XlaRuntimeError</span>                           Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[71]</span><span class="ansi-green-fg">, line 66</span>
<span class="ansi-green-fg">     64</span> test_params = jnp.array([<span class="ansi-green-fg">1.0</span>, <span class="ansi-green-fg">0.5</span>, <span class="ansi-green-fg">0.3</span>])
<span class="ansi-green-fg">     65</span> <span style="color:rgb(0,135,0)">print</span>(<span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">"</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span class="ansi-yellow-fg">Testing log-posterior at true parameters:</span><span class="ansi-yellow-fg">"</span>)
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">66</span> <span style="color:rgb(0,135,0)">print</span>(<span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">  Log-likelihood: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span class="ansi-yellow-bg">log_likelihood_fn</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">test_params</span><span class="ansi-yellow-bg">)</span><span style="font-weight:bold;color:rgb(175,95,135)">:</span><span class="ansi-yellow-fg">.3f</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span class="ansi-yellow-fg">"</span>)
<span class="ansi-green-fg">     67</span> <span style="color:rgb(0,135,0)">print</span>(<span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">  Log-prior: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>log_prior_fn(test_params)<span style="font-weight:bold;color:rgb(175,95,135)">:</span><span class="ansi-yellow-fg">.3f</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span class="ansi-yellow-fg">"</span>)
<span class="ansi-green-fg">     68</span> <span style="color:rgb(0,135,0)">print</span>(<span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">  Log-posterior: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>log_posterior_fn(test_params)<span style="font-weight:bold;color:rgb(175,95,135)">:</span><span class="ansi-yellow-fg">.3f</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span class="ansi-yellow-fg">"</span>)

<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[71]</span><span class="ansi-green-fg">, line 27</span>, in <span class="ansi-cyan-fg">log_likelihood_fn</span><span class="ansi-blue-fg">(params)</span>
<span class="ansi-green-fg">     24</span> structure_json = rabbit_model.serialize()
<span class="ansi-green-fg">     26</span> <span style="font-style:italic;color:rgb(95,135,135)"># Compute PDF for observed times</span>
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">27</span> pdf_values = <span class="ansi-yellow-bg">compute_pmf_ffi</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">     28</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">structure_json</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">     29</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">params</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">     30</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">observed_times</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">     31</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">discrete</span><span class="ansi-yellow-bg">=</span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">False</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">     32</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">granularity</span><span class="ansi-yellow-bg">=</span><span class="ansi-green-fg ansi-yellow-bg">100</span>
<span class="ansi-green-fg">     33</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">     35</span> <span style="font-style:italic;color:rgb(95,135,135)"># Sum log probabilities</span>
<span class="ansi-green-fg">     36</span> log_lik = jnp.sum(jnp.log(pdf_values + <span class="ansi-green-fg">1e-10</span>))  <span style="font-style:italic;color:rgb(95,135,135)"># Add small constant for numerical stability</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/PtDAlgorithms/src/ptdalgorithms/ffi_wrappers.py:361</span>, in <span class="ansi-cyan-fg">compute_pmf_ffi</span><span class="ansi-blue-fg">(structure_json, theta, times, discrete, granularity)</span>
<span class="ansi-green-fg">    317</span> <span style="font-style:italic" class="ansi-yellow-fg">"""</span>
<span class="ansi-green-fg">    318</span> <span style="font-style:italic" class="ansi-yellow-fg">Compute PMF (discrete) or PDF (continuous) using JAX FFI.</span>
<span class="ansi-green-fg">    319</span> 
<span class="ansi-green-fg">   (...)</span><span class="ansi-green-fg">    357</span> <span style="font-style:italic" class="ansi-yellow-fg">&gt;&gt;&gt; fast_pmf = jit_pmf(structure_json, theta, times, False, 100)</span>
<span class="ansi-green-fg">    358</span> <span style="font-style:italic" class="ansi-yellow-fg">"""</span>
<span class="ansi-green-fg">    359</span> <span style="font-style:italic;color:rgb(95,135,135)"># For now, use fallback implementation</span>
<span class="ansi-green-fg">    360</span> <span style="font-style:italic;color:rgb(95,135,135)"># TODO: Replace with true FFI call once handlers are properly exposed</span>
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">361</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">compute_pmf_fallback</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">structure_json</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">theta</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">times</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">discrete</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">granularity</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/PtDAlgorithms/src/ptdalgorithms/ffi_wrappers.py:174</span>, in <span class="ansi-cyan-fg">compute_pmf_fallback</span><span class="ansi-blue-fg">(structure_json, theta, times, discrete, granularity)</span>
<span class="ansi-green-fg">    170</span> <span style="font-style:italic;color:rgb(95,135,135)"># Use pure_callback to wrap the C++ call</span>
<span class="ansi-green-fg">    171</span> <span style="font-style:italic;color:rgb(95,135,135)"># This allows JIT compilation while calling out to Python/C++</span>
<span class="ansi-green-fg">    172</span> result_shape = jax.ShapeDtypeStruct(times.shape, jnp.float64)
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">174</span> result = <span class="ansi-yellow-bg">jax</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">pure_callback</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">    175</span> <span class="ansi-yellow-bg">    </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">lambda</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">theta_jax</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">times_jax</span><span class="ansi-yellow-bg">:</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">_compute_pmf_impl</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">    176</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">structure_json</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    177</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">np</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">asarray</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">theta_jax</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    178</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">np</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">asarray</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">times_jax</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    179</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">discrete</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    180</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">granularity</span>
<span class="ansi-green-fg">    181</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    182</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">result_shape</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    183</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">theta</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    184</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">times</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    185</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">vmap_method</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-fg ansi-yellow-bg">'</span><span class="ansi-yellow-fg ansi-yellow-bg">sequential</span><span class="ansi-yellow-fg ansi-yellow-bg">'</span><span class="ansi-yellow-bg">  </span><span style="font-style:italic;color:rgb(95,135,135)" class="ansi-yellow-bg"># Enable vmap support (JAX v0.6.0+)</span>
<span class="ansi-green-fg">    186</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    188</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> result

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/callback.py:388</span>, in <span class="ansi-cyan-fg">pure_callback</span><span class="ansi-blue-fg">(callback, result_shape_dtypes, sharding, vectorized, vmap_method, *args, **kwargs)</span>
<span class="ansi-green-fg">    385</span> result_avals = tree_util.tree_map(
<span class="ansi-green-fg">    386</span>     <span style="font-weight:bold;color:rgb(0,135,0)">lambda</span> x: core.ShapedArray(x.shape, x.dtype), result_shape_dtypes)
<span class="ansi-green-fg">    387</span> flat_result_avals, out_tree = tree_util.tree_flatten(result_avals)
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">388</span> out_flat = <span class="ansi-yellow-bg">pure_callback_p</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">bind</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">    389</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">flat_args</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    390</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">callback</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">_FlatCallback</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">callback</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">in_tree</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    391</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">result_avals</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">tuple</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">flat_result_avals</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    392</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">sharding</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">sharding</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    393</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">vmap_method</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">vmap_method</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    394</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    395</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> tree_util.tree_unflatten(out_tree, out_flat)

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/core.py:634</span>, in <span class="ansi-cyan-fg">Primitive.bind</span><span class="ansi-blue-fg">(self, *args, **params)</span>
<span class="ansi-green-fg">    632</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span class="ansi-blue-fg">bind</span>(<span style="color:rgb(0,135,0)">self</span>, *args, **params):
<span class="ansi-green-fg">    633</span>   args = args <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span>.skip_canonicalization <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(0,135,0)">map</span>(canonicalize_value, args)
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">634</span>   <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_true_bind</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">params</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/core.py:650</span>, in <span class="ansi-cyan-fg">Primitive._true_bind</span><span class="ansi-blue-fg">(self, *args, **params)</span>
<span class="ansi-green-fg">    648</span> trace_ctx.set_trace(eval_trace)
<span class="ansi-green-fg">    649</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">650</span>   <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">bind_with_trace</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">prev_trace</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">params</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    651</span> <span style="font-weight:bold;color:rgb(0,135,0)">finally</span>:
<span class="ansi-green-fg">    652</span>   trace_ctx.set_trace(prev_trace)

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/core.py:662</span>, in <span class="ansi-cyan-fg">Primitive.bind_with_trace</span><span class="ansi-blue-fg">(self, trace, args, params)</span>
<span class="ansi-green-fg">    660</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> set_current_trace(trace):
<span class="ansi-green-fg">    661</span>       <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span>.to_lojax(*args, **params)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore</span>
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">662</span>   <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">trace</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">process_primitive</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">params</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    663</span> trace.process_primitive(<span style="color:rgb(0,135,0)">self</span>, args, params)  <span style="font-style:italic;color:rgb(95,135,135)"># may raise lojax error</span>
<span class="ansi-green-fg">    664</span> <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">Exception</span>(<span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">couldn</span><span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">t apply typeof to args: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>args<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span class="ansi-yellow-fg">"</span>)

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/core.py:1189</span>, in <span class="ansi-cyan-fg">EvalTrace.process_primitive</span><span class="ansi-blue-fg">(self, primitive, args, params)</span>
<span class="ansi-green-fg">   1187</span> args = <span style="color:rgb(0,135,0)">map</span>(full_lower, args)
<span class="ansi-green-fg">   1188</span> check_eval_args(args)
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">1189</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">primitive</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">impl</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">params</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/dispatch.py:90</span>, in <span class="ansi-cyan-fg">apply_primitive</span><span class="ansi-blue-fg">(prim, *args, **params)</span>
<span class="ansi-green-fg">     88</span> prev = lib.jax_jit.swap_thread_local_state_disable_jit(<span style="font-weight:bold;color:rgb(0,135,0)">False</span>)
<span class="ansi-green-fg">     89</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">90</span>   outs = <span class="ansi-yellow-bg">fun</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">     91</span> <span style="font-weight:bold;color:rgb(0,135,0)">finally</span>:
<span class="ansi-green-fg">     92</span>   lib.jax_jit.swap_thread_local_state_disable_jit(prev)

    <span class="ansi-red-fg">[... skipping hidden 5 frame]</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/interpreters/pxla.py:1372</span>, in <span class="ansi-cyan-fg">ExecuteReplicated.__call__</span><span class="ansi-blue-fg">(self, *args)</span>
<span class="ansi-green-fg">   1369</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> (<span style="color:rgb(0,135,0)">self</span>.ordered_effects <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span>.has_unordered_effects
<span class="ansi-green-fg">   1370</span>     <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span>.has_host_callbacks):
<span class="ansi-green-fg">   1371</span>   input_bufs = <span style="color:rgb(0,135,0)">self</span>._add_tokens_to_inputs(input_bufs)
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">1372</span>   results = <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">xla_executable</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">execute_sharded</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">input_bufs</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">with_tokens</span><span class="ansi-yellow-bg">=</span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">True</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">   1374</span>   result_token_bufs = results.disassemble_prefix_into_single_device_arrays(
<span class="ansi-green-fg">   1375</span>       <span style="color:rgb(0,135,0)">len</span>(<span style="color:rgb(0,135,0)">self</span>.ordered_effects))
<span class="ansi-green-fg">   1376</span>   sharded_runtime_token = results.consume_token()

<span class="ansi-red-fg">XlaRuntimeError</span>: INTERNAL: CpuCallback error calling callback: Traceback (most recent call last):
  File "&lt;frozen runpy&gt;", line 198, in _run_module_as_main
  File "&lt;frozen runpy&gt;", line 88, in _run_code
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/ipykernel_launcher.py", line 18, in &lt;module&gt;
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/traitlets/config/application.py", line 1075, in launch_instance
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/ipykernel/kernelapp.py", line 739, in start
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/tornado/platform/asyncio.py", line 211, in start
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/asyncio/base_events.py", line 683, in run_forever
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/asyncio/base_events.py", line 2050, in _run_once
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/asyncio/events.py", line 89, in _run
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/ipykernel/kernelbase.py", line 519, in dispatch_queue
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/ipykernel/kernelbase.py", line 508, in process_one
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/ipykernel/kernelbase.py", line 400, in dispatch_shell
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/ipykernel/ipkernel.py", line 368, in execute_request
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/ipykernel/kernelbase.py", line 767, in execute_request
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/ipykernel/ipkernel.py", line 455, in do_execute
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/ipykernel/zmqshell.py", line 577, in run_cell
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/IPython/core/interactiveshell.py", line 3116, in run_cell
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/IPython/core/interactiveshell.py", line 3171, in _run_cell
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/IPython/core/async_helpers.py", line 128, in _pseudo_sync_runner
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/IPython/core/interactiveshell.py", line 3394, in run_cell_async
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/IPython/core/interactiveshell.py", line 3639, in run_ast_nodes
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/IPython/core/interactiveshell.py", line 3699, in run_code
  File "/var/folders/s6/srs8qkh52w1_h32d65z95tth0000gn/T/ipykernel_93797/2405647470.py", line 66, in &lt;module&gt;
  File "/var/folders/s6/srs8qkh52w1_h32d65z95tth0000gn/T/ipykernel_93797/2405647470.py", line 27, in log_likelihood_fn
  File "/Users/kmt/PtDAlgorithms/src/ptdalgorithms/ffi_wrappers.py", line 361, in compute_pmf_ffi
  File "/Users/kmt/PtDAlgorithms/src/ptdalgorithms/ffi_wrappers.py", line 174, in compute_pmf_fallback
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/callback.py", line 388, in pure_callback
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/core.py", line 634, in bind
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/core.py", line 650, in _true_bind
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/core.py", line 662, in bind_with_trace
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/core.py", line 1189, in process_primitive
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/dispatch.py", line 90, in apply_primitive
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/traceback_util.py", line 180, in reraise_with_filtered_traceback
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/pjit.py", line 268, in cache_miss
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/pjit.py", line 147, in _python_pjit_helper
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/pjit.py", line 1780, in _pjit_call_impl_python
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/profiler.py", line 364, in wrapper
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/interpreters/pxla.py", line 1372, in __call__
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/callback.py", line 784, in _wrapped_callback
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/callback.py", line 223, in _callback
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/callback.py", line 95, in pure_callback_impl
  File "/Users/kmt/PtDAlgorithms/.pixi/envs/default/lib/python3.13/site-packages/jax/_src/callback.py", line 70, in __call__
  File "/Users/kmt/PtDAlgorithms/src/ptdalgorithms/ffi_wrappers.py", line 175, in &lt;lambda&gt;
  File "/Users/kmt/PtDAlgorithms/src/ptdalgorithms/ffi_wrappers.py", line 136, in _compute_pmf_impl
TypeError: __init__(): incompatible constructor arguments. The following argument types are supported:
    1. ptdalgorithms.ptdalgorithmscpp_pybind.parameterized.GraphBuilder(structure_json: str)

Invoked with: {'states': array([[0, 0, 0],
       [0, 1, 0],
       [1, 0, 0],
       [0, 1, 1],
       [0, 2, 0],
       [1, 1, 0],
       [0, 2, 1],
       [0, 3, 0],
       [1, 2, 0],
       [0, 3, 1],
       [0, 4, 0],
       [1, 3, 0],
       [0, 4, 1],
       [1, 0, 1],
       [2, 0, 0],
       [1, 1, 1],
       [2, 1, 0],
       [1, 2, 1],
       [2, 2, 0],
       [1, 3, 1],
       [1, 4, 0],
       [2, 3, 0],
       [1, 4, 1],
       [2, 0, 1],
       [3, 0, 0],
       [2, 1, 1],
       [3, 1, 0],
       [2, 2, 1],
       [3, 2, 0],
       [2, 3, 1],
       [2, 4, 0],
       [3, 3, 0],
       [2, 4, 1],
       [3, 0, 1],
       [4, 0, 0],
       [3, 1, 1],
       [4, 1, 0],
       [3, 2, 1],
       [4, 2, 0],
       [3, 3, 1],
       [3, 4, 0],
       [4, 3, 0],
       [3, 4, 1],
       [4, 0, 1],
       [4, 1, 1],
       [4, 2, 1],
       [4, 3, 1],
       [4, 4, 0],
       [4, 4, 1],
       [0, 0, 1]], dtype=int32), 'edges': array([[ 1.,  2.,  0.],
       [ 1.,  3.,  1.],
       [ 2.,  1.,  0.],
       [ 2., 13.,  1.],
       [ 3., 13.,  0.],
       [ 3., 49.,  0.],
       [ 4.,  5.,  0.],
       [ 4.,  6.,  1.],
       [ 5.,  4.,  0.],
       [ 5., 14.,  0.],
       [ 5., 15.,  1.],
       [ 6., 15.,  0.],
       [ 6.,  3.,  0.],
       [ 7.,  8.,  0.],
       [ 7.,  9.,  1.],
       [ 8.,  7.,  0.],
       [ 8., 16.,  0.],
       [ 8., 17.,  1.],
       [ 9., 17.,  0.],
       [ 9.,  6.,  0.],
       [10., 11.,  0.],
       [10., 12.,  1.],
       [11., 10.,  0.],
       [11., 18.,  0.],
       [11., 19.,  1.],
       [12., 19.,  0.],
       [12.,  9.,  0.],
       [13.,  3.,  0.],
       [13., 49.,  0.],
       [14.,  5.,  0.],
       [14., 23.,  1.],
       [15.,  6.,  0.],
       [15., 23.,  0.],
       [15.,  3.,  0.],
       [15., 13.,  0.],
       [16.,  8.,  0.],
       [16., 24.,  0.],
       [16., 25.,  1.],
       [17.,  9.,  0.],
       [17., 25.,  0.],
       [17.,  6.,  0.],
       [17., 15.,  0.],
       [18., 11.,  0.],
       [18., 26.,  0.],
       [18., 27.,  1.],
       [19., 12.,  0.],
       [19., 27.,  0.],
       [19.,  9.,  0.],
       [19., 17.,  0.],
       [20., 21.,  0.],
       [20., 22.,  1.],
       [21., 20.,  0.],
       [21., 28.,  0.],
       [21., 29.,  1.],
       [22., 29.,  0.],
       [22., 12.,  0.],
       [22., 19.,  0.],
       [23., 15.,  0.],
       [23., 13.,  0.],
       [24., 16.,  0.],
       [24., 33.,  1.],
       [25., 17.,  0.],
       [25., 33.,  0.],
       [25., 15.,  0.],
       [25., 23.,  0.],
       [26., 18.,  0.],
       [26., 34.,  0.],
       [26., 35.,  1.],
       [27., 19.,  0.],
       [27., 35.,  0.],
       [27., 17.,  0.],
       [27., 25.,  0.],
       [28., 21.,  0.],
       [28., 36.,  0.],
       [28., 37.,  1.],
       [29., 22.,  0.],
       [29., 37.,  0.],
       [29., 19.,  0.],
       [29., 27.,  0.],
       [30., 31.,  0.],
       [30., 32.,  1.],
       [31., 30.,  0.],
       [31., 38.,  0.],
       [31., 39.,  1.],
       [32., 39.,  0.],
       [32., 22.,  0.],
       [32., 29.,  0.],
       [33., 25.,  0.],
       [33., 23.,  0.],
       [34., 26.,  0.],
       [34., 43.,  1.],
       [35., 27.,  0.],
       [35., 43.,  0.],
       [35., 25.,  0.],
       [35., 33.,  0.],
       [36., 28.,  0.],
       [36., 44.,  1.],
       [37., 29.,  0.],
       [37., 44.,  0.],
       [37., 27.,  0.],
       [37., 35.,  0.],
       [38., 31.,  0.],
       [38., 45.,  1.],
       [39., 32.,  0.],
       [39., 45.,  0.],
       [39., 29.,  0.],
       [39., 37.,  0.],
       [40., 41.,  0.],
       [40., 42.,  1.],
       [41., 40.,  0.],
       [41., 46.,  1.],
       [42., 46.,  0.],
       [42., 32.,  0.],
       [42., 39.,  0.],
       [43., 35.,  0.],
       [43., 33.,  0.],
       [44., 37.,  0.],
       [44., 35.,  0.],
       [44., 43.,  0.],
       [45., 39.,  0.],
       [45., 37.,  0.],
       [45., 44.,  0.],
       [46., 42.,  0.],
       [46., 39.,  0.],
       [46., 45.,  0.],
       [47., 48.,  1.],
       [48., 42.,  0.],
       [48., 46.,  0.]]), 'start_edges': array([], shape=(0, 2), dtype=float64), 'param_edges': array([[ 1.,  2.,  1.,  0.,  0.,  0.],
       [ 2.,  1.,  1.,  0.,  0.,  0.],
       [ 3., 13.,  1.,  0.,  0.,  0.],
       [ 3., 49.,  0.,  0.,  1.,  0.],
       [ 4.,  5.,  1.,  0.,  0.,  0.],
       [ 5.,  4.,  1.,  0.,  0.,  0.],
       [ 5., 14.,  1.,  0.,  0.,  0.],
       [ 6., 15.,  1.,  0.,  0.,  0.],
       [ 6.,  3.,  0.,  0.,  2.,  0.],
       [ 7.,  8.,  1.,  0.,  0.,  0.],
       [ 8.,  7.,  1.,  0.,  0.,  0.],
       [ 8., 16.,  1.,  0.,  0.,  0.],
       [ 9., 17.,  1.,  0.,  0.,  0.],
       [ 9.,  6.,  0.,  0.,  3.,  0.],
       [10., 11.,  1.,  0.,  0.,  0.],
       [11., 10.,  1.,  0.,  0.,  0.],
       [11., 18.,  1.,  0.,  0.,  0.],
       [12., 19.,  1.,  0.,  0.,  0.],
       [12.,  9.,  0.,  0.,  4.,  0.],
       [13.,  3.,  1.,  0.,  0.,  0.],
       [13., 49.,  0.,  1.,  0.,  0.],
       [14.,  5.,  1.,  0.,  0.,  0.],
       [15.,  6.,  1.,  0.,  0.,  0.],
       [15., 23.,  1.,  0.,  0.,  0.],
       [15.,  3.,  0.,  1.,  0.,  0.],
       [15., 13.,  0.,  0.,  1.,  0.],
       [16.,  8.,  1.,  0.,  0.,  0.],
       [16., 24.,  1.,  0.,  0.,  0.],
       [17.,  9.,  1.,  0.,  0.,  0.],
       [17., 25.,  1.,  0.,  0.,  0.],
       [17.,  6.,  0.,  1.,  0.,  0.],
       [17., 15.,  0.,  0.,  2.,  0.],
       [18., 11.,  1.,  0.,  0.,  0.],
       [18., 26.,  1.,  0.,  0.,  0.],
       [19., 12.,  1.,  0.,  0.,  0.],
       [19., 27.,  1.,  0.,  0.,  0.],
       [19.,  9.,  0.,  1.,  0.,  0.],
       [19., 17.,  0.,  0.,  3.,  0.],
       [20., 21.,  1.,  0.,  0.,  0.],
       [21., 20.,  1.,  0.,  0.,  0.],
       [21., 28.,  1.,  0.,  0.,  0.],
       [22., 29.,  1.,  0.,  0.,  0.],
       [22., 12.,  0.,  1.,  0.,  0.],
       [22., 19.,  0.,  0.,  4.,  0.],
       [23., 15.,  1.,  0.,  0.,  0.],
       [23., 13.,  0.,  2.,  0.,  0.],
       [24., 16.,  1.,  0.,  0.,  0.],
       [25., 17.,  1.,  0.,  0.,  0.],
       [25., 33.,  1.,  0.,  0.,  0.],
       [25., 15.,  0.,  2.,  0.,  0.],
       [25., 23.,  0.,  0.,  1.,  0.],
       [26., 18.,  1.,  0.,  0.,  0.],
       [26., 34.,  1.,  0.,  0.,  0.],
       [27., 19.,  1.,  0.,  0.,  0.],
       [27., 35.,  1.,  0.,  0.,  0.],
       [27., 17.,  0.,  2.,  0.,  0.],
       [27., 25.,  0.,  0.,  2.,  0.],
       [28., 21.,  1.,  0.,  0.,  0.],
       [28., 36.,  1.,  0.,  0.,  0.],
       [29., 22.,  1.,  0.,  0.,  0.],
       [29., 37.,  1.,  0.,  0.,  0.],
       [29., 19.,  0.,  2.,  0.,  0.],
       [29., 27.,  0.,  0.,  3.,  0.],
       [30., 31.,  1.,  0.,  0.,  0.],
       [31., 30.,  1.,  0.,  0.,  0.],
       [31., 38.,  1.,  0.,  0.,  0.],
       [32., 39.,  1.,  0.,  0.,  0.],
       [32., 22.,  0.,  2.,  0.,  0.],
       [32., 29.,  0.,  0.,  4.,  0.],
       [33., 25.,  1.,  0.,  0.,  0.],
       [33., 23.,  0.,  3.,  0.,  0.],
       [34., 26.,  1.,  0.,  0.,  0.],
       [35., 27.,  1.,  0.,  0.,  0.],
       [35., 43.,  1.,  0.,  0.,  0.],
       [35., 25.,  0.,  3.,  0.,  0.],
       [35., 33.,  0.,  0.,  1.,  0.],
       [36., 28.,  1.,  0.,  0.,  0.],
       [37., 29.,  1.,  0.,  0.,  0.],
       [37., 44.,  1.,  0.,  0.,  0.],
       [37., 27.,  0.,  3.,  0.,  0.],
       [37., 35.,  0.,  0.,  2.,  0.],
       [38., 31.,  1.,  0.,  0.,  0.],
       [39., 32.,  1.,  0.,  0.,  0.],
       [39., 45.,  1.,  0.,  0.,  0.],
       [39., 29.,  0.,  3.,  0.,  0.],
       [39., 37.,  0.,  0.,  3.,  0.],
       [40., 41.,  1.,  0.,  0.,  0.],
       [41., 40.,  1.,  0.,  0.,  0.],
       [42., 46.,  1.,  0.,  0.,  0.],
       [42., 32.,  0.,  3.,  0.,  0.],
       [42., 39.,  0.,  0.,  4.,  0.],
       [43., 35.,  1.,  0.,  0.,  0.],
       [43., 33.,  0.,  4.,  0.,  0.],
       [44., 37.,  1.,  0.,  0.,  0.],
       [44., 35.,  0.,  4.,  0.,  0.],
       [44., 43.,  0.,  0.,  1.,  0.],
       [45., 39.,  1.,  0.,  0.,  0.],
       [45., 37.,  0.,  4.,  0.,  0.],
       [45., 44.,  0.,  0.,  2.,  0.],
       [46., 42.,  1.,  0.,  0.,  0.],
       [46., 39.,  0.,  4.,  0.,  0.],
       [46., 45.,  0.,  0.,  3.,  0.],
       [48., 42.,  0.,  4.,  0.,  0.],
       [48., 46.,  0.,  0.,  4.,  0.]]), 'start_param_edges': array([], shape=(0, 5), dtype=float64), 'param_length': 4, 'state_length': 3, 'n_vertices': 50}</pre>
</div>
</div>
</div>
<div id="cell-179" class="cell" data-execution_count="72">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run SVGD inference</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ptdalgorithms.svgd <span class="im">import</span> SVGD</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize SVGD</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>n_particles <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>n_iterations <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Running SVGD with </span><span class="sc">{</span>n_particles<span class="sc">}</span><span class="ss"> particles for </span><span class="sc">{</span>n_iterations<span class="sc">}</span><span class="ss"> iterations..."</span>)</span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>svgd <span class="op">=</span> SVGD(</span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>    log_prob<span class="op">=</span>log_posterior_fn,</span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>    theta_dim<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>    n_particles<span class="op">=</span>n_particles,</span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>    n_iterations<span class="op">=</span>n_iterations,</span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>    learning_rate<span class="op">=</span><span class="fl">0.01</span>,</span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a>    kernel_bandwidth<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize particles from prior</span></span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a>key <span class="op">=</span> jax.random.PRNGKey(<span class="dv">42</span>)</span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a>initial_particles <span class="op">=</span> jax.random.lognormal(key, shape<span class="op">=</span>(n_particles, <span class="dv">3</span>)) <span class="op">*</span> jnp.array([<span class="fl">1.0</span>, <span class="fl">0.5</span>, <span class="fl">0.3</span>])</span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-23"><a href="#cb138-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Run optimization</span></span>
<span id="cb138-24"><a href="#cb138-24" aria-hidden="true" tabindex="-1"></a>final_particles <span class="op">=</span> svgd.fit(initial_particles)</span>
<span id="cb138-25"><a href="#cb138-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-26"><a href="#cb138-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute posterior statistics</span></span>
<span id="cb138-27"><a href="#cb138-27" aria-hidden="true" tabindex="-1"></a>posterior_mean <span class="op">=</span> jnp.mean(final_particles, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb138-28"><a href="#cb138-28" aria-hidden="true" tabindex="-1"></a>posterior_std <span class="op">=</span> jnp.std(final_particles, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb138-29"><a href="#cb138-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-30"><a href="#cb138-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Posterior estimates:"</span>)</span>
<span id="cb138-31"><a href="#cb138-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Jump rate:      </span><span class="sc">{</span>posterior_mean[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss"> ± </span><span class="sc">{</span>posterior_std[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">  (true: </span><span class="sc">{</span>true_params[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">)"</span>)</span>
<span id="cb138-32"><a href="#cb138-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Left flood rate:  </span><span class="sc">{</span>posterior_mean[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss"> ± </span><span class="sc">{</span>posterior_std[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">  (true: </span><span class="sc">{</span>true_params[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">)"</span>)</span>
<span id="cb138-33"><a href="#cb138-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Right flood rate: </span><span class="sc">{</span>posterior_mean[<span class="dv">2</span>]<span class="sc">:.3f}</span><span class="ss"> ± </span><span class="sc">{</span>posterior_std[<span class="dv">2</span>]<span class="sc">:.3f}</span><span class="ss">  (true: </span><span class="sc">{</span>true_params[<span class="dv">2</span>]<span class="sc">:.3f}</span><span class="ss">)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running SVGD with 50 particles for 200 iterations...</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">TypeError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[72]</span><span class="ansi-green-fg">, line 10</span>
<span class="ansi-green-fg">      6</span> n_iterations = <span class="ansi-green-fg">200</span>
<span class="ansi-green-fg">      8</span> <span style="color:rgb(0,135,0)">print</span>(<span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">Running SVGD with </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>n_particles<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span class="ansi-yellow-fg"> particles for </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>n_iterations<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span class="ansi-yellow-fg"> iterations...</span><span class="ansi-yellow-fg">"</span>)
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">10</span> svgd = <span class="ansi-yellow-bg">SVGD</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">     11</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">log_prob</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">log_posterior_fn</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">     12</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">theta_dim</span><span class="ansi-yellow-bg">=</span><span class="ansi-green-fg ansi-yellow-bg">3</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">     13</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">n_particles</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">n_particles</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">     14</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">n_iterations</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">n_iterations</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">     15</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">learning_rate</span><span class="ansi-yellow-bg">=</span><span class="ansi-green-fg ansi-yellow-bg">0.01</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">     16</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">kernel_bandwidth</span><span class="ansi-yellow-bg">=</span><span class="ansi-green-fg ansi-yellow-bg">1.0</span>
<span class="ansi-green-fg">     17</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">     19</span> <span style="font-style:italic;color:rgb(95,135,135)"># Initialize particles from prior</span>
<span class="ansi-green-fg">     20</span> key = jax.random.PRNGKey(<span class="ansi-green-fg">42</span>)

<span class="ansi-red-fg">TypeError</span>: SVGD.__init__() got an unexpected keyword argument 'log_prob'</pre>
</div>
</div>
</div>
<div id="cell-180" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize posterior distributions</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">4</span>))</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>param_names <span class="op">=</span> [<span class="st">'Jump rate'</span>, <span class="st">'Left flood rate'</span>, <span class="st">'Right flood rate'</span>]</span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (ax, name) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(axes, param_names)):</span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot posterior particles</span></span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>    ax.hist(final_particles[:, i], bins<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, density<span class="op">=</span><span class="va">True</span>, label<span class="op">=</span><span class="st">'Posterior'</span>)</span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark true value</span></span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>    ax.axvline(true_params[i], color<span class="op">=</span><span class="st">'r'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'True value'</span>)</span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark posterior mean</span></span>
<span id="cb140-15"><a href="#cb140-15" aria-hidden="true" tabindex="-1"></a>    ax.axvline(posterior_mean[i], color<span class="op">=</span><span class="st">'g'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Posterior mean'</span>)</span>
<span id="cb140-16"><a href="#cb140-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-17"><a href="#cb140-17" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(name)</span>
<span id="cb140-18"><a href="#cb140-18" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb140-19"><a href="#cb140-19" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb140-20"><a href="#cb140-20" aria-hidden="true" tabindex="-1"></a>    ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb140-21"><a href="#cb140-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-22"><a href="#cb140-22" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb140-23"><a href="#cb140-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb140-24"><a href="#cb140-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-25"><a href="#cb140-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">SVGD successfully recovered the parameters with quantified uncertainty!"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="model-caching-and-distribution" class="level2">
<h2 class="anchored" data-anchor-id="model-caching-and-distribution">Model Caching and Distribution</h2>
<p>When working with complex models, especially in research and production environments, two challenges frequently arise: . <strong>Computational efficiency</strong>: Recording elimination traces is O(n³) - expensive for large models. <strong>Reproducibility and sharing</strong>: How do we share pre-computed models with collaborators? PtDAlgorithms provides two caching mechanisms to address these challenges: ### Trace Caching Elimination traces are automatically cached based on graph structure (not parameter values). When you call <code>record_elimination_trace()</code> on a graph, the library: . Computes a content hash of the graph structure. Checks <code>~/.ptdalgorithms_cache/traces/</code> for a cached trace. If found, loads the trace instantly (avoiding O(n³) re-computation). If not found, records the trace and saves it for future use This means the expensive O(n³) recording happens only once per unique graph structure, regardless of how many times you evaluate the model with different parameters. ### Symbolic DAG Caching For models using symbolic elimination (the <code>eliminate_to_dag()</code> approach), similar caching is available. Symbolic DAGs are cached in <code>~/.ptdalgorithms_cache/symbolic/</code>. Let’s see both caching mechanisms in action:</p>
<div id="cell-182" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstrate automatic trace caching</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ptdalgorithms.trace_cache <span class="im">import</span> (</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>    get_trace_cache_stats,</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>    list_cached_traces,</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>    clear_trace_cache</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Check initial cache state</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>stats_before <span class="op">=</span> get_trace_cache_stats()</span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Trace cache before:"</span>)</span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Files: </span><span class="sc">{</span>stats_before[<span class="st">'total_files'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Size: </span><span class="sc">{</span>stats_before<span class="sc">.</span>get(<span class="st">'total_mb'</span>, <span class="dv">0</span>)<span class="sc">:.2f}</span><span class="ss"> MB"</span>)</span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Build a fresh model (same structure as before)</span></span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a>fresh_model <span class="op">=</span> build_rabbit_model()</span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a><span class="co"># First call: record trace (slow)</span></span>
<span id="cb141-19"><a href="#cb141-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">First trace recording (will be cached):"</span>)</span>
<span id="cb141-20"><a href="#cb141-20" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> time.time()</span>
<span id="cb141-21"><a href="#cb141-21" aria-hidden="true" tabindex="-1"></a>trace1 <span class="op">=</span> record_elimination_trace(fresh_model, param_length<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb141-22"><a href="#cb141-22" aria-hidden="true" tabindex="-1"></a>time1 <span class="op">=</span> time.time() <span class="op">-</span> start</span>
<span id="cb141-23"><a href="#cb141-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Time: </span><span class="sc">{</span>time1<span class="op">*</span><span class="dv">1000</span><span class="sc">:.1f}</span><span class="ss"> ms"</span>)</span>
<span id="cb141-24"><a href="#cb141-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-25"><a href="#cb141-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Build another model with same structure</span></span>
<span id="cb141-26"><a href="#cb141-26" aria-hidden="true" tabindex="-1"></a>another_model <span class="op">=</span> build_rabbit_model()</span>
<span id="cb141-27"><a href="#cb141-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-28"><a href="#cb141-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Second call: load from cache (fast)</span></span>
<span id="cb141-29"><a href="#cb141-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Second trace recording (loaded from cache):"</span>)</span>
<span id="cb141-30"><a href="#cb141-30" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> time.time()</span>
<span id="cb141-31"><a href="#cb141-31" aria-hidden="true" tabindex="-1"></a>trace2 <span class="op">=</span> record_elimination_trace(another_model, param_length<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb141-32"><a href="#cb141-32" aria-hidden="true" tabindex="-1"></a>time2 <span class="op">=</span> time.time() <span class="op">-</span> start</span>
<span id="cb141-33"><a href="#cb141-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Time: </span><span class="sc">{</span>time2<span class="op">*</span><span class="dv">1000</span><span class="sc">:.1f}</span><span class="ss"> ms"</span>)</span>
<span id="cb141-34"><a href="#cb141-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Speedup: </span><span class="sc">{</span>time1<span class="op">/</span>time2<span class="sc">:.1f}</span><span class="ss">x faster"</span>)</span>
<span id="cb141-35"><a href="#cb141-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-36"><a href="#cb141-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Check cache after</span></span>
<span id="cb141-37"><a href="#cb141-37" aria-hidden="true" tabindex="-1"></a>stats_after <span class="op">=</span> get_trace_cache_stats()</span>
<span id="cb141-38"><a href="#cb141-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Trace cache after:"</span>)</span>
<span id="cb141-39"><a href="#cb141-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Files: </span><span class="sc">{</span>stats_after[<span class="st">'total_files'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb141-40"><a href="#cb141-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Size: </span><span class="sc">{</span>stats_after<span class="sc">.</span>get(<span class="st">'total_mb'</span>, <span class="dv">0</span>)<span class="sc">:.2f}</span><span class="ss"> MB"</span>)</span>
<span id="cb141-41"><a href="#cb141-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-42"><a href="#cb141-42" aria-hidden="true" tabindex="-1"></a><span class="co"># List cached traces</span></span>
<span id="cb141-43"><a href="#cb141-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Cached traces:"</span>)</span>
<span id="cb141-44"><a href="#cb141-44" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> entry <span class="kw">in</span> list_cached_traces():</span>
<span id="cb141-45"><a href="#cb141-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Hash: </span><span class="sc">{</span>entry[<span class="st">'hash'</span>][:<span class="dv">16</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb141-46"><a href="#cb141-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"    Vertices: </span><span class="sc">{</span>entry<span class="sc">.</span>get(<span class="st">'n_vertices'</span>, <span class="st">'N/A'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb141-47"><a href="#cb141-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"    Operations: </span><span class="sc">{</span>entry<span class="sc">.</span>get(<span class="st">'n_operations'</span>, <span class="st">'N/A'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb141-48"><a href="#cb141-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"    Size: </span><span class="sc">{</span>entry<span class="sc">.</span>get(<span class="st">'size_kb'</span>, <span class="dv">0</span>)<span class="sc">:.1f}</span><span class="ss"> KB"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-183" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cache management utilities</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ptdalgorithms.trace_cache <span class="im">import</span> cleanup_old_traces</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up old caches (optional)</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a><span class="co"># This removes caches older than 30 days or enforces a size limit</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a><span class="co"># removed = cleanup_old_traces(max_size_mb=100.0, max_age_days=30)</span></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a><span class="co"># print(f"Removed {removed} old cache entries")</span></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a><span class="co"># To completely clear the cache (useful for testing):</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a><span class="co"># cleared = clear_trace_cache()</span></span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a><span class="co"># print(f"Cleared {cleared} cache files")</span></span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cache management utilities available:"</span>)</span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  - get_trace_cache_stats(): Get cache statistics"</span>)</span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  - list_cached_traces(): List all cached traces"</span>)</span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  - clear_trace_cache(): Clear all caches"</span>)</span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  - cleanup_old_traces(): Remove old/large caches"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="sharing-models-with-collaborators" class="level3">
<h3 class="anchored" data-anchor-id="sharing-models-with-collaborators">Sharing Models with Collaborators</h3>
<p>The cache system enables easy model sharing. Here’s a typical workflow: <strong>On your machine (researcher building the model):</strong> </p>
<pre class="python\n"><code># Build and record trace\n
model = build_complex_model()  # Your custom model\n
trace = record_elimination_trace(model)\n
\n
# Trace is automatically saved to ~/.ptdalgorithms_cache/traces/\n
# Find the cache file:\n
from ptdalgorithms.trace_cache import list_cached_traces\n
entries = list_cached_traces()\n
latest = entries[0]  # Most recent\n
print(f\"Cache file: {latest['hash']}.json\")\n
\n
# Share this file with collaborators\n
# They place it in their ~/.ptdalgorithms_cache/traces/ directory\n
```\n
\n
**On collaborator's machine:**\n
\n
```python\n
# Build same model structure\n
model = build_complex_model()  # Same code as above\n
\n
# This will find the cached trace (if file is in cache dir)\n
trace = record_elimination_trace(model)\n
# -&gt; Instant! No O(n³) computation needed\n
```\n
\n
For production deployments, you can commit cache files to your repository or use a shared file system (e.g., network drive, S3 bucket).

::: {#cell-185 .cell}
``` {.python .cell-code}
# Example: Save and load model structure for distribution
import json
from pathlib import Path

# Save model structure to JSON (for version control)
model_json = rabbit_model.serialize()
output_path = Path("rabbit_model_structure.json")

with open(output_path, 'w') as f:
    json.dump(model_json, f, indent=2)

print(f"Model structure saved to: {output_path}")
print(f"File size: {output_path.stat().st_size / 1024:.1f} KB")

# Later, reconstruct model from JSON
with open(output_path, 'r') as f:
    loaded_json = json.load(f)

from ptdalgorithms import Graph
reconstructed_model = Graph()
# reconstructed_model.deserialize(loaded_json)  # If implemented

print(f"\nModel can be version-controlled and shared via:")
print(f"  - Git repository (JSON structure)")
print(f"  - Shared file system (cache files)")
print(f"  - Package distribution (bundled cache)")
</code></pre>
<p>:::</p>
<p>The SVGD particles now represent our posterior distribution. Each particle is a plausible set of parameter values given the observed data, and the collection of particles approximates the full posterior. We can use these particles to compute posterior summaries (means, quantiles, credible intervals), make predictions, or perform model checking. The spread of the particles reflects our uncertainty—parameters with wide spread are less constrained by the data, while parameters with narrow spread are well-determined.</p>
<p>This inference workflow showcases the full power of the ptdalgorithms ecosystem. We constructed a complex stochastic model using graph-based state space representation. We parameterized it for efficient exploration of parameter space. We performed symbolic Gaussian elimination to enable ultra-fast repeated evaluation. We integrated with JAX for automatic differentiation and JIT compilation. We implemented a gradient-based inference algorithm (SVGD) that can be parallelized across devices and nodes. And we can scale this entire workflow to much larger problems—more complex models, more observations, more particles—by leveraging distributed computing.</p>
<p>For production inference runs, you would typically use more particles (100-1000), run for more iterations (1000-10000), use adaptive step sizes, monitor convergence diagnostics, and leverage the distributed computing infrastructure we described earlier to parallelize across many nodes. The combination of symbolic elimination (100× faster evaluation), distributed computing (100× more parallel evaluations), and gradient-based inference (100× fewer iterations than MCMC) can easily provide five or six orders of magnitude of speedup compared to naive approaches, transforming intractable problems into routine computations.</p>
<p>Modern computational infrastructure offers substantial computing power not just through faster processors, but through massive parallelism across multiple machines. A typical high-performance computing (HPC) cluster might have dozens to hundreds of compute nodes, each with dozens of CPU cores, representing thousands of processor cores working in parallel. For computationally intensive tasks like Bayesian inference, where we need to evaluate a complex model millions of times, this parallel computing power is transformative. What might take days on a single machine can complete in hours or minutes when distributed across a cluster.</p>
<p>The ptdalgorithms library is designed from the ground up to leverage this distributed computing infrastructure. Through tight integration with JAX’s distributed computing capabilities and support for SLURM (Simple Linux Utility for Resource Management), the standard job scheduler on HPC clusters, the library makes it straightforward to scale from running on your laptop to running on hundreds of nodes. The key insight is that many inference algorithms—particularly particle-based methods like Stein Variational Gradient Descent (SVGD)—are naturally parallel. Each particle can be evaluated independently, and gradients can be computed in parallel across all particles. With the right infrastructure, we can distribute these particles across many machines and aggregate results efficiently.</p>
<p>This section demonstrates how to set up and run distributed computations with ptdalgorithms. We will see how the library automatically detects whether it is running on a SLURM cluster, how it coordinates multiple processes across different nodes, and how JAX distributes computations across available resources. We will work with our rabbit model, showing how the combination of symbolic elimination (for fast per-particle evaluation) and distributed computing (for parallel particle evaluation) enables inference at scales that would be impossible on a single machine.</p>
<p>The workflow has three main components: (1) initialization, where we detect the distributed environment and set up JAX for multi-node computation; (2) model setup, where we construct our parameterized model and perform symbolic elimination; and (3) distributed evaluation, where we leverage JAX’s <code>pmap</code> (parallel map) to evaluate the model across all available devices in parallel. Let’s see each component in detail.</p>
</section>
</section>
<section id="distributed-computing" class="level2">
<h2 class="anchored" data-anchor-id="distributed-computing">Distributed Computing</h2>
<div id="cell-189" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="co"># code here</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[INFO] Not running under SLURM - using single-node setup
[INFO] Configured JAX for 1 CPU devices
[INFO] JAX x64 precision enabled
[INFO] Single-node setup - no distributed initialization needed
[INFO] 
Distributed Configuration:
  Job ID: N/A
  Process: 0/1
  Coordinator: localhost:12345 (this node)
  Local devices: 1
  Global devices: 1
  Platform: cpu</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Distributed computing initialized:</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">AttributeError</span>                            Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[73]</span><span class="ansi-green-fg">, line 21</span>
<span class="ansi-green-fg">     14</span> dist_info = initialize_distributed(
<span class="ansi-green-fg">     15</span>     coordinator_port=<span class="ansi-green-fg">12345</span>,  <span style="font-style:italic;color:rgb(95,135,135)"># Port for process coordination</span>
<span class="ansi-green-fg">     16</span>     platform=<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">cpu</span><span class="ansi-yellow-fg">"</span>,           <span style="font-style:italic;color:rgb(95,135,135)"># or "gpu" for GPU clusters</span>
<span class="ansi-green-fg">     17</span>     enable_x64=<span style="font-weight:bold;color:rgb(0,135,0)">True</span>          <span style="font-style:italic;color:rgb(95,135,135)"># Enable 64-bit precision</span>
<span class="ansi-green-fg">     18</span> )
<span class="ansi-green-fg">     20</span> <span style="color:rgb(0,135,0)">print</span>(<span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">Distributed computing initialized:</span><span class="ansi-yellow-fg">"</span>)
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">21</span> <span style="color:rgb(0,135,0)">print</span>(<span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">  Process rank: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span class="ansi-yellow-bg">dist_info</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">global_rank</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span class="ansi-yellow-fg">"</span>)
<span class="ansi-green-fg">     22</span> <span style="color:rgb(0,135,0)">print</span>(<span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">  Total processes: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>dist_info.num_processes<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span class="ansi-yellow-fg">"</span>)
<span class="ansi-green-fg">     23</span> <span style="color:rgb(0,135,0)">print</span>(<span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">  Local devices: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>dist_info.num_local_devices<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span class="ansi-yellow-fg">"</span>)

<span class="ansi-red-fg">AttributeError</span>: 'DistributedConfig' object has no attribute 'global_rank'</pre>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/munch-group\.github\.io\/PtDAlgorithms\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../pages/getting_started.html" class="pagination-link" aria-label="Getting Started">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Getting Started</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../pages/tutorials/coalescent_full_py_api_example.html" class="pagination-link" aria-label="Coalescent - Full API">
        <span class="nav-page-text">Coalescent - Full API</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>